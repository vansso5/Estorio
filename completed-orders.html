<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</title>
  
  <!-- Ø±Ø¨Ø· Ø§Ù„Ø®Ø· ÙˆØ§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯ -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="admin-style.css" />
</head>
<body>

  <nav>
    <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>
    <div class="logo">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
    <div class="links">
      <a href="admin-products.html" class="nav-link">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
      <a href="admin-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</a>
      <a href="completed-orders.html" class="nav-link active">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</a>
      <a href="admin-analytics.html" class="nav-link">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</a>
      <a href="admin-settings.html" class="nav-link">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
      <a href="admin-reviews.html" class="nav-link">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</a>
      <a href="admin-shipping.html" class="nav-link">Ø§Ù„Ø´Ø­Ù†</a>
      <a href="#" id="logoutBtn" class="nav-link" style="display: none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
    </div>
  </nav>

  <div class="container">
    <h2>âœ… Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</h2>
    
    <div class="search-wrapper">
      <input id="searchInput" class="search-input" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨...">
    </div>

    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø³ÙŠØ·Ø© -->
    <div class="orders-stats">
      <div class="stat-card">
        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</h3>
        <span id="completedOrdersCount">0</span>
      </div>
    </div>

    <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª -->
    <div id="ordersContainer" class="orders-grid">
      <p class="loading-message">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª...</p>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ø¹Ø±Ø¶ ÙÙ‚Ø·) -->
  <div id="orderDetailsModal" class="modal hidden">
    <div class="modal-content">
      <button class="close-modal-btn" id="closeDetailModal">&times;</button>
      <h3 class="modal-header-completed">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…ÙƒØªÙ…Ù„</h3>
      <div id="modalDetailsBody"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
      authDomain: "myestore-34f65.firebaseapp.com",
      databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
      projectId: "myestore-34f65",
      storageBucket: "myestore-34f65.firebasestorage.app",
      messagingSenderId: "14078917211",
      appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
      measurementId: "G-9181DX0XNJ"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);
    const ordersRef = ref(database, 'orders');

    // Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const ordersContainer = document.getElementById('ordersContainer');
    const logoutBtn = document.getElementById('logoutBtn');
    const completedOrdersCount = document.getElementById('completedOrdersCount');
    const searchInput = document.getElementById('searchInput');
    const detailModal = document.getElementById('orderDetailsModal');
    const closeDetailModal = document.getElementById('closeDetailModal');
    const modalDetailsBody = document.getElementById('modalDetailsBody');

    let userAuthenticated = false;
    let currentOrdersData = {};
    let searchKeyword = "";
    let currentOpenOrderId = null;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userAuthenticated = true;
        logoutBtn.style.display = 'block';
      } else {
        userAuthenticated = false;
        logoutBtn.style.display = 'none';
        alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…");
        window.location.href = 'admin-login.html';
      }
    });

    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        window.location.href = 'admin-login.html';
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:", error);
      }
    });

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
    closeDetailModal.addEventListener('click', () => detailModal.classList.add('hidden'));
    window.addEventListener('click', (e) => { 
      if(e.target === detailModal) detailModal.classList.add('hidden'); 
    });

    function formatDate(timestamp) {
      if (!timestamp || timestamp === 0) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const date = new Date(timestamp);
      return date.toLocaleString('en-GB', { 
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', hour12: false 
      });
    }

    function openOrderDetails(order, id) {
      currentOpenOrderId = id;
      detailModal.classList.remove('hidden');

      let productsHtml = '';
      if (order.items) {
        const items = Array.isArray(order.items) ? order.items : Object.values(order.items);
        productsHtml = items.map(it => `
           <div style="background:#f9f9f9; padding:10px; margin-bottom:8px; border-radius:6px; border-right:3px solid var(--success-color);">
              <div style="font-weight:bold; font-size:0.95rem;">â€¢ ${it.name || it.productName}</div>
              <div style="color:#666; font-size:0.85rem;">
                 Ø§Ù„ÙƒÙ…ÙŠØ©: ${it.quantity || 1} | Ø§Ù„Ø³Ø¹Ø±: ${parseFloat(it.price || it.productPrice || 0)} Ø¯Ø¬
              </div>
           </div>
        `).join('');
      } else {
         productsHtml = `
           <div style="background:#f9f9f9; padding:10px; margin-bottom:8px; border-radius:6px; border-right:3px solid var(--success-color);">
              <div style="font-weight:bold; font-size:0.95rem;">â€¢ ${order.productName || 'Ù…Ù†ØªØ¬'}</div>
              <div style="color:#666; font-size:0.85rem;">
                 Ø§Ù„ÙƒÙ…ÙŠØ©: ${order.quantity || 1} | Ø§Ù„Ø³Ø¹Ø±: ${parseFloat(order.productPrice || 0)} Ø¯Ø¬
              </div>
           </div>
         `;
      }

      modalDetailsBody.innerHTML = `
        <div class="details-section">
          <h4 class="completed-title">ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h4>
          <div class="details-row"><span class="details-label">Ø§Ù„Ø§Ø³Ù…:</span> ${order.customerName || order.name || '-'}</div>
          <div class="details-row"><span class="details-label">Ø§Ù„Ù‡Ø§ØªÙ:</span> <a href="tel:${order.customerPhone || order.phone}" style="color:var(--success-color);">${order.customerPhone || order.phone || '-'}</a></div>
          <div class="details-row"><span class="details-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</span> ${order.customerAddress || order.address || '-'}</div>
          <div class="details-row"><span class="details-label">Ø§Ù„ØªÙˆØµÙŠÙ„:</span> ${order.deliveryOption || '-'}</div>
        </div>

        <div class="details-section">
          <h4 class="completed-title">ğŸ“¦ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h4>
          ${productsHtml}
          <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #ddd; font-weight:bold; color:var(--success-color);">
             Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: ${parseFloat(order.totalPrice || 0).toLocaleString()} Ø¯Ø¬
          </div>
        </div>

        <div class="details-section" style="border-bottom:none;">
          <h4 class="completed-title">âœ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„</h4>
          <div class="details-row"><span class="details-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</span> ${formatDate(order.timestamp)}</div>
          ${order.updatedAt ? `<div class="details-row"><span class="details-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</span> ${formatDate(order.updatedAt)}</div>` : ''}
          <div class="details-row"><span class="details-label">Ø§Ù„Ø­Ø§Ù„Ø©:</span> <strong style="color:var(--success-color);">ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ âœ…</strong></div>
        </div>
      `;
    }

    function renderOrderRow(order, id) {
      const row = document.createElement('div');
      row.className = 'order-row status-completed';
      row.dataset.orderId = id;
      
      const productName = order.productName || (order.items ? 'Ø·Ù„Ø¨ Ù…ØªØ¹Ø¯Ø¯' : 'Ø·Ù„Ø¨ Ù…ÙƒØªÙ…Ù„');
      const shortId = id.slice(-5);

      row.innerHTML = `
        <div class="row-info">
          <span class="row-id completed-badge">#${shortId}</span>
          <span class="row-name">${order.customerName || order.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</span>
          <span class="row-product" style="color:var(--success-color)">${productName}</span>
          <span class="row-date completed-text">${formatDate(order.timestamp).split(',')[0] || ''}</span>
        </div>
        <div class="row-arrow completed-text">â®</div>
      `;

      row.addEventListener('click', () => {
        openOrderDetails(order, id);
      });

      return row;
    }

    function renderOrders(ordersData) {
      if (!userAuthenticated) return;

      const filteredCompletedOrders = {};
      Object.entries(ordersData || {}).forEach(([id, order]) => {
        if (order && (order.status === 'Delivered' || order.status === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„')) {
          if (searchKeyword) {
            const kw = searchKeyword.toLowerCase();
            const searchText = [
              id, order.customerName, order.customerPhone, 
              order.productName, order.customerAddress
            ].join(' ').toLowerCase();
            if (!searchText.includes(kw)) return;
          }
          filteredCompletedOrders[id] = order;
        }
      });

      completedOrdersCount.textContent = Object.keys(filteredCompletedOrders).length;
      ordersContainer.innerHTML = '';

      if (Object.keys(filteredCompletedOrders).length === 0) {
        ordersContainer.innerHTML = '<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨ÙŠØ§Øª Ù…ÙƒØªÙ…Ù„Ø© ØªØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«</p>';
        return;
      }

      Object.entries(filteredCompletedOrders)
        .sort((a, b) => (b[1]?.updatedAt || b[1]?.timestamp) - (a[1]?.updatedAt || a[1]?.timestamp))
        .forEach(([id, order]) => {
          const row = renderOrderRow(order, id);
          ordersContainer.appendChild(row);
        });
    }

    onValue(ordersRef, (snapshot) => {
      if (userAuthenticated) {
        currentOrdersData = snapshot.val() || {};
        renderOrders(currentOrdersData);
      }
    });

    searchInput.addEventListener('input', (e) => {
      searchKeyword = e.target.value.trim();
      renderOrders(currentOrdersData);
    });
  </script>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
  <script>
    function toggleMenu() {
      const links = document.querySelector('nav .links');
      links.classList.toggle('open');
    }
  </script>
</body>
</html>