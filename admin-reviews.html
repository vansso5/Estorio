<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</title>
  
  <!-- Ø±Ø¨Ø· Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <!-- Ø±Ø¨Ø· Ù…Ù„Ù Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯ -->
  <link rel="stylesheet" href="admin-style.css">
</head>
<body>

<nav>
  <div class="logo">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
  <div class="links">
    <a href="admin-products.html" class="nav-link">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
    <a href="admin-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</a>
    <a href="completed-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</a>
    <a href="admin-analytics.html" class="nav-link">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</a>
    <a href="admin-settings.html" class="nav-link">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
    <a href="admin-reviews.html" class="nav-link active">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</a>
    <a href="admin-shipping.html" class="nav-link">Ø§Ù„Ø´Ø­Ù†</a>
    <a href="#" id="logoutBtn" class="nav-link" style="display: none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
  </div>
</nav>

<div class="container">
    <h2>ğŸ’¬ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h2>
    <div id="adminContent">
        <p class="loading-message">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª...</p>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
  authDomain: "myestore-34f65.firebaseapp.com",
  databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
  projectId: "myestore-34f65",
  storageBucket: "myestore-34f65.appspot.com",
  messagingSenderId: "14078917211",
  appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
  measurementId: "G-9181DX0XNJ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const adminContent = document.getElementById('adminContent');
const logoutBtn = document.getElementById('logoutBtn');

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, (user) => {
  if(user){
    logoutBtn.style.display = 'block';
  } else {
    window.location.href='admin-login.html';
  }
});

logoutBtn.addEventListener('click', async ()=>{
  await signOut(auth);
  window.location.href='admin-login.html';
});

// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
function escapeHtml(text){
  if(!text) return '';
  return String(text)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function generateStarIconsForDisplay(rating){
  let stars='';
  for(let i=1;i<=5;i++){
    if(rating>=i) stars+='<i class="fas fa-star"></i>';
    else if(rating>=i-0.5) stars+='<i class="fas fa-star-half-alt"></i>';
    else stars+='<i class="far fa-star"></i>';
  }
  return stars;
}

// Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
let currentView='list';
let currentProductId=null;

// 1. Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù‡Ø§ ØªØ¹Ù„ÙŠÙ‚Ø§Øª
async function fetchAndRenderProductSummaries(){
  currentView='list';
  adminContent.innerHTML='<p class="loading-message">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';
  try{
    const productsSnap = await get(ref(db,'products'));
    const reviewsSnap = await get(ref(db,'reviews'));
    
    if(!productsSnap.exists()){
      adminContent.innerHTML='<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª.</p>'; return;
    }
    
    const products = productsSnap.val();
    const reviewsByProduct = reviewsSnap.exists()?reviewsSnap.val():{};
    
    let html='';
    let hasReviews = false;

    Object.keys(products).forEach(pid=>{
      const product=products[pid];
      const count = reviewsByProduct[pid]?Object.keys(reviewsByProduct[pid]).length:0;
      
      if(count>0){
        hasReviews = true;
        // Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬
        let img = 'https://via.placeholder.com/70';
        if (product.images && Array.isArray(product.images) && product.images.length > 0) {
            img = product.images[0];
        } else if (product.image) {
            img = product.image;
        }

        html+=`
          <div class="product-summary-card" data-product-id="${pid}">
            <img src="${escapeHtml(img)}" alt="${escapeHtml(product.name)}">
            <div>
              <h2>${escapeHtml(product.name)}</h2>
              <p>Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª: <strong>${count}</strong></p>
            </div>
            <i class="fas fa-chevron-left" style="margin-right:auto; color:#ccc;"></i>
          </div>
        `;
      }
    });

    if (!hasReviews) {
        adminContent.innerHTML = '<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙŠ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
    } else {
        adminContent.innerHTML = html;
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
        document.querySelectorAll('.product-summary-card').forEach(card=>{
          card.addEventListener('click',()=>renderProductDetails(card.dataset.productId));
        });
    }
    
  } catch(err){
    console.error(err);
    adminContent.innerHTML='<p class="error-message">Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„.</p>';
  }
}

// 2. Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù„Ù…Ù†ØªØ¬ Ù…Ø¹ÙŠÙ†
async function renderProductDetails(pid){
  currentView='detail';
  currentProductId=pid;
  adminContent.innerHTML='<p class="loading-message">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª...</p>';
  
  try{
    const productSnap = await get(ref(db,`products/${pid}`));
    const reviewsSnap = await get(ref(db,`reviews/${pid}`));
    
    if(!productSnap.exists()){ adminContent.innerHTML='<p>Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.</p>'; return; }
    
    const product = productSnap.val();
    const reviews = reviewsSnap.exists()?reviewsSnap.val():{};
    
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù„Ù…ØµÙÙˆÙØ© ÙˆØªØ±ØªÙŠØ¨Ù‡Ø§
    const reviewsArr = Object.keys(reviews).map(k=>({id:k,...reviews[k]}));
    reviewsArr.sort((a,b)=>b.timestamp-a.timestamp);
    
    // ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬
    let img = 'https://via.placeholder.com/120';
    if (product.images && Array.isArray(product.images) && product.images.length > 0) {
        img = product.images[0];
    } else if (product.image) {
        img = product.image;
    }

    let html=`
      <button class="back-to-list" id="backToListBtn">
        <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
      </button>
      
      <div class="product-detail-header">
        <img src="${escapeHtml(img)}" alt="${escapeHtml(product.name)}">
        <div>
            <h2>${escapeHtml(product.name)}</h2>
            <p style="color:#666;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª: ${reviewsArr.length}</p>
        </div>
      </div>
      
      <div class="comments-section">
        ${reviewsArr.map(r=>{
          const date=new Date(r.timestamp).toLocaleDateString('ar-DZ',{year:'numeric',month:'long',day:'numeric'});
          return `
            <div class="comment-card">
              <div class="comment-meta">
                <strong>${escapeHtml(r.reviewerName||'Ù…Ø¬Ù‡ÙˆÙ„')}</strong>
                <div class="comment-rating">${generateStarIconsForDisplay(parseFloat(r.rating)||0)}</div>
              </div>
              <p class="comment-text">${escapeHtml(r.comment)}</p>
              <span class="comment-date"><i class="far fa-clock"></i> ${date}</span>
              <button class="delete-review-btn" data-product-id="${pid}" data-review-id="${r.id}">
                <i class="fas fa-trash-alt"></i> Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
              </button>
            </div>
          `;
        }).join('')}
        ${reviewsArr.length===0?'<p class="loading-message">ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬.</p>':''}
      </div>
    `;
    
    adminContent.innerHTML=html;

    // Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø©
    document.getElementById('backToListBtn').addEventListener('click', fetchAndRenderProductSummaries);

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù
    document.querySelectorAll('.delete-review-btn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        if(confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')){
          try {
              await remove(ref(db,`reviews/${pid}/${btn.dataset.reviewId}`));
              // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
              renderProductDetails(pid);
          } catch(e) {
              alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù");
          }
        }
      });
    });

  } catch(err){ 
      console.error(err); 
      adminContent.innerHTML='<p class="error-message">Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.</p>'; 
  }
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
fetchAndRenderProductSummaries();

</script>
</body>
</html>