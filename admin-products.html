<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="admin-style.css" />
  
  <style>
    .hidden-section { display: none !important; }
    .form-container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); max-width: 900px; margin: 0 auto; }
    .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f4f4f4; }
    .back-btn { background: #eee; color: #333; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-family: 'Cairo', sans-serif; font-weight: bold; transition: 0.2s; }
    .back-btn:hover { background: #ddd; }
    
    .gallery-input-wrapper { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
    .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; background: #fafafa; padding: 10px; border: 1px dashed #ddd; border-radius: 8px; min-height: 120px; }
    .gallery-item { position: relative; height: 100px; border-radius: 8px; overflow: hidden; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; background: white; }
    .gallery-item:hover { transform: scale(1.03); }
    .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
    .gallery-item .remove-img-btn { position: absolute; top: 2px; left: 2px; background: rgba(220, 53, 69, 0.9); color: white; border: none; width: 24px; height: 24px; border-radius: 50%; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 2; }
    
    .desc-block, .icon-block { background: #f9f9f9; border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 5px; display: flex; align-items: center; gap: 10px; }
    .preview-box { width: 50px; height: 50px; border-radius: 4px; overflow: hidden; border: 1px solid #ddd; flex-shrink: 0; background: #fff; }
    .preview-box img { width: 100%; height: 100%; object-fit: contain; }
    .remove-btn { background: #ffebee; color: #c62828; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; flex-shrink: 0; }
    
    .builder-controls { margin-top: 10px; margin-bottom: 20px; }
    .builder-controls button { background: #e3f2fd; color: #1565c0; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; }
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
    .preview-link { margin-top: 8px; font-size: 0.9em; }
    .preview-link a { color: #007bff; text-decoration: none; border-bottom: 1px dashed #007bff; }
    .preview-link a:hover { border-bottom-style: solid; }
  </style>
</head>
<body>

  <nav>
    <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>
    <div class="logo">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
    <div class="links">
      <a href="admin-products.html" class="nav-link active">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
      <a href="admin-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</a>
      <a href="completed-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</a>
      <a href="add-manager.html" class="nav-link">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†</a>
      <a href="admin-analytics.html" class="nav-link">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</a>
      <a href="admin-settings.html" class="nav-link">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
      <a href="admin-reviews.html" class="nav-link">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</a>
      <a href="admin-shipping.html" class="nav-link">Ø§Ù„Ø´Ø­Ù†</a>
      <a href="#" id="logoutBtn" class="nav-link" style="display: none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
    </div>
  </nav>

  <div class="container page-products"> 
    
    <div id="viewProductList">
        <h2>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
        <button id="openAddProductBtn" class="floating-btn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯">+</button>
        <div class="search-wrapper">
            <input id="searchInput" class="search-input" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬...">
        </div>
        <div id="productsContainer" class="products-grid">
            <p class="loading-message">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
        </div>
    </div>

    <div id="viewProductForm" class="hidden-section">
        <div class="form-container">
            <div class="form-header">
                <h3 id="formTitle" style="margin:0;">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
                <button type="button" id="backToListBtn" class="back-btn">â†ª Ø±Ø¬ÙˆØ¹</button>
            </div>

            <form id="addProductForm">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>
                <input type="text" id="productName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" required />

                <label>Ù„ÙˆØ¬Ùˆ Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="url" id="productCustomLogo" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù„ÙˆØ¬Ùˆ" style="flex:1;">
                    <div class="preview-box" id="logoPreviewBox" style="display:none;"><img id="logoPreviewImg" src=""></div>
                </div>

                <label>ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬:</label>
                <div id="descBuilder">
                   <div id="descBlocksContainer"></div>
                   <div class="builder-controls">
                      <button type="button" id="addDescTextBtn">+ Ù†Øµ</button>
                      <button type="button" id="addDescImgBtn">+ ØµÙˆØ±Ø©</button>
                   </div>
                </div>

                <label>Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª:</label>
                <div id="iconBuilder">
                  <div id="iconBlocksContainer"></div>
                  <div class="builder-controls">
                    <button type="button" id="addIconBtn">+ Ø£ÙŠÙ‚ÙˆÙ†Ø©</button>
                  </div>
                </div>

                <label>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±:</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 150px;">
                        <span style="font-size:0.8em; font-weight:bold; color:#555;">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (ØªÙƒÙ„ÙØªÙƒ)</span>
                        <input type="number" id="productPurchasePrice" placeholder="Ù…Ø«Ù„Ø§Ù‹: 800" step="0.01" required />
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <span style="font-size:0.8em; font-weight:bold; color:#555;">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø§Ù„Ù…Ø´Ø·ÙˆØ¨)</span>
                        <input type="number" id="productOldPrice" placeholder="Ù…Ø«Ù„Ø§Ù‹: 2500" step="0.01" />
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 150px;">
                        <span style="font-size:0.8em; font-weight:bold; color:#27ae60;">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ù„Ù„Ø²Ø¨ÙˆÙ†)</span>
                        <input type="number" id="productNewPrice" placeholder="Ù…Ø«Ù„Ø§Ù‹: 1200" step="0.01" required />
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <span style="font-size:0.8em; font-weight:bold; color:#e67e22;">Ø®ØµÙ… Ø§Ù„Ø´Ø­Ù† (ØªØ³ÙˆÙŠÙ‚ÙŠ)</span>
                        <input type="number" id="marketingDiscount" placeholder="Ù…Ø«Ù„Ø§Ù‹: 200" step="0.01" />
                        <small style="display:block; font-size:0.7em; color:#777;">Ø³ÙŠØªÙ… Ø®ØµÙ… Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© Ù„Ù„Ø²Ø¨ÙˆÙ†.</small>
                    </div>
                </div>

                <label style="margin-top:15px;">ØµÙˆØ± Ø§Ù„Ù…Ø¹Ø±Ø¶:</label>
                <div class="gallery-input-wrapper">
                    <input type="url" id="newImageUrl" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©..." style="flex:1;">
                    <button type="button" id="addNewImageBtn" style="background:#28a745; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer;">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
                <div id="galleryGrid" class="gallery-grid"></div>

                <hr style="margin: 30px 0; border:0; border-top:1px solid #eee;">
                
                <button type="submit" id="saveButton" style="width:100%; padding:15px; background:#007bff; color:white; border:none; font-size:1.1em; cursor:pointer;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
            </form>
        </div>
    </div>

  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
    authDomain: "myestore-34f65.firebaseapp.com",
    databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
    projectId: "myestore-34f65",
    storageBucket: "myestore-34f65.firebasestorage.app",
    messagingSenderId: "14078917211",
    appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
    measurementId: "G-9181DX0XNJ"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const auth = getAuth(app);
  const productsRef = ref(database, 'products');

  const viewProductList = document.getElementById('viewProductList');
  const viewProductForm = document.getElementById('viewProductForm');
  const openAddProductBtn = document.getElementById('openAddProductBtn');
  const backToListBtn = document.getElementById('backToListBtn');
  const formTitle = document.getElementById('formTitle');
  const form = document.getElementById('addProductForm');
  const productsContainer = document.getElementById('productsContainer');
  const saveButton = document.getElementById('saveButton');
  const logoutBtn = document.getElementById('logoutBtn');
  const searchInput = document.getElementById('searchInput');

  const nameInput = document.getElementById('productName');
  const customLogoInput = document.getElementById('productCustomLogo');
  const logoPreviewBox = document.getElementById('logoPreviewBox');
  const logoPreviewImg = document.getElementById('logoPreviewImg');
  const descBlocksContainer = document.getElementById('descBlocksContainer');
  const iconBlocksContainer = document.getElementById('iconBlocksContainer');
  const purchasePriceInput = document.getElementById('productPurchasePrice');
  const oldPriceInput = document.getElementById('productOldPrice');
  const newPriceInput = document.getElementById('productNewPrice');
  const marketingDiscountInput = document.getElementById('marketingDiscount'); 
  const newImageUrlInput = document.getElementById('newImageUrl');
  const addNewImageBtn = document.getElementById('addNewImageBtn');
  const galleryGrid = document.getElementById('galleryGrid');

  const addDescTextBtn = document.getElementById('addDescTextBtn');
  const addDescImgBtn = document.getElementById('addDescImgBtn');
  const addIconBtn = document.getElementById('addIconBtn');

  let currentProductsData = {};
  let searchKeyword = "";
  let editingProductId = null;
  let userAuthenticated = false;

  customLogoInput.addEventListener('input', () => {
    const url = customLogoInput.value.trim();
    if(url){
        logoPreviewImg.src = url;
        logoPreviewBox.style.display = 'block';
    } else {
        logoPreviewBox.style.display = 'none';
    }
  });

  function showForm(productId = null) {
    form.reset();
    descBlocksContainer.innerHTML = '';
    iconBlocksContainer.innerHTML = '';
    galleryGrid.innerHTML = '';
    logoPreviewBox.style.display = 'none';

    editingProductId = productId;

    if (productId && currentProductsData[productId]) {
        formTitle.textContent = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬";
        saveButton.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª";
        fillFormWithData(currentProductsData[productId]);
    } else {
        formTitle.textContent = "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯";
        saveButton.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬";
    }

    viewProductList.classList.add('hidden-section');
    viewProductForm.classList.remove('hidden-section');
  }

  function showList() {
    viewProductList.classList.remove('hidden-section');
    viewProductForm.classList.add('hidden-section');
    editingProductId = null;
  }

  openAddProductBtn.addEventListener('click', () => showForm(null));
  backToListBtn.addEventListener('click', showList);

  function addDescBlock(type, value = '') {
      const div = document.createElement('div');
      div.className = 'desc-block';
      div.dataset.type = type;
      
      let inputHtml = '';
      if(type === 'text') {
          inputHtml = `<textarea placeholder="ÙÙ‚Ø±Ø© Ù†ØµÙŠØ©..." rows="2" style="resize:vertical; width:100%; border:1px solid #ddd;">${value}</textarea>`;
      } else {
          inputHtml = `<input type="url" class="desc-img-input" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ÙˆØµÙ..." value="${value}" style="flex:1;">`;
      }
      
      div.innerHTML = `
          <span style="font-size:20px;">${type === 'text' ? 'ğŸ“' : 'ğŸ–¼ï¸'}</span>
          ${inputHtml}
          <button type="button" class="remove-btn" title="Ø­Ø°Ù">Ã—</button>
      `;
      div.querySelector('.remove-btn').addEventListener('click', () => div.remove());
      descBlocksContainer.appendChild(div);
  }

  function addIconBlock(iconUrl = '', text = '') {
    const div = document.createElement('div');
    div.className = 'icon-block';
    div.innerHTML = `
      <input type="url" class="icon-url" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©" value="${iconUrl}" style="flex:1;">
      <input type="text" class="icon-text" placeholder="Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø§ÙÙ‚" value="${text}" style="flex:1;">
      <button type="button" class="remove-btn">Ã—</button>
    `;
    div.querySelector('.remove-btn').addEventListener('click', () => div.remove());
    iconBlocksContainer.appendChild(div);
  }

  function addImageToGrid(url) {
      if(!url) return;
      const div = document.createElement('div');
      div.className = 'gallery-item';
      div.dataset.url = url;
      div.innerHTML = `
          <img src="${url}">
          <button type="button" class="remove-img-btn">âœ•</button>
      `;
      div.querySelector('.remove-img-btn').addEventListener('click', () => div.remove());
      galleryGrid.appendChild(div);
  }

  addNewImageBtn.addEventListener('click', () => {
      const url = newImageUrlInput.value.trim();
      if (url) {
          addImageToGrid(url);
          newImageUrlInput.value = '';
      }
  });

  addDescTextBtn.addEventListener('click', () => addDescBlock('text'));
  addDescImgBtn.addEventListener('click', () => addDescBlock('image'));
  addIconBtn.addEventListener('click', () => addIconBlock());

  function fillFormWithData(product) {
    nameInput.value = product.name || '';
    
    customLogoInput.value = product.customLogo || '';
    if(product.customLogo) { logoPreviewImg.src = product.customLogo; logoPreviewBox.style.display = 'block'; }

    purchasePriceInput.value = product.purchasePrice || '';
    oldPriceInput.value = product.oldPrice || '';
    newPriceInput.value = product.newPrice || '';
    marketingDiscountInput.value = product.marketingDiscount || ''; 

    if (Array.isArray(product.description)) {
        product.description.forEach(blk => addDescBlock(blk.type, blk.val));
    }
    if (Array.isArray(product.icons)) {
        product.icons.forEach(ic => addIconBlock(ic.icon, ic.text));
    }
    const imgs = Array.isArray(product.images) ? product.images : (product.image ? [product.image] : []);
    imgs.forEach(url => addImageToGrid(url));
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const galleryItems = galleryGrid.querySelectorAll('.gallery-item');
    const images = Array.from(galleryItems).map(item => item.dataset.url).filter(Boolean);

    if(!nameInput.value || !newPriceInput.value || images.length===0){
      alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø³Ø¹Ø±ØŒ ÙˆØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)");
      return;
    }

    const descBlocks = [];
    descBlocksContainer.querySelectorAll('.desc-block').forEach(blk => {
        const type = blk.dataset.type;
        const val = type==='text' ? blk.querySelector('textarea').value : blk.querySelector('.desc-img-input').value;
        if(val.trim()) descBlocks.push({ type, val });
    });
    if(descBlocks.length===0) descBlocks.push({type:'text', val:''});

    const iconsData = Array.from(iconBlocksContainer.querySelectorAll('.icon-block')).map(b=>({
      icon: b.querySelector('.icon-url').value,
      text: b.querySelector('.icon-text').value
    }));

    const productData = {
      name: nameInput.value.trim(),
      customLogo: customLogoInput.value.trim() || null,
      description: descBlocks,
      icons: iconsData,
      purchasePrice: parseFloat(purchasePriceInput.value),
      oldPrice: oldPriceInput.value || null,
      newPrice: parseFloat(newPriceInput.value),
      marketingDiscount: parseFloat(marketingDiscountInput.value) || 0,
      images,
      updatedAt: new Date().toISOString()
    };
    if (!editingProductId) productData.createdAt = new Date().toISOString();
    
    // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¨ÙŠÙƒØ³Ù„ Ø§Ù„Ø®Ø§Øµ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    if (editingProductId && currentProductsData[editingProductId].customPixelId) {
        productData.customPixelId = currentProductsData[editingProductId].customPixelId;
    }

    try {
      saveButton.disabled = true;
      saveButton.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

      if(editingProductId) {
        await update(ref(database, 'products/'+editingProductId), productData);
        alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
      } else {
        await push(productsRef, productData);
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
      }
      
      saveButton.disabled = false;
      showList();

    } catch(error){
      alert("Ø®Ø·Ø£: "+error.message);
      saveButton.disabled = false;
    }
  });

  const deleteProduct = async (id) => {
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;
    try { await remove(ref(database, 'products/' + id)); } 
    catch (error) { alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + error.message); }
  };

  onAuthStateChanged(auth, (user) => {
    if (user) { userAuthenticated = true; logoutBtn.style.display = 'block'; } 
    else { window.location.href = 'admin-login.html'; }
  });
  
  logoutBtn.addEventListener('click', async () => { await signOut(auth); window.location.href = 'admin-login.html'; });
  
  onValue(productsRef, snapshot => {
    if(!userAuthenticated) return;
    productsContainer.innerHTML = '';
    currentProductsData = snapshot.val() || {};
    
    Object.entries(currentProductsData).forEach(([id, product]) => {
        if(searchKeyword) {
            const str = (product.name + JSON.stringify(product.description)).toLowerCase();
            if(!str.includes(searchKeyword)) return;
        }

        const div = document.createElement('div');
        div.className = 'product-card';
        const img = (product.images && product.images[0]) ? product.images[0] : 'https://via.placeholder.com/150';
        
        // Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø©
        const productLink = `product-detail.html?id=${id}`;

        div.innerHTML = `
          ${product.customLogo ? `<img src="${product.customLogo}" style="height:30px; display:block; margin:0 auto 5px;">` : ''}
          <img src="${img}" style="width:100%; height:150px; object-fit:cover;">
          <div class="product-info">
            <h3>${product.name||'Ù…Ù†ØªØ¬'}</h3>
            <p style="color:#27ae60; font-weight:bold;">${product.newPrice} Ø¯Ø¬</p>
            ${product.marketingDiscount ? `<small style="color:#e67e22;">Ø®ØµÙ… Ø´Ø­Ù†: ${product.marketingDiscount}</small>` : ''}
            
            <!-- ğŸ”¥ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø°ÙŠ Ø·Ù„Ø¨ØªÙ‡ ğŸ”¥ -->
            <p class="preview-link"><a href="${productLink}" target="_blank">ğŸ”— Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±</a></p>
          </div>
          <div class="product-actions">
            <button class="edit-btn" data-id="${id}">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="delete-btn" data-id="${id}">Ø­Ø°Ù</button>
          </div>
        `;
        productsContainer.appendChild(div);
    });

    document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', e => showForm(e.target.dataset.id)));
    document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', e => deleteProduct(e.target.dataset.id)));
  });

  searchInput.addEventListener('input', (e) => {
    searchKeyword = e.target.value.trim().toLowerCase();
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø³ØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø£Ù† onValue ÙŠØ³ØªÙ…Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§ØªØŒ 
    // ÙˆÙ„ÙƒÙ† Ù„Ù„ØªØµÙÙŠØ© Ø§Ù„ÙÙˆØ±ÙŠØ© Ù†Ø­ØªØ§Ø¬ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø£Ùˆ ØªØ­ÙÙŠØ²Ù‡.
    // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£Ø¨Ø³Ø· Ù‡Ù†Ø§:
    const tempSnapshot = { val: () => currentProductsData };
    // Ù…Ø­Ø§ÙƒØ§Ø© onValue Ù„Ù„ØªØµÙÙŠØ©
    // (Ù„Ù„Ø§Ø®ØªØµØ§Ø±ØŒ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… Ø¥Ø°Ø§ ØªÙ… ÙØµÙ„Ù‡Ø§ØŒ 
    // Ù„ÙƒÙ† Ù‡Ù†Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ onValue Ù…Ø¨Ø§Ø´Ø±Ø©. 
    // Ù„Ø°Ø§ ÙŠÙØ¶Ù„ ÙØµÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… renderProducts ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)
    // Ø³Ø£Ù‚ÙˆÙ… Ø¨Ù†Ø³Ø® Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø³Ù… Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø´ÙƒÙ„ Ø³Ù„ÙŠÙ….
  });
  
  // ØªØµØ­ÙŠØ­ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø­Ø«:
  // Ù‚Ù…Øª Ø¨Ù†Ù‚Ù„ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø³Ù… Ù„Ø¯Ø§Ù„Ø© renderProducts Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
  const renderProducts = (data) => {
      productsContainer.innerHTML = '';
      Object.entries(data).forEach(([id, product]) => {
        if(searchKeyword) {
            const str = (product.name + JSON.stringify(product.description)).toLowerCase();
            if(!str.includes(searchKeyword)) return;
        }

        const div = document.createElement('div');
        div.className = 'product-card';
        const img = (product.images && product.images[0]) ? product.images[0] : 'https://via.placeholder.com/150';
        const productLink = `product-detail.html?id=${id}`;

        div.innerHTML = `
          ${product.customLogo ? `<img src="${product.customLogo}" style="height:30px; display:block; margin:0 auto 5px;">` : ''}
          <img src="${img}" style="width:100%; height:150px; object-fit:cover;">
          <div class="product-info">
            <h3>${product.name||'Ù…Ù†ØªØ¬'}</h3>
            <p style="color:#27ae60; font-weight:bold;">${product.newPrice} Ø¯Ø¬</p>
            ${product.marketingDiscount ? `<small style="color:#e67e22;">Ø®ØµÙ… Ø´Ø­Ù†: ${product.marketingDiscount}</small>` : ''}
            <p class="preview-link"><a href="${productLink}" target="_blank">ğŸ”— Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±</a></p>
          </div>
          <div class="product-actions">
            <button class="edit-btn" data-id="${id}">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="delete-btn" data-id="${id}">Ø­Ø°Ù</button>
          </div>
        `;
        productsContainer.appendChild(div);
    });
    document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', e => showForm(e.target.dataset.id)));
    document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', e => deleteProduct(e.target.dataset.id)));
  }

  // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
  onValue(productsRef, snapshot => {
    if(!userAuthenticated) return;
    currentProductsData = snapshot.val() || {};
    renderProducts(currentProductsData);
  });

  // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø«
  searchInput.addEventListener('input', (e) => {
    searchKeyword = e.target.value.trim().toLowerCase();
    renderProducts(currentProductsData);
  });

  function toggleMenu() { document.querySelector('nav .links').classList.toggle('open'); }
  window.toggleMenu = toggleMenu;
</script>
</body>
</html>