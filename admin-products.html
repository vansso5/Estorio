<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="admin-style.css" />
  
  <style>
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª */
    .hidden-section { display: none !important; }

    /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ */
    .form-container {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      max-width: 900px;
      margin: 0 auto;
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f4f4f4;
    }

    .back-btn {
      background: #eee; color: #333; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-family: 'Cairo', sans-serif; font-weight: bold; transition: 0.2s;
    }
    .back-btn:hover { background: #ddd; }

    /* =========================================
       ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø´Ø¨ÙƒØ© Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Gallery Grid)
       ========================================= */
    .gallery-input-wrapper {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
    }
    .gallery-grid {
        display: grid;
        /* Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø³Ø­Ø±ÙŠ ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØªØªØ¬Ø§ÙˆØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹: Ø£Ù‚Ù„ Ø¹Ø±Ø¶ 100 Ø¨ÙƒØ³Ù„ ÙˆØªØªÙƒØ±Ø± Ù„Ù…Ù„Ø¡ Ø§Ù„ØµÙ */
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
        gap: 10px;
        background: #fafafa;
        padding: 10px;
        border: 1px dashed #ddd;
        border-radius: 8px;
        min-height: 120px; /* Ø§Ø±ØªÙØ§Ø¹ Ù…Ø¨Ø¯Ø¦ÙŠ */
    }

    .gallery-item {
        position: relative;
        height: 100px; /* Ù…Ø±Ø¨Ø¹ Ø«Ø§Ø¨Øª */
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: transform 0.2s;
        background: white;
    }
    .gallery-item:hover { transform: scale(1.03); }

    .gallery-item img {
        width: 100%;
        height: 100%;
        object-fit: cover; /* Ù„Ù…Ù„Ø¡ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø¯ÙˆÙ† Ù…Ø· Ø§Ù„ØµÙˆØ±Ø© */
    }

    .gallery-item .remove-img-btn {
        position: absolute;
        top: 2px;
        left: 2px; /* ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„ÙŠØ³Ø±Ù‰ Ù„Ø£Ù†Ù†Ø§ RTL */
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2;
    }
    .gallery-item .remove-img-btn:hover { background: red; }

    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¨Ù†Ø§Ø¡ (ÙˆØµÙØŒ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª) */
    .desc-block, .icon-block {
      background: #f9f9f9; border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 5px; display: flex; align-items: center; gap: 10px;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ± Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
    .preview-box {
        width: 50px; height: 50px; border-radius: 4px; overflow: hidden; border: 1px solid #ddd; flex-shrink: 0; background: #fff;
    }
    .preview-box img { width: 100%; height: 100%; object-fit: contain; }

    .remove-btn {
      background: #ffebee; color: #c62828; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; flex-shrink: 0;
    }

    .builder-controls { margin-top: 10px; margin-bottom: 20px; }
    .builder-controls button {
      background: #e3f2fd; color: #1565c0; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer;
    }
    
    .preview-link { margin-top: 8px; font-size: 0.9em; }
    .preview-link a { color: #007bff; text-decoration: none; border-bottom: 1px dashed #007bff; }
    .preview-link a:hover { border-bottom-style: solid; }
  </style>
</head>
<body>

  <nav>
    <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>
    <div class="logo">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
    <div class="links">
      <a href="admin-products.html" class="nav-link active">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
      <a href="admin-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</a>
      <a href="completed-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</a>
      <a href="admin-analytics.html" class="nav-link">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</a>
      <a href="admin-settings.html" class="nav-link">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
      <a href="admin-reviews.html" class="nav-link">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</a>
      <a href="admin-shipping.html" class="nav-link">Ø§Ù„Ø´Ø­Ù†</a>
      <a href="#" id="logoutBtn" class="nav-link" style="display: none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
    </div>
  </nav>

  <div class="container page-products"> 
    
    <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙˆÙ„: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <div id="viewProductList">
        <h2>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
        <button id="openAddProductBtn" class="floating-btn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯">+</button>
        <div class="search-wrapper">
            <input id="searchInput" class="search-input" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ù„ÙˆØµÙ...">
        </div>
        <div id="productsContainer" class="products-grid">
            <p class="loading-message">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
        </div>
    </div>

    <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ: Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
    <div id="viewProductForm" class="hidden-section">
        <div class="form-container">
            <div class="form-header">
                <h3 id="formTitle" style="margin:0;">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
                <button type="button" id="backToListBtn" class="back-btn">â†ª Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
            </div>

            <form id="addProductForm">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>
                <input type="text" id="productName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" required />

                <label>Ù„ÙˆØ¬Ùˆ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø®Ø§Øµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="url" id="productCustomLogo" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù„ÙˆØ¬Ùˆ" style="flex:1;">
                    <div class="preview-box" id="logoPreviewBox" style="display:none;"><img id="logoPreviewImg" src=""></div>
                </div>

                <label>ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬ (Ù‚Ø·Ø¹ Ù†ØµÙŠØ© ÙˆØµÙˆØ±):</label>
                <div id="descBuilder">
                   <div id="descBlocksContainer"></div>
                   <div class="builder-controls">
                      <button type="button" id="addDescTextBtn">+ Ù†Øµ</button>
                      <button type="button" id="addDescImgBtn">+ ØµÙˆØ±Ø©</button>
                   </div>
                </div>

                <label>Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬:</label>
                <div id="iconBuilder">
                  <div id="iconBlocksContainer"></div>
                  <div class="builder-controls">
                    <button type="button" id="addIconBtn">+ Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø©</button>
                  </div>
                </div>

                <label>Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="productPurchasePrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡" step="0.01" required />
                    <input type="number" id="productOldPrice" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…" step="0.01" />
                </div>
                <input type="number" id="productNewPrice" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹)" step="0.01" style="margin-top: 10px;" required />
                
                <!-- ================= Ù…Ù†Ø·Ù‚Ø© ØµÙˆØ± Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ================= -->
                <label>ØµÙˆØ± Ø§Ù„Ù…Ø¹Ø±Ø¶ (Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±):</label>
                
                <!-- Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->
                <div class="gallery-input-wrapper">
                    <input type="url" id="newImageUrl" placeholder="Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§..." style="flex:1;">
                    <button type="button" id="addNewImageBtn" style="background:#28a745; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer;">Ø¥Ø¶Ø§ÙØ©</button>
                </div>

                <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø¹Ø±Ø¶ (Grid) -->
                <div id="galleryGrid" class="gallery-grid">
                    <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
                </div>
                <p style="font-size:0.8em; color:#888; margin-top:5px;">ğŸ’¡ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø¶Ø§ÙØ© ØªØ¸Ù‡Ø± Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰. ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°ÙÙ‡Ø§ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø© X.</p>
                <!-- ========================================================== -->

                <hr style="margin: 30px 0; border:0; border-top:1px solid #eee;">
                
                <button type="submit" id="saveButton" style="width:100%; padding:15px; background:#007bff; color:white; border:none; font-size:1.1em; cursor:pointer;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
            </form>
        </div>
    </div>

  </div>

<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
    authDomain: "myestore-34f65.firebaseapp.com",
    databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
    projectId: "myestore-34f65",
    storageBucket: "myestore-34f65.firebasestorage.app",
    messagingSenderId: "14078917211",
    appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
    measurementId: "G-9181DX0XNJ"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const auth = getAuth(app);
  const productsRef = ref(database, 'products');

  // DOM Elements
  const viewProductList = document.getElementById('viewProductList');
  const viewProductForm = document.getElementById('viewProductForm');
  const openAddProductBtn = document.getElementById('openAddProductBtn');
  const backToListBtn = document.getElementById('backToListBtn');
  const formTitle = document.getElementById('formTitle');
  const form = document.getElementById('addProductForm');
  const productsContainer = document.getElementById('productsContainer');
  const saveButton = document.getElementById('saveButton');
  const logoutBtn = document.getElementById('logoutBtn');
  const searchInput = document.getElementById('searchInput');

  // Form Inputs
  const nameInput = document.getElementById('productName');
  const customLogoInput = document.getElementById('productCustomLogo');
  const logoPreviewBox = document.getElementById('logoPreviewBox');
  const logoPreviewImg = document.getElementById('logoPreviewImg');
  const descBlocksContainer = document.getElementById('descBlocksContainer');
  const iconBlocksContainer = document.getElementById('iconBlocksContainer');
  const purchasePriceInput = document.getElementById('productPurchasePrice');
  const oldPriceInput = document.getElementById('productOldPrice');
  const newPriceInput = document.getElementById('productNewPrice');
  
  // Gallery Elements
  const newImageUrlInput = document.getElementById('newImageUrl');
  const addNewImageBtn = document.getElementById('addNewImageBtn');
  const galleryGrid = document.getElementById('galleryGrid');

  const addDescTextBtn = document.getElementById('addDescTextBtn');
  const addDescImgBtn = document.getElementById('addDescImgBtn');
  const addIconBtn = document.getElementById('addIconBtn');

  let currentProductsData = {};
  let searchKeyword = "";
  let editingProductId = null;
  let userAuthenticated = false;
  let formHasChanges = false;

  // --- Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ---
  form.addEventListener('input', (e) => { 
      // Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø­Ù‚Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ "ÙŠÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª" Ø­ØªÙ‰ ÙŠØªÙ… Ø¶ØºØ· Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
      if(e.target !== newImageUrlInput) formHasChanges = true; 
  });

  // --- Ù„ÙˆØ¬Ùˆ Ø§Ù„Ù…Ù†ØªØ¬: Ù…Ø¹Ø§ÙŠÙ†Ø© ---
  customLogoInput.addEventListener('input', () => {
    const url = customLogoInput.value.trim();
    if(url){
        logoPreviewImg.src = url;
        logoPreviewBox.style.display = 'block';
    } else {
        logoPreviewBox.style.display = 'none';
    }
  });

  // --- Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª ---
  function showForm(productId = null) {
    resetForm();
    editingProductId = productId;
    formHasChanges = false;

    if (productId && currentProductsData[productId]) {
        formTitle.textContent = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬";
        saveButton.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª";
        fillFormWithData(currentProductsData[productId]);
    } else {
        formTitle.textContent = "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯";
        saveButton.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬";
    }

    viewProductList.classList.add('hidden-section');
    viewProductForm.classList.remove('hidden-section');
    window.scrollTo(0, 0);
  }

  function showList() {
    if (formHasChanges) {
        if (!confirm("âš ï¸ Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©.\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¯ÙˆÙ† Ø­ÙØ¸ØŸ")) return;
    }
    viewProductList.classList.remove('hidden-section');
    viewProductForm.classList.add('hidden-section');
    formHasChanges = false;
    editingProductId = null;
  }

  openAddProductBtn.addEventListener('click', () => showForm(null));
  backToListBtn.addEventListener('click', showList);

  // --- Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØµÙ (Description) ---
  function addDescBlock(type, value = '') {
      const div = document.createElement('div');
      div.className = 'desc-block';
      div.dataset.type = type;
      
      let inputHtml = '';
      if(type === 'text') {
          inputHtml = `<textarea placeholder="ÙÙ‚Ø±Ø© Ù†ØµÙŠØ©..." rows="2" style="resize:vertical; width:100%; border:1px solid #ddd;">${value}</textarea>`;
      } else {
          // ØµÙˆØ±Ø© Ø§Ù„ÙˆØµÙ Ù…Ø¹ Ù…Ø¹Ø§ÙŠÙ†Ø© ØµØºÙŠØ±Ø©
          inputHtml = `
            <div style="flex:1; display:flex; gap:10px; align-items:center;">
                <input type="url" class="desc-img-input" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ÙˆØµÙ..." value="${value}" style="flex:1;">
                <div class="preview-box" style="${value?'':'display:none'}"><img src="${value}"></div>
            </div>
          `;
      }
      
      div.innerHTML = `
          <span style="font-size:20px;">${type === 'text' ? 'ğŸ“' : 'ğŸ–¼ï¸'}</span>
          ${inputHtml}
          <button type="button" class="remove-btn" title="Ø­Ø°Ù">Ã—</button>
      `;

      // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„ØµÙˆØ±Ø© Ø§Ù„ÙˆØµÙ
      if(type === 'image') {
          const inp = div.querySelector('.desc-img-input');
          const box = div.querySelector('.preview-box');
          const img = div.querySelector('img');
          inp.addEventListener('input', () => {
             if(inp.value){ img.src = inp.value; box.style.display = 'block'; }
             else { box.style.display = 'none'; }
             formHasChanges = true;
          });
      }

      div.querySelector('.remove-btn').addEventListener('click', () => { div.remove(); formHasChanges = true; });
      if(type === 'text') div.querySelector('textarea').addEventListener('input', () => formHasChanges = true);
      
      descBlocksContainer.appendChild(div);
  }

  // --- Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ---
  function addIconBlock(iconUrl = '', text = '') {
    const div = document.createElement('div');
    div.className = 'icon-block';
    div.innerHTML = `
      <div class="preview-box"><img src="${iconUrl || 'https://via.placeholder.com/30'}" class="icon-preview"></div>
      <input type="url" class="icon-url" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©" value="${iconUrl}" style="flex:1;">
      <input type="text" class="icon-text" placeholder="Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø§ÙÙ‚" value="${text}" style="flex:1;">
      <button type="button" class="remove-btn">Ã—</button>
    `;
    const urlInput = div.querySelector('.icon-url');
    const imgPreview = div.querySelector('.icon-preview');
    
    urlInput.addEventListener('input', () => { 
        imgPreview.src = urlInput.value || 'https://via.placeholder.com/30'; 
        formHasChanges = true; 
    });
    div.querySelector('.icon-text').addEventListener('input', () => formHasChanges = true);
    div.querySelector('.remove-btn').addEventListener('click', () => { div.remove(); formHasChanges = true; });
    
    iconBlocksContainer.appendChild(div);
  }

  // --- [Ø¬Ø¯ÙŠØ¯] Ù†Ø¸Ø§Ù… Ø´Ø¨ÙƒØ© Ø§Ù„ØµÙˆØ± (Gallery Grid) ---
  
  // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø¨Ø¹ ØµÙˆØ±Ø© Ù„Ù„Ø´Ø¨ÙƒØ©
  function addImageToGrid(url) {
      if(!url) return;
      
      const div = document.createElement('div');
      div.className = 'gallery-item';
      div.dataset.url = url; // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

      div.innerHTML = `
          <img src="${url}" onerror="this.src='https://via.placeholder.com/100?text=Error'">
          <button type="button" class="remove-img-btn" title="Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©">âœ•</button>
      `;

      // Ø²Ø± Ø§Ù„Ø­Ø°Ù
      div.querySelector('.remove-img-btn').addEventListener('click', () => {
          div.remove();
          formHasChanges = true;
      });

      galleryGrid.appendChild(div);
      formHasChanges = true;
  }

  // Ø²Ø± "Ø¥Ø¶Ø§ÙØ©" Ø¨Ø¬Ø§Ù†Ø¨ Ø­Ù‚Ù„ Ø§Ù„ØµÙˆØ±
  addNewImageBtn.addEventListener('click', () => {
      const url = newImageUrlInput.value.trim();
      if (url) {
          addImageToGrid(url);
          newImageUrlInput.value = ''; // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚Ù„
      } else {
          alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙˆØ¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹");
      }
  });

  addDescTextBtn.addEventListener('click', () => { addDescBlock('text'); formHasChanges = true; });
  addDescImgBtn.addEventListener('click', () => { addDescBlock('image'); formHasChanges = true; });
  addIconBtn.addEventListener('click', () => { addIconBlock(); formHasChanges = true; });

  // --- Ù…Ù„Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
  function fillFormWithData(product) {
    nameInput.value = product.name || '';
    
    customLogoInput.value = product.customLogo || '';
    if(product.customLogo) { logoPreviewImg.src = product.customLogo; logoPreviewBox.style.display = 'block'; }

    purchasePriceInput.value = product.purchasePrice || '';
    oldPriceInput.value = product.oldPrice || '';
    newPriceInput.value = product.newPrice || '';

    // Ø§Ù„ÙˆØµÙ
    if (Array.isArray(product.description)) {
        product.description.forEach(blk => addDescBlock(blk.type, blk.val));
    } else if (product.description) {
        addDescBlock('text', product.description);
    }

    // Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
    if (Array.isArray(product.icons)) {
        product.icons.forEach(ic => addIconBlock(ic.icon, ic.text));
    }

    // ØµÙˆØ± Ø§Ù„Ù…Ø¹Ø±Ø¶ (ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø°Ø±ÙŠ)
    const imgs = Array.isArray(product.images) ? product.images : (product.image ? [product.image] : []);
    imgs.forEach(url => addImageToGrid(url));
  }

  function resetForm() {
    form.reset();
    descBlocksContainer.innerHTML = '';
    iconBlocksContainer.innerHTML = '';
    galleryGrid.innerHTML = ''; // ØªÙØ±ÙŠØº Ø§Ù„Ø´Ø¨ÙƒØ©
    logoPreviewBox.style.display = 'none';
  }

  // --- Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (ÙƒÙ…Ø§ Ù‡ÙŠ) ---
  const renderProducts = (productsData) => {
    if (!userAuthenticated) return;
    productsContainer.innerHTML = '';
    currentProductsData = productsData || {};
    
    const filteredProducts = {};
    Object.entries(currentProductsData).forEach(([id, product]) => {
      if (!product) return;
      if (searchKeyword) {
        let descText = Array.isArray(product.description) ? product.description.map(b => b.val).join(' ') : product.description || '';
        const concat = [(product.name||''), descText].join(' ').toLowerCase();
        if (!concat.includes(searchKeyword.toLowerCase())) return;
      }
      filteredProducts[id] = product;
    });

    if (Object.keys(filteredProducts).length > 0) {
      Object.entries(filteredProducts).forEach(([id, product]) => {
        const div = document.createElement('div');
        div.className = 'product-card';
        
        const images = Array.isArray(product.images) && product.images.length > 0 ? product.images : (product.image?[product.image]:['https://via.placeholder.com/150']);
        const imageGallery = images.slice(0, 3).map(src => `<img src="${src}" class="product-image" alt="img">`).join('');
        const productLink = `product-detail.html?id=${id}`;

        div.innerHTML = `
          ${product.customLogo ? `<img src="${product.customLogo}" style="height:30px; display:block; margin:0 auto 5px;">` : ''}
          <div class="product-gallery">${imageGallery}</div>
          <div class="product-info">
            <h3>${product.name||'Ù…Ù†ØªØ¬'}</h3>
            <p class="price">
              ${product.oldPrice ? `<span class="old-price">${product.oldPrice}</span>` : ''}
              <span class="new-price">${product.newPrice}</span>
            </p>
            <p class="preview-link"><a href="${productLink}" target="_blank">ğŸ”— Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙØ­Ø©</a></p>
          </div>
          <div class="product-actions">
            <button class="edit-btn" data-id="${id}">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="delete-btn" data-id="${id}">Ø­Ø°Ù</button>
          </div>
        `;
        productsContainer.appendChild(div);
      });

      document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', e => showForm(e.target.dataset.id)));
      document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', e => deleteProduct(e.target.dataset.id)));
    } else {
      productsContainer.innerHTML='<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</p>';
    }
  };

  // --- Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!userAuthenticated) return;

    const name = nameInput.value.trim();
    const customLogo = customLogoInput.value.trim();
    const purchasePrice = purchasePriceInput.value.trim();
    const oldPrice = oldPriceInput.value.trim();
    const newPrice = newPriceInput.value.trim();

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØµÙ
    const descBlocks = [];
    descBlocksContainer.querySelectorAll('.desc-block').forEach(blk => {
        const type = blk.dataset.type;
        const input = type==='text' ? blk.querySelector('textarea') : blk.querySelector('.desc-img-input');
        const val = input.value;
        if(val.trim()) descBlocks.push({ type, val });
    });
    if(descBlocks.length===0) descBlocks.push({type:'text', val:''});

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
    const iconsData = Array.from(iconBlocksContainer.querySelectorAll('.icon-block')).map(b=>({
      icon: b.querySelector('.icon-url').value,
      text: b.querySelector('.icon-text').value
    }));

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ© (Gallery Grid)
    // Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ data-url Ù„ÙƒÙ„ Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©
    const galleryItems = galleryGrid.querySelectorAll('.gallery-item');
    const images = Array.from(galleryItems).map(item => item.dataset.url).filter(Boolean);

    if(!name || !purchasePrice || !newPrice || images.length===0){
      alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø³Ø¹Ø±ØŒ ÙˆØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)");
      return;
    }

    const productData = {
      name,
      customLogo: customLogo || null,
      description: descBlocks,
      icons: iconsData,
      purchasePrice: parseFloat(purchasePrice),
      oldPrice: oldPrice || null,
      newPrice: parseFloat(newPrice),
      images, // Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      updatedAt: new Date().toISOString()
    };
    if (!editingProductId) productData.createdAt = new Date().toISOString();

    try {
      saveButton.disabled = true;
      saveButton.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

      if(editingProductId) {
        await update(ref(database, 'products/'+editingProductId), productData);
        alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
      } else {
        await push(productsRef, productData);
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
      }
      
      formHasChanges = false;
      saveButton.disabled = false;
      showList();

    } catch(error){
      alert("Ø®Ø·Ø£: "+error.message);
      saveButton.disabled = false;
      saveButton.textContent = editingProductId ? "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª" : "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬";
    }
  });

  const deleteProduct = async (id) => {
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;
    try { await remove(ref(database, 'products/' + id)); } 
    catch (error) { alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + error.message); }
  };

  onAuthStateChanged(auth, (user) => {
    if (user) { userAuthenticated = true; logoutBtn.style.display = 'block'; } 
    else { window.location.href = 'admin-login.html'; }
  });
  logoutBtn.addEventListener('click', async () => { await signOut(auth); window.location.href = 'admin-login.html'; });
  onValue(productsRef, snapshot => { if(userAuthenticated) renderProducts(snapshot.val()); });
  searchInput.addEventListener('input', (e) => {
    searchKeyword = e.target.value.trim().toLowerCase();
    renderProducts(currentProductsData);
  });
</script> 
<script>
  function toggleMenu() { document.querySelector('nav .links').classList.toggle('open'); }
</script>
</body>
</html>