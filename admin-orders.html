<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</title>

  <!-- Ø±Ø¨Ø· Ø§Ù„Ø®Ø· ÙˆØ§Ù„Ø³ØªØ§ÙŠÙ„ -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="admin-style.css">

  <style>
    /* === ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ§Ù„Ø­Ù‚ÙˆÙ„ === */
    .modal-inputs-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .modal-label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
    .modal-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: 'Cairo'; }
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
    .edit-input {
      width: 100%;
      padding: 8px;
      border: 2px solid #3498db;
      border-radius: 6px;
      font-family: 'Cairo', sans-serif;
      font-size: 0.95rem;
      background-color: #fafdff;
      color: #333;
      font-weight: bold;
    }

    /* === ğŸ”¥ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠØ© (Ø§Ù„Ù…Ø¹Ø¯Ù„ Ù„Ù„ØªÙ†Ø§Ø³Ù‚) ğŸ”¥ === */
    .modal-actions {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #f0f0f0;
    }

    /* Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    .modal-actions button {
        flex: 1;
        height: 45px;
        padding: 0 5px;
        border: none;
        border-radius: 8px;
        font-family: 'Cairo', sans-serif;
        font-weight: 700;
        font-size: 0.85rem;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        white-space: nowrap;
        overflow: hidden;
    }

    .modal-actions button:active { transform: scale(0.98); }

    /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
    #deleteOrderBtn, .btn-delete { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    #updateStatusBtn, .btn-status { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .btn-edit { background: linear-gradient(135deg, #3498db, #2980b9); }
    .btn-save-changes { background: linear-gradient(135deg, #16a085, #1abc9c); }

    /* Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ù„Ø¨ */
    .status-badge { padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; }
    .status-new { background: #e3f2fd; color: #1565c0; }
    .status-processing { background: #fff3e0; color: #ef6c00; }
    .status-shipped { background: #e8f5e9; color: #2e7d32; }
  </style>

</head>
<body>

<nav>
  <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>

  <div class="logo">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
  <div class="links">
    <a href="admin-products.html" class="nav-link">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
    <a href="admin-orders.html" class="nav-link active">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</a>
    <a href="completed-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</a>
    <a href="admin-analytics.html" class="nav-link">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</a>
    <a href="admin-settings.html" class="nav-link">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
    <a href="admin-reviews.html" class="nav-link">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</a>
    <a href="admin-shipping.html" class="nav-link">Ø§Ù„Ø´Ø­Ù†</a>
    <a href="#" id="logoutBtn" class="nav-link" style="display: none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
  </div>
</nav>

<!-- Ù…ÙƒØ§Ù† Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
<div class="visitors-wrapper">
  <div id="liveVisitors" class="live-visitors-badge inactive">
    <span class="live-dot"></span>
    <span style="margin-right:5px">Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ø¢Ù†: </span>
    <strong id="visitorsCount" style="margin:0 4px">0</strong>
  </div>
</div>

<div class="container">
<h2>ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h2>

<div class="search-wrapper">
  <input id="searchInput" class="search-input" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙ...">
</div>

<!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© (Tabs) -->
<div class="orders-stats">
  <div class="stat-card active" data-tab="new">
    <h3>Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h3>
    <span id="newOrdersCount">0</span>
  </div>
  <div class="stat-card" data-tab="processing">
    <h3>Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</h3>
    <span id="processingOrdersCount">0</span>
  </div>
  <div class="stat-card" data-tab="shipped">
    <h3>Ù…Ø´Ø­ÙˆÙ†Ø©</h3>
    <span id="shippedOrdersCount">0</span>
  </div>
</div>

<!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
<div id="newOrdersTab" class="orders-tabs active">
  <div id="newOrdersContainer" class="orders-grid">
    <p class="loading-message">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
  </div>
</div>

<div id="processingOrdersTab" class="orders-tabs">
  <div id="processingOrdersContainer" class="orders-grid">
    <p class="loading-message">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
  </div>
</div>

<div id="shippedOrdersTab" class="orders-tabs">
  <div id="shippedOrdersContainer" class="orders-grid">
    <p class="loading-message">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
  </div>
</div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Modal) -->
<div id="orderDetailsModal" class="modal hidden">
  <div class="modal-content">
    <button class="close-modal-btn" id="closeDetailModal">&times;</button>
    <h3 style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
    
    <div id="modalDetailsBody"></div>
    
    <div class="modal-actions" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
      <button id="deleteOrderBtn" class="btn-delete">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      <!-- Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ù‡Ù†Ø§ -->
      <span id="editBtnContainer" style="flex: 1; display: flex;"></span>
      <button id="updateStatusBtn" class="btn-status">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</button>
    </div>
  </div>
</div>

<!-- ============================================== -->
<!-- 1. ÙƒÙˆØ¯ Javascript Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Module) -->
<!-- ============================================== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
  authDomain: "myestore-34f65.firebaseapp.com",
  databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
  projectId: "myestore-34f65",
  storageBucket: "myestore-34f65.appspot.com",
  messagingSenderId: "14078917211",
  appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
  measurementId: "G-9181DX0XNJ"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const auth = getAuth(app);
const ordersRef = ref(database, 'orders');
const visitorsRef = ref(database, 'site_presence');

const logoutBtn = document.getElementById('logoutBtn');
const newOrdersCount = document.getElementById('newOrdersCount');
const processingOrdersCount = document.getElementById('processingOrdersCount');
const shippedOrdersCount = document.getElementById('shippedOrdersCount');

const newOrdersContainer = document.getElementById('newOrdersContainer');
const processingOrdersContainer = document.getElementById('processingOrdersContainer');
const shippedOrdersContainer = document.getElementById('shippedOrdersContainer');

const statCards = document.querySelectorAll('.stat-card');
const searchInput = document.getElementById('searchInput');

const detailModal = document.getElementById('orderDetailsModal');
const closeDetailModal = document.getElementById('closeDetailModal');
const modalDetailsBody = document.getElementById('modalDetailsBody');
const updateStatusBtn = document.getElementById('updateStatusBtn');
const deleteOrderBtn = document.getElementById('deleteOrderBtn');
const editBtnContainer = document.getElementById('editBtnContainer'); 

const liveVisitorsBadge = document.getElementById('liveVisitors');
const visitorsCountSpan = document.getElementById('visitorsCount');

let userAuthenticated = false;
let currentOrders = {};
let searchKeyword = "";
let currentOpenOrderId = null;

onAuthStateChanged(auth, (user) => {
  if (user) {
    userAuthenticated = true;
    logoutBtn.style.display = 'block';
  } else {
    userAuthenticated = false;
    logoutBtn.style.display = 'none';
    window.location.href = 'admin-login.html';
  }
});

logoutBtn.addEventListener('click', async () => {
  await signOut(auth); window.location.href = 'admin-login.html';
});

// --- ÙƒÙˆØ¯ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø²ÙˆØ§Ø± ---
onValue(visitorsRef, (snapshot) => {
    if (!snapshot.exists()) { updateVisitorsUI(0); return; }
    const data = snapshot.val();
    const count = Object.keys(data).length;
    updateVisitorsUI(count);
});

function updateVisitorsUI(count) {
    visitorsCountSpan.textContent = count;
    if (count > 0) {
        liveVisitorsBadge.classList.remove('inactive');
        liveVisitorsBadge.classList.add('active');
    } else {
        liveVisitorsBadge.classList.remove('active');
        liveVisitorsBadge.classList.add('inactive');
    }
}

statCards.forEach(card => {
  card.addEventListener('click', () => {
    statCards.forEach(c => c.classList.remove('active'));
    card.classList.add('active');
    document.querySelectorAll('.orders-tabs').forEach(tab => tab.classList.remove('active'));
    const tabName = card.dataset.tab;
    document.getElementById(`${tabName}OrdersTab`).classList.add('active');
  });
});

closeDetailModal.addEventListener('click', () => detailModal.classList.add('hidden'));
window.addEventListener('click', (e) => { if(e.target === detailModal) detailModal.classList.add('hidden'); });

function formatDate(timestamp) {
  if (!timestamp || timestamp === 0) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  const date = new Date(timestamp);
  return date.toLocaleString('en-GB', { 
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', hour12: false 
  });
}

function getNextAction(status) {
  const st = (status || '').toLowerCase();
  if (!st || st.includes('new') || st.includes('Ø¬Ø¯ÙŠØ¯') || st.includes('pending')) {
    return { text: 'ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨ âš™ï¸', nextStatus: 'Processing' };
  } else if (st.includes('processing') || st.includes('ØªØ¬Ù‡ÙŠØ²') || st.includes('Ù…Ø¹Ø§Ù„Ø¬Ø©')) {
    return { text: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù† ğŸšš', nextStatus: 'Shipped' };
  } else {
    return { text: 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ âœ…', nextStatus: 'Delivered' };
  }
}

// Ø¬Ø¹Ù„ Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ (Ù„ÙƒÙŠ ØªØ¹Ù…Ù„ ÙÙŠ renderOrderRow)
window.openOrderDetails = function(order, id) {
  currentOpenOrderId = id;
  detailModal.classList.remove('hidden');

  const action = getNextAction(order.status);
  updateStatusBtn.textContent = action.text;
  updateStatusBtn.style.display = 'inline-block'; 
  
  updateStatusBtn.onclick = async () => {
     await updateOrderStatus(id, action.nextStatus);
  };

  const st = (order.status || '').toLowerCase();
  const isNew = (!st || st.includes('new') || st.includes('Ø¬Ø¯ÙŠØ¯'));
  
  editBtnContainer.innerHTML = ''; 

  if(isNew) {
      const editBtn = document.createElement('button');
      editBtn.textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
      editBtn.className = 'btn-edit';
      // Ù†Ø±Ø¨Ø· Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù‡Ù†Ø§ Ù„Ø£Ù†Ù‡Ø§ Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ù†Ø·Ø§Ù‚ (Module Scope)
      editBtn.onclick = () => enableEditMode(order);
      editBtnContainer.appendChild(editBtn);
  }

  let productsHtml = '';
  if (order.items) {
    const items = Array.isArray(order.items) ? order.items : Object.values(order.items);
    productsHtml = items.map(it => `
       <div style="background:#f9f9f9; padding:8px; margin-bottom:5px; border-radius:5px; font-size:0.9rem;">
          <div>â€¢ <strong>${it.name || it.productName}</strong></div>
          <div style="color:#666; font-size:0.85rem;">
             Ø§Ù„ÙƒÙ…ÙŠØ©: ${it.quantity || 1} | Ø§Ù„Ø³Ø¹Ø±: ${parseFloat(it.price || it.productPrice || 0)} Ø¯Ø¬
          </div>
       </div>
    `).join('');
  } else {
     productsHtml = `
       <div style="background:#f9f9f9; padding:8px; margin-bottom:5px; border-radius:5px; font-size:0.9rem;">
          <div>â€¢ <strong>${order.productName || 'Ù…Ù†ØªØ¬'}</strong></div>
          <div style="color:#666; font-size:0.85rem;">
             Ø§Ù„ÙƒÙ…ÙŠØ©: ${order.quantity || 1} | Ø§Ù„Ø³Ø¹Ø±: ${parseFloat(order.productPrice || 0)} Ø¯Ø¬
          </div>
       </div>
     `;
  }

  modalDetailsBody.innerHTML = `
    <div class="details-section">
      <h4>ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h4>
      <div class="details-row"><span class="details-label">Ø§Ù„Ø§Ø³Ù…:</span> <span id="disp-name">${order.customerName || order.name || '-'}</span></div>
      <div class="details-row"><span class="details-label">Ø§Ù„Ù‡Ø§ØªÙ:</span> <a id="disp-phone-link" href="tel:${order.customerPhone || order.phone}" style="color:var(--primary-color);text-decoration:none;"><span id="disp-phone">${order.customerPhone || order.phone || '-'}</span></a></div>
      
      <div class="details-row"><span class="details-label">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©:</span> <span id="disp-wilaya">${order.customerWilaya || order.state || '-'}</span></div>
      <div class="details-row"><span class="details-label">Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©:</span> <span id="disp-commune" style="color:${!order.customerCommune?'red':'inherit'}">${order.customerCommune || order.city || '(ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©)'}</span></div>
      
      <div class="details-row"><span class="details-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</span> <span id="disp-address">${order.customerAddress || order.address || '-'}</span></div>
      <div class="details-row"><span class="details-label">Ø§Ù„ØªÙˆØµÙŠÙ„:</span> ${order.deliveryOption || '-'}</div>
      <div class="details-row" style="background:#fff3cd; padding:5px; border-radius:4px;"><span class="details-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span> ${order.note || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div>
    </div>

    <div class="details-section">
      <h4>ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h4>
      ${productsHtml}
      <div style="margin-top:15px; padding-top:10px; border-top:1px dashed #ddd;">
         <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#666;">
            <span>Ø³Ø¹Ø± Ø§Ù„Ø´Ø­Ù†:</span>
            <span>${parseFloat(order.shippingPrice || 0)} Ø¯Ø¬</span>
         </div>
         <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.1rem; color:var(--success-color);">
            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</span>
            <span>${parseFloat(order.totalPrice || 0).toLocaleString()} Ø¯Ø¬</span>
         </div>
      </div>
    </div>

    <div class="details-section" style="border-bottom:none;">
      <h4>â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h4>
      <div class="details-row"><span class="details-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</span> ${id}</div>
      <div class="details-row"><span class="details-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> ${formatDate(order.timestamp)}</div>
      <div class="details-row"><span class="details-label">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span> ${order.status || 'Ø¬Ø¯ÙŠØ¯'}</div>
    </div>
  `;
}

function enableEditMode(order) {
    const nameVal = order.customerName || order.name || '';
    const phoneVal = order.customerPhone || order.phone || '';
    const wilayaVal = order.customerWilaya || order.state || '';
    const communeVal = order.customerCommune || order.city || '';
    const addressVal = order.customerAddress || order.address || '';

    document.getElementById('disp-name').innerHTML = `<input type="text" id="edit-name" class="edit-input" value="${nameVal}">`;
    document.getElementById('disp-phone-link').outerHTML = `<input type="text" id="edit-phone" class="edit-input" value="${phoneVal}">`;
    document.getElementById('disp-wilaya').innerHTML = `<input type="text" id="edit-wilaya" class="edit-input" value="${wilayaVal}">`;
    document.getElementById('disp-commune').innerHTML = `<input type="text" id="edit-commune" class="edit-input" value="${communeVal}" placeholder="Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©">`;
    document.getElementById('disp-address').innerHTML = `<input type="text" id="edit-address" class="edit-input" value="${addressVal}">`;

    editBtnContainer.innerHTML = '';
    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸';
    saveBtn.className = 'btn-save-changes';
    saveBtn.onclick = () => saveOrderDetails(currentOpenOrderId);
    editBtnContainer.appendChild(saveBtn);

    updateStatusBtn.style.display = 'none';
}

async function saveOrderDetails(id) {
    if(!id) return;
    
    const newName = document.getElementById('edit-name').value;
    const newPhone = document.getElementById('edit-phone').value;
    const newWilaya = document.getElementById('edit-wilaya').value;
    const newCommune = document.getElementById('edit-commune').value;
    const newAddress = document.getElementById('edit-address').value;

    if(!newName || !newPhone) {
        alert("Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‡Ø§ØªÙ Ø¶Ø±ÙˆØ±ÙŠØ§Ù†");
        return;
    }

    try {
        await update(ref(database, 'orders/' + id), {
            customerName: newName,
            customerPhone: newPhone,
            customerWilaya: newWilaya,
            customerCommune: newCommune,
            customerAddress: newAddress
        });
        
        alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
        detailModal.classList.add('hidden');
        
    } catch(error) {
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: " + error.message);
    }
}

async function updateOrderStatus(id, newStatus) {
    if (!id) return;
    updateStatusBtn.disabled = true;
    updateStatusBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...';
    try {
        await update(ref(database, 'orders/' + id), {
            status: newStatus,
            updatedAt: Date.now()
        });
        detailModal.classList.add('hidden');
        if (newStatus === 'Delivered' || newStatus === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„') {
            alert('ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©)');
        }
    } catch (error) {
        alert("Ø®Ø·Ø£: " + error.message);
    } finally {
        updateStatusBtn.disabled = false;
    }
}

function renderOrderRow(order, id, container) {
  const row = document.createElement('div');
  let statusClass = 'status-new';
  const st = (order.status || '').toLowerCase();
  if (st.includes('processing') || st.includes('ØªØ¬Ù‡ÙŠØ²')) statusClass = 'status-processing';
  else if (st.includes('shipped') || st.includes('Ø´Ø­Ù†')) statusClass = 'status-shipped';
  
  row.className = `order-row ${statusClass}`;
  const productName = order.productName || (order.items ? (Array.isArray(order.items) ? order.items[0].name : Object.values(order.items)[0].name) : 'Ø·Ù„Ø¨ Ù…ØªØ¹Ø¯Ø¯');

  row.innerHTML = `
    <div class="row-info">
      <span class="row-id">#${id.slice(-5)}</span>
      <span class="row-name">${order.customerName || order.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</span>
      <span class="row-product">${productName}</span>
      <span class="row-date">${formatDate(order.timestamp).split(',')[0]}</span>
    </div>
    <div class="row-arrow">â®</div>
  `;
  
  // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ø§Ù„Ø°ÙŠ Ø¹Ø±ÙÙ†Ø§Ù‡ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰
  row.addEventListener('click', () => window.openOrderDetails(order, id));
  container.appendChild(row);
}

deleteOrderBtn.addEventListener('click', async () => {
    if (!currentOpenOrderId) return;
    if (confirm("âš ï¸ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
        try {
            await remove(ref(database, 'orders/' + currentOpenOrderId));
            detailModal.classList.add('hidden');
            alert("ØªÙ… Ø§Ù„Ø­Ø°Ù");
        } catch (error) {
            alert("Ø®Ø·Ø£: " + error.message);
        }
    }
});

function renderAllOrders(ordersData) {
  if (!userAuthenticated) return;
  currentOrders = ordersData || {};
  newOrdersContainer.innerHTML = '';
  processingOrdersContainer.innerHTML = '';
  shippedOrdersContainer.innerHTML = '';
  let newCount = 0, procCount = 0, shipCount = 0;

  Object.entries(currentOrders).sort((a,b) => b[1].timestamp - a[1].timestamp).forEach(([id, order]) => {
    if (!order) return;
    const status = (order.status || '').toLowerCase().trim();
    if (status === 'delivered' || status === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„') return;
    if (searchKeyword) {
      const str = JSON.stringify(order).toLowerCase();
      if (!str.includes(searchKeyword)) return;
    }
    if (status === 'shipped' || status === 'ØªÙ… Ø§Ù„Ø´Ø­Ù†' || status.includes('Ø´Ø­Ù†')) {
      renderOrderRow(order, id, shippedOrdersContainer);
      shipCount++;
    } else if (status === 'processing' || status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²' || status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' || status.includes('ØªØ¬Ù‡ÙŠØ²')) {
      renderOrderRow(order, id, processingOrdersContainer);
      procCount++;
    } else {
      renderOrderRow(order, id, newOrdersContainer);
      newCount++;
    }
  });

  newOrdersCount.textContent = newCount;
  processingOrdersCount.textContent = procCount;
  shippedOrdersCount.textContent = shipCount;

  if (newCount === 0) newOrdersContainer.innerHTML = '<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨ÙŠØ§Øª Ø¬Ø¯ÙŠØ¯Ø©</p>';
  if (procCount === 0) processingOrdersContainer.innerHTML = '<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨ÙŠØ§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</p>';
  if (shipCount === 0) shippedOrdersContainer.innerHTML = '<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨ÙŠØ§Øª Ù…Ø´Ø­ÙˆÙ†Ø©</p>';
}

onValue(ordersRef, snapshot => {
  renderAllOrders(snapshot.val() || {});
});

searchInput.addEventListener('input', (e) => {
  searchKeyword = e.target.value.trim().toLowerCase();
  renderAllOrders(currentOrders);
});
</script>

<!-- ============================================== -->
<!-- 2. ÙƒÙˆØ¯ Javascript Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ (Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©) -->
<!-- Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„ Ù„ÙŠÙƒÙˆÙ† Ù…ØªØ§Ø­Ø§Ù‹ Ù„Ù€ onclick ÙÙŠ Ø§Ù„Ù€ HTML -->
<!-- ============================================== -->
<script>
    function toggleMenu() {
      const links = document.querySelector('nav .links');
      if (links) {
        links.classList.toggle('open');
      }
    }
</script>

</body>
</html>