<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</title>

<!-- Ø±Ø¨Ø· Ø§Ù„Ø®Ø· ÙˆØ§Ù„Ø³ØªØ§ÙŠÙ„ -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="admin-style.css">

</head>
<body>

<nav>
  <div class="logo">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
  <div class="links">
    <a href="admin-products.html" class="nav-link">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
    <a href="admin-orders.html" class="nav-link active">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</a>
    <a href="completed-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</a>
    <a href="admin-analytics.html" class="nav-link">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</a>
    <a href="admin-settings.html" class="nav-link">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
    <a href="admin-reviews.html" class="nav-link">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</a>
    <a href="admin-shipping.html" class="nav-link">Ø§Ù„Ø´Ø­Ù†</a>
    <a href="#" id="logoutBtn" class="nav-link" style="display: none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
  </div>
</nav>

<!-- Ù…ÙƒØ§Ù† Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø£Ø³ÙÙ„ Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø±Ø©) -->
<div class="visitors-wrapper">
  <div id="liveVisitors" class="live-visitors-badge inactive">
    <span class="live-dot"></span>
    <span style="margin-right:5px">Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ø¢Ù†: </span>
    <strong id="visitorsCount" style="margin:0 4px">0</strong>
  </div>
</div>

<div class="container">
<h2>ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h2>

<div class="search-wrapper">
  <input id="searchInput" class="search-input" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙ...">
</div>

<!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© (Tabs) -->
<div class="orders-stats">
  <div class="stat-card active" data-tab="new">
    <h3>Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h3>
    <span id="newOrdersCount">0</span>
  </div>
  <div class="stat-card" data-tab="processing">
    <h3>Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</h3>
    <span id="processingOrdersCount">0</span>
  </div>
  <div class="stat-card" data-tab="shipped">
    <h3>Ù…Ø´Ø­ÙˆÙ†Ø©</h3>
    <span id="shippedOrdersCount">0</span>
  </div>
</div>

<!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
<div id="newOrdersTab" class="orders-tabs active">
  <div id="newOrdersContainer" class="orders-grid">
    <p class="loading-message">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
  </div>
</div>

<div id="processingOrdersTab" class="orders-tabs">
  <div id="processingOrdersContainer" class="orders-grid">
    <p class="loading-message">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
  </div>
</div>

<div id="shippedOrdersTab" class="orders-tabs">
  <div id="shippedOrdersContainer" class="orders-grid">
    <p class="loading-message">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
  </div>
</div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Modal) -->
<div id="orderDetailsModal" class="modal hidden">
  <div class="modal-content">
    <button class="close-modal-btn" id="closeDetailModal">&times;</button>
    <h3 style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
    <div id="modalDetailsBody"></div>
    <div class="modal-actions">
      <button id="deleteOrderBtn" class="btn-delete">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      <button id="updateStatusBtn" class="btn-status">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
  authDomain: "myestore-34f65.firebaseapp.com",
  databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
  projectId: "myestore-34f65",
  storageBucket: "myestore-34f65.appspot.com",
  messagingSenderId: "14078917211",
  appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
  measurementId: "G-9181DX0XNJ"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const auth = getAuth(app);
const ordersRef = ref(database, 'orders');
const visitorsRef = ref(database, 'site_presence'); // Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø²ÙˆØ§Ø±

const logoutBtn = document.getElementById('logoutBtn');
const newOrdersCount = document.getElementById('newOrdersCount');
const processingOrdersCount = document.getElementById('processingOrdersCount');
const shippedOrdersCount = document.getElementById('shippedOrdersCount');

const newOrdersContainer = document.getElementById('newOrdersContainer');
const processingOrdersContainer = document.getElementById('processingOrdersContainer');
const shippedOrdersContainer = document.getElementById('shippedOrdersContainer');

const statCards = document.querySelectorAll('.stat-card');
const searchInput = document.getElementById('searchInput');

const detailModal = document.getElementById('orderDetailsModal');
const closeDetailModal = document.getElementById('closeDetailModal');
const modalDetailsBody = document.getElementById('modalDetailsBody');
const updateStatusBtn = document.getElementById('updateStatusBtn');
const deleteOrderBtn = document.getElementById('deleteOrderBtn');

// Ø¹Ù†Ø§ØµØ± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø²ÙˆØ§Ø±
const liveVisitorsBadge = document.getElementById('liveVisitors');
const visitorsCountSpan = document.getElementById('visitorsCount');

let userAuthenticated = false;
let currentOrders = {};
let searchKeyword = "";
let currentOpenOrderId = null;

onAuthStateChanged(auth, (user) => {
  if (user) {
    userAuthenticated = true;
    logoutBtn.style.display = 'block';
  } else {
    userAuthenticated = false;
    logoutBtn.style.display = 'none';
    window.location.href = 'admin-login.html';
  }
});

logoutBtn.addEventListener('click', async () => {
  await signOut(auth); window.location.href = 'admin-login.html';
});

// --- ÙƒÙˆØ¯ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø²ÙˆØ§Ø± ---
onValue(visitorsRef, (snapshot) => {
    if (!snapshot.exists()) {
        updateVisitorsUI(0);
        return;
    }
    const data = snapshot.val();
    const count = Object.keys(data).length;
    updateVisitorsUI(count);
});

function updateVisitorsUI(count) {
    visitorsCountSpan.textContent = count;
    if (count > 0) {
        liveVisitorsBadge.classList.remove('inactive');
        liveVisitorsBadge.classList.add('active');
    } else {
        liveVisitorsBadge.classList.remove('active');
        liveVisitorsBadge.classList.add('inactive');
    }
}
// -------------------------

statCards.forEach(card => {
  card.addEventListener('click', () => {
    statCards.forEach(c => c.classList.remove('active'));
    card.classList.add('active');
    document.querySelectorAll('.orders-tabs').forEach(tab => tab.classList.remove('active'));
    const tabName = card.dataset.tab;
    document.getElementById(`${tabName}OrdersTab`).classList.add('active');
  });
});

closeDetailModal.addEventListener('click', () => detailModal.classList.add('hidden'));
window.addEventListener('click', (e) => { if(e.target === detailModal) detailModal.classList.add('hidden'); });

function formatDate(timestamp) {
  if (!timestamp || timestamp === 0) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  const date = new Date(timestamp);
  return date.toLocaleString('en-GB', { 
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', hour12: false 
  });
}

function getNextAction(status) {
  const st = (status || '').toLowerCase();
  if (!st || st.includes('new') || st.includes('Ø¬Ø¯ÙŠØ¯') || st.includes('pending')) {
    return { text: 'ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨ âš™ï¸', nextStatus: 'Processing' };
  } else if (st.includes('processing') || st.includes('ØªØ¬Ù‡ÙŠØ²') || st.includes('Ù…Ø¹Ø§Ù„Ø¬Ø©')) {
    return { text: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù† ğŸšš', nextStatus: 'Shipped' };
  } else {
    return { text: 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ âœ…', nextStatus: 'Delivered' };
  }
}

function openOrderDetails(order, id) {
  currentOpenOrderId = id;
  detailModal.classList.remove('hidden');

  const action = getNextAction(order.status);
  updateStatusBtn.textContent = action.text;
  updateStatusBtn.onclick = async () => {
     await updateOrderStatus(id, action.nextStatus);
  };

  let productsHtml = '';
  if (order.items) {
    const items = Array.isArray(order.items) ? order.items : Object.values(order.items);
    productsHtml = items.map(it => `
       <div style="background:#f9f9f9; padding:8px; margin-bottom:5px; border-radius:5px; font-size:0.9rem;">
          <div>â€¢ <strong>${it.name || it.productName}</strong></div>
          <div style="color:#666; font-size:0.85rem;">
             Ø§Ù„ÙƒÙ…ÙŠØ©: ${it.quantity || 1} | Ø§Ù„Ø³Ø¹Ø±: ${parseFloat(it.price || it.productPrice || 0)} Ø¯Ø¬
          </div>
       </div>
    `).join('');
  } else {
     productsHtml = `
       <div style="background:#f9f9f9; padding:8px; margin-bottom:5px; border-radius:5px; font-size:0.9rem;">
          <div>â€¢ <strong>${order.productName || 'Ù…Ù†ØªØ¬'}</strong></div>
          <div style="color:#666; font-size:0.85rem;">
             Ø§Ù„ÙƒÙ…ÙŠØ©: ${order.quantity || 1} | Ø§Ù„Ø³Ø¹Ø±: ${parseFloat(order.productPrice || 0)} Ø¯Ø¬
          </div>
       </div>
     `;
  }

  modalDetailsBody.innerHTML = `
    <div class="details-section">
      <h4>ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h4>
      <div class="details-row"><span class="details-label">Ø§Ù„Ø§Ø³Ù…:</span> ${order.customerName || order.name || '-'}</div>
      <div class="details-row"><span class="details-label">Ø§Ù„Ù‡Ø§ØªÙ:</span> <a href="tel:${order.customerPhone || order.phone}" style="color:var(--primary-color);text-decoration:none;">${order.customerPhone || order.phone || '-'}</a></div>
      <div class="details-row"><span class="details-label">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©:</span> ${order.customerWilaya || order.state || '-'}</div>
      <div class="details-row"><span class="details-label">Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©:</span> ${order.customerCommune || order.city || '-'}</div>
      <div class="details-row"><span class="details-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</span> ${order.customerAddress || order.address || '-'}</div>
      <div class="details-row"><span class="details-label">Ø§Ù„ØªÙˆØµÙŠÙ„:</span> ${order.deliveryOption || '-'}</div>
      <div class="details-row" style="background:#fff3cd; padding:5px; border-radius:4px;"><span class="details-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span> ${order.note || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div>
    </div>

    <div class="details-section">
      <h4>ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h4>
      ${productsHtml}
      <div style="margin-top:15px; padding-top:10px; border-top:1px dashed #ddd;">
         <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#666;">
            <span>Ø³Ø¹Ø± Ø§Ù„Ø´Ø­Ù†:</span>
            <span>${parseFloat(order.shippingPrice || 0)} Ø¯Ø¬</span>
         </div>
         <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.1rem; color:var(--success-color);">
            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</span>
            <span>${parseFloat(order.totalPrice || 0).toLocaleString()} Ø¯Ø¬</span>
         </div>
      </div>
    </div>

    <div class="details-section" style="border-bottom:none;">
      <h4>â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h4>
      <div class="details-row"><span class="details-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</span> ${id}</div>
      <div class="details-row"><span class="details-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> ${formatDate(order.timestamp)}</div>
      <div class="details-row"><span class="details-label">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span> ${order.status || 'Ø¬Ø¯ÙŠØ¯'}</div>
    </div>
  `;
}

async function updateOrderStatus(id, newStatus) {
    if (!id) return;
    updateStatusBtn.disabled = true;
    updateStatusBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...';
    try {
        await update(ref(database, 'orders/' + id), {
            status: newStatus,
            updatedAt: Date.now()
        });
        detailModal.classList.add('hidden');
        if (newStatus === 'Delivered' || newStatus === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„') {
            alert('ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©)');
        }
    } catch (error) {
        alert("Ø®Ø·Ø£: " + error.message);
    } finally {
        updateStatusBtn.disabled = false;
    }
}

function renderOrderRow(order, id, container) {
  const row = document.createElement('div');
  let statusClass = 'status-new';
  const st = (order.status || '').toLowerCase();
  if (st.includes('processing') || st.includes('ØªØ¬Ù‡ÙŠØ²')) statusClass = 'status-processing';
  else if (st.includes('shipped') || st.includes('Ø´Ø­Ù†')) statusClass = 'status-shipped';
  
  row.className = `order-row ${statusClass}`;
  const productName = order.productName || (order.items ? (Array.isArray(order.items) ? order.items[0].name : Object.values(order.items)[0].name) : 'Ø·Ù„Ø¨ Ù…ØªØ¹Ø¯Ø¯');

  row.innerHTML = `
    <div class="row-info">
      <span class="row-id">#${id.slice(-5)}</span>
      <span class="row-name">${order.customerName || order.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</span>
      <span class="row-product">${productName}</span>
      <span class="row-date">${formatDate(order.timestamp).split(',')[0]}</span>
    </div>
    <div class="row-arrow">â®</div>
  `;
  row.addEventListener('click', () => openOrderDetails(order, id));
  container.appendChild(row);
}

deleteOrderBtn.addEventListener('click', async () => {
    if (!currentOpenOrderId) return;
    if (confirm("âš ï¸ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
        try {
            await remove(ref(database, 'orders/' + currentOpenOrderId));
            detailModal.classList.add('hidden');
            alert("ØªÙ… Ø§Ù„Ø­Ø°Ù");
        } catch (error) {
            alert("Ø®Ø·Ø£: " + error.message);
        }
    }
});

function renderAllOrders(ordersData) {
  if (!userAuthenticated) return;
  currentOrders = ordersData || {};
  newOrdersContainer.innerHTML = '';
  processingOrdersContainer.innerHTML = '';
  shippedOrdersContainer.innerHTML = '';
  let newCount = 0, procCount = 0, shipCount = 0;

  Object.entries(currentOrders).sort((a,b) => b[1].timestamp - a[1].timestamp).forEach(([id, order]) => {
    if (!order) return;
    const status = (order.status || '').toLowerCase().trim();
    if (status === 'delivered' || status === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„') return;
    if (searchKeyword) {
      const str = JSON.stringify(order).toLowerCase();
      if (!str.includes(searchKeyword)) return;
    }
    if (status === 'shipped' || status === 'ØªÙ… Ø§Ù„Ø´Ø­Ù†' || status.includes('Ø´Ø­Ù†')) {
      renderOrderRow(order, id, shippedOrdersContainer);
      shipCount++;
    } else if (status === 'processing' || status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²' || status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' || status.includes('ØªØ¬Ù‡ÙŠØ²')) {
      renderOrderRow(order, id, processingOrdersContainer);
      procCount++;
    } else {
      renderOrderRow(order, id, newOrdersContainer);
      newCount++;
    }
  });

  newOrdersCount.textContent = newCount;
  processingOrdersCount.textContent = procCount;
  shippedOrdersCount.textContent = shipCount;

  if (newCount === 0) newOrdersContainer.innerHTML = '<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨ÙŠØ§Øª Ø¬Ø¯ÙŠØ¯Ø©</p>';
  if (procCount === 0) processingOrdersContainer.innerHTML = '<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨ÙŠØ§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</p>';
  if (shipCount === 0) shippedOrdersContainer.innerHTML = '<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨ÙŠØ§Øª Ù…Ø´Ø­ÙˆÙ†Ø©</p>';
}

onValue(ordersRef, snapshot => {
  renderAllOrders(snapshot.val() || {});
});

searchInput.addEventListener('input', (e) => {
  searchKeyword = e.target.value.trim().toLowerCase();
  renderAllOrders(currentOrders);
});
</script>
</body>
</html>