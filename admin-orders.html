<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>الطلبيات النشطة</title>
<link rel="stylesheet" href="admin-style.css">
<style>
.orders-grid { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
.order-card { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); position: relative; }
.order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.status-badge { padding: 5px 10px; border-radius: 5px; color: #fff; font-weight: bold; }
.status-new { background: #17a2b8; }
.status-processing { background: #ffc107; color: #000; }
.status-shipped { background: #fd7e14; }
.order-customer, .order-products, .order-meta { margin-bottom: 10px; }
.product-item { margin-bottom: 5px; }
.product-details span { display: inline-block; margin-right: 10px; }
.order-actions { margin-top: 15px; }
.action-btn { 
  background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; margin-left: 10px;
}
.action-btn:hover { background: #0056b3; }
.action-btn:disabled { background: #6c757d; cursor: not-allowed; }
.loading-message, .error-message { text-align: center; color: #888; margin-top: 20px; }

.orders-stats { display: flex; gap: 20px; margin-bottom: 20px; }
.stat-card { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex: 1; text-align: center; cursor: pointer; transition: all 0.3s ease; position: relative; }
.stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
.stat-card.active { border: 2px solid #007bff; background: #f8f9fa; }
.stat-card h3 { margin: 0 0 10px 0; color: #555; font-size: 14px; }
.stat-card span { font-size: 24px; font-weight: bold; color: #007bff; }

.orders-tabs { display: none; }
.orders-tabs.active { display: block; }
.tab-content { margin-top: 20px; }

.new-order-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #ff4757;
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.notification-badge {
  position: relative;
  display: inline-block;
}

.notification-icon {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #ff4757;
  color: white;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: bold;
  animation: pulse 1.5s infinite;
}

/* --- لا تغييرات خارج ما طلبت --- */
/* إضافة بسيطة لعنصر البحث (لا يغيّر أي ستايل آخر) */
.search-wrapper { margin-top: 12px; margin-bottom: 10px; text-align: center; }
.search-input { padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; width: 90%; max-width: 420px; direction: ltr; }
</style>
</head>
<body>
<nav>
<div class="logo">لوحة التحكم</div>
<div class="links">
  <a href="admin-products.html">المنتجات</a>
  <a href="admin-orders.html" class="notification-badge">
    الطلبيات النشطة
    <span id="activeOrdersBadge" class="notification-icon" style="display: none;"></span>
  </a>
  <a href="completed-orders.html">الطلبيات المكتملة</a>
  <a href="admin-analytics.html">التحليلات</a>
  <a href="admin-settings.html">الإعدادات</a>
  <a href="admin-reviews.html" class="active">التعليقات والتقييمات</a>
  <a href="#" id="logoutBtn" style="display: none;">تسجيل الخروج</a>
</div>
</nav>

<div class="container">
<h2>الطلبيات النشطة</h2>

<!-- ***** خانة البحث المضافة فقط ***** -->
<div class="search-wrapper">
  <input id="searchInput" class="search-input" type="text" placeholder="ابحث بالاسم أو الهاتف أو رقم الطلب أو الولاية أو البلدية أو المنتج...">
</div>
<!-- ***** انتهى البحث ***** -->

<div class="orders-stats">
  <div class="stat-card active" data-tab="new">
    <h3>الطلبيات الجديدة</h3>
    <span id="newOrdersCount">0</span>
  </div>
  <div class="stat-card" data-tab="processing">
    <h3>قيد التجهيز</h3>
    <span id="processingOrdersCount">0</span>
  </div>
  <div class="stat-card" data-tab="shipped">
    <h3>طلبات مشحونة</h3>
    <span id="shippedOrdersCount">0</span>
  </div>
</div>

<div id="newOrdersTab" class="orders-tabs active">
  <h3>الطلبيات الجديدة</h3>
  <div id="newOrdersContainer" class="orders-grid">
    <p class="loading-message">جاري تحميل الطلبيات الجديدة...</p>
  </div>
</div>

<div id="processingOrdersTab" class="orders-tabs">
  <h3>الطلبيات قيد التجهيز</h3>
  <div id="processingOrdersContainer" class="orders-grid">
    <p class="loading-message">جاري تحميل الطلبيات قيد التجهيز...</p>
  </div>
</div>

<div id="shippedOrdersTab" class="orders-tabs">
  <h3>الطلبيات المشحونة</h3>
  <div id="shippedOrdersContainer" class="orders-grid">
    <p class="loading-message">جاري تحميل الطلبيات المشحونة...</p>
  </div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
  authDomain: "myestore-34f65.firebaseapp.com",
  databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
  projectId: "myestore-34f65",
  storageBucket: "myestore-34f65.firebasestorage.app",
  messagingSenderId: "14078917211",
  appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
  measurementId: "G-9181DX0XNJ"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const auth = getAuth(app);
const ordersRef = ref(database, 'orders');

const logoutBtn = document.getElementById('logoutBtn');
const newOrdersCount = document.getElementById('newOrdersCount');
const processingOrdersCount = document.getElementById('processingOrdersCount');
const shippedOrdersCount = document.getElementById('shippedOrdersCount');
const activeOrdersBadge = document.getElementById('activeOrdersBadge');

const newOrdersContainer = document.getElementById('newOrdersContainer');
const processingOrdersContainer = document.getElementById('processingOrdersContainer');
const shippedOrdersContainer = document.getElementById('shippedOrdersContainer');

const statCards = document.querySelectorAll('.stat-card');
const searchInput = document.getElementById('searchInput');

let userAuthenticated = false;
let currentOrders = {}; // كائن بجميع الطلبيات
let searchKeyword = "";

onAuthStateChanged(auth, (user) => {
  if (user) {
    userAuthenticated = true;
    logoutBtn.style.display = 'block';
  } else {
    userAuthenticated = false;
    logoutBtn.style.display = 'none';
    alert("يرجى تسجيل الدخول للوصول إلى لوحة التحكم");
    window.location.href = 'admin-login.html';
  }
});

logoutBtn.addEventListener('click', async () => {
  try { await signOut(auth); window.location.href = 'admin-login.html'; }
  catch (error) { console.error("خطأ في تسجيل الخروج:", error); }
});

statCards.forEach(card => {
  card.addEventListener('click', () => {
    statCards.forEach(c => c.classList.remove('active'));
    card.classList.add('active');
    document.querySelectorAll('.orders-tabs').forEach(tab => tab.classList.remove('active'));
    const tabName = card.dataset.tab;
    document.getElementById(`${tabName}OrdersTab`).classList.add('active');
  });
});

function formatDate(timestamp) {
  if (!timestamp || timestamp === 0) return 'غير محدد';
  const date = new Date(timestamp);
  return date.toLocaleString('en-GB', { 
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', hour12: false 
  });
}

function getNextAction(status) {
  if (!status || status === 'الطلبات الجديدة' || status === 'الطلبيات الجديدة') {
    return { text: 'جهّز الطلب', nextStatus: 'قيد التجهيز' };
  } else if (status === 'Processing' || status === 'قيد التجهيز' || status === 'قيد المعالجة') {
    return { text: 'تم الشحن', nextStatus: 'Shipped' };
  } else {
    return { text: 'تم الاستلام', nextStatus: 'تم التوصيل' };
  }
}

function updateOrdersCount(ordersData) {
  const items = Object.values(ordersData || {});
  
  // تصفية الطلبيات الجديدة
  const newOrders = items.filter(order => 
    !order || !order.status || 
    order.status === 'الطلبات الجديدة' || 
    order.status === 'الطلبيات الجديدة'
  );
  
  // تصفية الطلبيات قيد التجهيز
  const processingOrders = items.filter(order => 
    order && (
      order.status === 'Processing' || 
      order.status === 'قيد التجهيز' || 
      order.status === 'قيد المعالجة'
    )
  );
  
  // ******** التغيير الدقيق هنا 1/2 ************
  // الطلبيات المشحونة: فقط 'Shipped' أو 'تم الشحن'، مع استبعاد 'تم التوصيل' تمامًا
  const shippedOrders = items.filter(order => 
    order && (
      order.status === 'Shipped' || 
      order.status === 'تم الشحن'
    )
  );
  // ************************************

  newOrdersCount.textContent = newOrders.length;
  processingOrdersCount.textContent = processingOrders.length;
  shippedOrdersCount.textContent = shippedOrders.length;

  if (newOrders.length > 0) {
    activeOrdersBadge.style.display = 'flex';
    activeOrdersBadge.textContent = newOrders.length > 9 ? '9+' : newOrders.length;
  } else {
    activeOrdersBadge.style.display = 'none';
  }
}

// عرض بطاقة طلب واحدة - فقط أضفت العرض الكامل للحقول هنا (لم أغيّر منطقك)
function renderOrderCard(order, id, container) {
  const action = getNextAction(order.status);
  const orderCard = document.createElement('div');
  orderCard.className = 'order-card';

  // استخدم id المفتاح كمرجع، لكن أيضاً اعرض order.id إن وُجد
  const displayOrderId = (order.id || order.orderId || id || '').toString();
  const isNewOrder = !order.status || order.status === 'الطلبات الجديدة' || order.status === 'الطلبيات الجديدة';

  orderCard.innerHTML = `
    <div class="order-header">
      <h3>طلب #${displayOrderId ? displayOrderId.slice(-6) : (id ? id.slice(-6) : '')}</h3>
      ${isNewOrder ? '<div class="new-order-badge">جديد</div>' : ''}
    </div>

    <div class="order-customer">
      <h4>معلومات العميل:</h4>
      <p><strong>الاسم:</strong> ${order.customerName || order.name || 'غير متوفر'}</p>
      <p><strong>الهاتف:</strong> ${order.customerPhone || order.phone || 'غير متوفر'}</p>
      <p><strong>الولاية:</strong> ${order.customerWilaya || order.state || ''}</p>
      <p><strong>البلدية:</strong> ${order.customerCommune || order.city || ''}</p>
      <p><strong>العنوان الكامل:</strong> ${order.customerAddress || order.address || ''}</p>
      <p><strong>🚚 نوع التوصيل:</strong> ${order.deliveryOption || order.deliveryMethod || ''}</p>
      <p><strong>📝 ملاحظات:</strong> ${order.note || order.customerNote || ''}</p>
    </div>

    <div class="order-products">
      <h4>المنتج/المنتجات:</h4>
      ${order.items ? (Array.isArray(order.items) ? order.items.map(it => `
          <div class="product-item">
            <strong>${it.name || it.productName || 'منتج'}</strong>
            <div class="product-details">
              <span>الكمية: ${it.quantity || 1}</span>
              <span>السعر: ${parseFloat(it.price || it.productPrice || 0).toFixed(2)} دج</span>
              <span>المجموع: ${parseFloat((it.quantity || 1) * (it.price || it.productPrice || 0)).toFixed(2)} دج</span>
            </div>
          </div>
        `).join('') : Object.values(order.items).map(it => `
          <div class="product-item">
            <strong>${it.name || it.productName || 'منتج'}</strong>
            <div class="product-details">
              <span>الكمية: ${it.quantity || 1}</span>
              <span>السعر: ${parseFloat(it.price || it.productPrice || 0).toFixed(2)} دج</span>
              <span>المجموع: ${parseFloat((it.quantity || 1) * (it.price || it.productPrice || 0)).toFixed(2)} دج</span>
            </div>
          </div>
        `).join('')
      ) : `
        <div class="product-item">
          <strong>${order.productName || order.name || 'غير متوفر'}</strong>
          <div class="product-details">
            <span>الكمية: ${order.quantity || 1}</span>
            <span>السعر: ${parseFloat(order.productPrice || order.price || 0).toFixed(2)} دج</span>
            <span>المجموع: ${parseFloat(order.totalPrice || 0).toFixed(2)} دج</span>
          </div>
        </div>
      `}
    </div>

    <div class="order-meta">
      <p><strong>رقم الطلب الكامل:</strong> ${displayOrderId}</p>
      <p><strong>تاريخ الطلب:</strong> ${formatDate(order.timestamp || order.date || order.dateTime || order.createdAt || 0)}</p>
      <p><strong>الحالة:</strong> ${order.status || 'جديد'}</p>
      ${order.updatedAt ? `<p><strong>آخر تحديث:</strong> ${formatDate(order.updatedAt)}</p>` : ''}
    </div>

    <div class="order-actions">
      <button class="action-btn update-status-btn" data-order-id="${id}" data-next-status="${action.nextStatus}">${action.text}</button>
    </div>
  `;

  container.appendChild(orderCard);
}

async function renderAllOrders(ordersData) {
  if (!userAuthenticated) return;
  currentOrders = ordersData || {};
  updateOrdersCount(ordersData);

  // نحضر القوائم الفارغة
  newOrdersContainer.innerHTML = '';
  processingOrdersContainer.innerHTML = '';
  shippedOrdersContainer.innerHTML = '';

  let hasNewOrders = false, hasProcessingOrders = false, hasShippedOrders = false;

  // تحويل الكائن إلى مصفوفة مع المفتاح
  Object.entries(currentOrders).forEach(([id, order]) => {
    if (!order) return;

    // تطبيق فلترة البحث (إن وُجد)
    if (searchKeyword && searchKeyword.length > 0) {
      const kw = searchKeyword.toLowerCase();
      const concat = [
        id,
        (order.id || '').toString(),
        (order.orderId || '').toString(),
        (order.customerName || order.name || '').toString(),
        (order.customerPhone || order.phone || '').toString(),
        (order.customerWilaya || order.state || '').toString(),
        (order.customerCommune || order.city || '').toString(),
        (order.customerAddress || order.address || '').toString(),
        (order.productName || '').toString(),
        (order.note || order.customerNote || '').toString(),
      ].join(' ').toLowerCase();

      if (!concat.includes(kw)) return; // لا تطابق — تجاهل هذا الطلب
    }

    const status = order.status;

    // ******** التغيير الدقيق هنا 2/2 ************
    // استبعاد الطلبات بحالة 'تم التوصيل' تمامًا من العرض في هذه الصفحة
    if (status === 'تم التوصيل') {
      return; // تجاهل هذا الطلب تمامًا ولا تعرضه
    }
    // ************************************

    // تصنيف حسب الحالة كما في كودك
    if (!status || status === 'الطلبات الجديدة' || status === 'الطلبيات الجديدة') {
      renderOrderCard(order, id, newOrdersContainer);
      hasNewOrders = true;
    } else if (status === 'قيد التجهيز' || status === 'قيد المعالجة' || status === 'Processing') {
      renderOrderCard(order, id, processingOrdersContainer);
      hasProcessingOrders = true;
    } else if (status === 'Shipped' || status === 'تم الشحن') { // الآن هذا الشرط يخص فقط 'Shipped' و 'تم الشحن'
      renderOrderCard(order, id, shippedOrdersContainer);
      hasShippedOrders = true;
    } else {
      // هذا الجزء للحالات غير المعروفة الأخرى غير "تم التوصيل"
      // إذا كانت لديك حالات أخرى تريد إظهارها كـ "جديدة" افتراضيًا
      // renderOrderCard(order, id, newOrdersContainer);
      // hasNewOrders = true;
    }
  });

  if (!hasNewOrders) newOrdersContainer.innerHTML = '<p class="error-message">لا توجد طلبيات جديدة</p>';
  if (!hasProcessingOrders) processingOrdersContainer.innerHTML = '<p class="error-message">لا توجد طلبيات قيد التجهيز</p>';
  if (!hasShippedOrders) shippedOrdersContainer.innerHTML = '<p class="error-message">لا توجد طلبيات مشحونة</p>';

  // ربط أزرار التحديث بعد العرض
  document.querySelectorAll('.update-status-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const orderId = e.target.dataset.orderId;
      const nextStatus = e.target.dataset.nextStatus;
      if (!orderId || !nextStatus) return;

      e.target.disabled = true;
      e.target.textContent = 'جاري التحديث...';

      try {
        await update(ref(database, 'orders/' + orderId), {
          status: nextStatus,
          updatedAt: Date.now()
        });

        // إزالة البطاقة مباشرة من الواجهة بعد التحديث
        // هذا المنطق سيضمن أن الطلب الذي تحولت حالته إلى 'تم التوصيل'
        // سيتم إزالته من العرض عند إعادة الرسم.
        if (currentOrders[orderId]) {
          // لا داعي لحذفه يدويًا من `currentOrders` هنا،
          // فـ `onValue` ستعيد استدعاء `renderAllOrders` بالبيانات الجديدة
          // والتي لن تحتوي على هذا الطلب في أقسام العرض النشطة.
        }
        renderAllOrders(currentOrders); // نعيد عرض الباقي فقط

        if (nextStatus === 'تم التوصيل') {
          alert('تم نقل الطلبية إلى الطلبيات المكتملة');
        }
      } catch (error) {
        console.error(error);
        alert('حدث خطأ أثناء تحديث حالة الطلب');
        e.target.disabled = false;
        e.target.textContent = getNextAction(currentOrders[orderId]?.status).text;
      }
    });
  });
}

// ربط المستمع على تغيّر الطلبيات في Firebase
onValue(ordersRef, snapshot => {
  renderAllOrders(snapshot.val() || {});
});

// ربط خانة البحث: تحدث الكلمة المفتاحية ثم أعد عرض الطلبيات
searchInput.addEventListener('input', (e) => {
  searchKeyword = e.target.value.trim().toLowerCase();
  renderAllOrders(currentOrders);
});
</script>
</body>
</html>