<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="admin-style.css">
  <style>
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª) */
    .choices-container {
      display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 50px;
    }
    .choice-card {
      background: #fff; width: 100%; max-width: 250px; height: 200px;
      border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      cursor: pointer; transition: transform 0.3s, border 0.3s;
      border: 2px solid transparent; text-decoration: none; color: inherit;
    }
    .choice-card:hover { transform: translateY(-5px); }
    
    .card-icon { font-size: 3rem; margin-bottom: 15px; }
    .card-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 5px; }
    .card-desc { font-size: 0.85rem; color: #777; text-align: center; padding: 0 10px; }

    .owner-card { border-bottom: 5px solid #f39c12; }
    .store-card { border-bottom: 5px solid #007bff; }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ */
    .stage-section { display: none; max-width: 500px; margin: 20px auto; text-align: center; }
    
    .security-lock {
      background: #34495e; color: #fff; padding: 30px; border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .security-lock input {
      background: #2c3e50; border: 1px solid #46637f; color: #fff;
      text-align: center; letter-spacing: 5px; font-size: 1.5rem;
      width: 100%; padding: 15px; border-radius: 8px; margin-bottom: 20px;
    }
    
    /* Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ */
    .error-text { color: red; font-weight: bold; margin-top: 10px; }
    .success-text { color: green; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>

  <nav>
    <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>
    <div class="logo">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
    <div class="links">
      <a href="add-manager.html" class="nav-link active">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†</a>
      <a href="#" id="logoutBtn" class="nav-link" style="display:none;">Ø®Ø±ÙˆØ¬</a>
    </div>
  </nav>

  <div class="container">

    <!-- ğŸ”„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loadingStage" style="text-align:center; padding:50px;">
      <h3>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</h3>
    </div>

    <!-- 1ï¸âƒ£ Ù…Ø±Ø­Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginStage" class="stage-section" style="background:#fff; padding:30px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
      <h3 style="color:#2c3e50; margin-bottom:20px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h3>
      <form id="loginForm">
        <input type="email" id="lEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:6px;">
        <input type="password" id="lPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:6px;">
        <button type="submit" id="lBtn" class="btn-primary" style="width:100%; padding:12px; font-size:1.1rem; border:none; border-radius:6px; background:#007bff; color:white; cursor:pointer;">Ø¯Ø®ÙˆÙ„</button>
      </form>
      <p id="lMsg" class="error-text"></p>
    </div>

    <!-- 2ï¸âƒ£ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± (Ø§Ù„Ù…Ø±Ø¨Ø¹ÙŠÙ† Ø§Ù„ÙƒØ¨ÙŠØ±ÙŠÙ†) -->
    <div id="choiceStage" style="display:none;">
      <h2 style="text-align:center; margin-top:20px; color:#2c3e50;">Ø§Ø®ØªØ± ÙˆØ¬Ù‡ØªÙƒ</h2>
      
      <div class="choices-container">
        <!-- Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙŠÙ…Ù†: Ø£Ù†Ø§ Ø§Ù„Ù…Ø§Ù„Ùƒ -->
        <div class="choice-card owner-card" onclick="goToOwnerLock()">
          <div class="card-icon">ğŸ‘‘</div>
          <div class="card-title">Ø£Ù†Ø§ Ø§Ù„Ù…Ø§Ù„Ùƒ (Owner)</div>
          <div class="card-desc">Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø°Ù Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ (ÙŠØªØ·Ù„Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø³Ø±ÙŠ)</div>
        </div>

        <!-- Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙŠØ³Ø±: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø± -->
        <div class="choice-card store-card" onclick="goToStore()">
          <div class="card-icon">ğŸ›’</div>
          <div class="card-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø±</div>
          <div class="card-desc">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
        </div>
      </div>
    </div>

    <!-- 3ï¸âƒ£ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù‚ÙÙ„ Ø§Ù„Ø³Ø±ÙŠ -->
    <div id="lockStage" class="stage-section">
      <div class="security-lock">
        <h3>ğŸ” Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ù…Ù„ÙƒÙŠØ©</h3>
        <p style="margin-bottom:20px; opacity:0.8;">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
        <input type="password" id="rootKeyInput" placeholder="******">
        <div style="display:flex; gap:10px;">
          <button onclick="showChoices()" style="flex:1; background:#555; color:white; border:none; padding:12px; border-radius:6px; cursor:pointer;">Ø±Ø¬ÙˆØ¹</button>
          <button onclick="verifyKey()" style="flex:2; background:#f39c12; color:white; border:none; padding:12px; border-radius:6px; cursor:pointer;">ÙØªØ­</button>
        </div>
        <p id="lockMsg" class="error-text"></p>
      </div>
    </div>

    <!-- 4ï¸âƒ£ Ù…Ø±Ø­Ù„Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ -->
    <div id="ownerStage" style="display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="color:#27ae60;">âœ… Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ</h3>
        <button onclick="showChoices()" style="background:#ddd; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Ø¹ÙˆØ¯Ø© Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</button>
      </div>

      <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->
      <div class="form-container" style="background:#fff; padding:25px; border-radius:10px; border-top:4px solid #27ae60; margin-bottom:30px; box-shadow:0 4px 10px rgba(0,0,0,0.05);">
        <h3 style="margin-bottom:15px;">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h3>
        <form id="addManagerForm">
          <input type="text" id="mName" placeholder="Ø§Ù„Ø§Ø³Ù…" required style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px;">
          <input type="email" id="mEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px;">
          <input type="password" id="mPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6+ Ø£Ø±Ù‚Ø§Ù…)" required minlength="6" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px;">
          <button type="submit" id="addBtn" style="width:100%; padding:12px; background:#27ae60; color:white; border:none; border-radius:5px; font-size:1.1rem; cursor:pointer;">Ø­ÙØ¸</button>
          <p id="statusMsg" style="text-align:center; margin-top:10px; font-weight:bold;"></p>
        </form>
      </div>

      <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
      <h3>Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
      <div id="adminsList" class="orders-grid"></div>
    </div>

  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
      authDomain: "myestore-34f65.firebaseapp.com",
      databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
      projectId: "myestore-34f65",
      storageBucket: "myestore-34f65.firebasestorage.app",
      messagingSenderId: "14078917211",
      appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
      measurementId: "G-9181DX0XNJ"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, set, remove, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const app = initializeApp(firebaseConfig, "ChoiceSystem");
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ´ÙÙŠØ±
    async function hashString(str) {
      const msgBuffer = new TextEncoder().encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±Ø¶ (ØªØ¶Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­ ÙÙ‚Ø·)
    function showSection(id) {
      // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
      ['loadingStage', 'loginStage', 'choiceStage', 'lockStage', 'ownerStage'].forEach(s => {
        const el = document.getElementById(s);
        if(el) el.style.display = 'none';
      });
      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
      const target = document.getElementById(id);
      if(target) target.style.display = 'block';
    }

    // Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© (ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø¹Ø¯Ù… Ø¸Ù‡ÙˆØ± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª)
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById('logoutBtn').style.display = 'block';
        
        // ğŸ”¥ Ø§Ù„Ø­Ù„ Ù„Ù…Ø´ÙƒÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„: Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        // Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ù‚ÙÙ„ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…Ø§Ù„Ùƒ
        document.getElementById('rootKeyInput').value = '';
        showSection('choiceStage'); 
        
        loadAdminsList(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
      } else {
        document.getElementById('logoutBtn').style.display = 'none';
        showSection('loginStage');
      }
    });

    // --- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('lBtn');
      const msg = document.getElementById('lMsg');
      btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...";
      btn.disabled = true;
      try {
        await signInWithEmailAndPassword(auth, document.getElementById('lEmail').value, document.getElementById('lPass').value);
        // onAuthStateChanged Ø³ÙŠØªÙƒÙÙ„ Ø¨Ø§Ù„Ø¨Ø§Ù‚ÙŠ
      } catch (err) {
        msg.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
        btn.textContent = "Ø¯Ø®ÙˆÙ„";
        btn.disabled = false;
      }
    });

    // --- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ---
    window.goToStore = () => {
      window.location.href = 'admin-products.html';
    };

    window.goToOwnerLock = () => {
      showSection('lockStage');
      document.getElementById('lockMsg').textContent = '';
    };

    window.showChoices = () => {
      showSection('choiceStage');
    };

    // --- ÙÙƒ Ø§Ù„Ù‚ÙÙ„ ---
    window.verifyKey = async () => {
      const key = document.getElementById('rootKeyInput').value;
      const msg = document.getElementById('lockMsg');
      
      if(!key) return;
      msg.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
      msg.style.color = "yellow";

      try {
        const snap = await get(ref(db, 'security/rootHash'));
        if(!snap.exists()) { msg.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…!"; return; }
        
        const dbHash = snap.val();
        const inputHash = await hashString(key);

        if(inputHash === dbHash) {
          showSection('ownerStage'); // ÙØªØ­ Ø§Ù„Ù„ÙˆØ­Ø©
        } else {
          msg.textContent = "âŒ ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦";
          msg.style.color = "#e74c3c";
        }
      } catch(e) {
        msg.textContent = "Ø®Ø·Ø£ Ø§ØªØµØ§Ù„";
      }
    };

    // --- Ø¥Ø¶Ø§ÙØ© Ù…Ø¯ÙŠØ± (Ù…Ø¹ ØªØ¹Ø±ÙŠØ¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡) ---
    document.getElementById('addManagerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const status = document.getElementById('statusMsg');
      const btn = document.getElementById('addBtn');
      
      status.style.display = 'none';
      btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
      btn.disabled = true;

      try {
        const secApp = initializeApp(firebaseConfig, "SecApp");
        const secAuth = getAuth(secApp);
        const cred = await createUserWithEmailAndPassword(secAuth, 
           document.getElementById('mEmail').value, 
           document.getElementById('mPass').value
        );
        await signOut(secAuth);

        await set(ref(db, `admins/${cred.user.uid}`), {
           name: document.getElementById('mName').value,
           email: document.getElementById('mEmail').value,
           role: 'manager', createdAt: Date.now()
        });
        
        status.className = 'success-text';
        status.textContent = "âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­!";
        status.style.display = 'block';
        e.target.reset();

      } catch(err) {
        status.className = 'error-text';
        // ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        if (err.code === 'auth/email-already-in-use') {
            status.textContent = "Ø®Ø·Ø£: Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ (Ù…Ø³ØªØ®Ø¯Ù… Ø³Ø§Ø¨Ù‚Ø§Ù‹)!";
        } else if (err.code === 'auth/weak-password') {
            status.textContent = "Ø®Ø·Ø£: ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹.";
        } else if (err.code === 'auth/invalid-email') {
            status.textContent = "Ø®Ø·Ø£: Ø´ÙƒÙ„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­.";
        } else {
            status.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£: " + err.message;
        }
        status.style.display = 'block';
      } finally {
        btn.textContent = "Ø­ÙØ¸";
        btn.disabled = false;
      }
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    function loadAdminsList() {
      onValue(ref(db, 'admins'), (snapshot) => {
        const list = document.getElementById('adminsList');
        list.innerHTML = '';
        const data = snapshot.val();
        if(!data) { list.innerHTML = '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯</p>'; return; }

        Object.entries(data).forEach(([uid, val]) => {
          const div = document.createElement('div');
          div.className = 'order-row';
          div.innerHTML = `
            <div class="row-info">
              <strong>${val.name || '---'}</strong><br>
              <small>${val.email}</small>
            </div>
            <button onclick="delManager('${uid}')" style="background:red; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Ø­Ø°Ù</button>
          `;
          list.appendChild(div);
        });
      });
    }

    window.delManager = async (uid) => {
      if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) await remove(ref(db, `admins/${uid}`));
    };

    window.toggleMenu = () => document.querySelector('nav .links').classList.toggle('open');
    document.getElementById('logoutBtn').addEventListener('click', async () => {
       await signOut(auth);
       window.location.reload(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    });
  </script>
</body>
</html>