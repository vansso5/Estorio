<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø±Ø¨Ø·</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="admin-style.css">
</head>
<body>

<nav>
  <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>
  <div class="logo">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
  <div class="links">
    <a href="admin-products.html" class="nav-link">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
    <a href="admin-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</a>
    <a href="completed-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</a>
    <a href="admin-analytics.html" class="nav-link">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</a>
    <a href="admin-settings.html" class="nav-link">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
    <a href="admin-reviews.html" class="nav-link">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</a>
    <a href="admin-shipping.html" class="nav-link active">Ø§Ù„Ø´Ø­Ù†</a>
    <a href="#" id="logoutBtn" class="nav-link" style="display: none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
  </div>
</nav>

<div class="visitors-wrapper">
  <div id="liveVisitors" class="live-visitors-badge inactive">
    <span class="live-dot"></span>
    <span style="margin-right:5px">Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ø¢Ù†: </span>
    <strong id="visitorsCount" style="margin:0 4px">0</strong>
  </div>
</div>

<div class="container">
    <h2 style="margin-bottom: 20px; color: var(--primary-color);">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø´Ø±ÙƒØ§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ (API)</h2>
    <div class="form-card" style="margin-bottom: 30px;">
        <h4 style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø© / ØªØ¹Ø¯ÙŠÙ„</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div><label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©:</label><input type="text" id="provName" class="search-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: GuepEX"></div>
            <div><label>Ø±Ø§Ø¨Ø· API:</label><input type="text" id="provUrl" class="search-input" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ API"></div>
            <div><label>API Key / User ID:</label><input type="text" id="provKey" class="search-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"></div>
            <div><label>API Token / Password:</label><input type="text" id="provToken" class="search-input" placeholder="Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø·ÙˆÙŠÙ„ (Token)"></div>
            <div>
                <label>Ù‡ÙŠÙƒÙ„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</label>
                <select id="provDriver" class="search-input">
                    <option value="yalidine_style" selected>Ù†Ø¸Ø§Ù… Yalidine / Guepex (Ø§Ù„Ø¬Ø¯ÙŠØ¯)</option>
                    <option value="standard">Ù†Ø¸Ø§Ù… Ø¢Ø®Ø± / Ù‚ÙŠØ§Ø³ÙŠ</option>
                </select>
            </div>
            <div>
                <label>ØµÙŠØºØ© Ø§Ù„ÙˆÙ„Ø§ÙŠØ©:</label>
                <select id="provWilayaFormat" class="search-input">
                    <option value="french_name" selected>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ© (Alger)</option>
                    <option value="id">Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ© (16)</option>
                    <option value="arabic_name">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±)</option>
                </select>
            </div>
        </div>
        <button id="saveProviderBtn" class="save-btn" style="margin-top:15px; width:100%; background-color: var(--secondary-color); color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer;">Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</button>
        <div style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px;">
            <label>Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</label>
            <div id="savedProvidersList" style="margin-top: 10px;"><p class="loading-message">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
        </div>
    </div>

    <h2 style="margin-bottom: 20px; color: var(--primary-color);">ğŸ“¦ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Shipping)</h2>
    <div class="form-card" style="margin-bottom: 30px;">
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
            <div style="flex:3; min-width: 250px;">
                <label>Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„:</label>
                <select id="shipProviderSelect" class="search-input">
                    <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© --</option>
                </select>
            </div>
            <div style="flex:1; display:flex; gap:5px;">
                <button id="sendBulkBtn" style="flex:2; padding: 10px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
                <button id="forceRefreshBtn" style="flex:1; padding: 10px; background-color: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer;" title="ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒØ§ØªØ¨ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
        </div>
        <div id="apiStatusMsg" style="margin-bottom:10px; font-size:0.85rem; color:#666;"></div>
        <h3 style="margin-bottom:15px;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ² (Processing)</h3>
        <div id="shippingOrdersContainer" class="orders-grid">
            <p class="loading-message">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
        </div>
    </div>

    <h2 style="margin-bottom: 20px; color: var(--primary-color);">ğŸ’° ØªØ³Ø¹ÙŠØ±Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ (Ù„Ù„Ù…ØªØ¬Ø±)</h2>
    <div class="form-card">
      <div style="display:flex; gap:10px; margin-bottom:15px;">
           <div style="flex:1;"><label>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†Ø²Ù„ (Home):</label><input type="number" id="homePrice" class="search-input"></div>
           <div style="flex:1;"><label>Ø³Ø¹Ø± Ø§Ù„Ù…ÙƒØªØ¨ (Desk):</label><input type="number" id="deskPrice" class="search-input"></div>
      </div>
      <div style="margin-bottom: 10px;"><button type="button" id="selectAllBtn" style="padding:5px 10px; cursor:pointer; background: #eee; border: 1px solid #ddd; border-radius: 4px;">ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„</button></div>
      <div id="wilayaGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; padding: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 5px;"></div>
      <button id="saveZoneBtn" class="save-btn" style="margin-top:15px; width: 100%; background-color: var(--secondary-color); color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer;">Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¹ÙŠØ±Ø©</button>
    </div>
    <div id="zonesContainer" class="orders-grid" style="margin-top: 20px;"></div>
</div>

<div id="orderDetailModal" class="modal hidden">
    <div class="modal-content">
      <button class="close-modal-btn" id="closeDetailModal">&times;</button>
      <h3>ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h3>
      <div class="details-section" style="margin-top: 15px;">
          <label style="display:block;margin-bottom:5px;">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input type="text" id="editName" class="search-input" style="margin-bottom:10px;">
          
          <label style="display:block;margin-bottom:5px;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input type="text" id="editPhone" class="search-input" style="margin-bottom:10px;">
          
          <div style="display:flex; gap:10px;">
              <div style="flex:1"><label style="display:block;margin-bottom:5px;">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</label><input type="text" id="editWilaya" class="search-input" style="margin-bottom:10px;"></div>
              <div style="flex:1"><label style="display:block;margin-bottom:5px;">Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©</label><input type="text" id="editCommune" class="search-input" style="margin-bottom:10px;"></div>
          </div>
          
          <label style="display:block;margin-bottom:5px;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
          <input type="text" id="editAddress" class="search-input" style="margin-bottom:10px;">

          <label style="display:block;margin-bottom:5px; color:var(--primary-color); font-weight:bold;">Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØµÙŠÙ„ (Delivery Mode):</label>
          <select id="editDeliveryOption" class="search-input" style="margin-bottom:15px; background:#fff3cd; border:1px solid #ffecb3;">
              <option value="home">ğŸ  ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…Ù†Ø²Ù„ (Home)</option>
              <option value="desk">ğŸ¢ ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…ÙƒØªØ¨ (Stop Desk)</option>
          </select>
          
          <label style="color:var(--primary-color); font-weight:bold; display:block; margin-bottom:5px;">Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ØµØ§ÙÙŠ:</label>
          <input type="number" id="editProductPrice" class="search-input" style="margin-bottom:10px; border:2px solid var(--primary-color); background:#f0f8ff; font-weight:bold; font-size:1.1rem;">
          
          <input type="hidden" id="currentOrderId">
          
          <div class="modal-actions" style="display: flex; gap: 10px; margin-top: 15px;">
              <button id="saveChangesBtn" style="flex: 1; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-size:1rem; font-weight:bold;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
              <button id="cancelOrderBtn" class="btn-delete">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
          </div>
      </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4", authDomain: "myestore-34f65.firebaseapp.com", databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com", projectId: "myestore-34f65", storageBucket: "myestore-34f65.firebasestorage.app", messagingSenderId: "14078917211", appId: "1:14078917211:web:a48eab2a7396c094f7dd7e", measurementId: "G-9181DX0XNJ" };
    const app = initializeApp(firebaseConfig); const db = getDatabase(app); const auth = getAuth(app);

    const ordersRef = ref(db, 'orders'); const settingsRef = ref(db, 'delivery_settings'); const zonesRef = ref(db, 'shipping_zones');
    const visitorsRef = ref(db, 'site_presence');
    const shippingContainer = document.getElementById('shippingOrdersContainer');
    const shipProviderSelect = document.getElementById('shipProviderSelect');
    const savedProvidersList = document.getElementById('savedProvidersList');
    
    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ© (Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù€ Checkbox ÙÙ‚Ø·)
    const allWilayas = [ "01. Ø£Ø¯Ø±Ø§Ø±", "02. Ø§Ù„Ø´Ù„Ù", "03. Ø§Ù„Ø£ØºÙˆØ§Ø·", "04. Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ", "05. Ø¨Ø§ØªÙ†Ø©", "06. Ø¨Ø¬Ø§ÙŠØ©", "07. Ø¨Ø³ÙƒØ±Ø©", "08. Ø¨Ø´Ø§Ø±", "09. Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©", "10. Ø§Ù„Ø¨ÙˆÙŠØ±Ø©", "11. ØªÙ…Ù†Ø±Ø§Ø³Øª", "12. ØªØ¨Ø³Ø©", "13. ØªÙ„Ù…Ø³Ø§Ù†", "14. ØªÙŠØ§Ø±Øª", "15. ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ", "16. Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", "17. Ø§Ù„Ø¬Ù„ÙØ©", "18. Ø¬ÙŠØ¬Ù„", "19. Ø³Ø·ÙŠÙ", "20. Ø³Ø¹ÙŠØ¯Ø©", "21. Ø³ÙƒÙŠÙƒØ¯Ø©", "22. Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³", "23. Ø¹Ù†Ø§Ø¨Ø©", "24. Ù‚Ø§Ù„Ù…Ø©", "25. Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©", "26. Ø§Ù„Ù…Ø¯ÙŠØ©", "27. Ù…Ø³ØªØºØ§Ù†Ù…", "28. Ø§Ù„Ù…Ø³ÙŠÙ„Ø©", "29. Ù…Ø¹Ø³ÙƒØ±", "30. ÙˆØ±Ù‚Ù„Ø©", "31. ÙˆÙ‡Ø±Ø§Ù†", "32. Ø§Ù„Ø¨ÙŠØ¶", "33. Ø¥Ù„ÙŠØ²ÙŠ", "34. Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬", "35. Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³", "36. Ø§Ù„Ø·Ø§Ø±Ù", "37. ØªÙ†Ø¯ÙˆÙ", "38. ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª", "39. Ø§Ù„ÙˆØ§Ø¯ÙŠ", "40. Ø®Ù†Ø´Ù„Ø©", "41. Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³", "42. ØªÙŠØ¨Ø§Ø²Ø©", "43. Ù…ÙŠÙ„Ø©", "44. Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰", "45. Ø§Ù„Ù†Ø¹Ø§Ù…Ø©", "46. Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª", "47. ØºØ±Ø¯Ø§ÙŠØ©", "48. ØºÙ„ÙŠØ²Ø§Ù†", "49. ØªÙŠÙ…ÙŠÙ…ÙˆÙ†", "50. Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±", "51. Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„", "52. Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³", "53. Ø¥Ù† ØµØ§Ù„Ø­", "54. Ø¥Ù† Ù‚Ø²Ø§Ù…", "55. ØªÙ‚Ø±Øª", "56. Ø¬Ø§Ù†Øª", "57. Ø§Ù„Ù…ØºÙŠØ±", "58. Ø§Ù„Ù…Ù†ÙŠØ¹Ø©" ];
    
    // Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø°ÙƒÙŠ (ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ù…Ø®ØªÙ„ÙØ© Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª)
    const wilayaMapping = {
        "adrar": 1, "Ø£Ø¯Ø±Ø§Ø±": 1, "adr": 1, "aderar": 1,
        "chlef": 2, "Ø§Ù„Ø´Ù„Ù": 2, "Ø´Ù„Ù": 2, "chleff": 2,
        "laghouat": 3, "Ø§Ù„Ø£ØºÙˆØ§Ø·": 3, "Ø£ØºÙˆØ§Ø·": 3,
        "oum el bouaghi": 4, "Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ": 4, "Ø§Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ": 4, "oeb": 4,
        "batna": 5, "Ø¨Ø§ØªÙ†Ø©": 5, "Ø¨Ø§ØªÙ†Ù‡": 5,
        "bejaia": 6, "Ø¨Ø¬Ø§ÙŠØ©": 6, "bgayet": 6,
        "biskra": 7, "Ø¨Ø³ÙƒØ±Ø©": 7,
        "bechar": 8, "Ø¨Ø´Ø§Ø±": 8,
        "blida": 9, "Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©": 9, "Ø¨Ù„ÙŠØ¯Ø©": 9,
        "bouira": 10, "Ø§Ù„Ø¨ÙˆÙŠØ±Ø©": 10, "Ø¨ÙˆÙŠØ±Ø©": 10,
        "tamanrasset": 11, "ØªÙ…Ù†Ø±Ø§Ø³Øª": 11, "tam": 11,
        "tebessa": 12, "ØªØ¨Ø³Ø©": 12,
        "tlemcen": 13, "ØªÙ„Ù…Ø³Ø§Ù†": 13,
        "tiaret": 14, "ØªÙŠØ§Ø±Øª": 14,
        "tizi ouzou": 15, "ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ": 15, "tizi": 15, "to": 15,
        "alger": 16, "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±": 16, "Ø¬Ø²Ø§Ø¦Ø±": 16, "algiers": 16, "djazair": 16, "Ø¯Ø²Ø§ÙŠØ±": 16, "Ø§Ù„Ø¹Ø§ØµÙ…Ø©": 16, "Ø¹Ø§ØµÙ…Ø©": 16,
        "djelfa": 17, "Ø§Ù„Ø¬Ù„ÙØ©": 17, "Ø¬Ù„ÙØ©": 17,
        "jijel": 18, "Ø¬ÙŠØ¬Ù„": 18,
        "setif": 19, "Ø³Ø·ÙŠÙ": 19,
        "saida": 20, "Ø³Ø¹ÙŠØ¯Ø©": 20,
        "skikda": 21, "Ø³ÙƒÙŠÙƒØ¯Ø©": 21,
        "sidi bel abbes": 22, "Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³": 22, "sba": 22,
        "annaba": 23, "Ø¹Ù†Ø§Ø¨Ø©": 23,
        "guelma": 24, "Ù‚Ø§Ù„Ù…Ø©": 24,
        "constantine": 25, "Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©": 25, "qsentina": 25,
        "medea": 26, "Ø§Ù„Ù…Ø¯ÙŠØ©": 26, "Ù…Ø¯ÙŠØ©": 26,
        "mostaganem": 27, "Ù…Ø³ØªØºØ§Ù†Ù…": 27, "mosta": 27,
        "msila": 28, "Ø§Ù„Ù…Ø³ÙŠÙ„Ø©": 28, "Ù…Ø³ÙŠÙ„Ø©": 28, "m'sila": 28,
        "mascara": 29, "Ù…Ø¹Ø³ÙƒØ±": 29,
        "ouargla": 30, "ÙˆØ±Ù‚Ù„Ø©": 30,
        "oran": 31, "ÙˆÙ‡Ø±Ø§Ù†": 31, "wahran": 31,
        "el bayadh": 32, "Ø§Ù„Ø¨ÙŠØ¶": 32, "Ø¨ÙŠØ¶": 32, "bayadh": 32,
        "illizi": 33, "Ø¥Ù„ÙŠØ²ÙŠ": 33, "Ø§Ù„ÙŠØ²ÙŠ": 33,
        "bordj bou arreridj": 34, "Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬": 34, "Ø¨Ø±Ø¬": 34, "bba": 34,
        "boumerdes": 35, "Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³": 35,
        "el tarf": 36, "Ø§Ù„Ø·Ø§Ø±Ù": 36, "Ø·Ø§Ø±Ù": 36, "tarf": 36,
        "tindouf": 37, "ØªÙ†Ø¯ÙˆÙ": 37,
        "tissemsilt": 38, "ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª": 38,
        "el oued": 39, "Ø§Ù„ÙˆØ§Ø¯ÙŠ": 39, "ÙˆØ§Ø¯ÙŠ": 39, "oued souf": 39, "ÙˆØ§Ø¯ Ø³ÙˆÙ": 39, "oued": 39, "Ø³ÙˆÙ": 39,
        "khenchela": 40, "Ø®Ù†Ø´Ù„Ø©": 40,
        "souk ahras": 41, "Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³": 41,
        "tipaza": 42, "ØªÙŠØ¨Ø§Ø²Ø©": 42, "tipa": 42,
        "mila": 43, "Ù…ÙŠÙ„Ø©": 43,
        "ain defla": 44, "Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰": 44,
        "naama": 45, "Ø§Ù„Ù†Ø¹Ø§Ù…Ø©": 45, "Ù†Ø¹Ø§Ù…Ø©": 45,
        "ain temouchent": 46, "Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª": 46,
        "ghardaia": 47, "ØºØ±Ø¯Ø§ÙŠØ©": 47,
        "relizane": 48, "ØºÙ„ÙŠØ²Ø§Ù†": 48,
        "timimoun": 49, "ØªÙŠÙ…ÙŠÙ…ÙˆÙ†": 49,
        "bordj badji mokhtar": 50, "Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±": 50, "bbm": 50,
        "ouled djellal": 51, "Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„": 51, "ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„": 51, "odj": 51,
        "beni abbes": 52, "Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³": 52,
        "in salah": 53, "Ø¥Ù† ØµØ§Ù„Ø­": 53, "Ø¹ÙŠÙ† ØµØ§Ù„Ø­": 53, "ain salah": 53,
        "in guezzam": 54, "Ø¥Ù† Ù‚Ø²Ø§Ù…": 54, "Ø¹ÙŠÙ† Ù‚Ø²Ø§Ù…": 54, "ain guezzam": 54,
        "touggourt": 55, "ØªÙ‚Ø±Øª": 55,
        "djanet": 56, "Ø¬Ø§Ù†Øª": 56,
        "el mghair": 57, "Ø§Ù„Ù…ØºÙŠØ±": 57, "Ù…ØºÙŠØ±": 57,
        "el meniaa": 58, "Ø§Ù„Ù…Ù†ÙŠØ¹Ø©": 58, "Ù…Ù†ÙŠØ¹Ø©": 58
    };

    const OFFLINE_CENTERS = {
        1: { id: 10101, commune: "Adrar" }, 2: { id: 20101, commune: "Chlef" }, 3: { id: 30101, commune: "Laghouat" }, 4: { id: 40101, commune: "Oum El Bouaghi" },
        5: { id: 50101, commune: "Batna" }, 6: { id: 60101, commune: "Bejaia" }, 7: { id: 70101, commune: "Biskra" }, 8: { id: 80101, commune: "Bechar" },
        9: { id: 90101, commune: "Blida" }, 10: { id: 100101, commune: "Bouira" }, 11: { id: 110101, commune: "Tamanrasset" }, 12: { id: 120101, commune: "Tebessa" },
        13: { id: 130101, commune: "Tlemcen" }, 14: { id: 140101, commune: "Tiaret" }, 15: { id: 150101, commune: "Tizi Ouzou" }, 16: { id: 163001, commune: "Bordj El Kiffan" }, 
        17: { id: 170101, commune: "Djelfa" }, 18: { id: 180101, commune: "Jijel" }, 19: { id: 190101, commune: "Setif" }, 20: { id: 200101, commune: "Saida" },
        21: { id: 210101, commune: "Skikda" }, 22: { id: 220101, commune: "Sidi Bel Abbes" }, 23: { id: 230101, commune: "Annaba" }, 24: { id: 240101, commune: "Guelma" },
        25: { id: 250101, commune: "Constantine" }, 26: { id: 260101, commune: "Medea" }, 27: { id: 270101, commune: "Mostaganem" }, 28: { id: 280101, commune: "M'Sila" },
        29: { id: 290101, commune: "Mascara" }, 30: { id: 300101, commune: "Ouargla" }, 31: { id: 310101, commune: "Oran" }, 32: { id: 320101, commune: "El Bayadh" },
        33: { id: 330101, commune: "Illizi" }, 34: { id: 340101, commune: "Bordj Bou Arreridj" }, 35: { id: 350101, commune: "Boumerdes" }, 36: { id: 360101, commune: "El Tarf" },
        37: { id: 370101, commune: "Tindouf" }, 38: { id: 380101, commune: "Tissemsilt" }, 39: { id: 390101, commune: "El Oued" }, 40: { id: 400101, commune: "Khenchela" },
        41: { id: 410101, commune: "Souk Ahras" }, 42: { id: 420101, commune: "Tipaza" }, 43: { id: 430101, commune: "Mila" }, 44: { id: 440101, commune: "Ain Defla" },
        45: { id: 450101, commune: "Naama" }, 46: { id: 460101, commune: "Ain Temouchent" }, 47: { id: 470101, commune: "Ghardaia" }, 48: { id: 480101, commune: "Relizane" },
        49: { id: 490101, commune: "Timimoun" }, 50: { id: 500101, commune: "Bordj Badji Mokhtar" }, 51: { id: 510101, commune: "Ouled Djellal" }, 52: { id: 520101, commune: "Beni Abbes" },
        53: { id: 530101, commune: "In Salah" }, 54: { id: 540101, commune: "In Guezzam" }, 55: { id: 550101, commune: "Touggourt" }, 56: { id: 560101, commune: "Djanet" },
        57: { id: 570101, commune: "El M'Ghair" }, 58: { id: 580101, commune: "El Meniaa" }
    };

    const communeMap = {
        "Ø²Ø±Ø§Ù„Ø¯Ø©": "Zeralda", "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±": "Alger Centre", "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„ÙˆØ³Ø·Ù‰": "Alger Centre", "Ø§Ù„Ø±ÙˆÙŠØ¨Ø©": "Rouiba",
        "Ø¨Ø¦Ø± Ù…Ø±Ø§Ø¯ Ø±Ø§ÙŠØ³": "Bir Mourad Rais", "Ø­ÙŠØ¯Ø±Ø©": "Hydra", "Ø¨Ù† Ø¹ÙƒÙ†ÙˆÙ†": "Ben Aknoun", "Ø¨ÙˆØ²Ø±ÙŠØ¹Ø©": "Bouzareah",
        "Ø§Ù„Ø´Ø±Ø§Ù‚Ø©": "Cheraga", "Ø¯Ø§Ù„ÙŠ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ…": "Dely Ibrahim", "Ø§Ù„Ù‚Ø¨Ø©": "Kouba", "Ø­Ø³ÙŠÙ† Ø¯Ø§ÙŠ": "Hussein Dey",
        "Ø¨Ø§Ø¨ Ø§Ù„Ø²ÙˆØ§Ø±": "Bab Ezzouar", "Ø§Ù„Ø¯Ø§Ø± Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡": "Dar El Beida", "Ø§Ù„Ø­Ø±Ø§Ø´": "El Harrach",
        "Ø¨Ø¦Ø± ØªÙˆØªØ©": "Birtouta", "Ø³ÙŠØ¯ÙŠ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡": "Sidi Abdellah", "Ø¹ÙŠÙ† Ø¨Ù†ÙŠØ§Ù†": "Ain Benian",
        "Ø³Ø·Ø§ÙˆØ§Ù„ÙŠ": "Staoueli", "Ø¨Ø§Ø¨Ø§ Ø­Ø³Ù†": "Baba Hassen",
        "ÙˆÙ‡Ø±Ø§Ù†": "Oran", "Ø§Ù„Ø³Ø§Ù†ÙŠØ©": "Es Senia", "Ø¨Ø¦Ø± Ø§Ù„Ø¬ÙŠØ±": "Bir El Djir", "Ø£Ø±Ø²ÙŠÙˆ": "Arzew",
        "Ø³Ø·ÙŠÙ": "Setif", "Ø§Ù„Ø¹Ù„Ù…Ø©": "El Eulma", "Ø¹ÙŠÙ† ÙˆÙ„Ù…Ø§Ù†": "Ain Oulmene", "Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©": "Blida", "Ø¨ÙˆÙØ§Ø±ÙŠÙƒ": "Boufarik"
    };

    let allCentersCache = JSON.parse(localStorage.getItem('yal_centers')) || [];
    let allWilayasApiCache = JSON.parse(localStorage.getItem('yal_wilayas')) || [];
    let allCommunesApiCache = JSON.parse(localStorage.getItem('yal_communes')) || [];

    // Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ (Ù…Ø­Ø¯Ø«Ø© Ù„ØªØ¯Ø¹Ù… Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„)
    function normalizeText(text) {
        if (!text) return "";
        let str = text.toLowerCase().trim();
        str = str.replace(/(Ø¢|Ø¥|Ø£)/g, 'Ø§').replace(/Ø©/g, 'Ù‡').replace(/Ø¦/g, 'ÙŠ').replace(/Ù‰/g, 'ÙŠ');
        // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (\u0600-\u06FF) ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§Øª
        str = str.replace(/[^a-z0-9\u0600-\u06FF\s]/g, ""); 
        return str.trim();
    }

    // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ©
    function getWilayaIdByName(rawName) {
        if (!rawName) return null;
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù…ÙŠ Ù…Ø¨Ø§Ø´Ø±
        const matchNum = rawName.match(/^(\d+)/);
        if (matchNum) return parseInt(matchNum[1]);

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ
        let cleanName = normalizeText(rawName); 
        cleanName = cleanName.replace("wilaya", "").trim();

        // 1. Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ØªØ§Ù…)
        if (wilayaMapping[cleanName]) return wilayaMapping[cleanName];
        
        // 2. Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø²Ø§Ù„Ø© "Ø§Ù„" Ø§Ù„ØªØ¹Ø±ÙŠÙ (Ù…Ø«Ù„: "Ø§Ù„Ù…Ø¯ÙŠØ©" -> "Ù…Ø¯ÙŠØ©")
        if (cleanName.startsWith("Ø§Ù„")) {
            const withoutAl = cleanName.substring(2).trim();
            if (wilayaMapping[withoutAl]) return wilayaMapping[withoutAl];
        }

        // 3. Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙØ© "Ø§Ù„" Ø§Ù„ØªØ¹Ø±ÙŠÙ (Ù…Ø«Ù„: "Ù…Ø¯ÙŠØ©" -> "Ø§Ù„Ù…Ø¯ÙŠØ©")
        const withAl = "Ø§Ù„" + cleanName;
        if (wilayaMapping[withAl]) return wilayaMapping[withAl];

        // 4. Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙØ© "el" Ù„Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù„Ø§ØªÙŠÙ†ÙŠØ© (Ù…Ø«Ù„: "tarf" -> "el tarf")
        const withEl = "el " + cleanName;
        if (wilayaMapping[withEl]) return wilayaMapping[withEl];

        // 5. Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø²Ø¦ÙŠ (Fallback) - ÙŠØ¨Ø­Ø« Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙƒÙ„Ù…Ø© Ø¬Ø²Ø¡ Ù…Ù† Ø§Ø³Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ©
        for (const [key, val] of Object.entries(wilayaMapping)) {
            if (key.length > 2 && (cleanName.includes(key) || key.includes(cleanName))) {
                return val;
            }
        }

        // 6. Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ÙƒØ§Ø´ Ø§Ù„Ù€ API (Ø§Ù„ÙØ±Ù†Ø³ÙŠ Ø§Ù„Ø±Ø³Ù…ÙŠ)
        if (allWilayasApiCache.length > 0) {
            const foundInApi = allWilayasApiCache.find(w => normalizeText(w.name) === cleanName);
            if (foundInApi) return foundInApi.id;
        }

        return null; 
    }

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = 'admin-login.html';
        else { 
            document.getElementById('logoutBtn').style.display = 'block'; 
            loadActiveProviders(); renderWilayaCheckboxes();
            updateApiStatusUI();
        }
    });
    document.getElementById('logoutBtn').addEventListener('click', async () => await signOut(auth));

    function updateApiStatusUI() {
        const msg = document.getElementById('apiStatusMsg');
        if(allCentersCache.length > 0) msg.innerHTML = `âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆÙØ±Ø©: ${allCentersCache.length} Ù…ÙƒØªØ¨ ØªÙˆØµÙŠÙ„.`;
        else msg.innerHTML = 'âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒØ§ØªØ¨.';
    }

    async function fetchAllPages(url, headers) {
        let allData = [];
        let page = 1;
        let hasMore = true;
        while(hasMore && page < 20) { 
            try {
                const sep = url.includes('?') ? '&' : '?';
                const finalUrl = `${url}${sep}page=${page}&page_size=1000`;
                const res = await fetch('https://corsproxy.io/?' + encodeURIComponent(finalUrl), { headers });
                const json = await res.json();
                if (json.data) allData = allData.concat(json.data);
                hasMore = json.has_more;
                page++;
            } catch(e) { hasMore = false; }
        }
        return allData;
    }

    async function fetchGuepexData(apiUrl, apiId, apiToken, forceUpdate = false) {
        if(!forceUpdate && allCentersCache.length > 0 && allCommunesApiCache.length > 0) return; 

        let baseUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
        if(baseUrl.includes('/v1/parcels')) baseUrl = baseUrl.replace('/v1/parcels', '/v1'); 
        else if(!baseUrl.includes('/v1')) baseUrl += '/v1';

        const headers = { 'X-API-ID': apiId, 'X-API-TOKEN': apiToken };
        const btn = document.getElementById('forceRefreshBtn');
        const originalText = btn.textContent;
        btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„..."; btn.disabled = true;

        try {
            console.log("Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù€ API...");
            allWilayasApiCache = await fetchAllPages(`${baseUrl}/wilayas`, headers);
            allCentersCache = await fetchAllPages(`${baseUrl}/centers`, headers);
            allCommunesApiCache = await fetchAllPages(`${baseUrl}/communes`, headers); 

            localStorage.setItem('yal_wilayas', JSON.stringify(allWilayasApiCache));
            localStorage.setItem('yal_centers', JSON.stringify(allCentersCache));
            localStorage.setItem('yal_communes', JSON.stringify(allCommunesApiCache));

            console.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allWilayasApiCache.length} ÙˆÙ„Ø§ÙŠØ©ØŒ ${allCentersCache.length} Ù…ÙƒØªØ¨.`);
            updateApiStatusUI();
            if(forceUpdate) alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ§ØªØ¨ ÙˆØ§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­!");
        } catch(e) { 
            console.error("Ø®Ø·Ø£ API:", e); 
            if(forceUpdate) alert("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ API. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª.");
        } finally {
            btn.textContent = originalText; btn.disabled = false;
        }
    }

    document.getElementById('forceRefreshBtn').addEventListener('click', async () => {
        const providerId = shipProviderSelect.value;
        if(!providerId) return alert('Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹.');
        const snap = await get(ref(db, `delivery_settings/${providerId}`));
        if(snap.exists()) {
            const d = snap.val();
            await fetchGuepexData(d.apiUrl, d.apiKey, d.apiToken, true);
        }
    });

    onValue(visitorsRef, (s) => { 
        if(!s.exists()) { document.getElementById('visitorsCount').textContent=0; return;} 
        const c = Object.keys(s.val()).length; 
        document.getElementById('visitorsCount').textContent=c; 
        document.getElementById('liveVisitors').className = c>0?'live-visitors-badge active':'live-visitors-badge inactive';
    });

    function resolveGuepexDestination(orderData, centersList, wilayasList, communesList) {
        const { wilayaId, rawCommune, isStopDesk } = orderData;
        
        let finalWilayaName = "Alger";
        const foundWilaya = wilayasList.find(w => w.id == wilayaId);
        if (foundWilaya) finalWilayaName = foundWilaya.name;

        let searchCommune = rawCommune || "";
        if (communeMap[searchCommune]) searchCommune = communeMap[searchCommune];
        const normalizedSearch = normalizeText(searchCommune);

        if (isStopDesk) {
            let stopDeskId = null;
            let centerCommuneName = null;
            let centerName = "";
            
            const centersInWilaya = centersList.filter(c => c.wilaya_id == wilayaId);
            const foundCenter = centersInWilaya.find(c => 
                normalizeText(c.name).includes(normalizedSearch) || 
                (c.commune_name && normalizeText(c.commune_name).includes(normalizedSearch))
            );

            if (foundCenter) {
                stopDeskId = foundCenter.center_id || foundCenter.id;
                centerCommuneName = foundCenter.commune_name;
                centerName = foundCenter.name;
            } else {
                if (centersInWilaya.length > 0) {
                    stopDeskId = centersInWilaya[0].center_id || centersInWilaya[0].id;
                    centerCommuneName = centersInWilaya[0].commune_name;
                    centerName = centersInWilaya[0].name;
                }
                else if (OFFLINE_CENTERS[wilayaId]) {
                    stopDeskId = OFFLINE_CENTERS[wilayaId].id;
                    centerCommuneName = OFFLINE_CENTERS[wilayaId].commune;
                    centerName = "Main Desk";
                }
            }

            if (!stopDeskId) throw new Error(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒØ§ØªØ¨ Ù…ØªØ§Ø­Ø© ÙÙŠ ÙˆÙ„Ø§ÙŠØ© ${finalWilayaName}`);

            return {
                to_wilaya_name: finalWilayaName,
                to_commune_name: centerCommuneName || finalWilayaName, 
                is_stopdesk: true,
                stopdesk_id: stopDeskId,
                address: `Stop Desk - ${centerName}` 
            };
        }
        else {
            let finalCommuneName = null;
            const exactCommune = communesList.find(c => c.wilaya_id == wilayaId && normalizeText(c.name) === normalizedSearch);
            
            if (exactCommune) {
                finalCommuneName = exactCommune.name;
            } else {
                const partialCommune = communesList.find(c => c.wilaya_id == wilayaId && normalizeText(c.name).includes(normalizedSearch));
                if (partialCommune) finalCommuneName = partialCommune.name;
                else {
                    if(OFFLINE_CENTERS[wilayaId]) finalCommuneName = OFFLINE_CENTERS[wilayaId].commune;
                    else finalCommuneName = finalWilayaName;
                    if (normalizeText(finalWilayaName) === 'alger') finalCommuneName = "Alger Centre";
                }
            }

            return {
                to_wilaya_name: finalWilayaName,
                to_commune_name: finalCommuneName,
                is_stopdesk: false,
                address: orderData.address 
            };
        }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©ØŒ ÙÙ‚Ø· Ø´Ø§Ø±Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©)
    onValue(ordersRef, async (snapshot) => {
        shippingContainer.innerHTML = '';
        const orders = snapshot.val() || {};
        const sorted = Object.entries(orders).sort((a,b) => b[1].timestamp - a[1].timestamp);
        
        let products = {};
        try { const productsSnap = await get(ref(db, 'products')); if (productsSnap.exists()) products = productsSnap.val(); } catch(e) { }

        let count = 0;
        sorted.forEach(([id, order]) => {
            const status = (order.status || '').toLowerCase().trim();
            if(status.includes('shipped') || status.includes('delivered') || status.includes('ØªÙ…') || status.includes('Ø´Ø­Ù†')) return;
            count++;
            let currentTotal = parseFloat(order.productTotal);
            if(isNaN(currentTotal)) currentTotal = calculateProductOnlyPrice(order);
            let discount = 0; if (order.productId && products[order.productId]) discount = parseFloat(products[order.productId].marketingDiscount || 0);
            const qty = parseInt(order.quantity || 1);
            let netPrice = currentTotal - (discount * qty); if(netPrice < 0) netPrice = 0;
            
            const isDeskByDefualt = (order.deliveryOption && (order.deliveryOption.includes('desk') || order.deliveryOption.includes('Ù…ÙƒØªØ¨')));

            const row = document.createElement('div'); row.className = 'order-row'; row.dataset.id = id;
            row.style.cssText = "display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; background: #fff; border-radius: 8px; margin-bottom: 8px; border: 1px solid #eee; border-right: 4px solid #f1c40f;";
            
            row.innerHTML = `
                <div class="row-info" style="display:flex;align-items:center; flex: 2;">
                    <input type="checkbox" class="order-checkbox" value="${id}" style="margin-left: 15px; transform: scale(1.3);">
                    <div style="margin-right:15px;">
                        <span class="row-name" style="font-weight:bold;">${order.customerName || order.name}</span>
                        <div style="font-size: 0.85rem; color: #666;"> ${order.customerWilaya || order.state} | ${order.customerCommune || ''} | <span style="color:#27ae60;font-weight:bold;">${netPrice} Ø¯Ø¬</span></div>
                    </div>
                </div>
                
                <div style="flex: 1; text-align: center;">
                    <span style="display:inline-block; padding:5px 10px; border-radius:15px; font-size:0.85rem; font-weight:bold; background:${isDeskByDefualt ? '#fff3cd' : '#e8f5e9'}; color:${isDeskByDefualt ? '#856404' : '#2e7d32'}; border:1px solid ${isDeskByDefualt ? '#ffeeba' : '#c3e6cb'};">
                        ${isDeskByDefualt ? 'ğŸ¢ Ù…ÙƒØªØ¨ (Desk)' : 'ğŸ  Ù…Ù†Ø²Ù„ (Home)'}
                    </span>
                </div>

                <div onclick="window.openDetails('${id}')" style="cursor:pointer; background:#e3f2fd; color:#0d47a1; padding:5px 10px; border-radius:5px; font-weight:bold; font-size:0.9rem;">âœï¸ ØªØ¹Ø¯ÙŠÙ„</div>`;
            shippingContainer.appendChild(row);
        });
        if(count === 0) shippingContainer.innerHTML = '<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ².</p>';
    });

    // ============================================================
    //  Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø« (Validation -> Translation -> Sending)
    // ============================================================
    document.getElementById('sendBulkBtn').addEventListener('click', async function() {
        const btn = this; 
        const providerId = shipProviderSelect.value; 
        const checks = document.querySelectorAll('.order-checkbox:checked');
        
        if(!providerId) return alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
        if(checks.length === 0) return alert('âš ï¸ Ù„Ù… ØªÙ‚Ù… Ø¨ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø·Ù„Ø¨ÙŠØ§Øª.');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        if(allCentersCache.length === 0) {
           if(!confirm("âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒØ§ØªØ¨ ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©. Ù‡Ù„ ØªÙˆØ¯ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ")) return;
        }

        btn.textContent = "ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ ÙˆØ§Ù„ØªØ±Ø¬Ù…Ø©..."; 
        btn.disabled = true;

        // 1. Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©
        let apiData = null;
        try {
            const setSnap = await get(ref(db, `delivery_settings/${providerId}`));
            if(setSnap.exists()) apiData = setSnap.val(); 
            else throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ù…ÙÙ‚ÙˆØ¯Ø©");
        } catch(e) { 
            alert(e.message); 
            btn.textContent = "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯"; 
            btn.disabled = false; 
            return; 
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        if(apiData.driverType === 'yalidine_style' && allCentersCache.length === 0) {
            await fetchGuepexData(apiData.apiUrl, apiData.apiKey, apiData.apiToken);
        }

        // ============================================================
        // Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ù„ØªØ±Ø¬Ù…Ø© ÙˆØ§Ù„ØªØ¬Ù‡ÙŠØ² (Validation & Preparation)
        // ============================================================
        let readyToSendList = []; 
        let errorMessages = [];   

        for (const chk of checks) {
            const orderId = chk.value;
            const orderSnap = await get(ref(db, `orders/${orderId}`));
            
            if(!orderSnap.exists()) continue;
            const order = orderSnap.val();
            const cleanOrderId = orderId.replace('#','').trim();
            const fullName = (order.customerName || order.name || "Client").trim();

            try {
                // 1. ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØµÙŠÙ„
                let isStopDesk = (order.deliveryOption && (order.deliveryOption.toLowerCase().includes('desk') || order.deliveryOption.includes('Ù…ÙƒØªØ¨')));
                
                // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³Ø¹Ø±
                let currentTotal = parseFloat(order.productTotal);
                if (isNaN(currentTotal)) currentTotal = parseFloat(order.totalPrice || 0) - parseFloat(order.shippingPrice || 0);
                let marketingDiscount = 0;
                if(order.productId) { 
                    try { const prodSnap = await get(ref(db, `products/${order.productId}`)); if(prodSnap.exists()) marketingDiscount = parseFloat(prodSnap.val().marketingDiscount || 0); } catch(e) { } 
                }
                const qty = parseInt(order.quantity || 1);
                let finalPriceToSend = currentTotal - (marketingDiscount * qty); 
                if (finalPriceToSend < 0) finalPriceToSend = 0; 

                // 3. Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù„ÙˆÙ„Ø§ÙŠØ©
                let rawWilaya = order.customerWilaya || order.state || "";
                let rawCommune = (order.customerCommune || "").trim();
                let wilayaId = getWilayaIdByName(rawWilaya); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø°ÙƒÙŠ

                if (!wilayaId) {
                    throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©: "${rawWilaya}".`);
                }

                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
                let destination = resolveGuepexDestination(
                    { wilayaId, rawCommune, isStopDesk, address: order.customerAddress || rawCommune },
                    allCentersCache, allWilayasApiCache, allCommunesApiCache
                );

                let phone = (order.customerPhone || order.phone || "").replace(/[^0-9]/g, ''); 
                if(phone.length === 9) phone = '0'+phone;

                // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                let parcelObj = {
                    "order_id": cleanOrderId,
                    "firstname": fullName,
                    "familyname": ".",
                    "contact_phone": phone,
                    "address": destination.address,
                    "to_wilaya_name": destination.to_wilaya_name,
                    "to_commune_name": destination.to_commune_name,
                    "product_list": order.productName || "Colis",
                    "price": finalPriceToSend,
                    "freeshipping": false,
                    "do_insurance": false,
                    "declared_value": finalPriceToSend,
                    "has_exchange": false,
                    "height": 10, "width": 20, "length": 30, "weight": 1,
                    "is_stopdesk": destination.is_stopdesk
                };

                if(destination.stopdesk_id) {
                    parcelObj.stopdesk_id = destination.stopdesk_id;
                }
                
                readyToSendList.push({
                    firebaseId: orderId,
                    payload: [parcelObj], 
                    customerName: fullName
                });

            } catch(err) {
                errorMessages.push(`âŒ ${fullName}: ${err.message}`);
            }
        }

        // ============================================================
        // Ù†Ù‚Ø·Ø© Ø§Ù„ØªÙØªÙŠØ´: Ù‡Ù„ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ØŸ
        // ============================================================
        if (errorMessages.length > 0) {
            btn.textContent = "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯"; 
            btn.disabled = false;
            
            let msg = "âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„ÙˆØ¬ÙˆØ¯ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†:\n\n";
            msg += errorMessages.join("\n");
            msg += "\n\nØ§Ù„Ø±Ø¬Ø§Ø¡ ØªØµØ­ÙŠØ­ Ù‡Ø°Ù‡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø«Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
            alert(msg);
            return; 
        }

        // ============================================================
        // Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ¹Ù„ÙŠ
        // ============================================================
        if(!confirm(`âœ… ØªÙ…Øª ØªØ±Ø¬Ù…Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­ (${readyToSendList.length} Ø·Ù„Ø¨).\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†ØŸ`)) {
            btn.textContent = "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯"; 
            btn.disabled = false;
            return;
        }

        btn.textContent = "ğŸš€ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±..."; 
        let successCount = 0; 
        let failCount = 0; 
        let sendDetails = "";

        let postUrl = apiData.apiUrl;
        if(postUrl.endsWith('/')) postUrl = postUrl.slice(0, -1);
        if(!postUrl.includes('/v1/parcels')) postUrl += '/v1/parcels';
        const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(postUrl);

        const requestHeaders = { 
            'Content-Type': 'application/json',
            'X-API-ID': apiData.apiKey,
            'X-API-TOKEN': apiData.apiToken
        };

        for (const item of readyToSendList) {
            try {
                const res = await fetch(proxyUrl, { 
                    method: 'POST', 
                    headers: requestHeaders, 
                    body: JSON.stringify(item.payload) 
                });
                
                const resText = await res.text();
                let resJson; 
                try { resJson = JSON.parse(resText); } catch (e) { throw new Error(`API Error: ${resText.substring(0, 50)}`); }

                let isSuccess = false; 
                let trackingCode = "Sent";
                
                const cleanId = item.payload[0].order_id;
                if (resJson[cleanId] && resJson[cleanId].success === true) { 
                    isSuccess = true; trackingCode = resJson[cleanId].tracking; 
                } else if (Array.isArray(resJson) && resJson[0] && (resJson[0].tracking || resJson[0].success)) { 
                    isSuccess = true; trackingCode = resJson[0].tracking || "Sent"; 
                }
                
                if (isSuccess) {
                    await update(ref(db, `orders/${item.firebaseId}`), { 
                        status: 'Shipped', 
                        deliveryProvider: apiData.displayName, 
                        trackingCode: trackingCode, 
                        shippedAt: Date.now() 
                    });
                    successCount++;
                } else { 
                    failCount++; 
                    const errMsg = resJson[cleanId] ? resJson[cleanId].message : JSON.stringify(resJson).substring(0,50);
                    sendDetails += `\nâŒ ${item.customerName}: ${errMsg}`;
                }

            } catch(e) {
                console.error(e); 
                failCount++; 
                sendDetails += `\nâš ï¸ ${item.customerName}: Ø®Ø·Ø£ Ø§ØªØµØ§Ù„ (${e.message})`;
            }
        }
        
        let report = `Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:\nâœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­: ${successCount}\nâŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${failCount}`;
        if(failCount > 0) report += `\n\nØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ´Ù„:${sendDetails}`;
        alert(report);
        
        btn.textContent = "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯"; 
        btn.disabled = false;
    });

    function calculateProductOnlyPrice(order) {
        if (order.productTotal && !isNaN(order.productTotal)) return parseFloat(order.productTotal);
        if (order.items) {
            let sum = 0; const items = Array.isArray(order.items) ? order.items : Object.values(order.items);
            items.forEach(i => sum += (parseFloat(i.price) * parseInt(i.quantity || 1)));
            if(sum > 0) return sum;
        }
        let total = parseFloat(order.totalPrice || 0); let ship = parseFloat(order.shippingPrice || 0);
        return (total - ship) > 0 ? (total - ship) : total;
    }

    document.getElementById('saveProviderBtn').addEventListener('click', async function() {
        let url = document.getElementById('provUrl').value;
        if(url && url.endsWith('/')) url = url.slice(0, -1);
        if(url && url.includes('/v1/parcels')) url = url.replace('/v1/parcels', '');
        const name=document.getElementById('provName').value, key=document.getElementById('provKey').value, token=document.getElementById('provToken').value;
        if(!name || !url || !key) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        const btn = this; btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; btn.disabled = true;
        try {
            await update(ref(db, `delivery_settings/${name.replace(/\s+/g,'_').toLowerCase()}`), {
                displayName: name, apiUrl: url, apiKey: key, apiToken: token, driverType: document.getElementById('provDriver').value, wilayaFormat: document.getElementById('provWilayaFormat').value, active: true
            });
            alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸"); document.getElementById('provName').value=''; document.getElementById('provKey').value=''; document.getElementById('provToken').value='';
        } catch(e) { alert(e.message); } finally { btn.textContent = "Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©"; btn.disabled = false; }
    });

    function loadActiveProviders() {
        onValue(settingsRef, (snap) => {
            shipProviderSelect.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© --</option>';
            savedProvidersList.innerHTML = '';
            if(snap.exists()) {
                Object.entries(snap.val()).forEach(([k, p]) => {
                    const opt = document.createElement('option'); opt.value = k; opt.textContent = p.displayName; shipProviderSelect.appendChild(opt);
                    const div = document.createElement('div'); div.className = 'provider-item';
                    div.style.cssText = "display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border: 1px solid #ddd; padding: 10px 15px; border-radius: 8px; margin-bottom: 8px;";
                    div.innerHTML = `<div>${p.displayName} <small style="color:blue">(${p.driverType})</small></div><button class="btn-delete-prov" onclick="window.delProv('${k}')" style="background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Ø­Ø°Ù ğŸ—‘ï¸</button>`;
                    savedProvidersList.appendChild(div);
                });
            }
        });
    }
    window.delProv = async (k) => { if(confirm('Ø­Ø°ÙØŸ')) await remove(ref(db, `delivery_settings/${k}`)); };

    onValue(zonesRef, (s) => {
        const c = document.getElementById('zonesContainer');
        c.innerHTML = '';
        if (s.exists()) Object.entries(s.val()).forEach(([k, v]) => {
            const wilayaList = v.wilayas ? v.wilayas.join('ØŒ ') : '';
            c.innerHTML += `
                <div class="zone-card" style="background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px; margin-bottom: 8px; position: relative;">
                    <button class="delete-zone-btn" onclick="window.delZ('${k}')" style="position: absolute; left: 10px; top: 10px; background: #ffcdd2; color: #c62828; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer;">x</button>
                    <div style="margin-top: 15px; margin-bottom: 10px; font-size: 0.9rem; color: #333; line-height: 1.4;">
                        <strong>Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ù…Ø´Ù…ÙˆÙ„Ø©:</strong><br>
                        ${wilayaList}
                    </div>
                    <div style="border-top: 1px solid #eee; padding-top: 8px;">
                        <span class="price-badge" style="padding: 2px 8px; border-radius: 4px; font-weight: bold; background: #e8f5e9; color: #2e7d32;">ğŸ  ${v.homePrice} Ø¯Ø¬</span>
                        <span class="price-badge" style="padding: 2px 8px; border-radius: 4px; font-weight: bold; background: #e3f2fd; color: #1565c0;">ğŸ¢ ${v.deskPrice || 0} Ø¯Ø¬</span>
                    </div>
                </div>`;
        });
    });
    window.delZ=(k)=>{if(confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŸ')) remove(ref(db,`shipping_zones/${k}`));};

    // =======================================================
    // Ø¯ÙˆØ§Ù„ ÙØªØ­ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ù„Ø­ÙØ¸ Ù…Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
    // =======================================================
    window.openDetails = async (id) => { 
        const orderSnap = await get(ref(db, 'orders/'+id)); 
        if(orderSnap.exists()) { 
            const o = orderSnap.val(); 
            document.getElementById('currentOrderId').value = id; 
            document.getElementById('editName').value = o.customerName || o.name; 
            document.getElementById('editPhone').value = o.customerPhone || o.phone; 
            document.getElementById('editWilaya').value = o.customerWilaya || o.state; 
            document.getElementById('editCommune').value = o.customerCommune||''; 
            document.getElementById('editAddress').value = o.customerAddress || o.address; 
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø±
            let currentTotal = parseFloat(o.productTotal); 
            if(isNaN(currentTotal)) currentTotal = calculateProductOnlyPrice(o); 
            let marketingDiscount = 0; 
            if(o.productId) { 
                try {
                    const prodSnap = await get(ref(db, `products/${o.productId}`)); 
                    if(prodSnap.exists()) marketingDiscount = parseFloat(prodSnap.val().marketingDiscount || 0); 
                } catch(e) {}
            } 
            const qty = parseInt(o.quantity || 1); 
            let netPrice = currentTotal - (marketingDiscount * qty); 
            if(netPrice < 0) netPrice = 0; 
            document.getElementById('editProductPrice').value = netPrice; 

            // Ø¶Ø¨Ø· Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
            const isDesk = (o.deliveryOption && (o.deliveryOption.includes('desk') || o.deliveryOption.includes('Ù…ÙƒØªØ¨')));
            document.getElementById('editDeliveryOption').value = isDesk ? 'desk' : 'home';

            document.getElementById('orderDetailModal').classList.remove('hidden'); 
        } 
    }

    document.getElementById('closeDetailModal').addEventListener('click',()=>document.getElementById('orderDetailModal').classList.add('hidden'));

    document.getElementById('saveChangesBtn').addEventListener('click',async()=>{ 
        const id=document.getElementById('currentOrderId').value; 
        const delOptionVal = document.getElementById('editDeliveryOption').value;
        const delOptionText = delOptionVal === 'desk' ? 'Stop Desk (Ù…ÙƒØªØ¨)' : 'Home (Ù…Ù†Ø²Ù„)';

        await update(ref(db,'orders/'+id), { 
            customerName:document.getElementById('editName').value, 
            customerPhone:document.getElementById('editPhone').value, 
            customerWilaya:document.getElementById('editWilaya').value, 
            customerCommune:document.getElementById('editCommune').value, 
            customerAddress:document.getElementById('editAddress').value, 
            productTotal: parseFloat(document.getElementById('editProductPrice').value),
            deliveryOption: delOptionText // Ø­ÙØ¸ Ø®ÙŠØ§Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        }); 
        document.getElementById('orderDetailModal').classList.add('hidden'); 
        alert("âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­"); 
    });

    function renderWilayaCheckboxes(){ const g=document.getElementById('wilayaGrid'); g.innerHTML=''; allWilayas.forEach(w=>{ g.innerHTML+=`<div class="wilaya-checkbox-item" style="font-size: 0.85rem; display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="wilaya-chk" value="${w.split('. ')[1]}"><span>${w.split('. ')[1]}</span></div>`; }); }
    document.getElementById('selectAllBtn').addEventListener('click',()=>{ const c=document.querySelectorAll('.wilaya-chk'); if(c.length>0){const s=!c[0].checked;c.forEach(i=>i.checked=s);} });
    document.getElementById('saveZoneBtn').addEventListener('click',async()=>{ const h=document.getElementById('homePrice').value, d=document.getElementById('deskPrice').value; const sel=[]; document.querySelectorAll('.wilaya-chk:checked').forEach(c=>sel.push(c.value)); if(!h||sel.length==0) return alert('Ø®Ø·Ø£'); await push(zonesRef,{homePrice:h,deskPrice:d,wilayas:sel}); alert('ØªÙ…'); renderWilayaCheckboxes(); });
</script>

<script>
    function toggleMenu() {
      const links = document.querySelector('nav .links');
      if(links) links.classList.toggle('open');
    }
</script>
</body>
</html>