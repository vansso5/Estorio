<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø±Ø¨Ø·</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="admin-style.css">

  <style>
      /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø®Ø§ØµØ© Ø¨ØµÙØ­Ø© Ø§Ù„Ø´Ø­Ù† */
      .form-section-title {
          font-size: 1.1rem; font-weight: bold; color: var(--primary-color);
          margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 5px;
      }
      .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
      
      .provider-item {
          display: flex; justify-content: space-between; align-items: center;
          background: #f8f9fa; border: 1px solid #ddd; padding: 10px 15px;
          border-radius: 8px; margin-bottom: 8px;
      }
      .btn-delete-prov {
          background: #ffebee; color: #c62828; border: 1px solid #ffcdd2;
          padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.85rem;
      }
      .btn-delete-prov:hover { background: #ef5350; color: white; }
      
      .search-wrapper { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
      
      #sendBulkBtn {
          height: 50px !important; min-height: 50px;
          font-size: 1rem; font-weight: bold; padding: 0 25px;
          background-color: var(--primary-color); color: white;
          border: none; border-radius: 6px; cursor: pointer;
          width: 100%;
          transition: 0.3s;
      }
      #sendBulkBtn:hover { filter: brightness(0.9); }
      #sendBulkBtn:disabled { background-color: #ccc; cursor: not-allowed; }

      #shippingOrdersContainer .order-row {
          display: flex; align-items: center; justify-content: space-between;
          padding: 12px 15px; background: #fff; border-radius: 8px; margin-bottom: 8px;
          border: 1px solid #eee; border-right: 4px solid var(--warning-color);
          transition: 0.2s; cursor: pointer;
      }
      #shippingOrdersContainer .order-row:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.05); background-color: #fafafa; }
      
      .order-checkbox { transform: scale(1.3); margin-left: 15px; cursor: pointer; }

      .wilaya-grid {
          display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
          gap: 10px; margin-top: 15px; max-height: 200px; overflow-y: auto; 
          padding: 10px; background: #f9f9f9; border: 1px solid #ddd;
      }
      .wilaya-checkbox-item { font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }
      
      .zone-card { 
          background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px; 
          margin-bottom: 8px; position: relative;
      }
      .price-badge { padding: 2px 8px; border-radius: 4px; font-weight: bold; background: #e8f5e9; color: #2e7d32; }
      
      .delete-zone-btn {
          position: absolute; left: 10px; top: 10px;
          background: #ffcdd2; color: #c62828; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer;
      }
      
      .loading-message { text-align: center; color: #777; padding: 20px; }
  </style>
</head>
<body>

  <nav>
    <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>
    <div class="logo">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
    <div class="links">
      <a href="admin-products.html" class="nav-link">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
      <a href="admin-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</a>
      <a href="completed-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</a>
      <a href="admin-analytics.html" class="nav-link">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</a>
      <a href="admin-settings.html" class="nav-link">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
      <a href="admin-shipping.html" class="nav-link active">Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø±Ø¨Ø·</a>
      <a href="#" id="logoutBtn" class="nav-link" style="display:none;">Ø®Ø±ÙˆØ¬</a>
    </div>
  </nav>

  <div class="container">
    
    <!-- ================= Ø§Ù„Ù‚Ø³Ù… 1: Ø¥Ø¯Ø§Ø±Ø© Ø´Ø±ÙƒØ§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ ================= -->
    <h2>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø´Ø±ÙƒØ§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ (API)</h2>
    <div class="form-card" style="margin-bottom: 30px;">
        <div class="form-section-title">Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø© / ØªØ¹Ø¯ÙŠÙ„</div>
        <div class="settings-grid">
            <div>
                <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©:</label>
                <input type="text" id="provName" class="search-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: Yalidine, Guepex...">
            </div>
            <div>
                <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø±Ø§Ø¨Ø· API (Base URL):</label>
                <input type="text" id="provUrl" class="search-input" placeholder="https://api.domain.com/v1/parcels">
            </div>
            <div>
                <label style="font-weight:bold; display:block; margin-bottom:5px;">API Key / User ID:</label>
                <input type="text" id="provKey" class="search-input">
            </div>
            <div>
                <label style="font-weight:bold; display:block; margin-bottom:5px;">API Token / Password:</label>
                <input type="text" id="provToken" class="search-input">
            </div>
            <div>
                <label style="font-weight:bold; display:block; margin-bottom:5px;">Ù‡ÙŠÙƒÙ„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Driver):</label>
                <select id="provDriver" class="search-input">
                    <option value="yalidine_style" selected>Ù†Ø¸Ø§Ù… Yalidine / Guepex</option>
                    <option value="standard">Ù†Ø¸Ø§Ù… Ù‚ÙŠØ§Ø³ÙŠ (Standard)</option>
                </select>
            </div>
            <div>
                <label style="font-weight:bold; display:block; margin-bottom:5px;">ØµÙŠØºØ© Ø§Ù„ÙˆÙ„Ø§ÙŠØ©:</label>
                <select id="provWilayaFormat" class="search-input">
                    <option value="french_name" selected>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ© (Alger)</option>
                    <option value="id">Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ© (16)</option>
                    <option value="arabic_name">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±)</option>
                </select>
            </div>
        </div>
        <button id="saveProviderBtn" class="save-btn" style="margin-top:15px; width:100%;">Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</button>
        
        <div style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px;">
            <label style="font-weight:bold; display:block; margin-bottom:10px;">Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</label>
            <div id="savedProvidersList"><p class="loading-message">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
        </div>
    </div>

    <!-- ================= Ø§Ù„Ù‚Ø³Ù… 2: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ================= -->
    <h2>ğŸ“¦ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Shipping)</h2>
    <div class="form-card">
        <div class="search-wrapper">
            <div style="flex:3; min-width: 250px;">
                <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„:</label>
                <select id="shipProviderSelect" class="search-input">
                    <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© --</option>
                </select>
            </div>
            
            <div style="flex:1; display:flex; align-items:flex-end;">
                <button id="sendBulkBtn">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
            </div>
        </div>

        <h3 style="margin-top:20px; border-bottom:1px solid #eee; padding-bottom:10px;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ² (Processing)</h3>
        <div id="shippingOrdersContainer" class="orders-grid">
            <p class="loading-message">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
        </div>
    </div>

    <hr style="border: 0; border-top: 2px dashed #ccc; margin: 40px 0;">

    <!-- ================= Ø§Ù„Ù‚Ø³Ù… 3: Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ (Zones) ================= -->
    <h2>ğŸ’° ØªØ³Ø¹ÙŠØ±Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ (Ù„Ù„Ù…ØªØ¬Ø±)</h2>
    <div class="form-card">
      <div class="price-inputs-row" style="display:flex; gap:10px; margin-bottom:10px;">
           <div class="price-group" style="flex:1;">
             <label style="display:block; font-weight:bold; color:#2e7d32;">Ø³Ø¹Ø± Ø§Ù„Ù…Ù†Ø²Ù„ (Home):</label>
             <input type="number" id="homePrice" class="search-input" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„ØªØ³Ø¹ÙŠØ±Ù‡">
           </div>
           <div class="price-group" style="flex:1;">
             <label style="display:block; font-weight:bold; color:#2e7d32;">Ø³Ø¹Ø± Ø§Ù„Ù…ÙƒØªØ¨ (Desk):</label>
             <input type="number" id="deskPrice" class="search-input" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„ØªØ³Ø¹ÙŠØ±Ù‡">
           </div>
      </div>
      
      <div class="wilaya-controls">
         <button type="button" id="selectAllBtn" class="add-btn" style="padding: 2px 10px; font-size:0.8rem;">ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„</button>
      </div>
      <div id="wilayaGrid" class="wilaya-grid"></div>
      <button id="saveZoneBtn" class="save-btn" style="margin-top:15px;">Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¹ÙŠØ±Ø©</button>
    </div>
    <div id="zonesContainer" class="orders-grid"></div>

  </div>

  <!-- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹) -->
  <div id="orderDetailModal" class="modal hidden">
    <div class="modal-content">
      <button class="close-modal-btn" id="closeDetailModal">&times;</button>
      <h3>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h3>
      <div class="details-section">
          
          <label style="display:block;margin-bottom:5px;">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input type="text" id="editName" class="search-input" style="margin-bottom:10px;">
          
          <label style="display:block;margin-bottom:5px;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input type="text" id="editPhone" class="search-input" style="margin-bottom:10px;">
          
          <div style="display:flex; gap:10px;">
              <div style="flex:1">
                  <label style="display:block;margin-bottom:5px;">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</label>
                  <input type="text" id="editWilaya" class="search-input" style="margin-bottom:10px;">
              </div>
              <div style="flex:1">
                  <label style="display:block;margin-bottom:5px;">Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©</label>
                  <input type="text" id="editCommune" class="search-input" style="margin-bottom:10px;">
              </div>
          </div>

          <label style="display:block;margin-bottom:5px;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
          <input type="text" id="editAddress" class="search-input" style="margin-bottom:10px;">
          
          <label style="display:block;margin-bottom:5px;">Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØµÙŠÙ„</label>
          <select id="editDeliveryType" class="search-input" style="margin-bottom:10px;">
              <option value="home">ğŸ  ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…Ù†Ø²Ù„</option>
              <option value="desk">ğŸ¢ ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…ÙƒØªØ¨ (Stop Desk)</option>
          </select>

          <label style="color:var(--primary-color); font-weight:bold; display:block; margin-bottom:5px;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¸Ø§Ù‡Ø± (Ù„Ù„Ø²ÙŠÙ†Ø© ÙÙ‚Ø·):</label>
          <input type="number" id="editProductPrice" class="search-input" style="margin-bottom:5px; border:2px solid var(--primary-color);">
          <small style="color:#666; display:block; margin-bottom:10px;">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠØŒ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠ Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®ØµÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</small>

          <input type="hidden" id="currentOrderId">
          
          <div class="modal-actions">
              <button id="saveChangesBtn" class="save-btn">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
              <button id="cancelOrderBtn" class="btn-delete" style="background:#ef5350; color:white; border:none; padding:10px; border-radius:5px;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
          </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
      authDomain: "myestore-34f65.firebaseapp.com",
      databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
      projectId: "myestore-34f65",
      storageBucket: "myestore-34f65.firebasestorage.app",
      messagingSenderId: "14078917211",
      appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
      measurementId: "G-9181DX0XNJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const ordersRef = ref(db, 'orders');
    const settingsRef = ref(db, 'delivery_settings');
    const zonesRef = ref(db, 'shipping_zones');

    const shippingContainer = document.getElementById('shippingOrdersContainer');
    const shipProviderSelect = document.getElementById('shipProviderSelect');
    const savedProvidersList = document.getElementById('savedProvidersList');
    
    onAuthStateChanged(auth, (user) => {
        if (!user) { window.location.href = 'admin-login.html'; } 
        else { document.getElementById('logoutBtn').style.display = 'block'; loadActiveProviders(); renderWilayaCheckboxes(); }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => { await signOut(auth); window.location.href = 'admin-login.html'; });

    // ================= 1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª =================
    document.getElementById('saveProviderBtn').addEventListener('click', async function() {
        const name = document.getElementById('provName').value.trim();
        const url = document.getElementById('provUrl').value.trim();
        const key = document.getElementById('provKey').value.trim();
        const token = document.getElementById('provToken').value.trim();
        const driver = document.getElementById('provDriver').value;
        const wFormat = document.getElementById('provWilayaFormat').value;

        if(!name || !url || !key) { alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©."); return; }

        const btn = this; btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; btn.disabled = true;
        const providerId = name.replace(/\s+/g, '_').toLowerCase();
        
        try {
            await update(ref(db, `delivery_settings/${providerId}`), {
                displayName: name, apiUrl: url, apiKey: key, apiToken: token,
                driverType: driver, wilayaFormat: wFormat, active: true
            });
            alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø±ÙƒØ©!");
            document.getElementById('provName').value = ''; document.getElementById('provKey').value = ''; document.getElementById('provToken').value = '';
        } catch (e) { alert("Ø®Ø·Ø£: " + e.message); } 
        finally { btn.textContent = "Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©"; btn.disabled = false; }
    });

    function loadActiveProviders() {
        onValue(settingsRef, (snapshot) => {
            shipProviderSelect.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ù„Ù„Ø´Ø­Ù† --</option>';
            savedProvidersList.innerHTML = '';
            if(snapshot.exists()) {
                const settings = snapshot.val();
                let hasActive = false;
                Object.keys(settings).forEach(key => {
                    const p = settings[key];
                    if(p.apiKey) {
                        hasActive = true;
                        const option = document.createElement('option');
                        option.value = key; option.textContent = p.displayName || key;
                        shipProviderSelect.appendChild(option);
                        const div = document.createElement('div');
                        div.className = 'provider-item';
                        div.innerHTML = `<div class="provider-info"><h4>${p.displayName}</h4><small>ğŸ”— ${p.apiUrl} | ğŸ“¦ ${p.driverType}</small></div><button class="btn-delete-prov" onclick="window.deleteProv('${key}')">Ø­Ø°Ù ğŸ—‘ï¸</button>`;
                        savedProvidersList.appendChild(div);
                    }
                });
                if(!hasActive) { shipProviderSelect.innerHTML = '<option disabled>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª</option>'; savedProvidersList.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª Ù…Ø­ÙÙˆØ¸Ø©.</p>'; }
            } else { shipProviderSelect.innerHTML = '<option disabled>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª</option>'; savedProvidersList.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª Ù…Ø­ÙÙˆØ¸Ø©.</p>'; }
        });
    }
    window.deleteProv = async (key) => { if(confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙƒØ©ØŸ')) await remove(ref(db, `delivery_settings/${key}`)); };

    // ================= 2. Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²) =================
    onValue(ordersRef, (snapshot) => {
        shippingContainer.innerHTML = '';
        const orders = snapshot.val();
        if(!orders) { shippingContainer.innerHTML = '<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</p>'; return; }
        const sorted = Object.entries(orders).sort((a,b) => b[1].timestamp - a[1].timestamp);
        let count = 0;
        
        sorted.forEach(([id, order]) => {
            const status = (order.status || '').toLowerCase();
            if(!status.includes('processing') && !status.includes('ØªØ¬Ù‡ÙŠØ²')) return;
            count++;
            
            const row = document.createElement('div');
            row.className = 'order-row';
            const isStopDesk = (order.deliveryOption && (order.deliveryOption.includes('desk') || order.deliveryOption.includes('Ù…ÙƒØªØ¨')));
            const typeIcon = isStopDesk ? 'ğŸ¢' : 'ğŸ ';
            
            // Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·: Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¯ÙØ¹Ù‡ Ø§Ù„Ø²Ø¨ÙˆÙ†
            // (Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„Ø´Ø±ÙƒØ© ØªØªÙ… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„)
            const totalToCollect = order.totalPrice || 0;
            
            row.innerHTML = `
                <div class="row-info" style="display:flex; justify-content: flex-start; align-items:center;">
                    <input type="checkbox" class="order-checkbox" value="${id}">
                    <div style="display:flex; flex-direction:column; margin-right:15px;">
                        <span class="row-name" style="font-weight:bold;">${order.customerName || order.name}</span>
                        <small style="color:#777;">
                            ${typeIcon} ${order.customerWilaya || order.state || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} | 
                            <span style="color:var(--success-color); font-weight:bold;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${totalToCollect} Ø¯Ø¬</span>
                        </small>
                    </div>
                </div>
                <div onclick="window.openDetails('${id}')" style="cursor:pointer; background:#f0f2f5; padding:8px 15px; border-radius:20px; font-size:0.85rem; font-weight:bold; color:var(--primary-color);">ØªØ¹Ø¯ÙŠÙ„ âœ</div>
            `;
            shippingContainer.appendChild(row);
        });
        if(count === 0) shippingContainer.innerHTML = '<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ².</p>';
    });

    const wilayaMapping = { "Ø£Ø¯Ø±Ø§Ø±": "Adrar", "Ø§Ù„Ø´Ù„Ù": "Chlef", "Ø§Ù„Ø£ØºÙˆØ§Ø·": "Laghouat", "Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ": "Oum El Bouaghi", "Ø¨Ø§ØªÙ†Ø©": "Batna", "Ø¨Ø¬Ø§ÙŠØ©": "BÃ©jaÃ¯a", "Ø¨Ø³ÙƒØ±Ø©": "Biskra", "Ø¨Ø´Ø§Ø±": "BÃ©char", "Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©": "Blida", "Ø§Ù„Ø¨ÙˆÙŠØ±Ø©": "Bouira", "ØªÙ…Ù†Ø±Ø§Ø³Øª": "Tamanrasset", "ØªØ¨Ø³Ø©": "TÃ©bessa", "ØªÙ„Ù…Ø³Ø§Ù†": "Tlemcen", "ØªÙŠØ§Ø±Øª": "Tiaret", "ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ": "Tizi Ouzou", "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±": "Alger", "Ø§Ù„Ø¬Ù„ÙØ©": "Djelfa", "Ø¬ÙŠØ¬Ù„": "Jijel", "Ø³Ø·ÙŠÙ": "SÃ©tif", "Ø³Ø¹ÙŠØ¯Ø©": "SaÃ¯da", "Ø³ÙƒÙŠÙƒØ¯Ø©": "Skikda", "Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³": "Sidi Bel AbbÃ¨s", "Ø¹Ù†Ø§Ø¨Ø©": "Annaba", "Ù‚Ø§Ù„Ù…Ø©": "Guelma", "Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©": "Constantine", "Ø§Ù„Ù…Ø¯ÙŠØ©": "MÃ©dÃ©a", "Ù…Ø³ØªØºØ§Ù†Ù…": "Mostaganem", "Ø§Ù„Ù…Ø³ÙŠÙ„Ø©": "M'Sila", "Ù…Ø¹Ø³ÙƒØ±": "Mascara", "ÙˆØ±Ù‚Ù„Ø©": "Ouargla", "ÙˆÙ‡Ø±Ø§Ù†": "Oran", "Ø§Ù„Ø¨ÙŠØ¶": "El Bayadh", "Ø¥Ù„ÙŠØ²ÙŠ": "Illizi", "Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬": "Bordj Bou Arreridj", "Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³": "BoumerdÃ¨s", "Ø§Ù„Ø·Ø§Ø±Ù": "El Tarf", "ØªÙ†Ø¯ÙˆÙ": "Tindouf", "ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª": "Tissemsilt", "Ø§Ù„ÙˆØ§Ø¯ÙŠ": "El Oued", "Ø®Ù†Ø´Ù„Ø©": "Khenchela", "Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³": "Souk Ahras", "ØªÙŠØ¨Ø§Ø²Ø©": "Tipaza", "Ù…ÙŠÙ„Ø©": "Mila", "Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰": "AÃ¯n Defla", "Ø§Ù„Ù†Ø¹Ø§Ù…Ø©": "NaÃ¢ma", "Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª": "AÃ¯n TÃ©mouchent", "ØºØ±Ø¯Ø§ÙŠØ©": "GhardaÃ¯a", "ØºÙ„ÙŠØ²Ø§Ù†": "Relizane", "ØªÙŠÙ…ÙŠÙ…ÙˆÙ†": "Timimoun", "Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±": "Bordj Badji Mokhtar", "Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„": "Ouled Djellal", "Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³": "BÃ©ni AbbÃ¨s", "Ø¥Ù† ØµØ§Ù„Ø­": "In Salah", "Ø¥Ù† Ù‚Ø²Ø§Ù…": "In Guezzam", "ØªÙ‚Ø±Øª": "Touggourt", "Ø¬Ø§Ù†Øª": "Djanet", "Ø§Ù„Ù…ØºÙŠØ±": "El M'Ghair", "Ø§Ù„Ù…Ù†ÙŠØ¹Ø©": "El Meniaa" };

    // ===============================================
    // ğŸ”¥ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ØµØ­Ø­ (Ù…Ø¹ ÙƒØ´Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¯Ù‚ÙŠÙ‚) ğŸ”¥
    // ===============================================
    document.getElementById('sendBulkBtn').addEventListener('click', async function() {
        const btn = this;
        const providerId = shipProviderSelect.value; 
        const checks = document.querySelectorAll('.order-checkbox:checked');
        
        if(!providerId || checks.length === 0) { alert('Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª'); return; }
        if(!confirm(`Ø¥Ø±Ø³Ø§Ù„ ${checks.length} Ø·Ù„Ø¨ØŸ`)) return;

        btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©..."; btn.disabled = true;

        let apiData = {};
        try {
            const settingsSnap = await get(ref(db, `delivery_settings/${providerId}`));
            if(settingsSnap.exists()) apiData = settingsSnap.val();
            else throw new Error("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
        } catch (e) { alert(e.message); btn.textContent = "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯"; btn.disabled = false; return; }

        let successCount = 0; let failCount = 0;
        let detailedErrors = ""; // Ù„ØªØ¬Ù…ÙŠØ¹ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£

        for (const chk of checks) {
            const orderId = chk.value;
            try {
                // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
                const orderSnap = await get(ref(db, `orders/${orderId}`));
                if (!orderSnap.exists()) continue;
                const order = orderSnap.val();

                // 2. ğŸ”¥ Ø¬Ù„Ø¨ Ø§Ù„Ø®ØµÙ… Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠ ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¯Ù‚Ø© ğŸ”¥
                let marketingDiscountPerUnit = 0;
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Product ID Ù‚Ø¨Ù„ Ø¬Ù„Ø¨Ù‡
                if(order.productId) {
                    const productSnap = await get(ref(db, `products/${order.productId}`));
                    if(productSnap.exists()) {
                        marketingDiscountPerUnit = parseFloat(productSnap.val().marketingDiscount || 0);
                    }
                }

                // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¢Ù…Ù† ---
                const quantity = parseInt(order.quantity || 1);
                
                // Ù†Ø³ØªØ®Ø¯Ù… productTotal Ø¥Ø°Ø§ ÙˆØ¬Ø¯ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… (totalPrice - shippingPrice)
                // ÙˆØ¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯Ø§ Ù†Ø³ØªØ®Ø¯Ù… totalPrice ÙƒØ®ÙŠØ§Ø± Ø£Ø®ÙŠØ±
                let inflatedTotal = parseFloat(order.productTotal);
                if (isNaN(inflatedTotal)) {
                    inflatedTotal = parseFloat(order.totalPrice || 0) - parseFloat(order.shippingPrice || 0);
                }
                if (isNaN(inflatedTotal)) inflatedTotal = 0; // Ø­Ù…Ø§ÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠØ©

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®ØµÙ…
                let totalDiscount = marketingDiscountPerUnit * quantity;
                
                // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØµØ§ÙÙŠ
                let finalPriceToSend = inflatedTotal - totalDiscount;
                
                // Ù…Ù…Ù†ÙˆØ¹ Ø¥Ø±Ø³Ø§Ù„ Ø³Ø¹Ø± Ø³Ø§Ù„Ø¨ Ø£Ùˆ NaN
                if (isNaN(finalPriceToSend) || finalPriceToSend < 0) finalPriceToSend = 0;

                // -----------------------------

                // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                let rawWilaya = order.customerWilaya || order.state || "";
                let cleanWilaya = rawWilaya.replace(/^[0-9]+[\.\-\s]*/, '').trim();
                let finalWilaya = apiData.wilayaFormat === 'french_name' ? (wilayaMapping[cleanWilaya] || cleanWilaya) : cleanWilaya;
                
                let phone = (order.customerPhone || order.phone || "").replace(/[^0-9]/g, '');
                if (phone.length === 9) phone = '0' + phone;

                let isStopDesk = (order.deliveryOption && (order.deliveryOption.includes('desk') || order.deliveryOption.includes('Ù…ÙƒØªØ¨')));
                
                let fullName = (order.customerName || order.name || "Client").trim();
                let splitName = fullName.split(" ");
                let firstName = splitName[0];
                let lastName = splitName.slice(1).join(" ") || ".";

                let parcelData = {};
                
                if (apiData.driverType === 'yalidine_style') {
                    parcelData = {
                        "order_id": orderId.replace('#', ''),
                        "firstname": firstName,
                        "familyname": lastName,
                        "contact_phone": phone,
                        "address": order.customerAddress || order.address || cleanWilaya,
                        "to_wilaya_name": finalWilaya,
                        "to_commune_name": finalWilaya, 
                        "product_list": order.productName || "Colis",
                        
                        "price": finalPriceToSend, // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØµØ§ÙÙŠ
                        "freeshipping": false,     // Ø§Ù„Ø´Ø±ÙƒØ© ØªØ¶ÙŠÙ Ø§Ù„ØªÙˆØµÙŠÙ„
                        "is_stopdesk": isStopDesk,
                        "has_exchange": false
                    };
                } else {
                    parcelData = { 
                        "name": fullName, 
                        "phone": phone, 
                        "price": finalPriceToSend, 
                        "free_shipping": 0 
                    };
                }

                // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„Ù„ØªØ£ÙƒØ¯
                console.log("Sending Payload:", parcelData);

                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(apiData.apiUrl);
                const res = await fetch(proxyUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'X-API-ID': apiData.apiKey, 'X-API-TOKEN': apiData.apiToken }, 
                    body: JSON.stringify([ parcelData ]) 
                });
                
                const resText = await res.text();
                let resJson;
                try { resJson = JSON.parse(resText); } catch (e) { throw new Error("Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³ÙŠØ±ÙØ± ØºÙŠØ± Ù…ÙÙ‡ÙˆÙ…Ø©: " + resText); }
                
                console.log("Server Response:", resJson);

                // ğŸ”¥ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ Ù…Ù† Ø§Ù„Ù†Ø¬Ø§Ø­ ğŸ”¥
                let isSuccess = false;
                let trackingCode = "Sent";

                // Ø­Ø§Ù„Ø© 1: Ø§Ù„Ø±Ø¯ Ù…ØµÙÙˆÙØ© (Yalidine)
                if (Array.isArray(resJson)) {
                    if (resJson[0] && (resJson[0].tracking || resJson[0].success === true)) {
                        isSuccess = true;
                        trackingCode = resJson[0].tracking || "Sent";
                    } else if (resJson[0] && resJson[0].error) {
                        throw new Error(JSON.stringify(resJson[0].error));
                    }
                } 
                // Ø­Ø§Ù„Ø© 2: Ø§Ù„Ø±Ø¯ ÙƒØ§Ø¦Ù† Ù…Ø¨Ø§Ø´Ø±
                else if (resJson.tracking || resJson.success === true) {
                    isSuccess = true;
                    trackingCode = resJson.tracking || "Sent";
                }
                // Ø­Ø§Ù„Ø© 3: ÙØ´Ù„ ØµØ±ÙŠØ­
                if (resJson.error || resJson.validation_error) {
                    throw new Error(JSON.stringify(resJson.error || resJson.validation_error));
                }

                if(isSuccess) {
                     await update(ref(db, `orders/${orderId}`), { 
                         status: 'Shipped', deliveryProvider: apiData.displayName, trackingCode: trackingCode, shippedAt: Date.now() 
                     });
                     successCount++;
                } else {
                    throw new Error("Ø±ÙØ¶ ØºØ§Ù…Ø¶: " + JSON.stringify(resJson));
                }

            } catch (e) { 
                console.error(e); 
                failCount++; 
                detailedErrors += `\n- Ø·Ù„Ø¨ ${orderId}: ${e.message.substring(0, 50)}...`; 
            }
        }

        let report = `Ø§Ù„Ù†ØªÙŠØ¬Ø©:\nâœ… Ù†Ø¬Ø§Ø­: ${successCount}\nâŒ ÙØ´Ù„: ${failCount}`;
        if (failCount > 0) report += `\n\nØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:${detailedErrors}`;
        
        alert(report);
        btn.textContent = "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯"; btn.disabled = false;
    });

    // ================= 5. Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ =================
    window.openDetails = (id) => {
        get(ref(db, 'orders/' + id)).then((snap) => {
            if(snap.exists()) {
                const order = snap.val();
                document.getElementById('currentOrderId').value = id;
                document.getElementById('editName').value = order.customerName || order.name || '';
                document.getElementById('editPhone').value = order.customerPhone || order.phone || '';
                document.getElementById('editWilaya').value = order.customerWilaya || order.state || '';
                document.getElementById('editCommune').value = order.customerCommune || order.city || '';
                document.getElementById('editAddress').value = order.customerAddress || order.address || '';
                
                // Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¸Ø§Ù‡Ø±)
                document.getElementById('editProductPrice').value = order.productTotal || order.productPrice || 0;

                document.getElementById('editDeliveryType').value = (order.deliveryOption && (order.deliveryOption.includes('desk') || order.deliveryOption.includes('Ù…ÙƒØªØ¨'))) ? 'desk' : 'home';
                
                let itemsHtml = '';
                if(order.items) {
                     const items = Array.isArray(order.items) ? order.items : Object.values(order.items);
                     items.forEach(item => { itemsHtml += `<div>ğŸ“¦ ${item.name} (x${item.quantity})</div>`; });
                } else { itemsHtml = `<div>ğŸ“¦ ${order.productName || 'Ù…Ù†ØªØ¬'}</div>`; }
                document.getElementById('productsList').innerHTML = itemsHtml;
                
                document.getElementById('orderDetailModal').classList.remove('hidden');
            }
        });
    };

    document.getElementById('closeDetailModal').addEventListener('click', () => document.getElementById('orderDetailModal').classList.add('hidden'));
    
    document.getElementById('saveChangesBtn').addEventListener('click', async () => {
        const id = document.getElementById('currentOrderId').value;
        const updates = {
            customerName: document.getElementById('editName').value,
            customerPhone: document.getElementById('editPhone').value,
            customerWilaya: document.getElementById('editWilaya').value,
            customerCommune: document.getElementById('editCommune').value,
            customerAddress: document.getElementById('editAddress').value,
            deliveryOption: document.getElementById('editDeliveryType').value,
            productTotal: parseFloat(document.getElementById('editProductPrice').value)
        };
        await update(ref(db, 'orders/'+id), updates);
        document.getElementById('orderDetailModal').classList.add('hidden');
        alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª.");
    });

    document.getElementById('cancelOrderBtn').addEventListener('click', async () => {
        const id = document.getElementById('currentOrderId').value;
        if(confirm('Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ')) {
            await update(ref(db, 'orders/'+id), { status: 'Cancelled' });
            document.getElementById('orderDetailModal').classList.add('hidden');
        }
    });

    // ================= 6. Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ (Zones) =================
    const allWilayas = [ "01. Ø£Ø¯Ø±Ø§Ø±", "02. Ø§Ù„Ø´Ù„Ù", "03. Ø§Ù„Ø£ØºÙˆØ§Ø·", "04. Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ", "05. Ø¨Ø§ØªÙ†Ø©", "06. Ø¨Ø¬Ø§ÙŠØ©", "07. Ø¨Ø³ÙƒØ±Ø©", "08. Ø¨Ø´Ø§Ø±", "09. Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©", "10. Ø§Ù„Ø¨ÙˆÙŠØ±Ø©", "11. ØªÙ…Ù†Ø±Ø§Ø³Øª", "12. ØªØ¨Ø³Ø©", "13. ØªÙ„Ù…Ø³Ø§Ù†", "14. ØªÙŠØ§Ø±Øª", "15. ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ", "16. Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", "17. Ø§Ù„Ø¬Ù„ÙØ©", "18. Ø¬ÙŠØ¬Ù„", "19. Ø³Ø·ÙŠÙ", "20. Ø³Ø¹ÙŠØ¯Ø©", "21. Ø³ÙƒÙŠÙƒØ¯Ø©", "22. Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³", "23. Ø¹Ù†Ø§Ø¨Ø©", "24. Ù‚Ø§Ù„Ù…Ø©", "25. Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©", "26. Ø§Ù„Ù…Ø¯ÙŠØ©", "27. Ù…Ø³ØªØºØ§Ù†Ù…", "28. Ø§Ù„Ù…Ø³ÙŠÙ„Ø©", "29. Ù…Ø¹Ø³ÙƒØ±", "30. ÙˆØ±Ù‚Ù„Ø©", "31. ÙˆÙ‡Ø±Ø§Ù†", "32. Ø§Ù„Ø¨ÙŠØ¶", "33. Ø¥Ù„ÙŠØ²ÙŠ", "34. Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬", "35. Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³", "36. Ø§Ù„Ø·Ø§Ø±Ù", "37. ØªÙ†Ø¯ÙˆÙ", "38. ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª", "39. Ø§Ù„ÙˆØ§Ø¯ÙŠ", "40. Ø®Ù†Ø´Ù„Ø©", "41. Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³", "42. ØªÙŠØ¨Ø§Ø²Ø©", "43. Ù…ÙŠÙ„Ø©", "44. Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰", "45. Ø§Ù„Ù†Ø¹Ø§Ù…Ø©", "46. Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª", "47. ØºØ±Ø¯Ø§ÙŠØ©", "48. ØºÙ„ÙŠØ²Ø§Ù†", "49. ØªÙŠÙ…ÙŠÙ…ÙˆÙ†", "50. Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±", "51. Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„", "52. Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³", "53. Ø¥Ù† ØµØ§Ù„Ø­", "54. Ø¥Ù† Ù‚Ø²Ø§Ù…", "55. ØªÙ‚Ø±Øª", "56. Ø¬Ø§Ù†Øª", "57. Ø§Ù„Ù…ØºÙŠØ±", "58. Ø§Ù„Ù…Ù†ÙŠØ¹Ø©" ];
    function renderWilayaCheckboxes() {
        const grid = document.getElementById('wilayaGrid');
        grid.innerHTML = '';
        allWilayas.forEach(w => {
            const clean = w.split('. ')[1] || w;
            const div = document.createElement('div');
            div.className = 'wilaya-checkbox-item';
            div.innerHTML = `<input type="checkbox" class="wilaya-chk" value="${clean}"> <span>${clean}</span>`;
            grid.appendChild(div);
        });
    }
    document.getElementById('selectAllBtn').addEventListener('click', () => {
        const chks = document.querySelectorAll('.wilaya-chk');
        if(chks.length > 0) { const firstState = chks[0].checked; chks.forEach(c => c.checked = !firstState); }
    });
    
    document.getElementById('saveZoneBtn').addEventListener('click', async () => {
        const home = document.getElementById('homePrice').value;
        const desk = document.getElementById('deskPrice').value;
        const selected = [];
        document.querySelectorAll('.wilaya-chk:checked').forEach(c => selected.push(c.value));
        if(!home || !desk || selected.length === 0) { alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙˆØ­Ø¯Ø¯ ÙˆÙ„Ø§ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
        await push(zonesRef, { homePrice: home, deskPrice: desk, wilayas: selected });
        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¹ÙŠØ±Ø©'); renderWilayaCheckboxes(); 
        document.getElementById('homePrice').value=''; document.getElementById('deskPrice').value='';
    });

    onValue(zonesRef, (snap) => {
        const cont = document.getElementById('zonesContainer');
        cont.innerHTML = '';
        if(snap.exists()) {
            const zones = snap.val();
            Object.entries(zones).forEach(([k, v]) => {
                const div = document.createElement('div');
                div.className = 'zone-card';
                div.innerHTML = `
                    <button class="delete-zone-btn" onclick="delZone('${k}')">x</button>
                    <div style="flex:1; margin-left: 10px;">
                        <div class="zone-header"><strong>Ù…Ø¬Ù…ÙˆØ¹Ø© (${v.wilayas ? v.wilayas.length : 0} ÙˆÙ„Ø§ÙŠØ©)</strong></div>
                        <div class="prices-display-row">
                            <span class="price-badge badge-eco">Eco</span> 
                            <span>ğŸ  ${v.homePrice} Ø¯Ø¬ | ğŸ¢ ${v.deskPrice} Ø¯Ø¬</span>
                        </div>
                    </div>
                `;
                cont.appendChild(div);
            });
        }
    });

    window.delZone = (k) => { if(confirm('Ø­Ø°ÙØŸ')) remove(ref(db, `shipping_zones/${k}`)); }
    window.toggleMenu = () => { document.querySelector('nav .links').classList.toggle('open'); };
  </script>
</body>
</html>