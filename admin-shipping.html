<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ø±ÙƒØ² Ø§Ù„Ø´Ø­Ù†</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="admin-style.css">

  <style>
      /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© --- */

      /* 1. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Tags) */
      .provider-tags-container {
          display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee;
      }
      .provider-tag {
          background-color: #e3f2fd; color: #0d47a1; border: 1px solid #bbdefb;
          padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold;
          display: flex; align-items: center; gap: 8px; animation: fadeIn 0.3s ease;
      }
      .provider-tag .remove-icon { cursor: pointer; color: #ef5350; font-weight: bold; font-size: 1.1rem; line-height: 1; }
      .provider-tag .remove-icon:hover { color: #c62828; }
      
      /* 2. Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­ */
      .success-message-box {
          display: none; background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc;
          padding: 10px; border-radius: 8px; margin-top: 15px; text-align: center; font-weight: bold;
      }

      /* 3. ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒØ¨ÙŠØ± */
      #sendBulkBtn {
          height: 60px !important;
          min-height: 60px;
          font-size: 1.1rem;
          font-weight: bold;
          padding: 0 30px;
          display: flex; align-items: center; justify-content: center;
          background-color: var(--primary-color); 
          color: white;
      }

      /* 4. ØªÙ†Ø³ÙŠÙ‚ ØµÙÙˆÙ Ø§Ù„Ø·Ù„Ø¨Ø§Øª */
      #shippingOrdersContainer .order-row {
          display: flex; align-items: center; justify-content: space-between;
          padding: 12px 15px; background: #fff; border-radius: 8px; margin-bottom: 8px;
          border: 1px solid #eee; border-right: 4px solid var(--warning-color);
          transition: 0.2s; cursor: pointer;
      }
      #shippingOrdersContainer .order-row:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.05); background-color: #fafafa; }
      
      .order-checkbox { transform: scale(1.3); margin-left: 15px; cursor: pointer; }
  </style>
</head>
<body>

  <nav>
    <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>
    <div class="logo">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
    <div class="links">
      <a href="admin-products.html" class="nav-link">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
      <a href="admin-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</a>
      <a href="completed-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</a>
      <a href="admin-analytics.html" class="nav-link">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</a>
      <a href="admin-settings.html" class="nav-link">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
      <a href="admin-shipping.html" class="nav-link active">Ø§Ù„Ø´Ø­Ù†</a>
      <a href="#" id="logoutBtn" class="nav-link" style="display:none;">Ø®Ø±ÙˆØ¬</a>
    </div>
  </nav>

  <div class="container">
    
    <!-- Ø§Ù„Ù‚Ø³Ù… 1: Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø¨Ø· -->
    <h2>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø´Ø±ÙƒØ§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</h2>
    <div class="form-card">
      <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø´Ø±ÙƒØ©</h3>
      
      <div class="search-wrapper">
          <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© :</label>
          <input type="text" id="providerNameInput" class="search-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: Guepex, Yalidine...">
          
          <div style="display:flex; gap:10px; margin-top:15px;">
            <div style="flex:1">
                <label style="font-weight:bold; display:block; margin-bottom:5px;">API Key (API ID):</label>
                <input type="text" id="apiKeyInput" class="search-input" placeholder="Ø£Ù„ØµÙ‚ Ø§Ù„Ù€ API ID Ù‡Ù†Ø§">
            </div>
            <div style="flex:1">
                <label style="font-weight:bold; display:block; margin-bottom:5px;">Token:</label>
                <input type="text" id="apiTokenInput" class="search-input" placeholder="Ø£Ù„ØµÙ‚ Ø§Ù„Ù€ Token Ù‡Ù†Ø§">
            </div>
          </div>

          <button id="saveConfigBtn" class="save-btn" style="margin-top:15px; width:100%;">Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</button>
          <div id="configSuccessMsg" class="success-message-box">âœ… ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­!</div>

          <div style="margin-top:15px;">
              <small style="color:#666;">Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹:</small>
              <div id="activeProvidersList" class="provider-tags-container"></div>
          </div>
      </div>
    </div>

    <!-- Ø§Ù„Ù‚Ø³Ù… 2: ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
    <h2>ğŸ“¦ ØªØ¬Ù‡ÙŠØ² ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
    <div class="form-card">
        <div class="search-wrapper" style="display:flex; gap:10px; align-items:center;">
            <div style="flex:2;">
                <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„:</label>
                <select id="shipProviderSelect" class="search-input">
                    <option value="" disabled selected>-- Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„... --</option>
                </select>
            </div>
            
            <div style="flex:1; display:flex; align-items:flex-end;">
                <button id="sendBulkBtn" class="add-btn">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</button>
            </div>
        </div>

        <h3 style="margin-top:20px; border-bottom:1px solid #eee; padding-bottom:10px;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ² (Processing)</h3>
        <div id="shippingOrdersContainer" class="orders-grid">
            <p class="loading-message">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
        </div>
    </div>

    <hr style="border: 0; border-top: 2px dashed #ccc; margin: 40px 0;">

    <!-- Ø§Ù„Ù‚Ø³Ù… 3: Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ -->
    <h2>ğŸ’° ØªØ³Ø¹ÙŠØ±Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ (Zones)</h2>
    <div class="form-card">
      <div class="price-inputs-row">
           <div class="price-group">
             <label>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†Ø²Ù„</label>
             <input type="number" id="homePrice" placeholder="600">
           </div>
           <div class="price-group">
             <label>Ø³Ø¹Ø± Ø§Ù„Ù…ÙƒØªØ¨</label>
             <input type="number" id="deskPrice" placeholder="400">
           </div>
      </div>
      <div class="wilaya-controls">
         <span>Ø­Ø¯Ø¯ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª:</span>
         <button type="button" id="selectAllBtn" class="select-all-btn">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
      </div>
      <div id="wilayaGrid" class="wilaya-grid"></div>
      <button id="saveZoneBtn" class="save-btn" style="margin-top:15px;">Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¹ÙŠØ±Ø©</button>
    </div>
    <h3 style="margin-top:20px;">Ø§Ù„ØªØ³Ø¹ÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h3>
    <div id="zonesContainer" class="orders-grid"></div>

  </div>

  <!-- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ -->
  <div id="orderDetailModal" class="modal hidden">
    <div class="modal-content">
      <button class="close-modal-btn" id="closeDetailModal">&times;</button>
      <h3>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h3>
      <div class="details-section">
          <label class="details-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input type="text" id="editName" class="search-input" style="margin-bottom:10px;">
          
          <label class="details-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input type="text" id="editPhone" class="search-input" style="margin-bottom:10px;">
          
          <div style="display:flex; gap:10px;">
              <div style="flex:1">
                  <label class="details-label">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</label>
                  <input type="text" id="editWilaya" class="search-input" style="margin-bottom:10px;">
              </div>
              <div style="flex:1">
                  <label class="details-label">Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©</label>
                  <input type="text" id="editCommune" class="search-input" style="margin-bottom:10px;">
              </div>
          </div>

          <label class="details-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
          <input type="text" id="editAddress" class="search-input" style="margin-bottom:10px;">
          
          <!-- Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØµÙŠÙ„ -->
          <label class="details-label">Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØµÙŠÙ„</label>
          <select id="editDeliveryType" class="search-input" style="margin-bottom:10px;">
              <option value="home">ğŸ  ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…Ù†Ø²Ù„</option>
              <option value="desk">ğŸ¢ ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…ÙƒØªØ¨ (Stop Desk)</option>
          </select>

          <div id="productsList" style="margin:15px 0; background:#f9f9f9; padding:10px; border-radius:5px;"></div>
          <input type="hidden" id="currentOrderId">
          
          <div class="modal-actions">
              <button id="saveChangesBtn" class="save-btn">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
              <button id="cancelOrderBtn" class="btn-delete">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
          </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
      authDomain: "myestore-34f65.firebaseapp.com",
      databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
      projectId: "myestore-34f65",
      storageBucket: "myestore-34f65.firebasestorage.app",
      messagingSenderId: "14078917211",
      appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
      measurementId: "G-9181DX0XNJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const ordersRef = ref(db, 'orders');
    const settingsRef = ref(db, 'delivery_settings');
    const zonesRef = ref(db, 'shipping_zones');

    const shippingContainer = document.getElementById('shippingOrdersContainer');
    const shipProviderSelect = document.getElementById('shipProviderSelect');
    const modal = document.getElementById('orderDetailModal');
    const closeModal = document.getElementById('closeDetailModal');
    
    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = 'admin-login.html';
        else {
            document.getElementById('logoutBtn').style.display = 'block';
            loadActiveProviders();
            renderWilayaCheckboxes();
        }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
        await signOut(auth); window.location.href = 'admin-login.html';
    });

    // 1. Ø­ÙØ¸ Ø§Ù„Ø´Ø±ÙƒØ§Øª
    document.getElementById('saveConfigBtn').addEventListener('click', async function() {
        const btn = this;
        const providerName = document.getElementById('providerNameInput').value.trim();
        const key = document.getElementById('apiKeyInput').value.trim();
        const token = document.getElementById('apiTokenInput').value.trim();

        if(!providerName) { alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©'); return; }
        if(!key) { alert('Ø£Ø¯Ø®Ù„ API ID'); return; }

        btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
        btn.disabled = true;

        try {
            const providerId = providerName.replace(/\s+/g, '_').toLowerCase();
            await update(ref(db, `delivery_settings/${providerId}`), { 
                displayName: providerName,
                apiKey: key, 
                apiToken: token 
            });
            
            const successMsg = document.getElementById('configSuccessMsg');
            successMsg.style.display = 'block';
            setTimeout(() => successMsg.style.display = 'none', 3000);

            document.getElementById('providerNameInput').value = '';
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('apiTokenInput').value = '';
            
        } catch (error) {
            alert("Ø®Ø·Ø£: " + error.message);
        } finally {
            btn.textContent = "Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©";
            btn.disabled = false;
        }
    });

    function loadActiveProviders() {
        onValue(settingsRef, (snapshot) => {
            shipProviderSelect.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ù„Ù„Ø´Ø­Ù† --</option>';
            const tagsContainer = document.getElementById('activeProvidersList');
            tagsContainer.innerHTML = '';

            if(snapshot.exists()) {
                const settings = snapshot.val();
                let hasActive = false;
                Object.keys(settings).forEach(key => {
                    const providerData = settings[key];
                    if(providerData.apiKey) {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = providerData.displayName || key; 
                        shipProviderSelect.appendChild(option);
                        
                        const tag = document.createElement('div');
                        tag.className = 'provider-tag';
                        tag.innerHTML = `<span>${providerData.displayName || key}</span><span class="remove-icon" onclick="deleteProvider('${key}')">&times;</span>`;
                        tagsContainer.appendChild(tag);
                        hasActive = true;
                    }
                });
                if(!hasActive) shipProviderSelect.innerHTML = '<option disabled>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª</option>';
            }
        });
    }

    window.deleteProvider = async (key) => {
        if(confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙƒØ©ØŸ')) await remove(ref(db, `delivery_settings/${key}`));
    };

    // 2. Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    onValue(ordersRef, (snapshot) => {
        shippingContainer.innerHTML = '';
        const orders = snapshot.val();
        if(!orders) {
            shippingContainer.innerHTML = '<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</p>';
            return;
        }

        const sorted = Object.entries(orders).sort((a,b) => b[1].timestamp - a[1].timestamp);
        let count = 0;

        sorted.forEach(([id, order]) => {
            const status = (order.status || '').toLowerCase();
            if(!status.includes('processing') && !status.includes('ØªØ¬Ù‡ÙŠØ²')) return;
            
            count++;
            const row = document.createElement('div');
            row.className = 'order-row';
            
            // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØµÙŠÙ„
            const isStopDesk = (order.deliveryOption && (order.deliveryOption.includes('desk') || order.deliveryOption.includes('Ù…ÙƒØªØ¨')));
            const typeIcon = isStopDesk ? 'ğŸ¢' : 'ğŸ ';
            
            row.innerHTML = `
                <div class="row-info" style="justify-content: flex-start;">
                    <input type="checkbox" class="order-checkbox" value="${id}">
                    <div style="display:flex; flex-direction:column; margin-right:15px;">
                        <span class="row-name">${order.customerName || order.name}</span>
                        <small style="color:#777;">
                            ${typeIcon} ${order.customerWilaya || order.state || ''} | 
                            <span style="color:var(--success-color); font-weight:bold;">${parseFloat(order.totalPrice || 0)} Ø¯Ø¬</span>
                        </small>
                    </div>
                </div>
                <div onclick="window.openDetails('${id}')" style="cursor:pointer; background:#f0f2f5; padding:8px 15px; border-radius:20px; font-size:0.85rem; font-weight:bold; color:var(--primary-color);">
                    ØªØ¹Ø¯ÙŠÙ„ âœ
                </div>
            `;
            shippingContainer.appendChild(row);
        });

        if(count === 0) shippingContainer.innerHTML = '<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ².</p>';
    });

    // 3. Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    window.openDetails = (id) => {
        get(ref(db, 'orders/' + id)).then((snap) => {
            if(snap.exists()) {
                const order = snap.val();
                document.getElementById('currentOrderId').value = id;
                document.getElementById('editName').value = order.customerName || order.name || '';
                document.getElementById('editPhone').value = order.customerPhone || order.phone || '';
                document.getElementById('editWilaya').value = order.customerWilaya || order.state || '';
                document.getElementById('editCommune').value = order.customerCommune || order.city || '';
                document.getElementById('editAddress').value = order.customerAddress || order.address || '';
                
                const deliveryType = (order.deliveryOption && (order.deliveryOption.includes('desk') || order.deliveryOption.includes('Ù…ÙƒØªØ¨'))) ? 'desk' : 'home';
                document.getElementById('editDeliveryType').value = deliveryType;

                const productsDiv = document.getElementById('productsList');
                let itemsHtml = '';
                if(order.items) {
                     const items = Array.isArray(order.items) ? order.items : Object.values(order.items);
                     items.forEach(item => {
                         itemsHtml += `<div>ğŸ“¦ ${item.name} <span style="font-weight:bold;">(x${item.quantity})</span></div>`;
                     });
                } else {
                    itemsHtml = `<div>ğŸ“¦ ${order.productName || 'Ù…Ù†ØªØ¬'}</div>`;
                }
                
                itemsHtml += `<div style="margin-top:10px; border-top:1px dashed #ccc; padding-top:5px; font-weight:bold;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: ${order.totalPrice} Ø¯Ø¬</div>`;
                
                productsDiv.innerHTML = itemsHtml;
                modal.classList.remove('hidden');
            }
        });
    };

    closeModal.addEventListener('click', () => modal.classList.add('hidden'));

    document.getElementById('saveChangesBtn').addEventListener('click', async () => {
        const id = document.getElementById('currentOrderId').value;
        const updates = {
            customerName: document.getElementById('editName').value,
            customerPhone: document.getElementById('editPhone').value,
            customerWilaya: document.getElementById('editWilaya').value,
            customerCommune: document.getElementById('editCommune').value,
            customerAddress: document.getElementById('editAddress').value,
            deliveryOption: document.getElementById('editDeliveryType').value,
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            name: document.getElementById('editName').value,
            phone: document.getElementById('editPhone').value,
            state: document.getElementById('editWilaya').value,
        };
        await update(ref(db, 'orders/'+id), updates);
        modal.classList.add('hidden');
    });

    document.getElementById('cancelOrderBtn').addEventListener('click', async () => {
        const id = document.getElementById('currentOrderId').value;
        if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) {
            await update(ref(db, 'orders/'+id), { status: 'Cancelled' });
            modal.classList.add('hidden');
        }
    });

    // ==========================================================
    // 4. Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (The Shipping Logic - Guepex & Others)
    // ==========================================================
    document.getElementById('sendBulkBtn').addEventListener('click', async function() {
        const btn = this;
        const providerId = shipProviderSelect.value; 
        const providerName = shipProviderSelect.options[shipProviderSelect.selectedIndex]?.text || providerId;
        const checks = document.querySelectorAll('.order-checkbox:checked');
        
        if(!providerId) { alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø±ÙƒØ© Ø´Ø­Ù† Ø£ÙˆÙ„Ø§Ù‹'); return; }
        if(checks.length === 0) { alert('Ù„Ù… ØªÙ‚Ù… Ø¨ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø·Ù„Ø¨!'); return; }
        if(!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ ${checks.length} Ø·Ù„Ø¨ Ø¹Ø¨Ø± (${providerName})ØŸ`)) return;

        btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ ...";
        btn.disabled = true;

        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        let apiData = null;
        try {
            const settingsSnap = await get(ref(db, `delivery_settings/${providerId}`));
            if(settingsSnap.exists()) apiData = settingsSnap.val();
            else throw new Error("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
        } catch (err) {
            alert(err.message);
            btn.textContent = "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©";
            btn.disabled = false;
            return;
        }

        let successCount = 0;
        let failCount = 0;
        let errorDetails = "";

        // 2. Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        for (const checkbox of checks) {
            const orderId = checkbox.value;
            try {
                const orderSnap = await get(ref(db, `orders/${orderId}`));
                if (!orderSnap.exists()) continue;
                const order = orderSnap.val();

                // Ø£) ØªÙ†Ø¸ÙŠÙ Ø§Ø³Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ© (Guepex ØªØ­ØªØ§Ø¬ Ø§Ø³Ù… Ù†Ø¸ÙŠÙ)
                let rawWilaya = order.customerWilaya || order.state || "";
                let cleanWilaya = rawWilaya.includes('.') ? rawWilaya.split('.').slice(1).join('.').trim() : rawWilaya;

                // Ø¨) ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨
                let fullName = (order.customerName || order.name || "Inconnu").trim();
                let firstName = fullName.split(' ')[0]; 
                let lastName = fullName.substring(firstName.length).trim() || ".";

                // Ø¬) ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØµÙŠÙ„ (Stop Desk)
                let isStopDesk = false;
                if(order.deliveryOption && (order.deliveryOption.toLowerCase().includes('desk') || order.deliveryOption.includes('Ù…ÙƒØªØ¨'))) {
                    isStopDesk = true;
                }

                // Ø¯) ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Payload)
                const parcelData = {
                    "firstname": firstName,
                    "lastname": lastName,
                    "phone": order.customerPhone || order.phone,
                    "address": order.customerAddress || order.address || cleanWilaya,
                    "wilaya": cleanWilaya, 
                    "commune": order.customerCommune || order.city || cleanWilaya, 
                    "price": parseFloat(order.totalPrice || 0), 
                    "freeshipping": false,
                    "is_stopdesk": isStopDesk, 
                    "has_exchange": false,
                    "product": order.productName || "Colis Divers",
                    "weight": 1 // ÙˆØ²Ù† Ø§ÙØªØ±Ø§Ø¶ÙŠ (1KG)
                };

                // Ù‡Ù€) Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± API (Ø§Ø³ØªØ®Ø¯Ø§Ù… Proxy Ù„ØªØ®Ø·ÙŠ CORS ÙÙŠ Localhost)
                const targetUrl = 'https://api.guepex.app/v1/parcels';
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(targetUrl);

                const response = await fetch(proxyUrl, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-ID': apiData.apiKey,
                        'X-API-TOKEN': apiData.apiToken
                    },
                    body: JSON.stringify(parcelData)
                });

                const resultText = await response.text();
                let result = {};
                try { result = JSON.parse(resultText); } catch(e) { result = { msg: resultText }; }

                // Ùˆ) Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø¬Ø§Ø­
                if (response.ok || result.success === true || result.tracking) { 
                    const updates = {};
                    updates[`orders/${orderId}/status`] = 'Shipped';
                    updates[`orders/${orderId}/deliveryProvider`] = providerName;
                    updates[`orders/${orderId}/trackingCode`] = result.tracking || result.id || "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
                    updates[`orders/${orderId}/shippedAt`] = Date.now();
                    await update(ref(db), updates);
                    successCount++;
                } else {
                    console.error("Guepex Error:", result);
                    failCount++;
                    // ÙÙƒ Ø´ÙØ±Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ù„ØªÙƒÙˆÙ† Ù…Ù‚Ø±ÙˆØ¡Ø©
                    let msg = "";
                    if (typeof result === 'string') msg = result;
                    else if (result.message) msg = JSON.stringify(result.message);
                    else if (result.errors) msg = JSON.stringify(result.errors);
                    else msg = JSON.stringify(result);

                    errorDetails += `\nâ›” ${firstName}: ${msg.substring(0, 150)}`;
                }

            } catch (err) {
                console.error("Sys Error:", err);
                failCount++;
                errorDetails += `\nâš ï¸ Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨ ${orderId}: ${err.message}`;
            }
        }

        let finalMsg = `Ø§Ù„Ù†ØªÙŠØ¬Ø©:\nâœ… Ù†Ø¬Ø§Ø­: ${successCount}`;
        if(failCount > 0) finalMsg += `\nâŒ ÙØ´Ù„: ${failCount}\n\nğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:${errorDetails}`;
        alert(finalMsg);
        
        btn.textContent = "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©";
        btn.disabled = false;
    });

    // Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ (Zones)
    const allWilayas = [ "01. Ø£Ø¯Ø±Ø§Ø±", "02. Ø§Ù„Ø´Ù„Ù", "03. Ø§Ù„Ø£ØºÙˆØ§Ø·", "04. Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ", "05. Ø¨Ø§ØªÙ†Ø©", "06. Ø¨Ø¬Ø§ÙŠØ©", "07. Ø¨Ø³ÙƒØ±Ø©", "08. Ø¨Ø´Ø§Ø±", "09. Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©", "10. Ø§Ù„Ø¨ÙˆÙŠØ±Ø©", "11. ØªÙ…Ù†Ø±Ø§Ø³Øª", "12. ØªØ¨Ø³Ø©", "13. ØªÙ„Ù…Ø³Ø§Ù†", "14. ØªÙŠØ§Ø±Øª", "15. ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ", "16. Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", "17. Ø§Ù„Ø¬Ù„ÙØ©", "18. Ø¬ÙŠØ¬Ù„", "19. Ø³Ø·ÙŠÙ", "20. Ø³Ø¹ÙŠØ¯Ø©", "21. Ø³ÙƒÙŠÙƒØ¯Ø©", "22. Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³", "23. Ø¹Ù†Ø§Ø¨Ø©", "24. Ù‚Ø§Ù„Ù…Ø©", "25. Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©", "26. Ø§Ù„Ù…Ø¯ÙŠØ©", "27. Ù…Ø³ØªØºØ§Ù†Ù…", "28. Ø§Ù„Ù…Ø³ÙŠÙ„Ø©", "29. Ù…Ø¹Ø³ÙƒØ±", "30. ÙˆØ±Ù‚Ù„Ø©", "31. ÙˆÙ‡Ø±Ø§Ù†", "32. Ø§Ù„Ø¨ÙŠØ¶", "33. Ø¥Ù„ÙŠØ²ÙŠ", "34. Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬", "35. Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³", "36. Ø§Ù„Ø·Ø§Ø±Ù", "37. ØªÙ†Ø¯ÙˆÙ", "38. ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª", "39. Ø§Ù„ÙˆØ§Ø¯ÙŠ", "40. Ø®Ù†Ø´Ù„Ø©", "41. Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³", "42. ØªÙŠØ¨Ø§Ø²Ø©", "43. Ù…ÙŠÙ„Ø©", "44. Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰", "45. Ø§Ù„Ù†Ø¹Ø§Ù…Ø©", "46. Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª", "47. ØºØ±Ø¯Ø§ÙŠØ©", "48. ØºÙ„ÙŠØ²Ø§Ù†", "49. ØªÙŠÙ…ÙŠÙ…ÙˆÙ†", "50. Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±", "51. Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„", "52. Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³", "53. Ø¥Ù† ØµØ§Ù„Ø­", "54. Ø¥Ù† Ù‚Ø²Ø§Ù…", "55. ØªÙ‚Ø±Øª", "56. Ø¬Ø§Ù†Øª", "57. Ø§Ù„Ù…ØºÙŠØ±", "58. Ø§Ù„Ù…Ù†ÙŠØ¹Ø©" ];
    function renderWilayaCheckboxes() {
        const grid = document.getElementById('wilayaGrid');
        grid.innerHTML = '';
        allWilayas.forEach(w => {
            const clean = w.split('. ')[1];
            const div = document.createElement('div');
            div.className = 'wilaya-checkbox-item';
            div.innerHTML = `<input type="checkbox" class="wilaya-chk" value="${clean}"> <span>${clean}</span>`;
            grid.appendChild(div);
        });
    }
    document.getElementById('selectAllBtn').addEventListener('click', () => {
        const chks = document.querySelectorAll('.wilaya-chk');
        const first = chks[0].checked;
        chks.forEach(c => c.checked = !first);
    });
    document.getElementById('saveZoneBtn').addEventListener('click', async () => {
        const home = document.getElementById('homePrice').value;
        const desk = document.getElementById('deskPrice').value;
        const selected = [];
        document.querySelectorAll('.wilaya-chk:checked').forEach(c => selected.push(c.value));
        if(!home || !desk || selected.length === 0) { alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
        await push(zonesRef, { homePrice: home, deskPrice: desk, wilayas: selected });
        alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
        renderWilayaCheckboxes();
        document.getElementById('homePrice').value = '';
        document.getElementById('deskPrice').value = '';
    });
    onValue(zonesRef, (snap) => {
        const cont = document.getElementById('zonesContainer');
        cont.innerHTML = '';
        if(snap.exists()) {
            const zones = snap.val();
            Object.entries(zones).forEach(([k, v]) => {
                const div = document.createElement('div');
                div.className = 'zone-card';
                div.innerHTML = `
                    <div class="zone-header"><strong>Ù…Ø¬Ù…ÙˆØ¹Ø© (${v.wilayas ? v.wilayas.length : 0})</strong></div>
                    <div class="zone-prices">
                        <span class="price-tag home">ğŸ  ${v.homePrice}</span>
                        <span class="price-tag desk">ğŸ¢ ${v.deskPrice}</span>
                    </div>
                    <button class="delete-review-btn" onclick="delZone('${k}')">Ø­Ø°Ù</button>
                `;
                cont.appendChild(div);
            });
        }
    });
    window.delZone = (k) => { if(confirm('Ø­Ø°ÙØŸ')) remove(ref(db, `shipping_zones/${k}`)); }
    window.toggleMenu = () => document.querySelector('nav .links').classList.toggle('open');
  </script>
</body>
</html>