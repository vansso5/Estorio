<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø­Ù† - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ§Ù…Ù„</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="admin-style.css">
<style>
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    .loading-overlay { opacity: 0.7; pointer-events: none; }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
    .badge-desk { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
    .badge-home { background: #e8f5e9; color: #2e7d32; border: 1px solid #c3e6cb; }
    .fix-btn { background-color: #673ab7; color: white; width: 100%; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 15px; }
</style>
</head>
<body>

<nav>
  <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>
  <div class="logo">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
  <div class="links">
    <a href="admin-products.html" class="nav-link">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
    <a href="admin-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</a>
    <a href="completed-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</a>
    <a href="admin-analytics.html" class="nav-link">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</a>
    <a href="admin-settings.html" class="nav-link">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
    <a href="admin-reviews.html" class="nav-link">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</a>
    <a href="admin-shipping.html" class="nav-link active">Ø§Ù„Ø´Ø­Ù†</a>
    <a href="#" id="logoutBtn" class="nav-link" style="display: none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
  </div>
</nav>

<div class="visitors-wrapper">
  <div id="liveVisitors" class="live-visitors-badge inactive">
    <span class="live-dot"></span>
    <span style="margin-right:5px">Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ø¢Ù†: </span>
    <strong id="visitorsCount" style="margin:0 4px">0</strong>
  </div>
</div>

<div class="container">
    <!-- Ù‚Ø³Ù… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø´Ø±ÙƒØ§Øª -->
    <h2 style="margin-bottom: 20px; color: var(--primary-color);">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø´Ø±ÙƒØ§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</h2>
    <div class="form-card" style="margin-bottom: 30px;">
        <!-- Ø²Ø± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
        <button id="autoFixProvidersBtn" class="fix-btn">ğŸ› ï¸ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø¥ØµÙ„Ø§Ø­ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</button>
        
        <h4 style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</h4>
        <div id="savedProvidersList" style="margin-top: 10px;">
            <p class="loading-message">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
    <h2 style="margin-bottom: 20px; color: var(--primary-color);">ğŸ“¦ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Shipping Engine)</h2>
    <div class="form-card" style="margin-bottom: 30px;">
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
            <div style="flex:3; min-width: 250px;">
                <label>Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„:</label>
                <select id="shipProviderSelect" class="search-input">
                    <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© --</option>
                </select>
            </div>
            <div style="flex:1; display:flex; gap:5px;">
                <button id="sendBulkBtn" style="flex:2; padding: 10px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
                <button id="forceRefreshBtn" style="flex:1; padding: 10px; background-color: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer;" title="ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒØ§ØªØ¨ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            </div>
        </div>
        <div id="apiStatusMsg" style="margin-bottom:10px; font-size:0.85rem; color:#666;"></div>
        <h3 style="margin-bottom:15px;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ² (Processing)</h3>
        <div id="shippingOrdersContainer" class="orders-grid">
            <p class="loading-message">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
        </div>
    </div>

    <div id="zonesContainer" class="orders-grid" style="margin-top: 20px;"></div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
<div id="orderDetailModal" class="modal hidden">
    <div class="modal-content">
      <button class="close-modal-btn" id="closeDetailModal">&times;</button>
      <h3>ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h3>
      <div class="details-section" style="margin-top: 15px;">
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" id="editName" class="search-input">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="editPhone" class="search-input">
          <div style="display:flex; gap:10px;">
              <div style="flex:1"><label>Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</label><input type="text" id="editWilaya" class="search-input"></div>
              <div style="flex:1"><label>Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©</label><input type="text" id="editCommune" class="search-input"></div>
          </div>
          <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="editAddress" class="search-input">
          <label>Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØµÙŠÙ„:</label>
          <select id="editDeliveryOption" class="search-input" style="background:#fff3cd;">
              <option value="home">ğŸ  ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…Ù†Ø²Ù„ (Home)</option>
              <option value="desk">ğŸ¢ ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…ÙƒØªØ¨ (Stop Desk)</option>
          </select>
          <label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØµØ§ÙÙŠ:</label><input type="number" id="editProductPrice" class="search-input" style="background:#f0f8ff; font-weight:bold;">
          <input type="hidden" id="currentOrderId">
          <div class="modal-actions" style="display: flex; gap: 10px; margin-top: 15px;">
              <button id="saveChangesBtn" style="flex: 1; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
              <button id="cancelOrderBtn" class="btn-delete">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
      </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, get, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4", authDomain: "myestore-34f65.firebaseapp.com", databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com", projectId: "myestore-34f65", storageBucket: "myestore-34f65.firebasestorage.app", messagingSenderId: "14078917211", appId: "1:14078917211:web:a48eab2a7396c094f7dd7e", measurementId: "G-9181DX0XNJ" };
    const app = initializeApp(firebaseConfig); const db = getDatabase(app); const auth = getAuth(app);

    const ordersRef = ref(db, 'orders'); const settingsRef = ref(db, 'delivery_settings'); const zonesRef = ref(db, 'shipping_zones');
    const visitorsRef = ref(db, 'site_presence');
    const shippingContainer = document.getElementById('shippingOrdersContainer');
    const shipProviderSelect = document.getElementById('shipProviderSelect');
    const savedProvidersList = document.getElementById('savedProvidersList');
    
    // Ø§Ù„Ø«ÙˆØ§Ø¨Øª
    const RATE_LIMIT_DELAY = 1000;
    const MAX_WEIGHT_FOR_PARTNERS = 10; 
    const CACHE_TTL = 24 * 60 * 60 * 1000; 

    let allCentersCache = JSON.parse(localStorage.getItem('yal_centers')) || [];
    let allWilayasApiCache = JSON.parse(localStorage.getItem('yal_wilayas')) || [];
    let allCommunesApiCache = JSON.parse(localStorage.getItem('yal_communes')) || [];

    const delay = ms => new Promise(res => setTimeout(res, ms));

    const wilayaMapping = {
        "adrar": 1, "Ø£Ø¯Ø±Ø§Ø±": 1, "adr": 1, "chlef": 2, "Ø§Ù„Ø´Ù„Ù": 2, "Ø´Ù„Ù": 2, 
        "laghouat": 3, "Ø§Ù„Ø£ØºÙˆØ§Ø·": 3, "Ø£ØºÙˆØ§Ø·": 3, "oum el bouaghi": 4, "Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ": 4, "oeb": 4,
        "batna": 5, "Ø¨Ø§ØªÙ†Ø©": 5, "bejaia": 6, "Ø¨Ø¬Ø§ÙŠØ©": 6, "bgayet": 6, "biskra": 7, "Ø¨Ø³ÙƒØ±Ø©": 7,
        "bechar": 8, "Ø¨Ø´Ø§Ø±": 8, "blida": 9, "Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©": 9, "Ø¨Ù„ÙŠØ¯Ø©": 9, "bouira": 10, "Ø§Ù„Ø¨ÙˆÙŠØ±Ø©": 10,
        "tamanrasset": 11, "ØªÙ…Ù†Ø±Ø§Ø³Øª": 11, "tam": 11, "tebessa": 12, "ØªØ¨Ø³Ø©": 12, "tlemcen": 13, "ØªÙ„Ù…Ø³Ø§Ù†": 13,
        "tiaret": 14, "ØªÙŠØ§Ø±Øª": 14, "tizi ouzou": 15, "ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ": 15, "tizi": 15,
        "alger": 16, "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±": 16, "Ø¬Ø²Ø§Ø¦Ø±": 16, "algiers": 16, "djazair": 16, "Ø§Ù„Ø¹Ø§ØµÙ…Ø©": 16,
        "djelfa": 17, "Ø§Ù„Ø¬Ù„ÙØ©": 17, "jijel": 18, "Ø¬ÙŠØ¬Ù„": 18, "setif": 19, "Ø³Ø·ÙŠÙ": 19,
        "saida": 20, "Ø³Ø¹ÙŠØ¯Ø©": 20, "skikda": 21, "Ø³ÙƒÙŠÙƒØ¯Ø©": 21, "sidi bel abbes": 22, "Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³": 22, "sba": 22,
        "annaba": 23, "Ø¹Ù†Ø§Ø¨Ø©": 23, "guelma": 24, "Ù‚Ø§Ù„Ù…Ø©": 24, "constantine": 25, "Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©": 25,
        "medea": 26, "Ø§Ù„Ù…Ø¯ÙŠØ©": 26, "Ù…Ø¯ÙŠØ©": 26, "mostaganem": 27, "Ù…Ø³ØªØºØ§Ù†Ù…": 27, "msila": 28, "Ø§Ù„Ù…Ø³ÙŠÙ„Ø©": 28, "Ù…Ø³ÙŠÙ„Ø©": 28,
        "mascara": 29, "Ù…Ø¹Ø³ÙƒØ±": 29, "ouargla": 30, "ÙˆØ±Ù‚Ù„Ø©": 30, "oran": 31, "ÙˆÙ‡Ø±Ø§Ù†": 31, "wahran": 31,
        "el bayadh": 32, "Ø§Ù„Ø¨ÙŠØ¶": 32, "illizi": 33, "Ø¥Ù„ÙŠØ²ÙŠ": 33, "bordj bou arreridj": 34, "Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬": 34, "bba": 34,
        "boumerdes": 35, "Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³": 35, "el tarf": 36, "Ø§Ù„Ø·Ø§Ø±Ù": 36, "tindouf": 37, "ØªÙ†Ø¯ÙˆÙ": 37,
        "tissemsilt": 38, "ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª": 38, "el oued": 39, "Ø§Ù„ÙˆØ§Ø¯ÙŠ": 39, "khenchela": 40, "Ø®Ù†Ø´Ù„Ø©": 40,
        "souk ahras": 41, "Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³": 41, "tipaza": 42, "ØªÙŠØ¨Ø§Ø²Ø©": 42, "mila": 43, "Ù…ÙŠÙ„Ø©": 43,
        "ain defla": 44, "Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰": 44, "naama": 45, "Ø§Ù„Ù†Ø¹Ø§Ù…Ø©": 45, "ain temouchent": 46, "Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª": 46,
        "ghardaia": 47, "ØºØ±Ø¯Ø§ÙŠØ©": 47, "relizane": 48, "ØºÙ„ÙŠØ²Ø§Ù†": 48, "timimoun": 49, "ØªÙŠÙ…ÙŠÙ…ÙˆÙ†": 49,
        "bordj badji mokhtar": 50, "Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±": 50, "ouled djellal": 51, "Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„": 51,
        "beni abbes": 52, "Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³": 52, "in salah": 53, "Ø¥Ù† ØµØ§Ù„Ø­": 53, "in guezzam": 54, "Ø¥Ù† Ù‚Ø²Ø§Ù…": 54,
        "touggourt": 55, "ØªÙ‚Ø±Øª": 55, "djanet": 56, "Ø¬Ø§Ù†Øª": 56, "el mghair": 57, "Ø§Ù„Ù…ØºÙŠØ±": 57, "el meniaa": 58, "Ø§Ù„Ù…Ù†ÙŠØ¹Ø©": 58
    };

    // =====================================
    // ğŸ”¥ Ø²Ø± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ğŸ”¥
    // =====================================
    document.getElementById('autoFixProvidersBtn').addEventListener('click', async () => {
        const confirmFix = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØµÙ„Ø§Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©.");
        if (!confirmFix) return;

        const defaultProviders = {
          "djezzy_express": {
            "displayName": "DjezzyExpress", "apiUrl": "https://api.djezzyexpress.dz/v1", "apiKey": "123456789", "apiToken": "abcdefg12345", "driverType": "standard", "wilayaFormat": "arabic_name", "active": true
          },
          "baraka_shipping": {
            "displayName": "BarakaShipping", "apiUrl": "https://api.barakashipping.com/v1", "apiKey": "987654321", "apiToken": "hijklm67890", "driverType": "yalidine_style", "wilayaFormat": "french_name", "active": true
          },
          "guepex": {
            "displayName": "GuepEX", "apiUrl": "https://api.guepex.com/v1", "apiKey": "CHANGE_ME", "apiToken": "CHANGE_ME", "driverType": "yalidine_style", "wilayaFormat": "french_name", "active": true
          }
        };

        try {
            await set(ref(db, 'delivery_settings'), defaultProviders);
            alert("âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø´Ø±ÙƒØ§Øª! Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.");
            location.reload();
        } catch (error) {
            alert("Ø®Ø·Ø£: " + error.message);
        }
    });

    // Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
    function extractSmartPhones(rawText) {
        const regex = /(0[567][0-9]{8})/g; 
        const matches = (rawText || "").match(regex) || [];
        const unique = [...new Set(matches)];
        if (unique.length === 0) return { primary: null, secondary: null };
        return { primary: unique[0], secondary: unique.slice(1).join(' / ') };
    }

    function sanitizeString(str, maxLength = 60) {
        if (!str) return "";
        let clean = str.replace(/[^\w\s\u0600-\u06FF\-\.]/g, ''); 
        return clean.replace(/\s+/g, ' ').trim().substring(0, maxLength);
    }

    function normalizeText(text) {
        if (!text) return "";
        let str = text.toLowerCase().trim();
        str = str.replace(/(Ø¢|Ø¥|Ø£)/g, 'Ø§'); 
        str = str.replace(/[^a-z0-9\u0600-\u06FF\s]/g, ""); 
        return str.trim();
    }

    function padAddress(addr, communeName, wilayaName) {
        let clean = sanitizeString(addr, 120);
        if (clean.length < 8) return `${clean}, ${communeName}, ${wilayaName} (Adresse Personnelle)`;
        return clean;
    }

    function saveOrderSnapshot(orderId, payload) {
        const snapshots = JSON.parse(localStorage.getItem('shipping_snapshots') || '{}');
        snapshots[orderId] = { payload, timestamp: Date.now() };
        localStorage.setItem('shipping_snapshots', JSON.stringify(snapshots));
    }

    function clearOrderSnapshot(orderId) {
        const snapshots = JSON.parse(localStorage.getItem('shipping_snapshots') || '{}');
        delete snapshots[orderId];
        localStorage.setItem('shipping_snapshots', JSON.stringify(snapshots));
    }

    function getWilayaIdByName(rawName) {
        if (!rawName) return null;
        const matchNum = rawName.match(/^(\d+)/);
        if (matchNum) { const id = parseInt(matchNum[1]); if (id >= 1 && id <= 58) return id; }
        
        let cleanName = normalizeText(rawName).replace("wilaya", "").trim();
        if (wilayaMapping[cleanName]) return wilayaMapping[cleanName];
        if (cleanName.startsWith("Ø§Ù„")) {
            const withoutAl = cleanName.substring(2).trim();
            if (wilayaMapping[withoutAl]) return wilayaMapping[withoutAl];
        }
        const withAl = "Ø§Ù„" + cleanName;
        if (wilayaMapping[withAl]) return wilayaMapping[withAl];
        let altName = cleanName;
        if (cleanName.endsWith("Ø©")) altName = cleanName.slice(0, -1) + "Ù‡";
        else if (cleanName.endsWith("Ù‡")) altName = cleanName.slice(0, -1) + "Ø©";
        if (wilayaMapping[altName]) return wilayaMapping[altName];
        
        if (allWilayasApiCache.length > 0) {
            const foundInApi = allWilayasApiCache.find(w => normalizeText(w.name) === cleanName);
            if (foundInApi) return foundInApi.id;
        }
        return null; 
    }

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = 'admin-login.html';
        else { 
            document.getElementById('logoutBtn').style.display = 'block'; 
            loadActiveProviders(); 
            updateApiStatusUI();
        }
    });
    document.getElementById('logoutBtn').addEventListener('click', async () => await signOut(auth));

    function updateApiStatusUI() {
        const msg = document.getElementById('apiStatusMsg');
        if(allCentersCache.length > 0) msg.innerHTML = `âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆÙØ±Ø©: ${allCentersCache.length} Ù…ÙƒØªØ¨ ØªÙˆØµÙŠÙ„.`;
        else msg.innerHTML = 'âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒØ§ØªØ¨.';
    }

    async function fetchAllPages(url, headers) {
        let allData = []; let page = 1; let hasMore = true;
        while(hasMore && page < 20) { 
            try {
                const sep = url.includes('?') ? '&' : '?';
                const finalUrl = `${url}${sep}page=${page}&page_size=1000`;
                const res = await fetch('https://corsproxy.io/?' + encodeURIComponent(finalUrl), { headers });
                const json = await res.json();
                if (json.data) allData = allData.concat(json.data);
                hasMore = json.has_more;
                page++;
            } catch(e) { hasMore = false; }
        }
        return allData;
    }

    async function fetchGuepexData(apiUrl, apiId, apiToken, forceUpdate = false) {
        if(!forceUpdate && allCentersCache.length > 0 && allCommunesApiCache.length > 0) return; 
        let baseUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
        if(baseUrl.includes('/v1/parcels')) baseUrl = baseUrl.replace('/v1/parcels', '/v1'); 
        else if(!baseUrl.includes('/v1')) baseUrl += '/v1';
        const headers = { 'X-API-ID': apiId, 'X-API-TOKEN': apiToken };
        const btn = document.getElementById('forceRefreshBtn');
        const originalText = btn.textContent;
        btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„..."; btn.disabled = true;

        try {
            console.log("Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù€ API...");
            allWilayasApiCache = await fetchAllPages(`${baseUrl}/wilayas`, headers);
            allCentersCache = await fetchAllPages(`${baseUrl}/centers`, headers);
            allCommunesApiCache = await fetchAllPages(`${baseUrl}/communes`, headers); 

            localStorage.setItem('yal_wilayas', JSON.stringify(allWilayasApiCache));
            localStorage.setItem('yal_centers', JSON.stringify(allCentersCache));
            localStorage.setItem('yal_communes', JSON.stringify(allCommunesApiCache));
            localStorage.setItem('yal_last_update', Date.now()); 

            updateApiStatusUI();
            if(forceUpdate) alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ§ØªØ¨ ÙˆØ§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­!");
        } catch(e) { 
            console.error("Ø®Ø·Ø£ API:", e); 
            if(forceUpdate) alert("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ API. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª.");
        } finally {
            btn.textContent = originalText; btn.disabled = false;
        }
    }

    document.getElementById('forceRefreshBtn').addEventListener('click', async () => {
        const providerId = shipProviderSelect.value;
        if(!providerId) return alert('Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹.');
        const snap = await get(ref(db, `delivery_settings/${providerId}`));
        if(snap.exists()) {
            const d = snap.val();
            await fetchGuepexData(d.apiUrl, d.apiKey, d.apiToken, true);
        }
    });

    onValue(ordersRef, async (snapshot) => {
        shippingContainer.innerHTML = '';
        const orders = snapshot.val() || {};
        const sorted = Object.entries(orders).sort((a,b) => b[1].timestamp - a[1].timestamp);
        let products = {};
        try { const productsSnap = await get(ref(db, 'products')); if (productsSnap.exists()) products = productsSnap.val(); } catch(e) { }

        let count = 0;
        sorted.forEach(([id, order]) => {
            const status = (order.status || '').toLowerCase().trim();
            if(status.includes('shipped') || status.includes('delivered') || status.includes('ØªÙ…') || status.includes('Ø´Ø­Ù†')) return;
            count++;
            let currentTotal = parseFloat(order.productTotal);
            if(isNaN(currentTotal)) currentTotal = calculateProductOnlyPrice(order);
            let discount = 0; if (order.productId && products[order.productId]) discount = parseFloat(products[order.productId].marketingDiscount || 0);
            const qty = parseInt(order.quantity || 1);
            let netPrice = currentTotal - (discount * qty); if(netPrice < 0) netPrice = 0;
            const isDeskByDefualt = (order.deliveryOption && (order.deliveryOption.includes('desk') || order.deliveryOption.includes('Ù…ÙƒØªØ¨')));
            const row = document.createElement('div'); row.className = 'order-row'; row.dataset.id = id;
            row.style.cssText = "display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; background: #fff; border-radius: 8px; margin-bottom: 8px; border: 1px solid #eee; border-right: 4px solid #f1c40f;";
            row.innerHTML = `
                <div class="row-info" style="display:flex;align-items:center; flex: 2;">
                    <input type="checkbox" class="order-checkbox" value="${id}" style="margin-left: 15px; transform: scale(1.3);">
                    <div style="margin-right:15px;">
                        <span class="row-name" style="font-weight:bold;">${order.customerName || order.name}</span>
                        <div style="font-size: 0.85rem; color: #666;"> ${order.customerWilaya || order.state} | ${order.customerCommune || ''} | <span style="color:#27ae60;font-weight:bold;">${netPrice} Ø¯Ø¬</span></div>
                    </div>
                </div>
                <div style="flex: 1; text-align: center;">
                    <span class="status-badge ${isDeskByDefualt ? 'badge-desk' : 'badge-home'}">${isDeskByDefualt ? 'ğŸ¢ Ù…ÙƒØªØ¨ (Desk)' : 'ğŸ  Ù…Ù†Ø²Ù„ (Home)'}</span>
                </div>
                <div onclick="window.openDetails('${id}')" style="cursor:pointer; background:#e3f2fd; color:#0d47a1; padding:5px 10px; border-radius:5px; font-weight:bold; font-size:0.9rem;">âœï¸ ØªØ¹Ø¯ÙŠÙ„</div>`;
            shippingContainer.appendChild(row);
        });
        if(count === 0) shippingContainer.innerHTML = '<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ².</p>';
    });

    // ============================================================
    // ğŸ”¥ Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠ (Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)
    // ============================================================
    function resolveLogisticDestination(orderData, centersList, wilayasList, communesList) {
        const { wilayaId, rawCommune, isStopDesk, originalAddress, parcelWeight, isCOD, customerPhone } = orderData;
        let logs = [];
        let driverNoteParts = []; 

        if (["0550000000"].includes(customerPhone)) throw new Error("BLOCKED_CUSTOMER");

        const officialWilaya = wilayasList.find(w => w.id == wilayaId);
        if (!officialWilaya) throw new Error(`Ø§Ù„ÙˆÙ„Ø§ÙŠØ© Ø±Ù‚Ù… ${wilayaId} ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©.`);

        let normalizedInput = normalizeText(rawCommune || "");
        const validCommunes = communesList.filter(c => c.wilaya_id == wilayaId);
        
        let targetCommuneObj = validCommunes.find(c => normalizeText(c.name) === normalizedInput) ||
                               validCommunes.find(c => normalizeText(c.name).includes(normalizedInput));

        // ğŸ”¥ Fallback Ù‚ÙˆÙŠ Ù„Ù„Ø¨Ù„Ø¯ÙŠØ© Ù„ØªØ¬Ù†Ø¨ "Not Deliverable"
        if (!targetCommuneObj) {
            targetCommuneObj = validCommunes.find(c => normalizeText(c.name) === normalizeText(officialWilaya.name)); // Ø§Ù„Ø¹Ø§ØµÙ…Ø©
            if (!targetCommuneObj) targetCommuneObj = validCommunes[0]; // Ø£ÙŠ Ø¨Ù„Ø¯ÙŠØ©
            logs.push(`âš ï¸ Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© "${rawCommune}" ØºÙŠØ± Ù…Ù‚Ø¨ÙˆÙ„Ø©ØŒ ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯: ${targetCommuneObj.name}`);
        }

        let finalIsStopDesk = isStopDesk;
        let finalStopDeskId = null;
        let finalWilayaName = officialWilaya.name;
        let finalCommuneName = targetCommuneObj.name;
        let finalAddress = padAddress(originalAddress, finalCommuneName, finalWilayaName);

        if (finalIsStopDesk) {
            let candidates = centersList.filter(c => {
                if (c.wilaya_id != wilayaId) return false;
                if (!c.active) return false;
                const nameLower = c.name.toLowerCase();
                if (c.is_hub || nameLower.includes('hub') || nameLower.includes('depot')) return false;
                if (parcelWeight > MAX_WEIGHT_FOR_PARTNERS && (c.is_partner || nameLower.includes('kiosk'))) return false;
                if (isCOD && c.no_cod === true) return false;
                return true;
            });

            let chosenCenter = null;
            if (!chosenCenter) chosenCenter = candidates.find(c => normalizeText(c.name).includes(normalizedInput));
            if (!chosenCenter) chosenCenter = candidates.find(c => c.name.toLowerCase().includes('centre'));
            if (!chosenCenter && candidates.length > 0) chosenCenter = candidates[0];

            if (chosenCenter) {
                finalStopDeskId = chosenCenter.center_id || chosenCenter.id;
                finalWilayaName = chosenCenter.wilaya_name || finalWilayaName; 
                finalCommuneName = chosenCenter.commune_name || finalCommuneName; 
                finalAddress = `Stop Desk: ${chosenCenter.name} (${finalCommuneName})`;
            } else {
                finalIsStopDesk = false;
                logs.push("âš ï¸ ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù€ Home (Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒØ§ØªØ¨ Ù…Ù†Ø§Ø³Ø¨Ø©).");
                driverNoteParts.push("âš ï¸ Client preferred Desk but forced Home - PLEASE CALL");
            }
        }

        return {
            to_wilaya_name: finalWilayaName,
            to_commune_name: finalCommuneName,
            is_stopdesk: finalIsStopDesk,
            stopdesk_id: finalStopDeskId,
            address: finalAddress,
            logs: logs,
            driverNotePrefix: driverNoteParts.join(' | ')
        };
    }

    document.getElementById('sendBulkBtn').addEventListener('click', async function() {
        const btn = this; 
        const providerId = shipProviderSelect.value; 
        const checks = document.querySelectorAll('.order-checkbox:checked');
        
        if(!providerId) return alert('âš ï¸ Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„.');
        if(checks.length === 0) return alert('âš ï¸ Ø­Ø¯Ø¯ Ø·Ù„Ø¨ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');

        let apiData = null;
        try {
            const snap = await get(ref(db, `delivery_settings/${providerId}`));
            if(snap.exists()) apiData = snap.val();
            else throw new Error("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ù…ÙÙ‚ÙˆØ¯Ø©.");
        } catch(e) { alert(e.message); return; }

        if(apiData.driverType === 'yalidine_style') {
            const lastUpdate = localStorage.getItem('yal_last_update');
            if(!lastUpdate || (Date.now() - lastUpdate > CACHE_TTL) || allCentersCache.length === 0) {
                if(confirm("â™»ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© Ø£Ùˆ Ù…ÙÙ‚ÙˆØ¯Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù† Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„Ù…ÙƒØ§ØªØ¨ØŸ")) {
                    return document.getElementById('forceRefreshBtn').click();
                }
            }
        }

        btn.textContent = "âš™ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©..."; btn.disabled = true;

        let successCount = 0;
        let failReport = "";

        for (const chk of checks) {
            const orderId = chk.value;
            try {
                const orderSnap = await get(ref(db, `orders/${orderId}`));
                if(!orderSnap.exists()) continue;
                const order = orderSnap.val();

                const phones = extractSmartPhones(order.customerPhone || order.phone);
                if (!phones.primary) throw new Error("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­");

                let weight = parseFloat(order.weight || 1); 
                let price = parseFloat(order.totalPrice || 0); 
                let isCOD = price > 0;

                let wilayaId = getWilayaIdByName(order.customerWilaya || order.state);
                if (!wilayaId) throw new Error(`Ø§Ø³Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: ${order.customerWilaya}`);

                let dest;
                if(apiData.driverType === 'yalidine_style') {
                    dest = resolveLogisticDestination({
                        wilayaId, 
                        rawCommune: order.customerCommune, 
                        isStopDesk: (order.deliveryOption && (order.deliveryOption.includes('desk') || order.deliveryOption.includes('Ù…ÙƒØªØ¨'))), 
                        originalAddress: order.customerAddress || order.customerCommune,
                        parcelWeight: weight,
                        isCOD: isCOD,
                        customerPhone: phones.primary
                    }, allCentersCache, allWilayasApiCache, allCommunesApiCache);
                } else {
                    const w = allWilayasApiCache.find(x=>x.id==wilayaId);
                    dest = {
                        to_wilaya_name: (apiData.wilayaFormat === 'id') ? wilayaId : (w ? w.name : "Alger"),
                        to_commune_name: order.customerCommune || "Centre",
                        is_stopdesk: false,
                        address: padAddress(order.customerAddress, order.customerCommune, "Wilaya"),
                        logs: [],
                        driverNotePrefix: ""
                    };
                }

                let finalNote = dest.driverNotePrefix || "";
                if (phones.secondary) finalNote += ` | 2nd Phone: ${phones.secondary}`;
                if (dest.logs.length > 0) finalNote += ` | Sys: ${dest.logs.join(',')}`;
                finalNote = sanitizeString(finalNote, 200);

                let parcelObj = {
                    "order_id": orderId.replace('#','').trim(),
                    "firstname": (order.customerName || "Client").trim(),
                    "familyname": ".",
                    "contact_phone": phones.primary,
                    "address": dest.address,
                    "to_wilaya_name": dest.to_wilaya_name,
                    "to_commune_name": dest.to_commune_name,
                    "product_list": sanitizeString(order.productName || "Colis", 40),
                    "price": price,
                    "freeshipping": false,
                    "is_stopdesk": dest.is_stopdesk,
                    "has_exchange": false,
                    "note": finalNote
                };
                if(dest.is_stopdesk && dest.stopdesk_id) {
                    parcelObj.stopdesk_id = dest.stopdesk_id;
                }

                saveOrderSnapshot(orderId, parcelObj);

                let postUrl = apiData.apiUrl.replace(/\/$/, '') + (apiData.apiUrl.includes('/v1/parcels') ? '' : '/v1/parcels');
                let proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(postUrl);
                
                let res = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-ID': apiData.apiKey, 'X-API-TOKEN': apiData.apiToken },
                    body: JSON.stringify([parcelObj])
                });

                let json = await res.json();
                let cleanId = parcelObj.order_id;
                let isSuccess = false; let tracking = null;

                if (json[cleanId] && json[cleanId].success) {
                    isSuccess = true; tracking = json[cleanId].tracking;
                } else if (Array.isArray(json) && json[0] && (json[0].tracking || json[0].success)) {
                    isSuccess = true; tracking = json[0].tracking;
                }

                if (isSuccess) {
                    await update(ref(db, `orders/${orderId}`), { 
                        status: 'Shipped', 
                        deliveryProvider: apiData.displayName, 
                        trackingCode: tracking,
                        shippedAt: Date.now(),
                        shippingLog: dest.logs.join(' | ') 
                    });
                    clearOrderSnapshot(orderId);
                    successCount++;
                } else {
                    let msg = json[cleanId] ? json[cleanId].message : JSON.stringify(json);
                    failReport += `\nâŒ ${order.customerName}: ${msg}`;
                }

                await delay(RATE_LIMIT_DELAY);

            } catch(err) {
                failReport += `\nâš ï¸ ${orderId}: ${err.message}`;
            }
        }

        let report = `âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${successCount}`;
        if(failReport) report += `\n\nğŸ›‘ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:${failReport}`;
        alert(report);
        
        btn.textContent = "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯"; 
        btn.disabled = false;
    });

    function calculateProductOnlyPrice(order) {
        if (order.productTotal && !isNaN(order.productTotal)) return parseFloat(order.productTotal);
        if (order.items) {
            let sum = 0; const items = Array.isArray(order.items) ? order.items : Object.values(order.items);
            items.forEach(i => sum += (parseFloat(i.price) * parseInt(i.quantity || 1)));
            if(sum > 0) return sum;
        }
        let total = parseFloat(order.totalPrice || 0); let ship = parseFloat(order.shippingPrice || 0);
        return (total - ship) > 0 ? (total - ship) : total;
    }

    function loadActiveProviders() {
        onValue(settingsRef, (snap) => {
            shipProviderSelect.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© --</option>';
            savedProvidersList.innerHTML = '';
            if(snap.exists()) {
                Object.entries(snap.val()).forEach(([k, p]) => {
                    const opt = document.createElement('option'); opt.value = k; opt.textContent = p.displayName; shipProviderSelect.appendChild(opt);
                    const div = document.createElement('div'); div.className = 'provider-item';
                    div.style.cssText = "display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border: 1px solid #ddd; padding: 10px 15px; border-radius: 8px; margin-bottom: 8px;";
                    div.innerHTML = `<div>${p.displayName} <small style="color:blue">(${p.driverType})</small></div><button class="btn-delete-prov" onclick="window.delProv('${k}')" style="background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Ø­Ø°Ù ğŸ—‘ï¸</button>`;
                    savedProvidersList.appendChild(div);
                });
            }
        });
    }
    window.delProv = async (k) => { if(confirm('Ø­Ø°ÙØŸ')) await remove(ref(db, `delivery_settings/${k}`)); };

    window.openDetails = async (id) => { 
        const orderSnap = await get(ref(db, 'orders/'+id)); 
        if(orderSnap.exists()) { 
            const o = orderSnap.val(); 
            document.getElementById('currentOrderId').value = id; 
            document.getElementById('editName').value = o.customerName || o.name; 
            document.getElementById('editPhone').value = o.customerPhone || o.phone; 
            document.getElementById('editWilaya').value = o.customerWilaya || o.state; 
            document.getElementById('editCommune').value = o.customerCommune||''; 
            document.getElementById('editAddress').value = o.customerAddress || o.address; 
            let currentTotal = parseFloat(o.productTotal); 
            if(isNaN(currentTotal)) currentTotal = calculateProductOnlyPrice(o); 
            let marketingDiscount = 0; 
            if(o.productId) { try { const prodSnap = await get(ref(db, `products/${o.productId}`)); if(prodSnap.exists()) marketingDiscount = parseFloat(prodSnap.val().marketingDiscount || 0); } catch(e) {} } 
            const qty = parseInt(o.quantity || 1); 
            let netPrice = currentTotal - (marketingDiscount * qty); 
            if(netPrice < 0) netPrice = 0; 
            document.getElementById('editProductPrice').value = netPrice; 
            const isDesk = (o.deliveryOption && (o.deliveryOption.includes('desk') || o.deliveryOption.includes('Ù…ÙƒØªØ¨')));
            document.getElementById('editDeliveryOption').value = isDesk ? 'desk' : 'home';
            document.getElementById('orderDetailModal').classList.remove('hidden'); 
        } 
    }
    document.getElementById('closeDetailModal').addEventListener('click',()=>document.getElementById('orderDetailModal').classList.add('hidden'));
    document.getElementById('saveChangesBtn').addEventListener('click',async()=>{ 
        const id=document.getElementById('currentOrderId').value; 
        const delOptionVal = document.getElementById('editDeliveryOption').value;
        const delOptionText = delOptionVal === 'desk' ? 'Stop Desk (Ù…ÙƒØªØ¨)' : 'Home (Ù…Ù†Ø²Ù„)';
        await update(ref(db,'orders/'+id), { 
            customerName:document.getElementById('editName').value, customerPhone:document.getElementById('editPhone').value, 
            customerWilaya:document.getElementById('editWilaya').value, customerCommune:document.getElementById('editCommune').value, 
            customerAddress:document.getElementById('editAddress').value, productTotal: parseFloat(document.getElementById('editProductPrice').value),
            deliveryOption: delOptionText 
        }); 
        document.getElementById('orderDetailModal').classList.add('hidden'); 
        alert("âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­"); 
    });
</script>

<script>
    function toggleMenu() {
      const links = document.querySelector('nav .links');
      if(links) links.classList.toggle('open');
    }
</script>
</body>
</html>