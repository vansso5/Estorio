<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø±Ø¨Ø· Ø§Ù„Ø°ÙƒÙŠ</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="admin-style.css">
<style>
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
    .refresh-btn { background-color: #17a2b8; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: 0.3s; }
    .refresh-btn:hover { background-color: #138496; }
    .status-badge { padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; }
    .status-badge.desk { background-color: #e3f2fd; color: #0d47a1; border: 1px solid #90caf9; }
    .status-badge.home { background-color: #e8f5e9; color: #1b5e20; border: 1px solid #a5d6a7; }
</style>
</head>
<body>

<nav>
  <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>
  <div class="logo">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
  <div class="links">
    <a href="admin-products.html" class="nav-link">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
    <a href="admin-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</a>
    <a href="completed-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</a>
    <a href="admin-analytics.html" class="nav-link">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</a>
    <a href="admin-settings.html" class="nav-link">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
    <a href="admin-reviews.html" class="nav-link">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</a>
    <a href="admin-shipping.html" class="nav-link active">Ø§Ù„Ø´Ø­Ù†</a>
    <a href="#" id="logoutBtn" class="nav-link" style="display: none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
  </div>
</nav>

<div class="visitors-wrapper">
  <div id="liveVisitors" class="live-visitors-badge inactive">
    <span class="live-dot"></span>
    <span style="margin-right:5px">Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ø¢Ù†: </span>
    <strong id="visitorsCount" style="margin:0 4px">0</strong>
  </div>
</div>

<div class="container">
    <h2 style="margin-bottom: 20px; color: var(--primary-color);">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø´Ø±ÙƒØ§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ (API)</h2>
    
    <!-- Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ§Øª -->
    <div class="form-card" style="margin-bottom: 30px;">
        <h4 style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø© / ØªØ¹Ø¯ÙŠÙ„</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div><label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©:</label><input type="text" id="provName" class="search-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: Guepex"></div>
            <div><label>Ø±Ø§Ø¨Ø· API:</label><input type="text" id="provUrl" class="search-input" placeholder="https://api.guepex.dz/v1/parcels"></div>
            <div><label>API Key / User ID:</label><input type="text" id="provKey" class="search-input" placeholder="API ID"></div>
            <div><label>API Token:</label><input type="text" id="provToken" class="search-input" placeholder="API Token"></div>
            <div>
                <label>Ù‡ÙŠÙƒÙ„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</label>
                <select id="provDriver" class="search-input">
                    <option value="yalidine_style" selected>Ù†Ø¸Ø§Ù… Yalidine / Guepex (StopDesk Ù…Ø¯Ø¹ÙˆÙ…)</option>
                    <option value="standard">Ù†Ø¸Ø§Ù… Ø¢Ø®Ø±</option>
                </select>
            </div>
            <div>
                <label>ØµÙŠØºØ© Ø§Ù„ÙˆÙ„Ø§ÙŠØ©:</label>
                <select id="provWilayaFormat" class="search-input">
                    <option value="french_name" selected>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ© (Alger)</option>
                </select>
            </div>
        </div>
        <button id="saveProviderBtn" class="save-btn" style="margin-top:15px; width:100%; background-color: var(--secondary-color); color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer;">Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</button>
        <div style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px;">
            <label>Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</label>
            <div id="savedProvidersList" style="margin-top: 10px;"><p class="loading-message">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
        </div>
    </div>

    <h2 style="margin-bottom: 20px; color: var(--primary-color);">ğŸ“¦ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Shipping)</h2>
    <div class="form-card" style="margin-bottom: 30px;">
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
            <div style="flex:3; min-width: 250px;">
                <label>Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„:</label>
                <select id="shipProviderSelect" class="search-input">
                    <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© --</option>
                </select>
            </div>
            <div style="flex:1; display:flex; gap:5px;">
                <button id="sendBulkBtn" style="flex:2; padding: 10px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
                <button id="refreshApiBtn" class="refresh-btn" title="ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ§ØªØ¨ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
        </div>
        <div id="apiStatusMsg" style="margin-bottom:10px; font-size:0.85rem; color:#666;"></div>

        <h3 style="margin-bottom:15px;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</h3>
        <div id="shippingOrdersContainer" class="orders-grid">
            <p class="loading-message">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
        </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ³Ø¹ÙŠØ± (ÙƒÙ…Ø§ Ù‡Ùˆ) -->
    <h2 style="margin-bottom: 20px; color: var(--primary-color);">ğŸ’° ØªØ³Ø¹ÙŠØ±Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</h2>
    <div class="form-card">
      <div style="display:flex; gap:10px; margin-bottom:15px;">
           <div style="flex:1;"><label>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†Ø²Ù„:</label><input type="number" id="homePrice" class="search-input"></div>
           <div style="flex:1;"><label>Ø³Ø¹Ø± Ø§Ù„Ù…ÙƒØªØ¨:</label><input type="number" id="deskPrice" class="search-input"></div>
      </div>
      <div style="margin-bottom: 10px;"><button type="button" id="selectAllBtn" style="padding:5px 10px; cursor:pointer; background: #eee; border: 1px solid #ddd; border-radius: 4px;">ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„</button></div>
      <div id="wilayaGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; padding: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 5px;"></div>
      <button id="saveZoneBtn" class="save-btn" style="margin-top:15px; width: 100%; background-color: var(--secondary-color); color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer;">Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¹ÙŠØ±Ø©</button>
    </div>
    <div id="zonesContainer" class="orders-grid" style="margin-top: 20px;"></div>
</div>

<!-- Modal -->
<div id="orderDetailModal" class="modal hidden">
    <div class="modal-content">
      <button class="close-modal-btn" id="closeDetailModal">&times;</button>
      <h3>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h3>
      <div class="details-section" style="margin-top: 15px;">
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" id="editName" class="search-input">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="editPhone" class="search-input">
          <div style="display:flex; gap:10px;">
              <div style="flex:1"><label>Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</label><input type="text" id="editWilaya" class="search-input"></div>
              <div style="flex:1"><label>Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©</label><input type="text" id="editCommune" class="search-input"></div>
          </div>
          <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="editAddress" class="search-input">
          <label style="color:var(--primary-color); font-weight:bold;">Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ØµØ§ÙÙŠ (Ù„Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…):</label>
          <input type="number" id="editProductPrice" class="search-input" style="border:2px solid var(--primary-color); background:#f0f8ff; font-weight:bold;">
          <input type="hidden" id="currentOrderId">
          <div class="modal-actions" style="display: flex; gap: 10px; margin-top: 15px;">
              <button id="saveChangesBtn" style="flex: 1; padding: 10px; background: var(--secondary-color); color: white; border: none; border-radius: 5px; cursor: pointer;">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
          </div>
      </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = { apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4", authDomain: "myestore-34f65.firebaseapp.com", databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com", projectId: "myestore-34f65", storageBucket: "myestore-34f65.firebasestorage.app", messagingSenderId: "14078917211", appId: "1:14078917211:web:a48eab2a7396c094f7dd7e", measurementId: "G-9181DX0XNJ" };
    const app = initializeApp(firebaseConfig); const db = getDatabase(app); const auth = getAuth(app);

    const ordersRef = ref(db, 'orders'); const settingsRef = ref(db, 'delivery_settings'); const zonesRef = ref(db, 'shipping_zones');
    const shippingContainer = document.getElementById('shippingOrdersContainer');
    const shipProviderSelect = document.getElementById('shipProviderSelect');
    const savedProvidersList = document.getElementById('savedProvidersList');
    
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ø§Ø¨ØªØ©
    const allWilayas = [ "01. Ø£Ø¯Ø±Ø§Ø±", "02. Ø§Ù„Ø´Ù„Ù", "03. Ø§Ù„Ø£ØºÙˆØ§Ø·", "04. Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ", "05. Ø¨Ø§ØªÙ†Ø©", "06. Ø¨Ø¬Ø§ÙŠØ©", "07. Ø¨Ø³ÙƒØ±Ø©", "08. Ø¨Ø´Ø§Ø±", "09. Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©", "10. Ø§Ù„Ø¨ÙˆÙŠØ±Ø©", "11. ØªÙ…Ù†Ø±Ø§Ø³Øª", "12. ØªØ¨Ø³Ø©", "13. ØªÙ„Ù…Ø³Ø§Ù†", "14. ØªÙŠØ§Ø±Øª", "15. ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ", "16. Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", "17. Ø§Ù„Ø¬Ù„ÙØ©", "18. Ø¬ÙŠØ¬Ù„", "19. Ø³Ø·ÙŠÙ", "20. Ø³Ø¹ÙŠØ¯Ø©", "21. Ø³ÙƒÙŠÙƒØ¯Ø©", "22. Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³", "23. Ø¹Ù†Ø§Ø¨Ø©", "24. Ù‚Ø§Ù„Ù…Ø©", "25. Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©", "26. Ø§Ù„Ù…Ø¯ÙŠØ©", "27. Ù…Ø³ØªØºØ§Ù†Ù…", "28. Ø§Ù„Ù…Ø³ÙŠÙ„Ø©", "29. Ù…Ø¹Ø³ÙƒØ±", "30. ÙˆØ±Ù‚Ù„Ø©", "31. ÙˆÙ‡Ø±Ø§Ù†", "32. Ø§Ù„Ø¨ÙŠØ¶", "33. Ø¥Ù„ÙŠØ²ÙŠ", "34. Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬", "35. Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³", "36. Ø§Ù„Ø·Ø§Ø±Ù", "37. ØªÙ†Ø¯ÙˆÙ", "38. ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª", "39. Ø§Ù„ÙˆØ§Ø¯ÙŠ", "40. Ø®Ù†Ø´Ù„Ø©", "41. Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³", "42. ØªÙŠØ¨Ø§Ø²Ø©", "43. Ù…ÙŠÙ„Ø©", "44. Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰", "45. Ø§Ù„Ù†Ø¹Ø§Ù…Ø©", "46. Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª", "47. ØºØ±Ø¯Ø§ÙŠØ©", "48. ØºÙ„ÙŠØ²Ø§Ù†", "49. ØªÙŠÙ…ÙŠÙ…ÙˆÙ†", "50. Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±", "51. Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„", "52. Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³", "53. Ø¥Ù† ØµØ§Ù„Ø­", "54. Ø¥Ù† Ù‚Ø²Ø§Ù…", "55. ØªÙ‚Ø±Øª", "56. Ø¬Ø§Ù†Øª", "57. Ø§Ù„Ù…ØºÙŠØ±", "58. Ø§Ù„Ù…Ù†ÙŠØ¹Ø©" ];
    
    // Ù…Ø±Ø§ÙƒØ² Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Fallback)
    const OFFLINE_CENTERS = {
        16: { id: 163001, commune: "Bordj El Kiffan" }, // Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±
        31: { id: 310101, commune: "Oran" },            // ÙˆÙ‡Ø±Ø§Ù†
        19: { id: 190101, commune: "Setif" },           // Ø³Ø·ÙŠÙ
        25: { id: 250101, commune: "Constantine" },     // Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©
        30: { id: 300101, commune: "Ouargla" },         // ÙˆØ±Ù‚Ù„Ø©
        09: { id: 90101, commune: "Blida" }             // Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©
    };

    const communeMap = {
        "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±": "Alger Centre", "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„ÙˆØ³Ø·Ù‰": "Alger Centre", "Ø²Ø±Ø§Ù„Ø¯Ø©": "Zeralda", "Ø§Ù„Ø±ÙˆÙŠØ¨Ø©": "Rouiba",
        "Ø§Ù„Ø­Ø±Ø§Ø´": "El Harrach", "Ø¨Ø¦Ø± Ù…Ø±Ø§Ø¯ Ø±Ø§ÙŠØ³": "Bir Mourad Rais", "Ø§Ù„Ù‚Ø¨Ø©": "Kouba", "ÙˆÙ‡Ø±Ø§Ù†": "Oran",
        "Ø§Ù„Ø³Ø§Ù†ÙŠØ©": "Es Senia", "Ø¨Ø¦Ø± Ø§Ù„Ø¬ÙŠØ±": "Bir El Djir", "Ø³Ø·ÙŠÙ": "Setif", "Ø§Ù„Ø¹Ù„Ù…Ø©": "El Eulma"
    };

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    let allCentersCache = JSON.parse(localStorage.getItem('guepex_centers')) || [];
    let allWilayasApiCache = JSON.parse(localStorage.getItem('guepex_wilayas')) || [];
    let allCommunesApiCache = JSON.parse(localStorage.getItem('guepex_communes')) || [];

    // Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
    function normalizeText(text) {
        if (!text) return "";
        let str = text.toLowerCase().trim();
        str = str.replace(/(Ø¢|Ø¥|Ø£)/g, 'a').replace(/Ø©/g, 'e').replace(/Ø¦/g, 'i').replace(/Ù‰/g, 'i').replace(/_/g, ' ').replace(/-/g, ' ');
        str = str.replace(/[^a-z0-9 ]/g, ""); 
        return str;
    }

    function getWilayaIdByName(arabicName) {
        if(!arabicName) return null;
        const matchNum = arabicName.match(/^(\d+)/);
        if (matchNum) return parseInt(matchNum[1]);
        const cleanName = normalizeText(arabicName);
        const match = allWilayas.find(w => normalizeText(w.split('. ')[1]) === cleanName);
        if(match) return parseInt(match.split('.')[0]); 
        return null;
    }

    // Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = 'admin-login.html';
        else { 
            document.getElementById('logoutBtn').style.display = 'block'; 
            loadActiveProviders(); renderWilayaCheckboxes();
            updateApiStatus();
        }
    });
    document.getElementById('logoutBtn').addEventListener('click', async () => await signOut(auth));

    function updateApiStatus() {
        const msg = document.getElementById('apiStatusMsg');
        if(allCentersCache.length > 0) msg.innerHTML = `âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆÙØ±Ø©: ${allCentersCache.length} Ù…ÙƒØªØ¨ØŒ ${allCommunesApiCache.length} Ø¨Ù„Ø¯ÙŠØ©.`;
        else msg.innerHTML = `âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙƒØ§ØªØ¨ Ù…Ø®Ø²Ù†Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª".`;
    }

    // =============================================
    // ğŸ”¥ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† API (Caching System) ğŸ”¥
    // =============================================
    async function fetchAllPages(url, headers) {
        let allData = []; let page = 1; let hasMore = true;
        while(hasMore && page <= 10) { // Safety limit
            try {
                const sep = url.includes('?') ? '&' : '?';
                const finalUrl = `${url}${sep}page=${page}&page_size=1000`;
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø±ÙˆÙƒØ³ÙŠ Ø¨Ø¯ÙŠÙ„ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                const res = await fetch('https://corsproxy.io/?' + encodeURIComponent(finalUrl), { headers });
                if(!res.ok) throw new Error("Network response was not ok");
                const json = await res.json();
                if (json.data) allData = allData.concat(json.data);
                hasMore = json.has_more;
                page++;
            } catch(e) { 
                console.warn("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØµÙØ­Ø© " + page, e); hasMore = false; 
            }
        }
        return allData;
    }

    async function forceFetchGuepexData(apiUrl, apiId, apiToken) {
        let baseUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
        if(baseUrl.includes('/v1/parcels')) baseUrl = baseUrl.replace('/v1/parcels', '/v1');
        else if(!baseUrl.includes('/v1')) baseUrl += '/v1';

        const headers = { 'X-API-ID': apiId, 'X-API-TOKEN': apiToken };
        const btn = document.getElementById('refreshApiBtn');
        const origText = btn.textContent;
        btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„..."; btn.disabled = true;

        try {
            console.log("Starting full API sync...");
            const [w, c, ct] = await Promise.all([
                fetchAllPages(`${baseUrl}/wilayas`, headers),
                fetchAllPages(`${baseUrl}/communes`, headers),
                fetchAllPages(`${baseUrl}/centers`, headers)
            ]);

            allWilayasApiCache = w; allCommunesApiCache = c; allCentersCache = ct;
            
            // Save to LocalStorage
            localStorage.setItem('guepex_wilayas', JSON.stringify(w));
            localStorage.setItem('guepex_communes', JSON.stringify(c));
            localStorage.setItem('guepex_centers', JSON.stringify(ct));

            alert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!\nØªÙ… Ø¬Ù„Ø¨ ${ct.length} Ù…ÙƒØªØ¨ ØªÙˆØµÙŠÙ„.`);
            updateApiStatus();
        } catch(e) {
            alert("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ù…ÙØ§ØªÙŠØ­ API Ø£Ùˆ Ø¬Ø±Ø¨ Ù„Ø§Ø­Ù‚Ø§Ù‹.\nØ§Ù„Ø®Ø·Ø£: " + e.message);
        } finally {
            btn.textContent = origText; btn.disabled = false;
        }
    }

    document.getElementById('refreshApiBtn').addEventListener('click', async () => {
        const providerId = shipProviderSelect.value;
        if(!providerId) return alert("Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ø´Ø­Ù† Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.");
        const snap = await get(ref(db, `delivery_settings/${providerId}`));
        if(snap.exists()) {
            const d = snap.val();
            await forceFetchGuepexData(d.apiUrl, d.apiKey, d.apiToken);
        }
    });

    // =============================================
    // ğŸ”¥ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø·Ù„Ø¨ (Logic) ğŸ”¥
    // =============================================
    function resolveGuepexDestination(orderData) {
        const { wilayaId, rawCommune, isStopDesk } = orderData;
        const normalizedSearch = normalizeText(communeMap[rawCommune] || rawCommune);

        // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆÙ„Ø§ÙŠØ© (Official Name)
        let finalWilayaName = "Alger";
        const foundWilaya = allWilayasApiCache.find(w => w.id == wilayaId);
        if (foundWilaya) finalWilayaName = foundWilaya.name;

        // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Stop Desk (Ø§Ù„Ù…ÙƒØªØ¨)
        if (isStopDesk) {
            let selectedCenter = null;
            
            // ØªØµÙÙŠØ© Ø§Ù„Ù…ÙƒØ§ØªØ¨ ÙÙŠ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©
            const centersInWilaya = allCentersCache.filter(c => c.wilaya_id == wilayaId);
            
            if (centersInWilaya.length === 0) {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Offline Data
                if(OFFLINE_CENTERS[wilayaId]) {
                    return { 
                        to_wilaya_name: finalWilayaName, 
                        to_commune_name: OFFLINE_CENTERS[wilayaId].commune, 
                        is_stopdesk: true, 
                        stopdesk_id: OFFLINE_CENTERS[wilayaId].id,
                        address: "Stop Desk"
                    };
                }
                throw new Error(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒØ§ØªØ¨ ØªÙˆØµÙŠÙ„ Ù…ØªØ§Ø­Ø© ÙÙŠ ÙˆÙ„Ø§ÙŠØ© ${finalWilayaName}`);
            }

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØªØ¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©
            selectedCenter = centersInWilaya.find(c => normalizeText(c.name).includes(normalizedSearch) || normalizeText(c.commune_name).includes(normalizedSearch));

            // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ØŒ Ù†Ø£Ø®Ø° "Ø§Ù„Ù…ÙƒØªØ¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ" Ø£Ùˆ "Ø£ÙˆÙ„ Ù…ÙƒØªØ¨" (Fallback Ù‚ÙˆÙŠ)
            if (!selectedCenter) {
                // Ù†ÙØ¶Ù„ Ø§Ù„Ù…ÙƒØ§ØªØ¨ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ© (ØºØ§Ù„Ø¨Ø§Ù‹ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)
                selectedCenter = centersInWilaya.find(c => normalizeText(c.name).includes(normalizeText(finalWilayaName)));
                if(!selectedCenter) selectedCenter = centersInWilaya[0]; // Ø§Ù„Ù…Ù„Ø§Ø° Ø§Ù„Ø£Ø®ÙŠØ±
            }

            return {
                to_wilaya_name: finalWilayaName,
                to_commune_name: selectedCenter.commune_name || finalWilayaName,
                is_stopdesk: true,
                stopdesk_id: selectedCenter.center_id || selectedCenter.id, // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„ØªØ³Ù…ÙŠØ§Øª
                address: `Stop Desk - ${selectedCenter.name}`
            };
        } 
        
        // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…Ù†Ø²Ù„ (Home)
        else {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© Ø§Ù„ØµØ­ÙŠØ­ ÙÙŠ API
            const exactCommune = allCommunesApiCache.find(c => c.wilaya_id == wilayaId && normalizeText(c.name) === normalizedSearch);
            let finalCommuneName = exactCommune ? exactCommune.name : finalWilayaName;
            
            // ØªØµØ­ÙŠØ­ Ø®Ø§Øµ Ù„Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„Ø¹Ø§ØµÙ…Ø©
            if (normalizeText(finalWilayaName) === 'alger' && (!exactCommune || normalizedSearch.includes('alger'))) {
                finalCommuneName = "Alger Centre";
            }

            return {
                to_wilaya_name: finalWilayaName,
                to_commune_name: finalCommuneName,
                is_stopdesk: false,
                address: orderData.address || rawCommune // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£ØµÙ„ÙŠ
            };
        }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    onValue(ordersRef, async (snapshot) => {
        shippingContainer.innerHTML = '';
        const orders = snapshot.val() || {};
        const sorted = Object.entries(orders).sort((a,b) => b[1].timestamp - a[1].timestamp);
        
        let products = {};
        try { const pSnap = await get(ref(db, 'products')); if(pSnap.exists()) products = pSnap.val(); } catch(e){}

        let count = 0;
        sorted.forEach(([id, order]) => {
            const status = (order.status || '').toLowerCase();
            if(status.includes('shipped') || status.includes('deliv')) return; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø´Ø­ÙˆÙ†
            
            count++;
            let currentTotal = parseFloat(order.productTotal);
            if(isNaN(currentTotal)) currentTotal = parseFloat(order.totalPrice || 0) - parseFloat(order.shippingPrice || 0);
            
            // Ø®ØµÙ… Ø§Ù„ØªØ³ÙˆÙŠÙ‚
            let marketing = 0;
            if(order.productId && products[order.productId]) marketing = parseFloat(products[order.productId].marketingDiscount || 0);
            const qty = parseInt(order.quantity || 1);
            let netPrice = currentTotal - (marketing * qty); if(netPrice < 0) netPrice = 0;

            const isDeskDefault = (order.deliveryOption && (order.deliveryOption.includes('desk') || order.deliveryOption.includes('Ù…ÙƒØªØ¨')));

            const row = document.createElement('div'); row.className = 'order-row'; row.dataset.id = id;
            row.style.cssText = "display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #fff; border: 1px solid #eee; margin-bottom: 8px; border-right: 4px solid " + (isDeskDefault ? "#1976d2" : "#388e3c");
            
            row.innerHTML = `
                <div style="flex:2; display:flex; gap:10px;">
                    <input type="checkbox" class="order-checkbox" value="${id}">
                    <div>
                        <div style="font-weight:bold;">${order.customerName || order.name} <span style="font-size:0.8rem; color:#888;">${id}</span></div>
                        <div style="font-size:0.85rem;">${order.customerWilaya || '?'} - ${order.customerCommune || '?'}</div>
                        <div style="color:var(--primary-color); font-weight:bold;">${netPrice} Ø¯Ø¬ (ØµØ§ÙÙŠ)</div>
                    </div>
                </div>
                <div style="flex:1; text-align:center;">
                    <select class="delivery-type-select" style="padding:5px; border-radius:4px; border:1px solid #ddd;">
                        <option value="home" ${!isDeskDefault?'selected':''}>ğŸ  Ù…Ù†Ø²Ù„</option>
                        <option value="desk" ${isDeskDefault?'selected':''}>ğŸ¢ Ù…ÙƒØªØ¨</option>
                    </select>
                </div>
                <div onclick="window.openDetails('${id}')" style="cursor:pointer; font-size:1.2rem;">âœï¸</div>
            `;
            shippingContainer.appendChild(row);
        });
        if(count===0) shippingContainer.innerHTML = '<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</p>';
    });

    // =============================================
    // ğŸ”¥ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ (Ø§Ù„ØªÙ†ÙÙŠØ°) ğŸ”¥
    // =============================================
    document.getElementById('sendBulkBtn').addEventListener('click', async function() {
        const btn = this; const providerId = shipProviderSelect.value; 
        const checks = document.querySelectorAll('.order-checkbox:checked');
        
        if(!providerId) return alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù† Ø£ÙˆÙ„Ø§Ù‹!');
        if(checks.length === 0) return alert('Ø­Ø¯Ø¯ Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if(allCentersCache.length === 0) {
            if(!confirm("âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒØ§ØªØ¨ ØºÙŠØ± Ù…Ø­Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±. Ù‚Ø¯ ØªÙØ´Ù„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù€ Stop Desk Ø£Ùˆ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŸ")) return;
        }

        btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©..."; btn.disabled = true;
        let successCount = 0; let failCount = 0; let logs = "";

        try {
            const setSnap = await get(ref(db, `delivery_settings/${providerId}`));
            const apiData = setSnap.val();

            for (const chk of checks) {
                const orderId = chk.value;
                try {
                    const orderSnap = await get(ref(db, `orders/${orderId}`));
                    const order = orderSnap.val();
                    const row = document.querySelector(`.order-row[data-id="${orderId}"]`);
                    const isStopDesk = row.querySelector('.delivery-type-select').value === 'desk';

                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø±
                    let netPrice = parseFloat(order.productTotal);
                    if(isNaN(netPrice)) netPrice = parseFloat(order.totalPrice||0) - parseFloat(order.shippingPrice||0);
                    // (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø®ØµÙ… Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ù‡Ù†Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©)

                    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙˆØ¬Ù‡Ø©
                    let wilayaId = getWilayaIdByName(order.customerWilaya || order.state);
                    let rawCommune = (order.customerCommune || "").trim();
                    
                    const destination = resolveGuepexDestination({
                        wilayaId: wilayaId,
                        rawCommune: rawCommune,
                        isStopDesk: isStopDesk,
                        address: order.customerAddress || rawCommune
                    });

                    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ Payload
                    let payloadItem = {
                        "order_id": orderId.replace('#',''),
                        "firstname": (order.customerName || "Client").split(' ')[0],
                        "familyname": (order.customerName || " ").split(' ').slice(1).join(' ') || ".",
                        "contact_phone": (order.customerPhone || "").replace(/[^0-9]/g, ''),
                        "address": destination.address,
                        "to_wilaya_name": destination.to_wilaya_name,
                        "to_commune_name": destination.to_commune_name,
                        "product_list": order.productName || "Colis",
                        "price": netPrice,
                        "freeshipping": false, // Ø¯Ø§Ø¦Ù…Ø§ false Ù„Ù€ COD
                        "is_stopdesk": destination.is_stopdesk,
                        "has_exchange": false,
                        "product_type": "colis"
                    };

                    if(destination.is_stopdesk && destination.stopdesk_id) {
                        payloadItem.stopdesk_id = destination.stopdesk_id;
                    }

                    // Ø¥Ø±Ø³Ø§Ù„
                    let postUrl = apiData.apiUrl;
                    if(!postUrl.includes('/v1/parcels')) postUrl = postUrl.replace(/\/$/, '') + '/v1/parcels';
                    
                    console.log("Sending Payload:", JSON.stringify([payloadItem])); // Debug

                    const res = await fetch('https://corsproxy.io/?' + encodeURIComponent(postUrl), {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-API-ID': apiData.apiKey,
                            'X-API-TOKEN': apiData.apiToken
                        },
                        body: JSON.stringify([payloadItem])
                    });

                    const resJson = await res.json();
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø¬Ø§Ø­ (Yalidine ÙŠØ±Ø¬Ø¹ Object Ù…ÙØªØ§Ø­Ù‡ order_id)
                    const key = payloadItem.order_id;
                    if(resJson[key] && resJson[key].success) {
                        successCount++;
                        await update(ref(db, `orders/${orderId}`), { 
                            status: 'Shipped', 
                            trackingCode: resJson[key].tracking,
                            shippedAt: Date.now()
                        });
                    } else if (Array.isArray(resJson) && resJson[0].tracking) {
                         successCount++;
                         await update(ref(db, `orders/${orderId}`), { status: 'Shipped', trackingCode: resJson[0].tracking });
                    } else {
                        throw new Error(resJson[key] ? resJson[key].message : JSON.stringify(resJson));
                    }

                } catch(err) {
                    failCount++;
                    logs += `\nâŒ ${orderId}: ${err.message}`;
                    console.error(err);
                }
            }
        } catch(mainErr) {
            alert("Ø®Ø·Ø£ Ø¹Ø§Ù…: " + mainErr.message);
        }

        btn.textContent = "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯"; btn.disabled = false;
        let msg = `Ø§Ù„Ù†ØªÙŠØ¬Ø©:\nâœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${successCount}\nâŒ ÙØ´Ù„: ${failCount}`;
        if(logs) msg += `\n\nØ§Ù„Ø£Ø®Ø·Ø§Ø¡:${logs}`;
        alert(msg);
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    function loadActiveProviders() {
        onValue(settingsRef, (snap) => {
            shipProviderSelect.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© --</option>';
            savedProvidersList.innerHTML = '';
            if(snap.exists()) {
                Object.entries(snap.val()).forEach(([k, p]) => {
                    if(p.active !== false) {
                        const opt = document.createElement('option'); opt.value = k; opt.textContent = p.displayName; shipProviderSelect.appendChild(opt);
                        savedProvidersList.innerHTML += `<div class="provider-item" style="padding:10px; background:#f4f4f4; margin-bottom:5px;">${p.displayName} <button onclick="window.delProv('${k}')" style="float:left;color:red;">Ø­Ø°Ù</button></div>`;
                    }
                });
            }
        });
    }

    // Ø¨Ø§Ù‚ÙŠ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªØ³Ø¹ÙŠØ± (ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ)
    document.getElementById('saveProviderBtn').addEventListener('click', async function() {
        const name=document.getElementById('provName').value, key=document.getElementById('provKey').value, token=document.getElementById('provToken').value, url=document.getElementById('provUrl').value;
        if(!name || !key) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        await update(ref(db, `delivery_settings/${name.replace(/\s+/g,'_').toLowerCase()}`), {
            displayName: name, apiUrl: url, apiKey: key, apiToken: token, driverType: document.getElementById('provDriver').value, active: true
        });
        alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸");
    });
    window.delProv = async (k) => { if(confirm('Ø­Ø°ÙØŸ')) await remove(ref(db, `delivery_settings/${k}`)); };
    
    // Modal Functions
    window.openDetails = async (id) => { const s=await get(ref(db,'orders/'+id)); if(s.exists()){const o=s.val(); document.getElementById('currentOrderId').value=id; document.getElementById('editName').value=o.customerName||o.name; document.getElementById('editWilaya').value=o.customerWilaya; document.getElementById('editCommune').value=o.customerCommune||''; document.getElementById('orderDetailModal').classList.remove('hidden');}};
    document.getElementById('closeDetailModal').addEventListener('click',()=>document.getElementById('orderDetailModal').classList.add('hidden'));
    document.getElementById('saveChangesBtn').addEventListener('click',async()=>{const id=document.getElementById('currentOrderId').value; await update(ref(db,'orders/'+id),{customerName:document.getElementById('editName').value, customerWilaya:document.getElementById('editWilaya').value, customerCommune:document.getElementById('editCommune').value}); document.getElementById('orderDetailModal').classList.add('hidden'); alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");});

</script>
<script> function toggleMenu() { document.querySelector('nav .links').classList.toggle('open'); } </script>
</body>
</html>