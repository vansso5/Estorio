<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø±Ø¨Ø·</title>

<!-- Ø±Ø¨Ø· Ø§Ù„Ø®Ø· ÙˆØ§Ù„Ø³ØªØ§ÙŠÙ„ -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="admin-style.css">

</head>
<body>

<nav>
  <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>

  <div class="logo">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
  <div class="links">
    <a href="admin-products.html" class="nav-link">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
    <a href="admin-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</a>
    <a href="completed-orders.html" class="nav-link">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</a>
    <a href="admin-analytics.html" class="nav-link">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</a>
    <a href="admin-settings.html" class="nav-link">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
    <a href="admin-reviews.html" class="nav-link">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</a>
    <a href="admin-shipping.html" class="nav-link active">Ø§Ù„Ø´Ø­Ù†</a>
    <a href="#" id="logoutBtn" class="nav-link" style="display: none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
  </div>
</nav>

<!-- Ù…ÙƒØ§Ù† Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
<div class="visitors-wrapper">
  <div id="liveVisitors" class="live-visitors-badge inactive">
    <span class="live-dot"></span>
    <span style="margin-right:5px">Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ø¢Ù†: </span>
    <strong id="visitorsCount" style="margin:0 4px">0</strong>
  </div>
</div>

<div class="container">
    
    <!-- Ø§Ù„Ù‚Ø³Ù… 1: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª -->
    <h2 style="margin-bottom: 20px; color: var(--primary-color);">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø´Ø±ÙƒØ§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ (API)</h2>
    <div class="form-card" style="margin-bottom: 30px;">
        <h4 style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø© / ØªØ¹Ø¯ÙŠÙ„</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div><label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©:</label><input type="text" id="provName" class="search-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: GroupEX"></div>
            <div><label>Ø±Ø§Ø¨Ø· API (Ù…Ø«Ù„Ø§Ù‹ https://api.guepex.app):</label><input type="text" id="provUrl" class="search-input" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ API"></div>
            <div><label>API Key / User ID:</label><input type="text" id="provKey" class="search-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"></div>
            <div><label>API Token / Password:</label><input type="text" id="provToken" class="search-input" placeholder="Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø·ÙˆÙŠÙ„ (Token)"></div>
            <div>
                <label>Ù‡ÙŠÙƒÙ„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</label>
                <select id="provDriver" class="search-input">
                    <option value="yalidine_style" selected>Ù†Ø¸Ø§Ù… Yalidine / Guepex (Ø§Ù„Ø¬Ø¯ÙŠØ¯)</option>
                    <option value="standard">Ù†Ø¸Ø§Ù… Ø¢Ø®Ø± / Ù‚ÙŠØ§Ø³ÙŠ</option>
                </select>
            </div>
            <div>
                <label>ØµÙŠØºØ© Ø§Ù„ÙˆÙ„Ø§ÙŠØ©:</label>
                <select id="provWilayaFormat" class="search-input">
                    <option value="french_name" selected>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ© (Alger)</option>
                    <option value="id">Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ© (16)</option>
                    <option value="arabic_name">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±)</option>
                </select>
            </div>
        </div>
        <button id="saveProviderBtn" class="save-btn" style="margin-top:15px; width:100%; background-color: var(--secondary-color); color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer;">Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</button>
        
        <div style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px;">
            <label>Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</label>
            <div id="savedProvidersList" style="margin-top: 10px;"><p class="loading-message">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
        </div>
    </div>

    <!-- Ø§Ù„Ù‚Ø³Ù… 2: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
    <h2 style="margin-bottom: 20px; color: var(--primary-color);">ğŸ“¦ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Shipping)</h2>
    <div class="form-card" style="margin-bottom: 30px;">
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
            <div style="flex:3; min-width: 250px;">
                <label>Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„:</label>
                <select id="shipProviderSelect" class="search-input">
                    <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© --</option>
                </select>
            </div>
            <div style="flex:1;">
                <button id="sendBulkBtn" style="width: 100%; padding: 10px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
            </div>
        </div>
        
        <h3 style="margin-bottom:15px;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ² (Processing)</h3>
        <div id="shippingOrdersContainer" class="orders-grid">
            <p class="loading-message">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
        </div>
    </div>

    <!-- Ø§Ù„Ù‚Ø³Ù… 3: Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ -->
    <h2 style="margin-bottom: 20px; color: var(--primary-color);">ğŸ’° ØªØ³Ø¹ÙŠØ±Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ (Ù„Ù„Ù…ØªØ¬Ø±)</h2>
    <div class="form-card">
      <div style="display:flex; gap:10px; margin-bottom:15px;">
           <div style="flex:1;"><label>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†Ø²Ù„ (Home):</label><input type="number" id="homePrice" class="search-input"></div>
           <div style="flex:1;"><label>Ø³Ø¹Ø± Ø§Ù„Ù…ÙƒØªØ¨ (Desk):</label><input type="number" id="deskPrice" class="search-input"></div>
      </div>
      <div style="margin-bottom: 10px;"><button type="button" id="selectAllBtn" style="padding:5px 10px; cursor:pointer; background: #eee; border: 1px solid #ddd; border-radius: 4px;">ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„</button></div>
      
      <div id="wilayaGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; padding: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 5px;"></div>
      
      <button id="saveZoneBtn" class="save-btn" style="margin-top:15px; width: 100%; background-color: var(--secondary-color); color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer;">Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¹ÙŠØ±Ø©</button>
    </div>
    
    <div id="zonesContainer" class="orders-grid" style="margin-top: 20px;"></div>

</div>

<!-- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ -->
<div id="orderDetailModal" class="modal hidden">
    <div class="modal-content">
      <button class="close-modal-btn" id="closeDetailModal">&times;</button>
      <h3>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h3>
      <div class="details-section" style="margin-top: 15px;">
          <label style="display:block;margin-bottom:5px;">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input type="text" id="editName" class="search-input" style="margin-bottom:10px;">
          
          <label style="display:block;margin-bottom:5px;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input type="text" id="editPhone" class="search-input" style="margin-bottom:10px;">
          
          <div style="display:flex; gap:10px;">
              <div style="flex:1">
                  <label style="display:block;margin-bottom:5px;">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</label>
                  <input type="text" id="editWilaya" class="search-input" style="margin-bottom:10px;">
              </div>
              <div style="flex:1">
                  <label style="display:block;margin-bottom:5px;">Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©</label>
                  <input type="text" id="editCommune" class="search-input" style="margin-bottom:10px;">
              </div>
          </div>

          <label style="display:block;margin-bottom:5px;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
          <input type="text" id="editAddress" class="search-input" style="margin-bottom:10px;">
          
          <label style="color:var(--primary-color); font-weight:bold; display:block; margin-bottom:5px;">Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ØµØ§ÙÙŠ (Ø¨Ø¹Ø¯ Ø®ØµÙ… Ø§Ù„Ø´Ø­Ù†):</label>
          <input type="number" id="editProductPrice" class="search-input" style="margin-bottom:10px; border:2px solid var(--primary-color); background:#f0f8ff; font-weight:bold; font-size:1.1rem;">
          <small style="color:#666; display:block; margin-bottom:10px;">âš ï¸ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„.</small>

          <input type="hidden" id="currentOrderId">
          
          <div class="modal-actions" style="display: flex; gap: 10px; margin-top: 15px;">
              <button id="saveChangesBtn" style="flex: 1; padding: 10px; background: var(--secondary-color); color: white; border: none; border-radius: 5px; cursor: pointer;">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
              <button id="cancelOrderBtn" class="btn-delete">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
          </div>
      </div>
    </div>
  </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4", authDomain: "myestore-34f65.firebaseapp.com", databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com", projectId: "myestore-34f65", storageBucket: "myestore-34f65.firebasestorage.app", messagingSenderId: "14078917211", appId: "1:14078917211:web:a48eab2a7396c094f7dd7e", measurementId: "G-9181DX0XNJ" };
    const app = initializeApp(firebaseConfig); const db = getDatabase(app); const auth = getAuth(app);

    const ordersRef = ref(db, 'orders'); const settingsRef = ref(db, 'delivery_settings'); const zonesRef = ref(db, 'shipping_zones');
    const visitorsRef = ref(db, 'site_presence');
    const shippingContainer = document.getElementById('shippingOrdersContainer');
    const shipProviderSelect = document.getElementById('shipProviderSelect');
    const savedProvidersList = document.getElementById('savedProvidersList');
    
    // ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    let allCentersCache = []; 
    let allWilayasCache = [];
    let allCommunesCache = []; // Ø³Ù†Ø®Ø²Ù† Ø¨Ù„Ø¯ÙŠØ§Øª Guepex Ù‡Ù†Ø§

    // ==========================================
    // 1. Ù‚Ø§Ù…ÙˆØ³ ÙŠØ¯ÙˆÙŠ Ø³Ø±ÙŠØ¹ (Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ø¬Ø¯Ø§Ù‹)
    // ==========================================
    const manualCommuneMap = {
        "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±": "Alger Centre", "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„ÙˆØ³Ø·Ù‰": "Alger Centre", 
        "ÙˆÙ‡Ø±Ø§Ù†": "Oran", "Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©": "Constantine", "Ø¹Ù†Ø§Ø¨Ø©": "Annaba", "Ø³Ø·ÙŠÙ": "Setif",
        "Ø²Ø±Ø§Ù„Ø¯Ø©": "Zeralda", "Ø§Ù„Ø±ÙˆÙŠØ¨Ø©": "Rouiba", "Ø§Ù„Ø´Ø±Ø§Ù‚Ø©": "Cheraga", "Ø¨Ø¦Ø± Ù…Ø±Ø§Ø¯ Ø±Ø§ÙŠØ³": "Bir Mourad Rais",
        "Ø¯Ø±Ø§Ø±ÙŠØ©": "Draria", "Ø¨Ø§Ø¨ Ø§Ù„Ø²ÙˆØ§Ø±": "Bab Ezzouar", "Ø§Ù„Ø­Ø±Ø§Ø´": "El Harrach"
    };

    // Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†ØµÙˆØµ (ØªØ­Ø°Ù Ø§Ù„ Ø§Ù„ØªØ¹Ø±ÙŠÙ ÙˆØ§Ù„Ù‡Ù…Ø²Ø§Øª)
    function normalizeText(text) {
        if (!text) return "";
        let str = text.toLowerCase().trim();
        str = str.replace(/(Ø¢|Ø¥|Ø£)/g, 'Ø§').replace(/Ø©/g, 'Ù‡').replace(/Ø¦/g, 'ÙŠ').replace(/Ù‰/g, 'ÙŠ');
        str = str.replace(/^Ø§Ù„/, ''); // Ø­Ø°Ù Ø§Ù„ Ø§Ù„ØªØ¹Ø±ÙŠÙ
        return str;
    }

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = 'admin-login.html';
        else { document.getElementById('logoutBtn').style.display = 'block'; loadActiveProviders(); renderWilayaCheckboxes(); }
    });
    document.getElementById('logoutBtn').addEventListener('click', async () => await signOut(auth));

    // --- Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Guepex ---
    async function fetchGuepexData(apiUrl, apiId, apiToken) {
        if(allCommunesCache.length > 0) return; // ØªÙ… Ø§Ù„Ø¬Ù„Ø¨ Ù…Ø³Ø¨Ù‚Ø§Ù‹
        
        let baseUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;
        if(!baseUrl.includes('/v1')) baseUrl += '/v1';
        
        const headers = { 'X-API-ID': apiId, 'X-API-TOKEN': apiToken };

        try {
            console.log("Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ù„Ø¯ÙŠØ§Øª ÙˆØ§Ù„Ù…ÙƒØ§ØªØ¨...");
            
            // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙƒØ§ØªØ¨ (Centers)
            const centerRes = await fetch('https://corsproxy.io/?' + encodeURIComponent(`${baseUrl}/centers`), { headers });
            const centerJson = await centerRes.json();
            if(centerJson.data) allCentersCache = centerJson.data;

            // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ù„Ø¯ÙŠØ§Øª (Communes) - Ù†Ø­ØªØ§Ø¬ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø· ÙƒØ¨Ø¯Ø§ÙŠØ© Ø£Ùˆ Ù†Ø­Ø§ÙˆÙ„ Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙ„
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ù€ 1541 Ø¨Ù„Ø¯ÙŠØ© Ù‚Ø¯ Ù†Ø­ØªØ§Ø¬ Ù„Ø¹Ø¯Ø© ØµÙØ­Ø§ØªØŒ Ù„ÙƒÙ† Ø³Ù†Ø¬Ù„Ø¨ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ø­Ø¬Ù… ÙƒØ¨ÙŠØ±
            const commRes = await fetch('https://corsproxy.io/?' + encodeURIComponent(`${baseUrl}/communes?page_size=2000`), { headers });
            const commJson = await commRes.json();
            if(commJson.data) allCommunesCache = commJson.data;

            console.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allCommunesCache.length} Ø¨Ù„Ø¯ÙŠØ© Ùˆ ${allCentersCache.length} Ù…ÙƒØªØ¨.`);
            
        } catch(e) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Guepex:", e);
        }
    }

    // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø¹Ù† Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© ---
    function findBestCommuneMatch(arabicCommune, frenchWilaya) {
        if (!arabicCommune) return null;

        // 1. Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„ÙŠØ¯ÙˆÙŠ
        if (manualCommuneMap[arabicCommune]) return manualCommuneMap[arabicCommune];

        // 2. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ
        const cleanArabic = normalizeText(arabicCommune);

        // 3. Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Guepex (Ø§Ù„ØªÙŠ Ø¬Ù„Ø¨Ù†Ø§Ù‡Ø§)
        // Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¨Ù„Ø¯ÙŠØ© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ„Ø§ÙŠØ© (Ø¥Ø°Ø§ Ø¹Ø±ÙÙ†Ø§ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©)
        const relevantCommunes = frenchWilaya 
            ? allCommunesCache.filter(c => c.wilaya_name.toLowerCase() === frenchWilaya.toLowerCase())
            : allCommunesCache;

        // Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: Ù‡Ù„ Ø§Ø³Ù… Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ© ÙŠØ´Ø¨Ù‡ Ù†Ø·Ù‚ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŸ (Ù‡Ù†Ø§ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¨Ø­Ø« Ø¨Ø³ÙŠØ·)
        // Ù‡Ø°Ø§ ØµØ¹Ø¨ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ø¨Ø¯Ù‚Ø© 100% Ø¨Ø¯ÙˆÙ† Ù‚Ø§Ù…ÙˆØ³ ÙƒØ§Ù…Ù„ØŒ Ù„ÙƒÙ† Ø³Ù†Ø­Ø§ÙˆÙ„ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„Ù‰
        // Ø§Ù„Ø£ÙØ¶Ù„: Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ÙƒØ§ØªØ¨ Ù„Ø£Ù† Ø£Ø³Ù…Ø§Ø¦Ù‡Ø§ ØªØ­ØªÙˆÙŠ Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø£Ùˆ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªÙ†ØªØ§Ø¬Ù‡Ø§
        
        return null; // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ØŒ Ø³Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø© ÙÙŠ ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    }

    // --- Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª ---
    onValue(visitorsRef, (s) => { 
        if(!s.exists()) { document.getElementById('visitorsCount').textContent=0; return;} 
        const c = Object.keys(s.val()).length; 
        document.getElementById('visitorsCount').textContent=c; 
        document.getElementById('liveVisitors').className = c>0?'live-visitors-badge active':'live-visitors-badge inactive';
    });

    document.getElementById('saveProviderBtn').addEventListener('click', async function() {
        let url = document.getElementById('provUrl').value;
        if(url && url.endsWith('/')) url = url.slice(0, -1);
        if(url && url.includes('/v1/parcels')) url = url.replace('/v1/parcels', '');
        const name=document.getElementById('provName').value, key=document.getElementById('provKey').value, token=document.getElementById('provToken').value;
        if(!name || !url || !key) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        const btn = this; btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; btn.disabled = true;
        try {
            await update(ref(db, `delivery_settings/${name.replace(/\s+/g,'_').toLowerCase()}`), {
                displayName: name, apiUrl: url, apiKey: key, apiToken: token, driverType: document.getElementById('provDriver').value, wilayaFormat: document.getElementById('provWilayaFormat').value, active: true
            });
            alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸"); document.getElementById('provName').value=''; document.getElementById('provKey').value=''; document.getElementById('provToken').value='';
        } catch(e) { alert(e.message); } finally { btn.textContent = "Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©"; btn.disabled = false; }
    });

    function loadActiveProviders() {
        onValue(settingsRef, (snap) => {
            shipProviderSelect.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© --</option>';
            savedProvidersList.innerHTML = '';
            if(snap.exists()) {
                Object.entries(snap.val()).forEach(([k, p]) => {
                    const opt = document.createElement('option'); opt.value = k; opt.textContent = p.displayName; shipProviderSelect.appendChild(opt);
                    const div = document.createElement('div'); div.className = 'provider-item';
                    div.style.cssText = "display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border: 1px solid #ddd; padding: 10px 15px; border-radius: 8px; margin-bottom: 8px;";
                    div.innerHTML = `<div>${p.displayName} <small style="color:blue">(${p.driverType})</small></div><button class="btn-delete-prov" onclick="window.delProv('${k}')" style="background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Ø­Ø°Ù ğŸ—‘ï¸</button>`;
                    savedProvidersList.appendChild(div);
                });
            }
        });
    }
    window.delProv = async (k) => { if(confirm('Ø­Ø°ÙØŸ')) await remove(ref(db, `delivery_settings/${k}`)); };

    onValue(ordersRef, async (snapshot) => {
        shippingContainer.innerHTML = '';
        const orders = snapshot.val() || {};
        const sorted = Object.entries(orders).sort((a,b) => b[1].timestamp - a[1].timestamp);
        const productsSnap = await get(ref(db, 'products')); const products = productsSnap.exists() ? productsSnap.val() : {};
        let count = 0;

        sorted.forEach(([id, order]) => {
            const status = (order.status || '').toLowerCase();
            if(!status.includes('processing') && !status.includes('ØªØ¬Ù‡ÙŠØ²')) return;
            count++;
            let currentTotal = parseFloat(order.productTotal);
            if(isNaN(currentTotal)) currentTotal = calculateProductOnlyPrice(order);
            let discount = 0; if (order.productId && products[order.productId]) discount = parseFloat(products[order.productId].marketingDiscount || 0);
            const qty = parseInt(order.quantity || 1);
            let netPrice = currentTotal - (discount * qty); if(netPrice < 0) netPrice = 0;
            const isDeskByDefualt = (order.deliveryOption && (order.deliveryOption.includes('desk') || order.deliveryOption.includes('Ù…ÙƒØªØ¨')));

            const row = document.createElement('div'); row.className = 'order-row'; row.dataset.id = id;
            row.style.cssText = "display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; background: #fff; border-radius: 8px; margin-bottom: 8px; border: 1px solid #eee; border-right: 4px solid #f1c40f;";
            row.innerHTML = `
                <div class="row-info" style="display:flex;align-items:center; flex: 2;">
                    <input type="checkbox" class="order-checkbox" value="${id}" style="margin-left: 15px; transform: scale(1.3);">
                    <div style="margin-right:15px;">
                        <span class="row-name" style="font-weight:bold;">${order.customerName || order.name}</span>
                        <div style="font-size: 0.85rem; color: #666;"> ${order.customerWilaya || order.state} | ${order.customerCommune || ''} | <span style="color:#27ae60;font-weight:bold;">${netPrice} Ø¯Ø¬</span></div>
                    </div>
                </div>
                <div style="flex: 1; text-align: center;">
                    <select class="delivery-type-select" style="padding: 5px; border: 1px solid #ccc; border-radius: 4px; background: #f8f9fa;">
                        <option value="home" ${!isDeskByDefualt ? 'selected' : ''}>ğŸ  Ù…Ù†Ø²Ù„</option>
                        <option value="desk" ${isDeskByDefualt ? 'selected' : ''}>ğŸ¢ Ù…ÙƒØªØ¨</option>
                    </select>
                </div>
                <div onclick="window.openDetails('${id}')" style="cursor:pointer;color:blue; flex: 0.5; text-align: left;">ØªØ¹Ø¯ÙŠÙ„</div>`;
            shippingContainer.appendChild(row);
        });
        if(count === 0) shippingContainer.innerHTML = '<p class="loading-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØ¬Ù‡ÙŠØ².</p>';
    });

    function calculateProductOnlyPrice(order) {
        if (order.productTotal && !isNaN(order.productTotal)) return parseFloat(order.productTotal);
        if (order.items) {
            let sum = 0; const items = Array.isArray(order.items) ? order.items : Object.values(order.items);
            items.forEach(i => sum += (parseFloat(i.price) * parseInt(i.quantity || 1)));
            if(sum > 0) return sum;
        }
        let total = parseFloat(order.totalPrice || 0); let ship = parseFloat(order.shippingPrice || 0);
        return (total - ship) > 0 ? (total - ship) : total;
    }

    const wilayaMapping = { "Ø£Ø¯Ø±Ø§Ø±": "Adrar", "Ø§Ù„Ø´Ù„Ù": "Chlef", "Ø§Ù„Ø£ØºÙˆØ§Ø·": "Laghouat", "Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ": "Oum El Bouaghi", "Ø¨Ø§ØªÙ†Ø©": "Batna", "Ø¨Ø¬Ø§ÙŠØ©": "Bejaia", "Ø¨Ø³ÙƒØ±Ø©": "Biskra", "Ø¨Ø´Ø§Ø±": "Bechar", "Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©": "Blida", "Ø§Ù„Ø¨ÙˆÙŠØ±Ø©": "Bouira", "ØªÙ…Ù†Ø±Ø§Ø³Øª": "Tamanrasset", "ØªØ¨Ø³Ø©": "Tebessa", "ØªÙ„Ù…Ø³Ø§Ù†": "Tlemcen", "ØªÙŠØ§Ø±Øª": "Tiaret", "ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ": "Tizi Ouzou", "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±": "Alger", "Ø§Ù„Ø¬Ù„ÙØ©": "Djelfa", "Ø¬ÙŠØ¬Ù„": "Jijel", "Ø³Ø·ÙŠÙ": "Setif", "Ø³Ø¹ÙŠØ¯Ø©": "Saida", "Ø³ÙƒÙŠÙƒØ¯Ø©": "Skikda", "Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³": "Sidi Bel Abbes", "Ø¹Ù†Ø§Ø¨Ø©": "Annaba", "Ù‚Ø§Ù„Ù…Ø©": "Guelma", "Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©": "Constantine", "Ø§Ù„Ù…Ø¯ÙŠØ©": "Medea", "Ù…Ø³ØªØºØ§Ù†Ù…": "Mostaganem", "Ø§Ù„Ù…Ø³ÙŠÙ„Ø©": "M'sila", "Ù…Ø¹Ø³ÙƒØ±": "Mascara", "ÙˆØ±Ù‚Ù„Ø©": "Ouargla", "ÙˆÙ‡Ø±Ø§Ù†": "Oran", "Ø§Ù„Ø¨ÙŠØ¶": "El Bayadh", "Ø¥Ù„ÙŠØ²ÙŠ": "Illizi", "Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬": "Bordj Bou Arreridj", "Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³": "Boumerdes", "Ø§Ù„Ø·Ø§Ø±Ù": "El Tarf", "ØªÙ†Ø¯ÙˆÙ": "Tindouf", "ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª": "Tissemsilt", "Ø§Ù„ÙˆØ§Ø¯ÙŠ": "El Oued", "Ø®Ù†Ø´Ù„Ø©": "Khenchela", "Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³": "Souk Ahras", "ØªÙŠØ¨Ø§Ø²Ø©": "Tipaza", "Ù…ÙŠÙ„Ø©": "Mila", "Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰": "Ain Defla", "Ø§Ù„Ù†Ø¹Ø§Ù…Ø©": "Naama", "Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª": "Ain Temouchent", "ØºØ±Ø¯Ø§ÙŠØ©": "Ghardaia", "ØºÙ„ÙŠØ²Ø§Ù†": "Relizane", "ØªÙŠÙ…ÙŠÙ…ÙˆÙ†": "Timimoun", "Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±": "Bordj Badji Mokhtar", "Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„": "Ouled Djellal", "Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³": "Beni Abbes", "Ø¥Ù† ØµØ§Ù„Ø­": "In Salah", "Ø¥Ù† Ù‚Ø²Ø§Ù…": "In Guezzam", "ØªÙ‚Ø±Øª": "Touggourt", "Ø¬Ø§Ù†Øª": "Djanet", "Ø§Ù„Ù…ØºÙŠØ±": "El M'Ghair", "Ø§Ù„Ù…Ù†ÙŠØ¹Ø©": "El Meniaa" };

    // ==========================================
    // ğŸ”¥ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ğŸ”¥
    // ==========================================
    document.getElementById('sendBulkBtn').addEventListener('click', async function() {
        const btn = this; const providerId = shipProviderSelect.value; const checks = document.querySelectorAll('.order-checkbox:checked');
        if(!providerId || checks.length === 0) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª');
        if(!confirm(`Ø¥Ø±Ø³Ø§Ù„ ${checks.length} Ø·Ù„Ø¨ØŸ`)) return;
        btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„..."; btn.disabled = true;

        let apiData = null;
        try {
            const setSnap = await get(ref(db, `delivery_settings/${providerId}`));
            if(setSnap.exists()) apiData = setSnap.val(); else throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ù…ÙÙ‚ÙˆØ¯Ø©");
        } catch(e) { alert(e.message); btn.textContent = "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯"; btn.disabled = false; return; }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Guepex Ø£ÙˆÙ„Ø§Ù‹
        if(apiData.driverType === 'yalidine_style') {
            await fetchGuepexData(apiData.apiUrl, apiData.apiKey, apiData.apiToken);
        }

        let successCount = 0; let failCount = 0; let errorDetails = "";

        for (const chk of checks) {
            const orderId = chk.value;
            try {
                const orderSnap = await get(ref(db, `orders/${orderId}`));
                if(!orderSnap.exists()) continue;
                const order = orderSnap.val();
                
                const orderRow = document.querySelector(`.order-row[data-id="${orderId}"]`);
                const selectBox = orderRow ? orderRow.querySelector('.delivery-type-select') : null;
                let isStopDesk = selectBox ? (selectBox.value === 'desk') : (order.deliveryOption && (order.deliveryOption.toLowerCase().includes('desk') || order.deliveryOption.includes('Ù…ÙƒØªØ¨')));

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø±
                let currentTotal = parseFloat(order.productTotal);
                if (isNaN(currentTotal)) currentTotal = parseFloat(order.totalPrice || 0) - parseFloat(order.shippingPrice || 0);
                let marketingDiscount = 0;
                if(order.productId) { try { const prodSnap = await get(ref(db, `products/${order.productId}`)); if(prodSnap.exists()) marketingDiscount = parseFloat(prodSnap.val().marketingDiscount || 0); } catch(e) { } }
                const qty = parseInt(order.quantity || 1);
                let finalPriceToSend = currentTotal - (marketingDiscount * qty); if (finalPriceToSend < 0) finalPriceToSend = 0; 

                // === 1. ØªØµØ­ÙŠØ­ Ø§Ù„ÙˆÙ„Ø§ÙŠØ© ===
                let rawWilaya = order.customerWilaya || order.state || "";
                let cleanWilaya = rawWilaya.replace(/^[0-9]+[\.\-\s]*/, '').trim();
                let finalWilaya = apiData.wilayaFormat === 'french_name' ? (wilayaMapping[cleanWilaya] || cleanWilaya) : cleanWilaya;
                
                // === 2. ØªØµØ­ÙŠØ­ Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© (Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Unknown to_commune_name) ===
                let rawCommune = (order.customerCommune || "").trim();
                let finalCommuneName = null;

                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø­Ø« Ø°ÙƒÙŠ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹
                if (manualCommuneMap[rawCommune]) {
                    finalCommuneName = manualCommuneMap[rawCommune];
                } 
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙˆÙ„Ø§ÙŠØ© Ù‡ÙŠ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± ÙˆØ§Ù„Ø¨Ù„Ø¯ÙŠØ© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø© Ø£Ùˆ Ù…ÙƒØªÙˆØ¨Ø© "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±"ØŒ ØµØ­Ø­Ù‡Ø§ Ø¥Ù„Ù‰ "Alger Centre"
                else if (finalWilaya.toLowerCase() === 'alger' && (!rawCommune || rawCommune.includes('Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±'))) {
                     finalCommuneName = "Alger Centre";
                }
                // ÙÙŠ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§ØªØŒ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„Ù„Ù…Ù†Ø²Ù„ ÙˆÙ„Ø§ Ù†Ø¹Ø±Ù Ø§Ù„ØªØ±Ø¬Ù…Ø©ØŒ Ø£Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ© Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©
                // Ù…Ù„Ø§Ø­Ø¸Ø©: Guepex ØªØ±ÙØ¶ Ø§Ø³Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ© ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©ØŒ Ù„Ø°Ø§ Ø³Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© allCommunesCache
                else {
                    const match = allCommunesCache.find(c => c.name.toLowerCase() === normalizeText(rawCommune));
                    if(match) finalCommuneName = match.name;
                    else {
                        // Ø§Ù„Ù…Ù„Ø§Ø° Ø§Ù„Ø£Ø®ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ© + "Centre" Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ© ÙÙ‚Ø· (Ù‚Ø¯ ÙŠØ±ÙØ¶Ù‡ Ø§Ù„Ù†Ø¸Ø§Ù…)
                        // Ø§Ù„Ø­Ù„ Ø§Ù„Ø¢Ù…Ù†: Ø£Ø±Ø³Ù„ "Alger Centre" Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙˆÙ„Ø§ÙŠØ© AlgerØŒ ÙˆØ¥Ù„Ø§ Ø¬Ø±Ø¨ Ø§Ø³Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ©
                        finalCommuneName = (finalWilaya.toLowerCase() === 'alger') ? "Alger Centre" : finalWilaya;
                    }
                }

                // === 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…ÙƒØªØ¨ (Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© No Stop Desk) ===
                let stopDeskId = null;
                if (isStopDesk && apiData.driverType === 'yalidine_style') {
                    // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ÙƒØ§ØªØ¨ ÙÙŠ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©
                    let centersInWilaya = allCentersCache.filter(c => 
                        c.wilaya_name && c.wilaya_name.toLowerCase() === finalWilaya.toLowerCase()
                    );
                    
                    if(centersInWilaya.length === 0) {
                        // Ø±Ø¨Ù…Ø§ Ø§Ø³Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø®ØªÙ„Ù (Ù…Ø«Ù„Ø§Ù‹ Wilaya d'Alger vs Alger)
                        // Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ© Ø¥Ø°Ø§ ØªÙˆÙØ±ØŒ Ø£Ùˆ Ø§Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…ÙƒØ§ØªØ¨
                         centersInWilaya = allCentersCache.filter(c => c.wilaya_name.includes(finalWilaya));
                    }

                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙŠØ¬Ø§Ø¯ Ù…ÙƒØªØ¨ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©
                    let foundCenter = centersInWilaya.find(c => c.name.includes(rawCommune) || (c.commune_name && c.commune_name.includes(finalCommuneName)));
                    
                    if (foundCenter) {
                        stopDeskId = foundCenter.id || foundCenter.center_id;
                    } else if (centersInWilaya.length > 0) {
                        // Ø§Ù„Ù…Ù„Ø§Ø° Ø§Ù„Ø£Ø®ÙŠØ±: Ø§Ø®ØªØ± Ø£ÙˆÙ„ Ù…ÙƒØªØ¨ ÙÙŠ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©
                        stopDeskId = centersInWilaya[0].id || centersInWilaya[0].center_id;
                        errorDetails += `\nâš ï¸ ØªÙ… ØªÙˆØ¬ÙŠÙ‡ Ø·Ù„Ø¨ ${order.customerName} Ù„Ø£ÙˆÙ„ Ù…ÙƒØªØ¨ ÙÙŠ ${finalWilaya}.`;
                    } else {
                        failCount++; errorDetails += `\nâ›” Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒØ§ØªØ¨ ÙÙŠ ${finalWilaya}`; continue;
                    }
                }

                // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                let phone = (order.customerPhone || order.phone || "").replace(/[^0-9]/g, ''); if(phone.length === 9) phone = '0'+phone;
                let fullName = (order.customerName || order.name || "Client").trim();
                const cleanOrderId = orderId.replace('#','').trim();

                let payload = {}; let requestHeaders = { 'Content-Type': 'application/json' };

                if (apiData.driverType === 'yalidine_style') {
                    requestHeaders['X-API-ID'] = apiData.apiKey; requestHeaders['X-API-TOKEN'] = apiData.apiToken;
                    
                    let parcelObj = {
                        "order_id": cleanOrderId,
                        "firstname": fullName, "familyname": ".", "contact_phone": phone,
                        "address": order.customerAddress || rawCommune,
                        "to_wilaya_name": finalWilaya, 
                        "to_commune_name": finalCommuneName, // Ø§Ù„Ø¢Ù† Ù†Ø±Ø³Ù„ "Alger Centre" Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† "Alger"
                        "product_list": order.productName || "Colis",
                        "price": finalPriceToSend, "freeshipping": false, "do_insurance": false, "declared_value": finalPriceToSend,
                        "is_stopdesk": isStopDesk, "has_exchange": false,
                        "height": 10, "width": 20, "length": 30, "weight": 1
                    };
                    if (isStopDesk && stopDeskId) parcelObj.stopdesk_id = stopDeskId;
                    payload = [parcelObj];
                }

                // Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                let postUrl = apiData.apiUrl;
                if(postUrl.endsWith('/')) postUrl = postUrl.slice(0, -1);
                if(!postUrl.includes('/v1/parcels')) postUrl += '/v1/parcels';
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(postUrl);
                
                const res = await fetch(proxyUrl, { method: 'POST', headers: requestHeaders, body: JSON.stringify(payload) });
                const resText = await res.text();
                let resJson; try { resJson = JSON.parse(resText); } catch (e) { throw new Error(`API Error: ${resText.substring(0, 50)}`); }

                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¯
                let isSuccess = false; let trackingCode = "Sent";
                if (Array.isArray(resJson)) { if (resJson[0] && (resJson[0].tracking || resJson[0].success === true)) { isSuccess = true; trackingCode = resJson[0].tracking || "Sent"; } } 
                else if (resJson[cleanOrderId]) { 
                    if (resJson[cleanOrderId].success === true) { isSuccess = true; trackingCode = resJson[cleanOrderId].tracking; } 
                    else { failCount++; errorDetails += `\nâŒ ${fullName}: ${resJson[cleanOrderId].message}`; continue; } 
                }
                else if (resJson.tracking || resJson.success === true) { isSuccess = true; trackingCode = resJson.tracking || "Sent"; }
                
                if (isSuccess) {
                    await update(ref(db, `orders/${orderId}`), { status: 'Shipped', deliveryProvider: apiData.displayName, trackingCode: trackingCode, shippedAt: Date.now() });
                    successCount++;
                } else { if(!resJson[cleanOrderId]) { failCount++; errorDetails += `\nâŒ ${fullName}: ${JSON.stringify(resJson).substring(0, 100)}`; } }

            } catch(e) { console.error(e); failCount++; errorDetails += `\nâš ï¸ ${orderId}: ${e.message}`; }
        }
        let report = `Ø§Ù„Ù†ØªÙŠØ¬Ø©:\nâœ… Ù†Ø¬Ø§Ø­: ${successCount}\nâŒ ÙØ´Ù„: ${failCount}`;
        if(failCount > 0 || errorDetails.length > 0) report += `\n\nØ§Ù„ØªÙØ§ØµÙŠÙ„:${errorDetails}`;
        alert(report);
        btn.textContent = "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯"; btn.disabled = false;
    });

    // ... Ø¨Ø§Ù‚ÙŠ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ§Ù„Ø­ÙØ¸ (ÙƒÙ…Ø§ ÙƒØ§Ù†Øª) ...
    window.openDetails = async (id) => { const orderSnap = await get(ref(db, 'orders/'+id)); if(orderSnap.exists()) { const o = orderSnap.val(); document.getElementById('currentOrderId').value = id; document.getElementById('editName').value = o.customerName || o.name; document.getElementById('editPhone').value = o.customerPhone || o.phone; document.getElementById('editWilaya').value = o.customerWilaya || o.state; document.getElementById('editCommune').value = o.customerCommune||''; document.getElementById('editAddress').value = o.customerAddress || o.address; let currentTotal = parseFloat(o.productTotal); if(isNaN(currentTotal)) currentTotal = calculateProductOnlyPrice(o); let marketingDiscount = 0; if(o.productId) { const prodSnap = await get(ref(db, `products/${o.productId}`)); if(prodSnap.exists()) marketingDiscount = parseFloat(prodSnap.val().marketingDiscount || 0); } const qty = parseInt(o.quantity || 1); let netPrice = currentTotal - (marketingDiscount * qty); if(netPrice < 0) netPrice = 0; document.getElementById('editProductPrice').value = netPrice; document.getElementById('orderDetailModal').classList.remove('hidden'); } }
    document.getElementById('closeDetailModal').addEventListener('click',()=>document.getElementById('orderDetailModal').classList.add('hidden'));
    document.getElementById('saveChangesBtn').addEventListener('click',async()=>{ const id=document.getElementById('currentOrderId').value; await update(ref(db,'orders/'+id), { customerName:document.getElementById('editName').value, customerPhone:document.getElementById('editPhone').value, customerWilaya:document.getElementById('editWilaya').value, customerCommune:document.getElementById('editCommune').value, customerAddress:document.getElementById('editAddress').value, productTotal: parseFloat(document.getElementById('editProductPrice').value) }); document.getElementById('orderDetailModal').classList.add('hidden'); alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"); });
    const allWilayas = [ "01. Ø£Ø¯Ø±Ø§Ø±", "02. Ø§Ù„Ø´Ù„Ù", "03. Ø§Ù„Ø£ØºÙˆØ§Ø·", "04. Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ", "05. Ø¨Ø§ØªÙ†Ø©", "06. Ø¨Ø¬Ø§ÙŠØ©", "07. Ø¨Ø³ÙƒØ±Ø©", "08. Ø¨Ø´Ø§Ø±", "09. Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©", "10. Ø§Ù„Ø¨ÙˆÙŠØ±Ø©", "11. ØªÙ…Ù†Ø±Ø§Ø³Øª", "12. ØªØ¨Ø³Ø©", "13. ØªÙ„Ù…Ø³Ø§Ù†", "14. ØªÙŠØ§Ø±Øª", "15. ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ", "16. Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", "17. Ø§Ù„Ø¬Ù„ÙØ©", "18. Ø¬ÙŠØ¬Ù„", "19. Ø³Ø·ÙŠÙ", "20. Ø³Ø¹ÙŠØ¯Ø©", "21. Ø³ÙƒÙŠÙƒØ¯Ø©", "22. Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³", "23. Ø¹Ù†Ø§Ø¨Ø©", "24. Ù‚Ø§Ù„Ù…Ø©", "25. Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©", "26. Ø§Ù„Ù…Ø¯ÙŠØ©", "27. Ù…Ø³ØªØºØ§Ù†Ù…", "28. Ø§Ù„Ù…Ø³ÙŠÙ„Ø©", "29. Ù…Ø¹Ø³ÙƒØ±", "30. ÙˆØ±Ù‚Ù„Ø©", "31. ÙˆÙ‡Ø±Ø§Ù†", "32. Ø§Ù„Ø¨ÙŠØ¶", "33. Ø¥Ù„ÙŠØ²ÙŠ", "34. Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬", "35. Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³", "36. Ø§Ù„Ø·Ø§Ø±Ù", "37. ØªÙ†Ø¯ÙˆÙ", "38. ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª", "39. Ø§Ù„ÙˆØ§Ø¯ÙŠ", "40. Ø®Ù†Ø´Ù„Ø©", "41. Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³", "42. ØªÙŠØ¨Ø§Ø²Ø©", "43. Ù…ÙŠÙ„Ø©", "44. Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰", "45. Ø§Ù„Ù†Ø¹Ø§Ù…Ø©", "46. Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª", "47. ØºØ±Ø¯Ø§ÙŠØ©", "48. ØºÙ„ÙŠØ²Ø§Ù†", "49. ØªÙŠÙ…ÙŠÙ…ÙˆÙ†", "50. Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±", "51. Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„", "52. Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³", "53. Ø¥Ù† ØµØ§Ù„Ø­", "54. Ø¥Ù† Ù‚Ø²Ø§Ù…", "55. ØªÙ‚Ø±Øª", "56. Ø¬Ø§Ù†Øª", "57. Ø§Ù„Ù…ØºÙŠØ±", "58. Ø§Ù„Ù…Ù†ÙŠØ¹Ø©" ];
    function renderWilayaCheckboxes(){ const g=document.getElementById('wilayaGrid'); g.innerHTML=''; allWilayas.forEach(w=>{ g.innerHTML+=`<div class="wilaya-checkbox-item" style="font-size: 0.85rem; display: flex; align-items: center; gap: 5px;"><input type="checkbox" class="wilaya-chk" value="${w.split('. ')[1]}"><span>${w.split('. ')[1]}</span></div>`; }); }
    document.getElementById('selectAllBtn').addEventListener('click',()=>{ const c=document.querySelectorAll('.wilaya-chk'); if(c.length>0){const s=!c[0].checked;c.forEach(i=>i.checked=s);} });
    document.getElementById('saveZoneBtn').addEventListener('click',async()=>{ const h=document.getElementById('homePrice').value, d=document.getElementById('deskPrice').value; const sel=[]; document.querySelectorAll('.wilaya-chk:checked').forEach(c=>sel.push(c.value)); if(!h||sel.length==0) return alert('Ø®Ø·Ø£'); await push(zonesRef,{homePrice:h,deskPrice:d,wilayas:sel}); alert('ØªÙ…'); renderWilayaCheckboxes(); });
    onValue(zonesRef, (s) => { const c = document.getElementById('zonesContainer'); c.innerHTML = ''; if (s.exists()) Object.entries(s.val()).forEach(([k, v]) => { const wilayaList = v.wilayas ? v.wilayas.join('ØŒ ') : ''; c.innerHTML += `<div class="zone-card" style="background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px; margin-bottom: 8px; position: relative;"><button class="delete-zone-btn" onclick="delZ('${k}')" style="position: absolute; left: 10px; top: 10px; background: #ffcdd2; color: #c62828; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer;">x</button><div style="margin-top: 15px; margin-bottom: 10px; font-size: 0.9rem; color: #333; line-height: 1.4;"><strong>Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ù…Ø´Ù…ÙˆÙ„Ø©:</strong><br>${wilayaList}</div><div style="border-top: 1px solid #eee; padding-top: 8px;"><span class="price-badge" style="padding: 2px 8px; border-radius: 4px; font-weight: bold; background: #e8f5e9; color: #2e7d32;">ğŸ  ${v.homePrice} Ø¯Ø¬</span><span class="price-badge" style="padding: 2px 8px; border-radius: 4px; font-weight: bold; background: #e3f2fd; color: #1565c0;">ğŸ¢ ${v.deskPrice || 0} Ø¯Ø¬</span></div></div>`; }); });
    window.delZ=(k)=>{if(confirm('Ø­Ø°ÙØŸ')) remove(ref(db,`shipping_zones/${k}`));};
</script>
</body>
</html>