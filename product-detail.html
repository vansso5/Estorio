<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ุชูุงุตูู ุงูููุชุฌ</title>
<link rel="stylesheet" href="customer-style.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css">
<!-- Font Awesome ูุฃููููุงุช ุงููุฌูู -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<!-- ุดุงุดุฉ ุงูุชุญููู -->
<div id="loadingScreen" class="hidden">
  <div class="spinner"></div>
  <p>ุฌุงุฑู ุชุฃููุฏ ุงูุทูุจ...</p>
</div>
<body>

<!-- โ ุดุฑูุท ุงูุงุชุตุงู ุงูุซุงุจุช -->
<div class="top-contact">
๐ ุงุชุตู ุจูุง ุนูู
<a href="tel:0540667186">0540667186</a>
</div>

<div class="container">
  <div id="productDetailContainer"><p>ุฌุงุฑู ุชุญููู ุชูุงุตูู ุงูููุชุฌ...</p></div>
</div>

<!-- โ ูุงูุฐุฉ ุชูุจูุฑ ุงูุตูุฑุฉ -->
<div class="image-preview-modal" id="imagePreviewModal">
  <button class="close-preview" id="closePreview">&times;</button>
  <img id="previewImage" src="" alt="ุตูุฑุฉ ููุจุฑุฉ">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get, child, push, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
  authDomain: "myestore-34f65.firebaseapp.com",
  databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
  projectId: "myestore-34f65",
  storageBucket: "myestore-34f65.appspot.com",
  messagingSenderId: "14078917211",
  appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
  measurementId: "G-9181DX0XNJ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const container = document.getElementById('productDetailContainer');
const previewModal = document.getElementById('imagePreviewModal');
const previewImage = document.getElementById('previewImage');
const closePreview = document.getElementById('closePreview');

let currentProductId = null;

function getProductIdFromUrl() {
  return new URLSearchParams(window.location.search).get('id');
}

// ุฏุงูุฉ ูุญุณุงุจ ูุชูุณุท ุงูุชููููุงุช
function calculateAverageRating(reviews) {
  if (!reviews || reviews.length === 0) return 0;
  
  const total = reviews.reduce((sum, review) => sum + (review.rating || 0), 0);
  return (total / reviews.length).toFixed(1);
}

// ุฏุงูุฉ ูุนุฑุถ ูุชูุณุท ุงูุชูููู
function displayAverageRating(averageRating, totalReviews) {
  const ratingSummary = document.getElementById('ratingSummary');
  if (ratingSummary) {
    ratingSummary.innerHTML = `
      <div class="average-rating">${averageRating}</div>
      <div class="rating-stars-display">
        ${generateStarIcons(averageRating)}
      </div>
      <div class="total-reviews">(${totalReviews} ุชูููู)</div>
    `;
  }
}

// ุฏุงูุฉ ูุชูููุฏ ุฃููููุงุช ุงููุฌูู ููุชูููู
function generateStarIcons(rating) {
  const fullStars = Math.floor(rating);
  const halfStar = rating % 1 >= 0.5;
  const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
  
  let stars = '';
  
  // ูุฌูู ูุงููุฉ
  for (let i = 0; i < fullStars; i++) {
    stars += '<i class="fas fa-star"></i>';
  }
  
  // ูุตู ูุฌูุฉ ุฅู ูุฌุฏุช
  if (halfStar) {
    stars += '<i class="fas fa-star-half-alt"></i>';
  }
  
  // ูุฌูู ูุงุฑุบุฉ
  for (let i = 0; i < emptyStars; i++) {
    stars += '<i class="far fa-star"></i>';
  }
  
  return stars;
}

async function fetchProductDetails() {
  const productId = getProductIdFromUrl();
  if (!productId) {
    container.innerHTML = '<p class="error-message">ูู ูุชู ุงูุนุซูุฑ ุนูู ูุนุฑู ุงูููุชุฌ.</p>';
    return;
  }
  currentProductId = productId;

  try {
    const snapshot = await get(child(ref(db), `products/${productId}`));
    if (!snapshot.exists()) {
      container.innerHTML = '<p class="error-message">ุงูููุชุฌ ุบูุฑ ููุฌูุฏ.</p>';
      return;
    }

    const product = snapshot.val();
    const images = Array.isArray(product.images) ? product.images : [product.images || 'default.jpg'];
    const swiperSlides = images.map(src => `<div class="swiper-slide"><img src="${src}" alt="ุตูุฑุฉ ุงูููุชุฌ"></div>`).join('');

    const wilayas = [
      "ุฃุฏุฑุงุฑ","ุงูุดูู","ุงูุฃุบูุงุท","ุฃู ุงูุจูุงูู","ุจุงุชูุฉ","ุจุฌุงูุฉ","ุจุณูุฑุฉ","ุจุดุงุฑ","ุงูุจููุฏุฉ","ุงูุจููุฑุฉ","ุชููุฑุงุณุช","ุชุจุณุฉ","ุชููุณุงู","ุชูุงุฑุช","ุชูุฒู ูุฒู","ุงูุฌุฒุงุฆุฑ","ุงูุฌููุฉ","ุฌูุฌู","ุณุทูู","ุณุนูุฏุฉ","ุณูููุฏุฉ","ุณูุฏู ุจูุนุจุงุณ","ุนูุงุจุฉ","ูุงููุฉ","ูุณูุทููุฉ","ุงููุฏูุฉ","ูุณุชุบุงูู","ุงููุณููุฉ","ูุนุณูุฑ","ูุฑููุฉ","ููุฑุงู","ุงูุจูุถ","ุฅููุฒู","ุจุฑุฌ ุจูุนุฑูุฑูุฌ","ุจููุฑุฏุงุณ","ุงูุทุงุฑู","ุชูุฏูู","ุชูุณูุณููุช","ุงููุงุฏู","ุฎูุดูุฉ","ุณูู ุฃูุฑุงุณ","ุชูุจุงุฒุฉ","ูููุฉ","ุนูู ุงูุฏููู","ุงููุนุงูุฉ","ุนูู ุชููุดูุช","ุบุฑุฏุงูุฉ","ุบููุฒุงู","ุชูููููู","ุจุฑุฌ ุจุงุฌู ูุฎุชุงุฑ","ุฃููุงุฏ ุฌูุงู","ุจูู ุนุจุงุณ","ุฅู ุตุงูุญ","ุฅู ูุฒุงู","ุชูุฑุช","ุฌุงูุช","ุงููุบูุฑ","ุงููููุนุฉ"
    ];

    const wilayaOptions = wilayas.map(w => `<option value="${w}">${w}</option>`).join('');

    container.innerHTML = `
      <div class="swiper mySwiper"><div class="swiper-wrapper">${swiperSlides}</div><div class="swiper-pagination"></div></div>
      <div class="product-detail-info">
        <h2>${product.name}</h2>
        <p class="product-detail-price">
          ${product.oldPrice ? `<span style="text-decoration: line-through; color: #999; font-size: 18px; margin-left: 10px;">${Number(product.oldPrice).toLocaleString()} ุฏุฌ</span>` : ''}
          <span style="color: #e74c3c; font-weight: bold;">${Number(product.newPrice).toLocaleString()} ุฏุฌ</span>
        </p>
        <p class="product-description">${product.description || ''}</p>
        <button id="orderBtn">ุงุทูุจ ุงูุขู</button>
      </div>

      <!-- โ ูุณู ุงูุชุนูููุงุช ูุงูุชููููุงุช ุงููุญุณู -->
      <div class="reviews-section">
        <h3>ุงูุชุนูููุงุช ูุงูุชููููุงุช</h3>
        
        <!-- โ ููุฎุต ุงูุชููููุงุช -->
        <div class="rating-summary" id="ratingSummary">
          <p>ุฌุงุฑู ุชุญููู ุงูุชููููุงุช...</p>
        </div>

        <div class="review-form">
          <input type="text" id="reviewerName" placeholder="ุงุณูู (ุงุฎุชูุงุฑู)">
          <div class="rating-stars" id="ratingStars">
            <i class="far fa-star" data-rating="1"></i>
            <i class="far fa-star" data-rating="2"></i>
            <i class="far fa-star" data-rating="3"></i>
            <i class="far fa-star" data-rating="4"></i>
            <i class="far fa-star" data-rating="5"></i>
          </div>
          <span id="ratingText" style="color: #666; font-size: 14px; display: block; margin-bottom: 10px;">ุงุถุบุท ุนูู ุงููุฌูู ููุชูููู</span>
          <textarea id="reviewText" placeholder="ุงูุชุจ ุชุนูููู ููุง..." rows="4"></textarea>
          <button id="submitReviewBtn">ุฅุฑุณุงู ุงูุชุนููู</button>
        </div>
        <div class="comments-list" id="commentsList">
          <p style="text-align: center; color: #777;">ุฌุงุฑู ุชุญููู ุงูุชุนูููุงุช...</p>
        </div>
      </div>

      <!-- ูุงูุฐุฉ ุงูุทูุจ (ุชุจูู ููุง ูู) -->
      <div id="orderModal" class="modal hidden">
        <div class="modal-content">
          <h3>ุฃุฏุฎู ูุนูููุงุช ุงูุทูุจ</h3>
          <input type="text" id="fname" placeholder="ุงูุงุณู">
          <input type="text" id="lname" placeholder="ุงูููุจ">
          <input type="text" id="phone" placeholder="ุฑูู ุงููุงุชู">

          <select id="wilaya">
            <option value="">ุงุฎุชุฑ ุงูููุงูุฉ</option>
            ${wilayaOptions}
          </select>
          <input type="text" id="commune" placeholder="ุงูุจูุฏูุฉ (ุฅุฌุจุงุฑู)">
          <input type="text" id="address" placeholder="ุงูุนููุงู ุงููุงูู">

          <div class="quantity-selector">
            <button type="button" id="decreaseQty">-</button>
            <span id="quantityValue">1</span>
            <button type="button" id="increaseQty">+</button>
          </div>

          <select id="deliveryType">
            <option value="ุงูููุฒู">ุชูุตูู ุฅูู ุงูููุฒู</option>
            <option value="ููุชุจ ุงูุดุฑูุฉ">ุฅูู ููุชุจ ุงูุดุฑูุฉ</option>
          </select>

          <textarea id="note" placeholder="ููุงุญุธุงุช ุฅุถุงููุฉ (ุงุฎุชูุงุฑู)" rows="3"></textarea>
          <button id="confirmOrderBtn">ุชุฃููุฏ ุงูุทูุจ</button>
        </div>
      </div>
<!-- โ ุดุงุดุฉ ุงูุชุญููู -->
<div id="loadingScreen" class="hidden">
  <div class="spinner"></div>
  <p>ุฌุงุฑู ูุนุงูุฌุฉ ุงูุทูุจ...</p>
</div>
      <div id="thankYouModal" class="modal hidden">
        <div class="modal-content">
          <h3>ุดูุฑูุง ูุทูุจู!</h3>
          <p>ุชู ุฅุฑุณุงู ุทูุจู ุจูุฌุงุญ โค๏ธ ุงูุฑุฌุงุก ูุณุฎ ุฑูู ุทูุจูุชูู ู ุงูุงุญุชูุงุถ ุจู ุงูู ุบุงูุฉ ูุตูููุง</p>
          <div id="orderIdBox" style="background:#f0f0f0;padding:10px;border-radius:8px;margin-bottom:10px;font-weight:bold;"></div>
          <button id="copyOrderId" style="background:#4CAF50;color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;margin-bottom:10px;">๐ ูุณุฎ ุงูุฑูู</button>
          <br>
          <button id="closeModal" style="background:#e74c3c;color:white;padding:8px 20px;border:none;border-radius:6px;cursor:pointer;">ููุงูู</button>
        </div>
      </div>
    `;

    // ุชููุฆุฉ ุงูุณููุจุฑ
    const swiper = new Swiper(".mySwiper", { pagination: { el: ".swiper-pagination", clickable: true } });

    // ุชูุจูุฑ ุงูุตูุฑุฉ
    document.querySelectorAll('.swiper-slide img').forEach(img => {
      img.addEventListener('click', () => {
        previewImage.src = img.src;
        previewModal.classList.add('active');
      });
    });

    closePreview.addEventListener('click', () => previewModal.classList.remove('active'));
    previewModal.addEventListener('click', e => { if(e.target === previewModal) previewModal.classList.remove('active'); });

    // ููุทู ุงูุทูุจ (ูุจูู ููุง ูู)
    const orderBtn = document.getElementById("orderBtn");
    const orderModal = document.getElementById("orderModal");
    const confirmOrderBtn = document.getElementById("confirmOrderBtn");
    const thankYouModal = document.getElementById("thankYouModal");
    const decreaseQty = document.getElementById("decreaseQty");
    const increaseQty = document.getElementById("increaseQty");
    const quantityValue = document.getElementById("quantityValue");

    let quantity = 1;

    orderBtn.addEventListener("click", () => orderModal.classList.remove("hidden"));
    orderModal.addEventListener("click", e => { if(e.target === orderModal) orderModal.classList.add("hidden"); });

    decreaseQty.addEventListener("click", () => { if(quantity>1) quantity--; quantityValue.textContent = quantity; });
    increaseQty.addEventListener("click", () => { quantity++; quantityValue.textContent = quantity; });

    confirmOrderBtn.addEventListener("click", async () => {
  const loadingScreen = document.getElementById("loadingScreen");
  loadingScreen.classList.remove("hidden"); // ูุธูุฑ ุดุงุดุฉ ุงูุชุญููู
  
  // ูููุฐ ุงูุนูููุฉ ุจุนุฏ 3 ุซูุงูู (3000ms)
  setTimeout(async () => {
    const fname = document.getElementById("fname").value.trim();
    const lname = document.getElementById("lname").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const wilaya = document.getElementById("wilaya").value.trim();
    const commune = document.getElementById("commune").value.trim();
    const address = document.getElementById("address").value.trim();
    const deliveryType = document.getElementById("deliveryType").value;
    const note = document.getElementById("note").value.trim();
    
    if (!fname || !lname || !phone || !wilaya || !commune || !address) {
      alert("ูุฑุฌู ููุก ุฌููุน ุงูุฎุงูุงุช ุงูุฅุฌุจุงุฑูุฉ ุจุดูู ุตุญูุญ.");
      loadingScreen.classList.add("hidden"); // ุฎูู ุงูุชุญููู ูู ุงูุจูุงูุงุช ูุงูุตุฉ
      return;
    }
    
    orderModal.classList.add("hidden");
    
    try {
      const orderRef = push(ref(db, "orders"));
      const orderId = orderRef.key;
      const totalPrice = parseFloat(product.newPrice) * quantity;
      
      await set(orderRef, {
        id: orderId,
        productId: productId,
        productName: product.name,
        productPrice: parseFloat(product.newPrice),
        quantity,
        totalPrice,
        customerName: `${fname} ${lname}`,
        customerPhone: phone,
        customerWilaya: wilaya,
        customerCommune: commune,
        customerAddress: address,
        deliveryOption: deliveryType,
        note,
        timestamp: Date.now(),
        status: "ุงูุทูุจุงุช ุงูุฌุฏูุฏุฉ",
        rating: 0
      });
      
      document.getElementById("orderIdBox").textContent = orderId;
      loadingScreen.classList.add("hidden"); // ุฅุฎูุงุก ุดุงุดุฉ ุงูุชุญููู ุจุนุฏ ุงูุงูุชูุงุก
      thankYouModal.classList.remove("hidden");
      
      document.getElementById("copyOrderId").onclick = () => {
        navigator.clipboard.writeText(orderId);
        alert("ุชู ูุณุฎ ุฑูู ุงูุทูุจ!");
      };
      
      document.getElementById("closeModal").onclick = () => {
        thankYouModal.classList.add("hidden");
      };
    } catch (err) {
      console.error("Error saving order:", err);
      alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุทูุจ. ุญุงูู ูุฑุฉ ุฃุฎุฑู.");
      loadingScreen.classList.add("hidden");
    }
    
  }, 3000); // ููุงูุฉ setTimeout ูุน ุงููููุฉ 3000ms
});

    // --- ููุทู ุงูุชุนูููุงุช ูุงูุชููููุงุช ุงููุญุณู ---
    const ratingStarsContainer = document.getElementById('ratingStars');
    const submitReviewBtn = document.getElementById('submitReviewBtn');
    const reviewText = document.getElementById('reviewText');
    const reviewerNameInput = document.getElementById('reviewerName');
    const commentsList = document.getElementById('commentsList');
    const ratingText = document.getElementById('ratingText');

    let selectedRating = 0;

    // ุชุญุณูู ุชูุงุนู ุงููุฌูู
    ratingStarsContainer.querySelectorAll('.fa-star').forEach(star => {
      star.addEventListener('click', () => {
  const clickedRating = parseInt(star.dataset.rating);
  // ุฅุฐุง ุถุบุท ุนูู ููุณ ุงููุฌูุฉ ูุฑุฉ ุฃุฎุฑู โ ูุนูุฏ ุงูุชูููู ุฅูู 0
  if (selectedRating === clickedRating) {
    selectedRating = 0;
  } else {
    selectedRating = clickedRating;
  }
  updateStarColorsInForm();
  updateRatingText();
});
      
      star.addEventListener('mouseover', () => {
        highlightStarsInForm(parseInt(star.dataset.rating));
      });
      
      star.addEventListener('mouseout', () => {
        updateStarColorsInForm();
      });
    });

    function highlightStarsInForm(rating) {
        ratingStarsContainer.querySelectorAll('.fa-star').forEach(star => {
            if (parseInt(star.dataset.rating) <= rating) {
                star.classList.remove('far');
                star.classList.add('fas', 'checked');
            } else {
                star.classList.remove('fas', 'checked');
                star.classList.add('far');
            }
        });
    }

    function updateStarColorsInForm() {
        ratingStarsContainer.querySelectorAll('.fa-star').forEach(star => {
            if (parseInt(star.dataset.rating) <= selectedRating) {
                star.classList.remove('far');
                star.classList.add('fas', 'checked');
            } else {
                star.classList.remove('fas', 'checked');
                star.classList.add('far');
            }
        });
    }

    function updateRatingText() {
      const ratingLabels = {
        1: "ุณูุก",
        2: "ููุณ ุฌูุฏ",
        3: "ุฌูุฏ",
        4: "ุฌูุฏ ุฌุฏุงู",
        5: "ููุชุงุฒ"
      };
      ratingText.textContent = ratingLabels[selectedRating] || "ุงุถุบุท ุนูู ุงููุฌูู ููุชูููู";
    }

    // ุฅุฑุณุงู ุงูุชุนููู ุฅูู Firebase
    submitReviewBtn.addEventListener('click', async () => {
      const name = reviewerNameInput.value.trim() || "ูุฌููู";
      const comment = reviewText.value.trim();

      if (selectedRating === 0) {
        alert("ูุฑุฌู ุงุฎุชูุงุฑ ุชูููู ุจุงููุฌูู ูุจู ุงูุฅุฑุณุงู.");
        return;
      }

      if (!comment) {
        alert("ูุฑุฌู ูุชุงุจุฉ ุชุนููู ูุจู ุงูุฅุฑุณุงู.");
        return;
      }

      try {
        const reviewRef = push(child(ref(db), `product_reviews/${productId}`));
        await set(reviewRef, {
          reviewerName: name,
          rating: selectedRating,
          comment: comment,
          timestamp: Date.now()
        });

        // ูุณุญ ุงููููุฐุฌ ุจุนุฏ ุงูุฅุฑุณุงู
        reviewerNameInput.value = '';
        reviewText.value = '';
        selectedRating = 0;
        updateStarColorsInForm();
        updateRatingText();
        
        alert("ุชู ุฅุฑุณุงู ุชุนูููู ุจูุฌุงุญ!");
      } catch (error) {
        console.error("Error submitting review:", error);
        alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุชุนููู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
      }
    });

    // ุฌูุจ ูุนุฑุถ ุงูุชุนูููุงุช ูู Firebase
    function fetchAndDisplayReviews() {
        if (!currentProductId) return;

        const reviewsRef = ref(db, `product_reviews/${currentProductId}`);
        onValue(reviewsRef, (snapshot) => {
            if (snapshot.exists()) {
                const reviews = [];
                snapshot.forEach((childSnapshot) => {
                    reviews.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                
                // ุชุฑุชูุจ ุงูุชุนูููุงุช ูู ุงูุฃุญุฏุซ ููุฃูุฏู
                reviews.sort((a, b) => b.timestamp - a.timestamp);

                // ุญุณุงุจ ูุชูุณุท ุงูุชููููุงุช
                const averageRating = calculateAverageRating(reviews);
                displayAverageRating(averageRating, reviews.length);

                // ุนุฑุถ ุงูุชุนูููุงุช
                commentsList.innerHTML = '';
                if (reviews.length === 0) {
                    commentsList.innerHTML = '<p style="text-align: center; color: #777;">ูุง ุชูุฌุฏ ุชุนูููุงุช ุญุชู ุงูุขู. ูู ุฃูู ูู ูุนูู!</p>';
                } else {
                    reviews.forEach(review => {
                        const date = new Date(review.timestamp).toLocaleDateString('ar-DZ', {
                            year: 'numeric', month: 'long', day: 'numeric',
                            hour: '2-digit', minute: '2-digit'
                        });
                        commentsList.innerHTML += `
                            <div class="comment-item">
                                <strong>${review.reviewerName}</strong>
                                <div class="comment-rating">
                                    ${Array(review.rating).fill('<i class="fas fa-star"></i>').join('')}
                                    ${Array(5 - review.rating).fill('<i class="far fa-star"></i>').join('')}
                                </div>
                                <p>${review.comment}</p>
                                <span class="comment-date">${date}</span>
                            </div>
                        `;
                    });
                }
            } else {
                commentsList.innerHTML = '<p style="text-align: center; color: #777;">ูุง ุชูุฌุฏ ุชุนูููุงุช ุญุชู ุงูุขู. ูู ุฃูู ูู ูุนูู!</p>';
                displayAverageRating(0, 0);
            }
        });
    }

    // ุงุณุชุฏุนุงุก ุฌูุจ ุงูุชุนูููุงุช ุจุนุฏ ุชุญููู ุชูุงุตูู ุงูููุชุฌ
    fetchAndDisplayReviews();

  } catch(err) {
    console.error("Error fetching product details:", err);
    container.innerHTML = '<p class="error-message">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุชูุงุตูู ุงูููุชุฌ.</p>';
  }
}

fetchProductDetails();
</script>
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
</body>
</html>