<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</title>
<link rel="stylesheet" href="customer-style.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css">
<!-- Font Awesome Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø¬ÙˆÙ… ÙˆØ§Ù„Ø³Ø¨ÙŠÙ‘Ù†Ø± -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
/* Ø¨Ø¹Ø¶ Ø£Ù†Ù…Ø§Ø· Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ CSS Ù„Ø¯ÙŠÙƒ */
.reviews-section { margin-top: 20px; background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
.review-form input, .review-form textarea, .review-form button, .review-form select { width: 100%; margin-bottom: 8px; padding: 8px; box-sizing: border-box }
/* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù†Ø¬ÙˆÙ… Ø§Ù„Ù…ÙØ­Ø¯Ø«Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†ØµÙ Ù†Ø¬Ù…Ø© */
.rating-stars .fa-star, .rating-stars .fa-star-half-alt, .rating-stars .far.fa-star { 
    cursor: pointer; 
    margin-left: 6px; 
    font-size: 20px; 
    color: #ccc; /* Ù„ÙˆÙ† Ø§Ù„Ù†Ø¬Ù…Ø© Ø§Ù„ÙØ§Ø±ØºØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ */
}
.rating-stars .fas.fa-star, .rating-stars .fas.fa-star-half-alt { 
    color: #f0ad4e; /* Ù„ÙˆÙ† Ø§Ù„Ù†Ø¬Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©/Ø§Ù„Ù…Ø¸Ù„Ù„Ø© */
}

.comment-item { border-top: 1px solid #eee; padding: 10px 0; }
.comment-rating i { margin-left: 4px; color: #f5a623; }
.rating-summary { display:flex; align-items:center; gap:12px; margin-bottom:10px; }
.average-rating { font-size:22px; font-weight:700; color:#333; }
.rating-stars-display i { margin-left:4px; color:#f5a623; }
.comment-date { display:block; color:#777; font-size:12px; margin-top:6px; }

/* âœ… Ø£Ù†Ù…Ø§Ø· Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Spinner) */
.spinner {
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top: 4px solid #fff;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  animation: spin 1s linear infinite;
  display: inline-block;
  vertical-align: middle;
  margin-left: 8px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.confirm-order-btn-content {
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>
</head>
<body>

<!-- âœ… Ø´Ø±ÙŠØ· Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø«Ø§Ø¨Øª -->
<div class="top-contact">
ğŸ“ Ø§ØªØµÙ„ Ø¨Ù†Ø§ Ø¹Ù„Ù‰
<a href="tel:0540667186">0540667186</a>
</div>

<div class="container">
  <div id="productDetailContainer"><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬...</p></div>
</div>

<!-- âœ… Ù†Ø§ÙØ°Ø© ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© -->
<div class="image-preview-modal" id="imagePreviewModal">
  <button class="close-preview" id="closePreview">&times;</button>
  <img id="previewImage" src="" alt="ØµÙˆØ±Ø© Ù…ÙƒØ¨Ø±Ø©">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get, child, push, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
  authDomain: "myestore-34f65.firebaseapp.com",
  databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
  projectId: "myestore-34f65",
  storageBucket: "myestore-34f65.appspot.com",
  messagingSenderId: "14078917211",
  appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
  measurementId: "G-9181DX0XNJ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const container = document.getElementById('productDetailContainer');
const previewModal = document.getElementById('imagePreviewModal');
const previewImage = document.getElementById('previewImage');
const closePreview = document.getElementById('closePreview');

let currentProductId = null;

function getProductIdFromUrl() {
  return new URLSearchParams(window.location.search).get('id');
}

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
function calculateAverageRating(reviews) {
  if (!reviews || reviews.length === 0) return 0;
  
  const total = reviews.reduce((sum, review) => sum + (parseFloat(review.rating) || 0), 0); // Ø§Ø³ØªØ®Ø¯Ù… parseFloat
  return (total / reviews.length).toFixed(1);
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
function displayAverageRating(averageRating, totalReviews) {
  const ratingSummary = document.getElementById('ratingSummary');
  if (ratingSummary) {
    ratingSummary.innerHTML = `
      <div class="average-rating">${averageRating}</div>
      <div class="rating-stars-display">
        ${generateStarIconsForDisplay(averageRating)}
      </div>
      <div class="total-reviews">(${totalReviews} ØªÙ‚ÙŠÙŠÙ…)</div>
    `;
  }
}

// ØªÙˆÙ„ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø¬ÙˆÙ… Ù„Ù„Ø¹Ø±Ø¶ (Ù„Ø¯Ø¹Ù… Ù†ØµÙ Ù†Ø¬Ù…Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ø®Øµ)
function generateStarIconsForDisplay(rating) {
  let starsHtml = '';
  for (let i = 1; i <= 5; i++) {
    if (rating >= i) {
      starsHtml += '<i class="fas fa-star"></i>';
    } else if (rating >= i - 0.5) {
      starsHtml += '<i class="fas fa-star-half-alt"></i>';
    } else {
      starsHtml += '<i class="far fa-star"></i>';
    }
  }
  return starsHtml;
}

// Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø­Ù…Ø§ÙŠØ© Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ innerHTML
function escapeHtml(text) {
  if (!text) return '';
  return text
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

async function fetchProductDetails() {
  const productId = getProductIdFromUrl();
  if (!productId) {
    container.innerHTML = '<p class="error-message">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬.</p>';
    return;
  }
  currentProductId = productId;

  try {
    const snapshot = await get(child(ref(db), `products/${productId}`));
    if (!snapshot.exists()) {
      container.innerHTML = '<p class="error-message">Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.</p>';
      return;
    }

    const product = snapshot.val();
    const images = Array.isArray(product.images) ? product.images : [product.images || 'default.jpg'];
    const swiperSlides = images.map(src => `<div class="swiper-slide"><img src="${src}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬"></div>`).join('');

    const wilayas = [
      "Ø£Ø¯Ø±Ø§Ø±","Ø§Ù„Ø´Ù„Ù","Ø§Ù„Ø£ØºÙˆØ§Ø·","Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ","Ø¨Ø§ØªÙ†Ø©","Ø¨Ø¬Ø§ÙŠØ©","Ø¨Ø³ÙƒØ±Ø©","Ø¨Ø´Ø§Ø±","Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©","Ø§Ù„Ø¨ÙˆÙŠØ±Ø©","ØªÙ…Ù†Ø±Ø§Ø³Øª","ØªØ¨Ø³Ø©","ØªÙ„Ù…Ø³Ø§Ù†","ØªÙŠØ§Ø±Øª","ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ","Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±","Ø§Ù„Ø¬Ù„ÙØ©","Ø¬ÙŠØ¬Ù„","Ø³Ø·ÙŠÙ","Ø³Ø¹ÙŠØ¯Ø©","Ø³ÙƒÙŠÙƒØ¯Ø©","Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³","Ø¹Ù†Ø§Ø¨Ø©","Ù‚Ø§Ù„Ù…Ø©","Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©","Ø§Ù„Ù…Ø¯ÙŠØ©","Ù…Ø³ØªØºØ§Ù†Ù…","Ø§Ù„Ù…Ø³ÙŠÙ„Ø©","Ù…Ø¹Ø³ÙƒØ±","ÙˆØ±Ù‚Ù„Ø©","ÙˆÙ‡Ø±Ø§Ù†","Ø§Ù„Ø¨ÙŠØ¶","Ø¥Ù„ÙŠØ²ÙŠ","Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬","Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³","Ø§Ù„Ø·Ø§Ø±Ù","ØªÙ†Ø¯ÙˆÙ","ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª","Ø§Ù„ÙˆØ§Ø¯ÙŠ","Ø®Ù†Ø´Ù„Ø©","Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³","ØªÙŠØ¨Ø§Ø²Ø©","Ù…ÙŠÙ„Ø©","Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰","Ø§Ù„Ù†Ø¹Ø§Ù…Ø©","Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª","ØºØ±Ø¯Ø§ÙŠØ©","ØºÙ„ÙŠØ²Ø§Ù†","ØªÙŠÙ…ÙŠÙ…ÙˆÙ†","Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±","Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„","Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³","Ø¥Ù† ØµØ§Ù„Ø­","Ø¥Ù† Ù‚Ø²Ø§Ù…","ØªÙ‚Ø±Øª","Ø¬Ø§Ù†Øª","Ø§Ù„Ù…ØºÙŠØ±","Ø§Ù„Ù…Ù†ÙŠØ¹Ø©"
    ];

    const wilayaOptions = wilayas.map(w => `<option value="${w}">${w}</option>`).join('');

    container.innerHTML = `
      <div class="swiper mySwiper"><div class="swiper-wrapper">${swiperSlides}</div><div class="swiper-pagination"></div></div>
      <div class="product-detail-info">
        <h2>${escapeHtml(product.name)}</h2>
        <p class="product-detail-price">
          ${product.oldPrice ? `<span style="text-decoration: line-through; color: #999; font-size: 18px; margin-left: 10px;">${Number(product.oldPrice).toLocaleString()} Ø¯Ø¬</span>` : ''}
          <span style="color: #e74c3c; font-weight: bold;">${Number(product.newPrice).toLocaleString()} Ø¯Ø¬</span>
        </p>
        <p class="product-description">${escapeHtml(product.description || '')}</p>
        <button id="orderBtn">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
      </div>

      <!-- âœ… Ù‚Ø³Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
      <div class="reviews-section">
        <h3>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h3>

        <!-- Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¨ÙˆØ§Ø³Ø·Ø© JS) -->
        <div id="ratingSummary" class="rating-summary">
          <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…...</div>
        </div>

        <!-- Ù†Ù…ÙˆØ°Ø¬ ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø£ÙˆÙ„Ø§Ù‹ -->
        <div class="review-form">
          <input type="text" id="reviewerName" placeholder="Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
          <div class="rating-stars" id="ratingStars">
            <i class="far fa-star" data-rating="1"></i>
            <i class="far fa-star" data-rating="2"></i>
            <i class="far fa-star" data-rating="3"></i>
            <i class="far fa-star" data-rating="4"></i>
            <i class="far fa-star" data-rating="5"></i>
          </div>
          <span id="ratingText" style="color: #666; font-size: 14px; display: block; margin-bottom: 10px;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¬ÙˆÙ… Ù„Ù„ØªÙ‚ÙŠÙŠÙ…</span>
          <textarea id="reviewText" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ù‡Ù†Ø§..." rows="4"></textarea>
          <button id="submitReviewBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</button>
        </div>

        <!-- Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© -->
        <div class="comments-list" id="commentsList">
          <p style="text-align: center; color: #777;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª...</p>
        </div>
      </div>

      <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ù„Ø¨ (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) -->
      <div id="orderModal" class="modal hidden">
        <div class="modal-content">
          <h3>Ø£Ø¯Ø®Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h3>
          <input type="text" id="fname" placeholder="Ø§Ù„Ø§Ø³Ù…">
          <input type="text" id="lname" placeholder="Ø§Ù„Ù„Ù‚Ø¨">
          <input type="text" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">

          <select id="wilaya">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</option>
            ${wilayaOptions}
          </select>
          <input type="text" id="commune" placeholder="Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)">
          <input type="text" id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„">

          <div class="quantity-selector">
            <button type="button" id="decreaseQty">-</button>
            <span id="quantityValue">1</span>
            <button type="button" id="increaseQty">+</button>
          </div>

          <select id="deliveryType">
            <option value="Ø§Ù„Ù…Ù†Ø²Ù„">ØªÙˆØµÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†Ø²Ù„</option>
            <option value="Ù…ÙƒØªØ¨ Ø§Ù„Ø´Ø±ÙƒØ©">Ø¥Ù„Ù‰ Ù…ÙƒØªØ¨ Ø§Ù„Ø´Ø±ÙƒØ©</option>
          </select>

          <textarea id="note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" rows="3"></textarea>
          <button id="confirmOrderBtn">
            <span class="confirm-order-btn-content">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</span>
          </button>
        </div>
      </div>

      <div id="thankYouModal" class="modal hidden">
        <div class="modal-content">
          <h3>Ø´ÙƒØ±Ù‹Ø§ Ù„Ø·Ù„Ø¨Ùƒ!</h3>
          <p>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ â¤ï¸</p>
          <div id="orderIdBox" style="background:#f0f0f0;padding:10px;border-radius:8px;margin-bottom:10px;font-weight:bold;"></div>
          <button id="copyOrderId" style="background:#4CAF50;color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;margin-bottom:10px;">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…</button>
          <br>
          <button id="closeModal" style="background:#e74c3c;color:white;padding:8px 20px;border:none;border-radius:6px;cursor:pointer;">Ù…ÙˆØ§ÙÙ‚</button>
        </div>
      </div>
    `;

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø³ÙˆÙŠØ¨Ø±
    const swiper = new Swiper(".mySwiper", { pagination: { el: ".swiper-pagination", clickable: true } });

    // ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙˆØ±Ø©
    document.querySelectorAll('.swiper-slide img').forEach(img => {
      img.addEventListener('click', () => {
        previewImage.src = img.src;
        previewModal.classList.add('active');
      });
    });

    closePreview.addEventListener('click', () => previewModal.classList.remove('active'));
    previewModal.addEventListener('click', e => { if(e.target === previewModal) previewModal.classList.remove('active'); });

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø·Ù„Ø¨ (Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© spinner)
    const orderBtn = document.getElementById("orderBtn");
    const orderModal = document.getElementById("orderModal");
    const confirmOrderBtn = document.getElementById("confirmOrderBtn");
    const thankYouModal = document.getElementById("thankYouModal");
    const decreaseQty = document.getElementById("decreaseQty");
    const increaseQty = document.getElementById("increaseQty");
    const quantityValue = document.getElementById("quantityValue");
    const confirmOrderBtnContent = confirmOrderBtn.querySelector('.confirm-order-btn-content');

    let quantity = 1;

    orderBtn.addEventListener("click", () => orderModal.classList.remove("hidden"));
    orderModal.addEventListener("click", e => { if(e.target === orderModal) orderModal.classList.add("hidden"); });

    decreaseQty.addEventListener("click", () => { if(quantity>1) quantity--; quantityValue.textContent = quantity; });
    increaseQty.addEventListener("click", () => { quantity++; quantityValue.textContent = quantity; });

    confirmOrderBtn.addEventListener("click", async () => {
      const fname = document.getElementById("fname").value.trim();
      const lname = document.getElementById("lname").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const wilaya = document.getElementById("wilaya").value.trim();
      const commune = document.getElementById("commune").value.trim();
      const address = document.getElementById("address").value.trim();
      const deliveryType = document.getElementById("deliveryType").value;
      const note = document.getElementById("note").value.trim();

      if (!fname || !lname || !phone || !wilaya || !commune || !address) {
        alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");
        return;
      }

      // âœ… ØªÙØ¹ÙŠÙ„ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø±
      confirmOrderBtn.disabled = true;
      confirmOrderBtnContent.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ£ÙƒÙŠØ¯ <span class="spinner"></span>';

      try {
        orderModal.classList.add("hidden");

        const orderRef = push(ref(db, "orders"));
        const orderId = orderRef.key;
        const totalPrice = parseFloat(product.newPrice) * quantity;

        await set(orderRef, {
          id: orderId,
          productId: productId,
          productName: product.name,
          productPrice: parseFloat(product.newPrice),
          quantity,
          totalPrice,
          customerName: `${fname} ${lname}`,
          customerPhone: phone,
          customerWilaya: wilaya,
          customerCommune: commune,
          customerAddress: address,
          deliveryOption: deliveryType,
          note,
          timestamp: Date.now(),
          status: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©",
          rating: 0 // Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ù„Ø·Ù„Ø¨ ÙˆÙ„ÙŠØ³ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ù†ØªØ¬
        });

        // âœ… ØªØ£Ø®ÙŠØ± ÙˆÙ‡Ù…ÙŠ Ù„Ù…Ø¯Ø© 2-3 Ø«ÙˆØ§Ù†ÙŠ
        await new Promise(resolve => setTimeout(resolve, 2500)); 

        document.getElementById("orderIdBox").textContent = orderId;
        thankYouModal.classList.remove("hidden");
        document.getElementById("copyOrderId").onclick = () => { navigator.clipboard.writeText(orderId); alert("ØªÙ… Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨!"); };
        document.getElementById("closeModal").onclick = () => { thankYouModal.classList.add("hidden"); };

      } catch (error) {
        console.error("Error confirming order:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
      } finally {
        // âœ… Ø¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        confirmOrderBtn.disabled = false;
        confirmOrderBtnContent.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨';
      }
    });

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù† (Ø¯Ø¹Ù… Ù†ØµÙ Ù†Ø¬Ù…Ø©) ---
    const ratingStarsContainer = document.getElementById('ratingStars');
    const submitReviewBtn = document.getElementById('submitReviewBtn');
    const reviewText = document.getElementById('reviewText');
    const reviewerNameInput = document.getElementById('reviewerName');
    const commentsList = document.getElementById('commentsList');
    const ratingText = document.getElementById('ratingText');

    let selectedRating = 0; // Ø³ÙŠÙ…Ø«Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ (ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† 0ØŒ 0.5ØŒ 1ØŒ 1.5 ÙˆÙ‡ÙƒØ°Ø§)

    // Ø¯Ø§Ù„Ø© Ù„Ù€ "ØªÙ„ÙˆÙŠÙ†" Ø§Ù„Ù†Ø¬ÙˆÙ… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ… Ù…Ø¹ÙŠÙ† (Ø¯Ø¹Ù… Ù†ØµÙ Ù†Ø¬Ù…Ø©)
    function renderInteractiveStars(currentRating) {
        ratingStarsContainer.querySelectorAll('.fa-star').forEach((star, index) => {
            const starValue = index + 1;
            if (currentRating >= starValue) {
                star.className = 'fas fa-star'; // Ù†Ø¬Ù…Ø© ÙƒØ§Ù…Ù„Ø©
            } else if (currentRating >= starValue - 0.5) {
                star.className = 'fas fa-star-half-alt'; // Ù†ØµÙ Ù†Ø¬Ù…Ø©
            } else {
                star.className = 'far fa-star'; // Ù†Ø¬Ù…Ø© ÙØ§Ø±ØºØ©
            }
        });
    }

    // ØªÙ‡ÙŠØ¦Ø© ØªÙØ§Ø¹Ù„ Ø§Ù„Ù†Ø¬ÙˆÙ… (click, hover)
    ratingStarsContainer.querySelectorAll('.fa-star').forEach(star => {
      star.addEventListener('click', (event) => {
        const starValue = parseInt(star.dataset.rating);
        const rect = star.getBoundingClientRect();
        const clickX = event.clientX - rect.left; // Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ù†Ø¬Ù…Ø©
        
        // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù†ØµÙ Ø§Ù„Ø£ÙŠØ³Ø± (Ù„Ù†ØµÙ Ù†Ø¬Ù…Ø©)
        let newRating = starValue;
        if (clickX < rect.width / 2) {
            newRating = starValue - 0.5;
        }

        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù†Ù‚Ø±: Ø¥Ø°Ø§ Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŒ ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ (Ø¬Ø¹Ù„Ù‡ 0)
        // Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªÙ‚ÙŠÙŠÙ… 0.5 ÙˆØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù†ØµÙ Ø§Ù„Ø£ÙŠØ³Ø± Ù…Ù† Ø§Ù„Ù†Ø¬Ù…Ø© 1ØŒ ÙÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
        if (selectedRating === newRating) {
             selectedRating = 0;
        } else if (newRating === 0) { // Ù…Ù†Ø¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… 0 Ù…Ù† Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù†ØµÙ Ø§Ù„Ø£ÙŠØ³Ø± Ù„Ù„Ù†Ø¬Ù…Ø© 1
             selectedRating = 0.5;
        } else {
             selectedRating = newRating;
        }

        renderInteractiveStars(selectedRating);
        updateRatingText();
      });
      
      star.addEventListener('mousemove', (event) => {
        const starValue = parseInt(star.dataset.rating);
        const rect = star.getBoundingClientRect();
        const clickX = event.clientX - rect.left;
        
        let hoverRating = starValue;
        if (clickX < rect.width / 2) {
            hoverRating = starValue - 0.5;
        }
        renderInteractiveStars(hoverRating);
      });
      
      star.addEventListener('mouseout', () => {
        renderInteractiveStars(selectedRating); // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø­Ø¯Ø¯
      });
    });

    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ù†ØµÙ Ù†Ø¬Ù…Ø©
    function updateRatingText() {
      const ratingLabels = {
        0: "Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¬ÙˆÙ… Ù„Ù„ØªÙ‚ÙŠÙŠÙ…",
        0.5: "Ø³ÙŠØ¡ Ø¬Ø¯Ù‹Ø§",
        1: "Ø³ÙŠØ¡",
        1.5: "Ù„ÙŠØ³ Ø¬ÙŠØ¯",
        2: "Ù„ÙŠØ³ Ø¬ÙŠØ¯",
        2.5: "Ù…Ù‚Ø¨ÙˆÙ„",
        3: "Ø¬ÙŠØ¯",
        3.5: "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹",
        4: "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹",
        4.5: "Ù…Ù…ØªØ§Ø²",
        5: "Ù…Ù…ØªØ§Ø²"
      };
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ù‚ÙŠÙ…Ø© ÙÙŠ labels Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Øµ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
      ratingText.textContent = ratingLabels[selectedRating] || ratingLabels[Math.round(selectedRating * 2) / 2] || "Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¬ÙˆÙ… Ù„Ù„ØªÙ‚ÙŠÙŠÙ…";
    }

    // === Ø­ÙØ¸ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙÙŠ Firebase (Ø§Ù„Ù…Ø³Ø§Ø±: reviews/{productId}) ===
    submitReviewBtn.addEventListener('click', async () => {
      const name = reviewerNameInput.value.trim() || "Ù…Ø¬Ù‡ÙˆÙ„";
      const comment = reviewText.value.trim();

      if (selectedRating === 0) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ… Ø¨Ø§Ù„Ù†Ø¬ÙˆÙ… Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.");
        return;
      }

      if (!comment) {
        alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.");
        return;
      }

      try {
        // push Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± reviews/{currentProductId}
        const reviewRef = push(ref(db, `reviews/${currentProductId}`));
        await set(reviewRef, {
          reviewerName: name,
          rating: selectedRating, // Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‚ÙŠÙ…Ø© Ù†ØµÙ Ù†Ø¬Ù…Ø© Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§
          comment: comment,
          timestamp: Date.now()
        });

        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        reviewerNameInput.value = '';
        reviewText.value = '';
        selectedRating = 0;
        renderInteractiveStars(selectedRating); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¬ÙˆÙ… Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø¯Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ¯
        updateRatingText();

        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ø¨Ù†Ø¬Ø§Ø­!");
      } catch (error) {
        console.error("Error submitting review:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
      }
    });

    // === Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù…Ù† Firebase (Ø§Ù„Ù…Ø³Ø§Ø± reviews/{productId}) ===
    function fetchAndDisplayReviews() {
        if (!currentProductId) return;

        const reviewsRef = ref(db, `reviews/${currentProductId}`);
        onValue(reviewsRef, (snapshot) => {
            const ratingSummaryEl = document.getElementById('ratingSummary');
            commentsList.innerHTML = '';

            if (!snapshot.exists()) {
                commentsList.innerHTML = '<p style="text-align: center; color: #777;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¹Ù„Ù‚!</p>';
                if (ratingSummaryEl) displayAverageRating(0, 0);
                return;
            }

            const reviewsObj = snapshot.val();
            const reviews = Object.keys(reviewsObj).map(k => ({ id: k, ...reviewsObj[k] }));
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
            reviews.sort((a, b) => b.timestamp - a.timestamp);

            // Ø­Ø³Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
            const averageRating = calculateAverageRating(reviews);
            if (ratingSummaryEl) displayAverageRating(averageRating, reviews.length);

            // Ø¹Ø±Ø¶ ÙƒÙ„ ØªØ¹Ù„ÙŠÙ‚
            commentsList.innerHTML = '';
            reviews.forEach(review => {
                const date = new Date(review.timestamp).toLocaleDateString('ar-DZ', {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                commentsList.innerHTML += `
                    <div class="comment-item">
                        <strong>${escapeHtml(review.reviewerName)}</strong>
                        <div class="comment-rating">
                            ${generateStarIconsForDisplay(parseFloat(review.rating))}
                        </div>
                        <p>${escapeHtml(review.comment)}</p>
                        <span class="comment-date">${date}</span>
                    </div>
                `;
            });
        }, (error) => {
          console.error("Error reading reviews:", error);
        });
    }

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬
    fetchAndDisplayReviews();

  } catch(err) {
    console.error("Error fetching product details:", err);
    container.innerHTML = '<p class="error-message">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬.</p>';
  }
}

fetchProductDetails();
</script>
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
</body>
</html>