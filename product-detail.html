<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø·Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬</title>
<link rel="stylesheet" href="customer-style.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css ">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css ">
<meta name="google-site-verification" content="lgCRZS6OSalJssBPY7QkuciuXfNh6Uf_nfvWLKNvmQg" />

<style>
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø± */
    #storePolicySection h3 { cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; }
    #storePolicySection h3::after { content: 'â–¼'; font-size: 0.8em; margin-right: 10px; transition: transform 0.3s; }
    #storePolicySection.open h3::after { transform: rotate(180deg); }
    
    .price-summary { background: #f9f9f9; padding: 10px; border-radius: 8px; margin: 10px 0; border: 1px solid #eee; }
    .final-price { color: #27ae60; font-weight: bold; font-size: 1.2em; }
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ±Ø© (Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© ÙˆØ§Ù„ÙˆÙ„Ø§ÙŠØ©) */
    .row-dual { 
        display: flex; 
        gap: 10px; 
        margin-bottom: 10px; 
    }
    .col-half { 
        flex: 1; 
        position: relative; /* Ø¶Ø±ÙˆØ±ÙŠ Ù„Ø¶Ø¨Ø· Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
    }

    /* ğŸ”¥ğŸ”¥ğŸ”¥ Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¶Ø¨Ø· Ø§Ù„Ø­Ø¬Ù… ÙˆØ§Ù„Ù…Ø­Ø§Ø°Ø§Ø© ğŸ”¥ğŸ”¥ğŸ”¥ */
    .col-half select, 
    .col-half input { 
        width: 100%; 
        box-sizing: border-box; 
        height: 50px; /* â¬…ï¸ ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø§Ù†Ø©: ØºÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù„ØªÙƒØ¨ÙŠØ±Ù‡Ø§ Ø£Ùˆ ØªØµØºÙŠØ±Ù‡Ø§ (Ù…Ø«Ù„Ø§ 45px Ø£Ùˆ 60px) */
        font-size: 16px; /* â¬…ï¸ ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· Ù„ÙŠØµØ¨Ø­ Ø£ÙˆØ¶Ø­ */
        font-weight: bold;
        text-align: center; /* â¬…ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„ÙˆØ³Ø· */
        text-align-last: center; /* â¬…ï¸ Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ù„Ù‰ ØªÙˆØ³ÙŠØ· Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        padding: 0 10px; /* Ù…Ø³Ø§ÙØ© Ø¯Ø§Ø®Ù„ÙŠØ© Ù…Ø±ÙŠØ­Ø© */
        border-radius: 8px; /* ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø­ÙˆØ§Ù Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
        border: 1px solid #ddd; /* Ù„ÙˆÙ† Ø§Ù„Ø¥Ø·Ø§Ø± */
        appearance: none; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ù„Ø¶Ø¨Ø· Ø§Ù„ØªÙˆØ³ÙŠØ· */
        -webkit-appearance: none;
        background-color: #fff;
    }

    /* Ø¥Ø¶Ø§ÙØ© Ø³Ù‡Ù… Ù…Ø®ØµØµ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ÙŠØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ Ø¬Ù…ÙŠÙ„ */
    .col-half select {
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='gray' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: left 10px center; /* Ø§Ù„Ø³Ù‡Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø£Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø±Ø¨ÙŠ */
        background-size: 15px;
    }

    /* ØªØ­Ø³ÙŠÙ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ */
    select {
        font-family: 'Cairo', sans-serif;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„ØºÙ„Ø§Ù */
    .select-no-border {
        width: 100%;
        height: 100%;
        border: none;
        background: transparent;
        outline: none;
        font-family: 'Cairo', sans-serif;
        color: #333;
        font-weight: bold;
        text-align: center;
        text-align-last: center;
    }
</style>

</head>

<body>

<!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ -->
<div class="top-marquee">
  <div class="marquee-content">ğŸ”’ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© ØªÙØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ ÙˆÙ„Ù† ØªÙØ´Ø§Ø±Ùƒ Ù…Ø¹ Ø£ÙŠ Ø·Ø±Ù Ø«Ø§Ù„Ø«.</div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="loadingScreen" class="hidden">
  <div class="spinner"></div>
  <p>Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨...</p>
</div>

<!-- Ø§Ù„Ù„ÙˆØ¬Ùˆ -->
<div class="logo-container">
    <img id="storeLogo" src="https://via.placeholder.com/500x120?text=Ø¬Ø§Ø±ÙŠ+Ø§Ù„ØªØ­Ù…ÙŠÙ„..." alt="Logo">
</div>

<!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬ -->
<div class="container">
    <div class="left-side">
        <div id="productDetailContainer">
            <p style="text-align:center; padding:20px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬...</p>
        </div>
    </div>
    <div class="right-side"></div>
</div>

<!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ± -->
<div class="image-preview-modal" id="imagePreviewModal">
  <button class="close-preview" id="closePreview">&times;</button>
  <img id="previewImage" src="" alt="">
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø´ÙƒØ± -->
<div id="thankYouModal" class="modal hidden">
    <div class="modal-content">
      <div class="check-icon">âœ”</div>
      <h3>ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ!</h3>
      <p id="thankYouMessage"></p>
      <div id="orderIdBox"></div>
      <div class="modal-buttons">
          <button id="copyOrderId">Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…</button>
          <button id="closeModal">Ø­Ø³Ù†Ø§Ù‹</button>
      </div>
    </div>
</div>

<!-- Ø²Ø± Ø¹Ø§Ø¦Ù… Ù„Ù„Ù‡Ø§ØªÙ -->
<div id="floatingOrderBtn">
    <button id="floatingConfirmBtn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ğŸš€</button>
</div>

<!-- Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get, child, push, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
  authDomain: "myestore-34f65.firebaseapp.com",
  databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
  projectId: "myestore-34f65",
  storageBucket: "myestore-34f65.appspot.com",
  messagingSenderId: "14078917211",
  appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
  measurementId: "G-9181DX0XNJ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const contactFooter = document.querySelector('.contact-footer .contact-container');

// Ø¨ÙŠÙƒØ³Ù„ ÙÙŠØ³Ø¨ÙˆÙƒ
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');

let activePixelId = null;
function initPixel(pixelId) {
    if (!pixelId) return;
    if (activePixelId) return; 
    activePixelId = pixelId;
    fbq('init', pixelId);
    fbq('track', 'PageView');
}

onValue(ref(db, 'settings/contactPhone'), (snapshot) => {
    if (snapshot.exists()) {
        const phone = snapshot.val();
        contactFooter.innerHTML = `<span>ğŸ“ Ø§ØªØµÙ„ Ø¨Ù†Ø§: </span><a href="tel:${phone}">${phone}</a>`;
    }
});

const presenceRef = ref(db, "site_presence");
const myCon = push(presenceRef);
onDisconnect(myCon).remove();
set(myCon, { timestamp: Date.now(), page: window.location.href });

const container = document.getElementById('productDetailContainer');
const previewModal = document.getElementById('imagePreviewModal');
const previewImage = document.getElementById('previewImage');
const closePreview = document.getElementById('closePreview');
const storeLogoImg = document.getElementById('storeLogo');

let currentProductId = null;
let currentProductPrice = 0;
let shippingZones = []; 

onValue(ref(db, 'shipping_zones'), (snapshot) => {
    shippingZones = [];
    if (snapshot.exists()) {
        snapshot.forEach((childSnapshot) => { shippingZones.push(childSnapshot.val()); });
    }
});

function getProductIdFromUrl() { return new URLSearchParams(window.location.search).get('id'); }

async function fetchProductDetails() {
  const productId = getProductIdFromUrl();
  if (!productId) { container.innerHTML = '<p class="error-text">Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.</p>'; return; }
  currentProductId = productId;

  try {
    const snapshot = await get(child(ref(db, 'products'), productId));
    if (!snapshot.exists()) { container.innerHTML = '<p class="error-text">Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.</p>'; return; }

    const product = snapshot.val();
    const marketingDiscount = parseFloat(product.marketingDiscount || 0);
    currentProductPrice = parseFloat(product.newPrice) + marketingDiscount;

    if (product.customPixelId && product.customPixelId.trim() !== "") {
        initPixel(product.customPixelId);
    } else {
        get(child(ref(db), 'settings/pixel_id')).then((snap) => {
            if(snap.exists() && snap.val()) initPixel(snap.val());
        });
    }
    
    setTimeout(() => {
        if (typeof fbq !== 'undefined' && activePixelId) {
            fbq('track', 'ViewContent', { 
                content_name: product.name, 
                content_ids: [productId], 
                content_type: 'product',
                value: currentProductPrice, 
                currency: 'DZD'
            });
        }
    }, 1500);

    if (product.customLogo && product.customLogo.trim() !== "") {
        storeLogoImg.src = product.customLogo;
    } else {
        onValue(ref(db, 'settings/logo'), (snap) => {
            if(snap.exists()) storeLogoImg.src = snap.val();
            else storeLogoImg.src = "https://via.placeholder.com/500x120?text=Welcome";
        });
    }

    const images = Array.isArray(product.images) ? product.images : [product.images || 'default.jpg'];
    const swiperSlides = images.map(src => `<div class="swiper-slide"><img src="${src}" alt="ØµÙˆØ±Ø©"></div>`).join('');

    // ===========================================
    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª
    // ===========================================
    const wilayas = [
        "Ø£Ø¯Ø±Ø§Ø±", "Ø§Ù„Ø´Ù„Ù", "Ø§Ù„Ø£ØºÙˆØ§Ø·", "Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ", "Ø¨Ø§ØªÙ†Ø©", "Ø¨Ø¬Ø§ÙŠØ©", "Ø¨Ø³ÙƒØ±Ø©", "Ø¨Ø´Ø§Ø±", "Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©", "Ø§Ù„Ø¨ÙˆÙŠØ±Ø©",
        "ØªÙ…Ù†Ø±Ø§Ø³Øª", "ØªØ¨Ø³Ø©", "ØªÙ„Ù…Ø³Ø§Ù†", "ØªÙŠØ§Ø±Øª", "ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ", "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", "Ø§Ù„Ø¬Ù„ÙØ©", "Ø¬ÙŠØ¬Ù„", "Ø³Ø·ÙŠÙ", "Ø³Ø¹ÙŠØ¯Ø©",
        "Ø³ÙƒÙŠÙƒØ¯Ø©", "Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³", "Ø¹Ù†Ø§Ø¨Ø©", "Ù‚Ø§Ù„Ù…Ø©", "Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©", "Ø§Ù„Ù…Ø¯ÙŠØ©", "Ù…Ø³ØªØºØ§Ù†Ù…", "Ø§Ù„Ù…Ø³ÙŠÙ„Ø©", "Ù…Ø¹Ø³ÙƒØ±", "ÙˆØ±Ù‚Ù„Ø©",
        "ÙˆÙ‡Ø±Ø§Ù†", "Ø§Ù„Ø¨ÙŠØ¶", "Ø¥Ù„ÙŠØ²ÙŠ", "Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬", "Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³", "Ø§Ù„Ø·Ø§Ø±Ù", "ØªÙ†Ø¯ÙˆÙ", "ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª", "Ø§Ù„ÙˆØ§Ø¯ÙŠ", "Ø®Ù†Ø´Ù„Ø©",
        "Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³", "ØªÙŠØ¨Ø§Ø²Ø©", "Ù…ÙŠÙ„Ø©", "Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰", "Ø§Ù„Ù†Ø¹Ø§Ù…Ø©", "Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª", "ØºØ±Ø¯Ø§ÙŠØ©", "ØºÙ„ÙŠØ²Ø§Ù†", "ØªÙŠÙ…ÙŠÙ…ÙˆÙ†", "Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±",
        "Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„", "Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³", "Ø¥Ù† ØµØ§Ù„Ø­", "Ø¥Ù† Ù‚Ø²Ø§Ù…", "ØªÙ‚Ø±Øª", "Ø¬Ø§Ù†Øª", "Ø§Ù„Ù…ØºÙŠØ±", "Ø§Ù„Ù…Ù†ÙŠØ¹Ø©"
    ];
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙˆÙ„Ø§ÙŠØ©
    const wilayaOptions = wilayas.map((w, index) => `<option value="${w}">${index + 1} - ${w}</option>`).join('');

    let descriptionHTML = '';
    if (Array.isArray(product.description)) {
        product.description.forEach(block => {
            if (block.type === 'text') descriptionHTML += `<p>${block.val}</p>`;
            else if (block.type === 'image') descriptionHTML += `<img src="${block.val}" alt="ØªÙˆØ¶ÙŠØ­">`;
        });
    } else { descriptionHTML = `<p>${product.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ.'}</p>`; }

    // =======================================================
    // ğŸ”¥ ØªØ­Ø¯ÙŠØ« Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (ØªØ±ØªÙŠØ¨ Ø§Ù„Ø®Ø§Ù†Ø§Øª) ğŸ”¥
    // =======================================================
    container.innerHTML = `
      <div class="swiper mySwiper"><div class="swiper-wrapper">${swiperSlides}</div><div class="swiper-pagination"></div></div>
      <div class="product-header">
        <h2>${product.name}</h2>
        <div class="price-badge">
            ${Number(currentProductPrice).toLocaleString()} Ø¯Ø¬
            ${product.oldPrice ? `<small>${Number(product.oldPrice).toLocaleString()}</small>` : ''}
        </div>
        <div id="liveViewersWrapper" style="display: none; text-align: center; margin-top: 10px; color: #c0392b; font-weight: bold;">
            <span style="animation: pulse 1.5s infinite;">â—</span> ÙŠØ´Ø§Ù‡Ø¯ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¢Ù†: <span id="liveViewersCount">0</span> Ø£Ø´Ø®Ø§Øµ
        </div>
      </div>

      <div class="compact-card" id="orderCard">
        <div class="card-header">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† ğŸ‘‡</div>
        
        <!-- 1. Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ -->
        <div class="input-wrapper"><i class="fas fa-phone input-icon"></i><input type="tel" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" dir="ltr" style="text-align:right;"></div>
        
        <!-- 2. Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨ -->
        <div class="input-wrapper"><i class="fas fa-user input-icon"></i><input type="text" id="fullName" placeholder="Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨"></div>
        
        <!-- 3. Ø§Ù„ÙˆÙ„Ø§ÙŠØ© ÙˆØ§Ù„Ø¨Ù„Ø¯ÙŠØ© (ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø³Ø·Ø±) -->
        <div class="row-dual">
            <div class="col-half"><select id="wilaya"><option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</option>${wilayaOptions}</select></div>
            <div class="col-half"><input type="text" id="commune" placeholder="Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©"></div>
        </div>
        
        <!-- 4. Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
        <div class="input-wrapper">
            <i class="fas fa-map-marker-alt input-icon"></i>
            <input type="text" id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ù„Ø­ÙŠ / Ø§Ù„Ø´Ø§Ø±Ø¹)">
        </div>

        <!-- 5. Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (Ø¨Ø¯ÙˆÙ† Ø¥ÙŠÙ…ÙˆØ¬ÙŠ) -->
        <div class="input-wrapper">
            <i class="fas fa-truck input-icon"></i>
            <select id="deliveryType" class="select-no-border">
                <option value="Ø§Ù„Ù…Ù†Ø²Ù„">ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…Ù†Ø²Ù„</option>
                <option value="Ù…ÙƒØªØ¨ Ø§Ù„Ø´Ø±ÙƒØ©">Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„Ù…ÙƒØªØ¨</option>
            </select>
        </div>

        <div class="price-summary">
            <div class="total-row"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span><span id="summaryTotalPrice" class="final-price">0 Ø¯Ø¬</span></div>
            <small id="shippingText" class="ship-note">(Ø§Ù„Ø´Ø­Ù† ØºÙŠØ± Ù…Ø­Ø¯Ø¯)</small>
        </div>
        <div class="action-bar">
            <div class="qty-box"><button type="button" id="increaseQty">+</button><span id="quantityValue">1</span><button type="button" id="decreaseQty">-</button></div>
            <button id="confirmOrderBtn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ğŸš€</button>
        </div>
      </div>

      <div class="desc-section"><h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h3><div class="desc-content">${descriptionHTML}</div></div>
      ${product.icons && Array.isArray(product.icons) && product.icons.length > 0 ? `
      <div class="product-icons-section"><div class="product-icons-grid">
          ${product.icons.map(ic => `<div class="icon-item"><img src="${ic.icon || ''}" alt="Ø£ÙŠÙ‚ÙˆÙ†Ø©"><span>${ic.text || ''}</span></div>`).join('')}
      </div></div>` : ''}

      <div class="reviews-section">
         <h3>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h3>
         <div id="postOrderReview">
            <h4 style="text-align:center; color:#27ae60; margin:0 0 10px;">ğŸ‰ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø·Ù„Ø¨Ùƒ! Ù…Ø§ Ù‡Ùˆ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù„Ù„Ù…Ù†ØªØ¬ØŸ</h4>
            <div class="stars-box" id="reviewStars">
                <i class="fas fa-star" data-rating="1"></i><i class="fas fa-star" data-rating="2"></i>
                <i class="fas fa-star" data-rating="3"></i><i class="fas fa-star" data-rating="4"></i>
                <i class="fas fa-star" data-rating="5"></i>
            </div>
            <div class="review-input-group"><input type="text" id="reviewName" placeholder="Ø§Ø³Ù…Ùƒ (Ø³ÙŠØ¸Ù‡Ø± Ù…Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚)"></div>
            <div class="review-input-group"><textarea id="reviewText" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒ Ø¨ØµØ±Ø§Ø­Ø©..."></textarea></div>
            <button id="submitReviewBtn" style="width:100%; padding:10px; background:#27ae60; color:white; border:none; border-radius:50px; cursor:pointer;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
         </div>
         <div id="commentsList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>

      <div id="storePolicySection" class="store-policy-section" style="display:none;"><h3>ğŸ“œ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª</h3><div id="policyContent" class="policy-content" style="display:none;"></div></div>
    `;

    new Swiper(".mySwiper", { pagination: { el: ".swiper-pagination", clickable: true } });
    document.querySelectorAll('.swiper-slide img, .desc-content img').forEach(img => {
      img.addEventListener('click', () => { previewImage.src = img.src; previewModal.classList.add('active'); });
    });
    closePreview.addEventListener('click', () => previewModal.classList.remove('active'));
    previewModal.addEventListener('click', e => { if(e.target === previewModal) previewModal.classList.remove('active'); });

    const policySection = document.getElementById('storePolicySection');
    const policyContent = document.getElementById('policyContent');
    const policyHeader = policySection ? policySection.querySelector('h3') : null;
    if (policyHeader) {
        policyHeader.addEventListener('click', () => {
            const isHidden = policyContent.style.display === "none";
            policyContent.style.display = isHidden ? "block" : "none";
            if (isHidden) policySection.classList.add('open'); else policySection.classList.remove('open');
        });
    }
    onValue(ref(db, 'policies'), (snapshot) => {
      if (snapshot.exists()) {
        const policies = snapshot.val();
        let policyHTML = '';
        for (const id in policies) {
          const p = policies[id];
          if (p.title && p.content) {
            policyHTML += `<div class="policy-item"><h4 class="policy-title">${p.title}</h4><p class="policy-body" style="display:none;">${p.content}</p></div>`;
          }
        }
        if (policyHTML) {
          policyContent.innerHTML = policyHTML; policySection.style.display = 'block';
          const titles = policyContent.querySelectorAll('.policy-title');
          titles.forEach(title => { title.addEventListener('click', () => { const body = title.nextElementSibling; body.style.display = (body.style.display === "none") ? "block" : "none"; }); });
        } else policySection.style.display = 'none';
      } else policySection.style.display = 'none';
    });

    const confirmBtn = document.getElementById("confirmOrderBtn");
    const qtyVal = document.getElementById("quantityValue");
    const wilayaSel = document.getElementById("wilaya");
    const delSel = document.getElementById("deliveryType");
    let qty = 1;
    let shipPrice = 0;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ©
    wilayaSel.addEventListener("change", updatePrice);
    delSel.addEventListener("change", updatePrice);

    function updatePrice() {
        const pPrice = currentProductPrice * qty;
        
        const zone = shippingZones.find(z => z.wilayas && z.wilayas.includes(wilayaSel.value));
        if (zone) {
            shipPrice = (delSel.value === "Ø§Ù„Ù…Ù†Ø²Ù„") ? parseFloat(zone.homePrice || 0) : parseFloat(zone.deskPrice || 0);
            document.getElementById("shippingText").textContent = `(+${shipPrice} Ø¯Ø¬ ØªÙˆØµÙŠÙ„)`;
            document.getElementById("shippingText").style.color = "#27ae60";
        } else {
            shipPrice = 0;
            document.getElementById("shippingText").textContent = wilayaSel.value ? "(ØªÙˆØµÙŠÙ„ ØºÙŠØ± Ù…Ø­Ø¯Ø¯)" : "(Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆØµÙŠÙ„)";
            document.getElementById("shippingText").style.color = "#7f8c8d";
        }
        
        document.getElementById("summaryTotalPrice").textContent = (pPrice + shipPrice).toLocaleString() + " Ø¯Ø¬";
    }

    document.getElementById("decreaseQty").addEventListener("click", () => { if(qty>1) { qty--; qtyVal.textContent = qty; updatePrice(); }});
    document.getElementById("increaseQty").addEventListener("click", () => { qty++; qtyVal.textContent = qty; updatePrice(); });
    
    updatePrice();

    confirmBtn.addEventListener("click", async () => {
        const load = document.getElementById("loadingScreen");
        const ph = document.getElementById("phone").value.trim();
        const nm = document.getElementById("fullName").value.trim();
        const wl = document.getElementById("wilaya").value;
        const cm = document.getElementById("commune").value.trim(); // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© Ù…Ù† Ø§Ù„Ù€ Input
        const ad = document.getElementById("address").value.trim();

        if(!ph || !nm || !wl || !cm || !ad) { alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø§Ù†Ø§Øª (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©)!"); return; }
        
        load.classList.remove("hidden");
        try {
            const refOrd = push(ref(db, "orders"));
            
            const productTotalAmount = currentProductPrice * qty;
            const finalTotal = productTotalAmount + shipPrice; 

            await set(refOrd, {
                id: refOrd.key,
                productId: productId,
                productName: product.name,
                productPrice: currentProductPrice,
                quantity: qty,
                productTotal: productTotalAmount,
                shippingPrice: shipPrice,
                totalPrice: finalTotal,
                customerName: nm,
                customerPhone: ph,
                customerWilaya: wl,
                customerCommune: cm,
                customerAddress: ad,
                deliveryOption: delSel.value,
                timestamp: Date.now(),
                status: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"
            });
            
            if (typeof fbq !== 'undefined' && activePixelId) {
                fbq('track', 'Purchase', { 
                    value: finalTotal,      
                    currency: 'DZD',        
                    content_name: product.name,
                    content_ids: [productId],
                    content_type: 'product',
                    num_items: qty
                });
            }

            load.classList.add("hidden");
            document.getElementById("thankYouModal").classList.remove("hidden");
            document.getElementById("orderIdBox").textContent = refOrd.key;
            document.getElementById("thankYouMessage").innerHTML = `Ø´ÙƒØ±Ø§Ù‹ <b>${nm}</b>ØŒ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­.`;
            document.getElementById("postOrderReview").style.display = "block";
            document.getElementById("reviewName").value = nm; 
            document.getElementById("postOrderReview").scrollIntoView({behavior: "smooth"});
            document.getElementById("closeModal").onclick = () => { document.getElementById("thankYouModal").classList.add("hidden"); };
            document.getElementById("copyOrderId").onclick = () => { navigator.clipboard.writeText(refOrd.key); alert("ØªÙ… Ø§Ù„Ù†Ø³Ø®"); };
        } catch(e) { console.error(e); alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); load.classList.add("hidden"); }
    });
    
    let selectedRating = 0;
    const stars = document.querySelectorAll('#reviewStars i');
    stars.forEach(star => {
        star.addEventListener('click', () => {
            selectedRating = parseInt(star.dataset.rating);
            stars.forEach(s => { if(parseInt(s.dataset.rating) <= selectedRating) s.classList.add('active'); else s.classList.remove('active'); });
        });
    });
    document.getElementById('submitReviewBtn').addEventListener('click', async () => {
        const rName = document.getElementById('reviewName').value.trim() || "Ø²Ø¨ÙˆÙ†";
        const rText = document.getElementById('reviewText').value.trim();
        if(selectedRating === 0) { alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¬ÙˆÙ… â­"); return; }
        if(!rText) { alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ‚"); return; }
        try { await push(child(ref(db), `reviews/${productId}`), { reviewerName: rName, rating: selectedRating, comment: rText, timestamp: Date.now() }); alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚ÙŠÙŠÙ…ÙƒØŒ Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ! â¤ï¸"); document.getElementById("postOrderReview").style.display = "none"; } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."); }
    });
    onValue(ref(db, `reviews/${productId}`), (snap) => {
        const list = document.getElementById('commentsList');
        if(snap.exists()) {
            list.innerHTML = '';
            snap.forEach(c => { const r = c.val(); list.innerHTML += `<div class="review-item" style="border-bottom:1px solid #eee; padding:10px 0;"><b>${r.reviewerName}</b> <span style="color:#f1c40f">${'â˜…'.repeat(r.rating)}</span><br><span style="color:#555;">${r.comment}</span></div>`; });
        } else list.innerHTML = '<p style="text-align:center;color:#999">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯.</p>';
    });
    
    const orderCard = document.getElementById('orderCard');
    const floatingBtn = document.getElementById('floatingOrderBtn');
    function checkScroll() {
        if (!orderCard) return;
        if (orderCard.getBoundingClientRect().bottom < 100) floatingBtn.classList.add('visible'); else floatingBtn.classList.remove('visible');
    }
    document.getElementById('floatingConfirmBtn').addEventListener('click', () => { orderCard.scrollIntoView({ behavior: 'smooth', block: 'center' }); });
    window.addEventListener('scroll', checkScroll); window.addEventListener('resize', checkScroll);
    const waitForCard = setInterval(() => { if (document.getElementById('orderCard')) { checkScroll(); clearInterval(waitForCard); } }, 300);
    setTimeout(checkScroll, 1500); 

    onValue(presenceRef, (snapshot) => {
        let count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
        if (count < 1) count = 1;
        const wrapper = document.getElementById("liveViewersWrapper");
        const countSpan = document.getElementById("liveViewersCount");
        if (wrapper && countSpan) { countSpan.innerText = count; wrapper.style.display = "inline-flex"; }
    });

  } catch(err) { container.innerHTML = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.'; console.log(err); }
}
fetchProductDetails();
</script>
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js "></script>
</body>
<div class="contact-footer"><div class="contact-container"></div></div>
</html>