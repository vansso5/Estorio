<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تفاصيل المنتج</title>
<link rel="stylesheet" href="customer-style.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css">
<!-- Font Awesome لأيقونات النجوم والسبيّنر -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
/* بعض أنماط بسيطة للتعليقات إن لم تكن موجودة في CSS لديك */
.reviews-section { margin-top: 20px; background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
.review-form input, .review-form textarea, .review-form button, .review-form select { width: 100%; margin-bottom: 8px; padding: 8px; box-sizing: border-box }
/* أنماط النجوم المُحدثة لتفعيل النصف نجمة */
.rating-stars .fa-star, .rating-stars .fa-star-half-alt, .rating-stars .far.fa-star { 
    cursor: pointer; 
    margin-left: 6px; 
    font-size: 20px; 
    color: #ccc; /* لون النجمة الفارغة الافتراضي */
}
.rating-stars .fas.fa-star, .rating-stars .fas.fa-star-half-alt { 
    color: #f0ad4e; /* لون النجمة المحددة/المظللة */
}

.comment-item { border-top: 1px solid #eee; padding: 10px 0; }
.comment-rating i { margin-left: 4px; color: #f5a623; }
.rating-summary { display:flex; align-items:center; gap:12px; margin-bottom:10px; }
.average-rating { font-size:22px; font-weight:700; color:#333; }
.rating-stars-display i { margin-left:4px; color:#f5a623; }
.comment-date { display:block; color:#777; font-size:12px; margin-top:6px; }

/* ✅ أنماط مؤشر التحميل (Spinner) */
.spinner {
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top: 4px solid #fff;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  animation: spin 1s linear infinite;
  display: inline-block;
  vertical-align: middle;
  margin-left: 8px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.confirm-order-btn-content {
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>
</head>
<body>

<!-- ✅ شريط الاتصال الثابت -->
<div class="top-contact">
📞 اتصل بنا على
<a href="tel:0540667186">0540667186</a>
</div>

<div class="container">
  <div id="productDetailContainer"><p>جاري تحميل تفاصيل المنتج...</p></div>
</div>

<!-- ✅ نافذة تكبير الصورة -->
<div class="image-preview-modal" id="imagePreviewModal">
  <button class="close-preview" id="closePreview">&times;</button>
  <img id="previewImage" src="" alt="صورة مكبرة">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get, child, push, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
  authDomain: "myestore-34f65.firebaseapp.com",
  databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
  projectId: "myestore-34f65",
  storageBucket: "myestore-34f65.appspot.com",
  messagingSenderId: "14078917211",
  appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
  measurementId: "G-9181DX0XNJ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const container = document.getElementById('productDetailContainer');
const previewModal = document.getElementById('imagePreviewModal');
const previewImage = document.getElementById('previewImage');
const closePreview = document.getElementById('closePreview');

let currentProductId = null;

function getProductIdFromUrl() {
  return new URLSearchParams(window.location.search).get('id');
}

// دالة لحساب متوسط التقييمات
function calculateAverageRating(reviews) {
  if (!reviews || reviews.length === 0) return 0;
  
  const total = reviews.reduce((sum, review) => sum + (parseFloat(review.rating) || 0), 0); // استخدم parseFloat
  return (total / reviews.length).toFixed(1);
}

// دالة لعرض متوسط التقييم
function displayAverageRating(averageRating, totalReviews) {
  const ratingSummary = document.getElementById('ratingSummary');
  if (ratingSummary) {
    ratingSummary.innerHTML = `
      <div class="average-rating">${averageRating}</div>
      <div class="rating-stars-display">
        ${generateStarIconsForDisplay(averageRating)}
      </div>
      <div class="total-reviews">(${totalReviews} تقييم)</div>
    `;
  }
}

// توليد أيقونات النجوم للعرض (لدعم نصف نجمة في الملخص)
function generateStarIconsForDisplay(rating) {
  let starsHtml = '';
  for (let i = 1; i <= 5; i++) {
    if (rating >= i) {
      starsHtml += '<i class="fas fa-star"></i>';
    } else if (rating >= i - 0.5) {
      starsHtml += '<i class="fas fa-star-half-alt"></i>';
    } else {
      starsHtml += '<i class="far fa-star"></i>';
    }
  }
  return starsHtml;
}

// مساعدة لحماية إدراج النصوص في innerHTML
function escapeHtml(text) {
  if (!text) return '';
  return text
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

async function fetchProductDetails() {
  const productId = getProductIdFromUrl();
  if (!productId) {
    container.innerHTML = '<p class="error-message">لم يتم العثور على معرف المنتج.</p>';
    return;
  }
  currentProductId = productId;

  try {
    const snapshot = await get(child(ref(db), `products/${productId}`));
    if (!snapshot.exists()) {
      container.innerHTML = '<p class="error-message">المنتج غير موجود.</p>';
      return;
    }

    const product = snapshot.val();
    const images = Array.isArray(product.images) ? product.images : [product.images || 'default.jpg'];
    const swiperSlides = images.map(src => `<div class="swiper-slide"><img src="${src}" alt="صورة المنتج"></div>`).join('');

    const wilayas = [
      "أدرار","الشلف","الأغواط","أم البواقي","باتنة","بجاية","بسكرة","بشار","البليدة","البويرة","تمنراست","تبسة","تلمسان","تيارت","تيزي وزو","الجزائر","الجلفة","جيجل","سطيف","سعيدة","سكيكدة","سيدي بلعباس","عنابة","قالمة","قسنطينة","المدية","مستغانم","المسيلة","معسكر","ورقلة","وهران","البيض","إليزي","برج بوعريريج","بومرداس","الطارف","تندوف","تيسمسيلت","الوادي","خنشلة","سوق أهراس","تيبازة","ميلة","عين الدفلى","النعامة","عين تموشنت","غرداية","غليزان","تيميمون","برج باجي مختار","أولاد جلال","بني عباس","إن صالح","إن قزام","تقرت","جانت","المغير","المنيعة"
    ];

    const wilayaOptions = wilayas.map(w => `<option value="${w}">${w}</option>`).join('');

    container.innerHTML = `
      <div class="swiper mySwiper"><div class="swiper-wrapper">${swiperSlides}</div><div class="swiper-pagination"></div></div>
      <div class="product-detail-info">
        <h2>${escapeHtml(product.name)}</h2>
        <p class="product-detail-price">
          ${product.oldPrice ? `<span style="text-decoration: line-through; color: #999; font-size: 18px; margin-left: 10px;">${Number(product.oldPrice).toLocaleString()} دج</span>` : ''}
          <span style="color: #e74c3c; font-weight: bold;">${Number(product.newPrice).toLocaleString()} دج</span>
        </p>
        <p class="product-description">${escapeHtml(product.description || '')}</p>
        <button id="orderBtn">اطلب الآن</button>
      </div>

      <!-- ✅ قسم التعليقات والتقييمات بالترتيب الجديد -->
      <div class="reviews-section">
        <h3>التعليقات والتقييمات</h3>

        <!-- ملخص التقييم (سيتم تعبئته بواسطة JS) -->
        <div id="ratingSummary" class="rating-summary">
          <div>جاري تحميل ملخص التقييم...</div>
        </div>

        <!-- نموذج كتابة التعليق أولاً -->
        <div class="review-form">
          <input type="text" id="reviewerName" placeholder="اسمك (اختياري)">
          <div class="rating-stars" id="ratingStars">
            <i class="far fa-star" data-rating="1"></i>
            <i class="far fa-star" data-rating="2"></i>
            <i class="far fa-star" data-rating="3"></i>
            <i class="far fa-star" data-rating="4"></i>
            <i class="far fa-star" data-rating="5"></i>
          </div>
          <span id="ratingText" style="color: #666; font-size: 14px; display: block; margin-bottom: 10px;">اضغط على النجوم للتقييم</span>
          <textarea id="reviewText" placeholder="اكتب تعليقك هنا..." rows="4"></textarea>
          <button id="submitReviewBtn">إرسال التعليق</button>
        </div>

        <!-- التعليقات السابقة تظهر بعدها مباشرة -->
        <div class="comments-list" id="commentsList">
          <p style="text-align: center; color: #777;">جاري تحميل التعليقات...</p>
        </div>
      </div>

      <!-- نافذة الطلب (تبقى كما هي) -->
      <div id="orderModal" class="modal hidden">
        <div class="modal-content">
          <h3>أدخل معلومات الطلب</h3>
          <input type="text" id="fname" placeholder="الاسم">
          <input type="text" id="lname" placeholder="اللقب">
          <input type="text" id="phone" placeholder="رقم الهاتف">

          <select id="wilaya">
            <option value="">اختر الولاية</option>
            ${wilayaOptions}
          </select>
          <input type="text" id="commune" placeholder="البلدية (إجباري)">
          <input type="text" id="address" placeholder="العنوان الكامل">

          <div class="quantity-selector">
            <button type="button" id="decreaseQty">-</button>
            <span id="quantityValue">1</span>
            <button type="button" id="increaseQty">+</button>
          </div>

          <select id="deliveryType">
            <option value="المنزل">توصيل إلى المنزل</option>
            <option value="مكتب الشركة">إلى مكتب الشركة</option>
          </select>

          <textarea id="note" placeholder="ملاحظات إضافية (اختياري)" rows="3"></textarea>
          <button id="confirmOrderBtn">
            <span class="confirm-order-btn-content">تأكيد الطلب</span>
          </button>
        </div>
      </div>

      <div id="thankYouModal" class="modal hidden">
        <div class="modal-content">
          <h3>شكرًا لطلبك!</h3>
          <p>تم إرسال طلبك بنجاح ❤️</p>
          <div id="orderIdBox" style="background:#f0f0f0;padding:10px;border-radius:8px;margin-bottom:10px;font-weight:bold;"></div>
          <button id="copyOrderId" style="background:#4CAF50;color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;margin-bottom:10px;">📋 نسخ الرقم</button>
          <br>
          <button id="closeModal" style="background:#e74c3c;color:white;padding:8px 20px;border:none;border-radius:6px;cursor:pointer;">موافق</button>
        </div>
      </div>
    `;

    // تهيئة السويبر
    const swiper = new Swiper(".mySwiper", { pagination: { el: ".swiper-pagination", clickable: true } });

    // تكبير الصورة
    document.querySelectorAll('.swiper-slide img').forEach(img => {
      img.addEventListener('click', () => {
        previewImage.src = img.src;
        previewModal.classList.add('active');
      });
    });

    closePreview.addEventListener('click', () => previewModal.classList.remove('active'));
    previewModal.addEventListener('click', e => { if(e.target === previewModal) previewModal.classList.remove('active'); });

    // منطق الطلب (مع إضافة spinner)
    const orderBtn = document.getElementById("orderBtn");
    const orderModal = document.getElementById("orderModal");
    const confirmOrderBtn = document.getElementById("confirmOrderBtn");
    const thankYouModal = document.getElementById("thankYouModal");
    const decreaseQty = document.getElementById("decreaseQty");
    const increaseQty = document.getElementById("increaseQty");
    const quantityValue = document.getElementById("quantityValue");
    const confirmOrderBtnContent = confirmOrderBtn.querySelector('.confirm-order-btn-content');

    let quantity = 1;

    orderBtn.addEventListener("click", () => orderModal.classList.remove("hidden"));
    orderModal.addEventListener("click", e => { if(e.target === orderModal) orderModal.classList.add("hidden"); });

    decreaseQty.addEventListener("click", () => { if(quantity>1) quantity--; quantityValue.textContent = quantity; });
    increaseQty.addEventListener("click", () => { quantity++; quantityValue.textContent = quantity; });

    confirmOrderBtn.addEventListener("click", async () => {
      const fname = document.getElementById("fname").value.trim();
      const lname = document.getElementById("lname").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const wilaya = document.getElementById("wilaya").value.trim();
      const commune = document.getElementById("commune").value.trim();
      const address = document.getElementById("address").value.trim();
      const deliveryType = document.getElementById("deliveryType").value;
      const note = document.getElementById("note").value.trim();

      if (!fname || !lname || !phone || !wilaya || !commune || !address) {
        alert("يرجى ملء جميع الخانات الإجبارية بشكل صحيح.");
        return;
      }

      // ✅ تفعيل مؤشر التحميل وتعطيل الزر
      confirmOrderBtn.disabled = true;
      confirmOrderBtnContent.innerHTML = 'جاري التأكيد <span class="spinner"></span>';

      try {
        orderModal.classList.add("hidden");

        const orderRef = push(ref(db, "orders"));
        const orderId = orderRef.key;
        const totalPrice = parseFloat(product.newPrice) * quantity;

        await set(orderRef, {
          id: orderId,
          productId: productId,
          productName: product.name,
          productPrice: parseFloat(product.newPrice),
          quantity,
          totalPrice,
          customerName: `${fname} ${lname}`,
          customerPhone: phone,
          customerWilaya: wilaya,
          customerCommune: commune,
          customerAddress: address,
          deliveryOption: deliveryType,
          note,
          timestamp: Date.now(),
          status: "الطلبات الجديدة",
          rating: 0 // هذا التقييم للطلب وليس تقييم المنتج
        });

        // ✅ تأخير وهمي لمدة 2-3 ثواني
        await new Promise(resolve => setTimeout(resolve, 2500)); 

        document.getElementById("orderIdBox").textContent = orderId;
        thankYouModal.classList.remove("hidden");
        document.getElementById("copyOrderId").onclick = () => { navigator.clipboard.writeText(orderId); alert("تم نسخ رقم الطلب!"); };
        document.getElementById("closeModal").onclick = () => { thankYouModal.classList.add("hidden"); };

      } catch (error) {
        console.error("Error confirming order:", error);
        alert("حدث خطأ أثناء تأكيد طلبك. يرجى المحاولة مرة أخرى.");
      } finally {
        // ✅ إلغاء تفعيل مؤشر التحميل وتفعيل الزر
        confirmOrderBtn.disabled = false;
        confirmOrderBtnContent.innerHTML = 'تأكيد الطلب';
      }
    });

    // --- منطق التعليقات والتقييمات المحسن (دعم نصف نجمة) ---
    const ratingStarsContainer = document.getElementById('ratingStars');
    const submitReviewBtn = document.getElementById('submitReviewBtn');
    const reviewText = document.getElementById('reviewText');
    const reviewerNameInput = document.getElementById('reviewerName');
    const commentsList = document.getElementById('commentsList');
    const ratingText = document.getElementById('ratingText');

    let selectedRating = 0; // سيمثل التقييم الحالي (يمكن أن يكون 0، 0.5، 1، 1.5 وهكذا)

    // دالة لـ "تلوين" النجوم بناءً على تقييم معين (دعم نصف نجمة)
    function renderInteractiveStars(currentRating) {
        ratingStarsContainer.querySelectorAll('.fa-star').forEach((star, index) => {
            const starValue = index + 1;
            if (currentRating >= starValue) {
                star.className = 'fas fa-star'; // نجمة كاملة
            } else if (currentRating >= starValue - 0.5) {
                star.className = 'fas fa-star-half-alt'; // نصف نجمة
            } else {
                star.className = 'far fa-star'; // نجمة فارغة
            }
        });
    }

    // تهيئة تفاعل النجوم (click, hover)
    ratingStarsContainer.querySelectorAll('.fa-star').forEach(star => {
      star.addEventListener('click', (event) => {
        const starValue = parseInt(star.dataset.rating);
        const rect = star.getBoundingClientRect();
        const clickX = event.clientX - rect.left; // موقع النقر بالنسبة للنجمة
        
        // تحديد ما إذا كان النقر على النصف الأيسر (لنصف نجمة)
        let newRating = starValue;
        if (clickX < rect.width / 2) {
            newRating = starValue - 0.5;
        }

        // منطق النقر: إذا نقر على نفس التقييم المحدد مرة أخرى، يتم إلغاء التحديد (جعله 0)
        // باستثناء إذا كان التقييم 0.5 وتم النقر على النصف الأيسر من النجمة 1، فيتم إلغاء التحديد
        if (selectedRating === newRating) {
             selectedRating = 0;
        } else if (newRating === 0) { // منع التقييم 0 من النقر على النصف الأيسر للنجمة 1
             selectedRating = 0.5;
        } else {
             selectedRating = newRating;
        }

        renderInteractiveStars(selectedRating);
        updateRatingText();
      });
      
      star.addEventListener('mousemove', (event) => {
        const starValue = parseInt(star.dataset.rating);
        const rect = star.getBoundingClientRect();
        const clickX = event.clientX - rect.left;
        
        let hoverRating = starValue;
        if (clickX < rect.width / 2) {
            hoverRating = starValue - 0.5;
        }
        renderInteractiveStars(hoverRating);
      });
      
      star.addEventListener('mouseout', () => {
        renderInteractiveStars(selectedRating); // العودة للتقييم المحدد
      });
    });

    // تحديث نص التقييم ليناسب النصف نجمة
    function updateRatingText() {
      const ratingLabels = {
        0: "اضغط على النجوم للتقييم",
        0.5: "سيء جدًا",
        1: "سيء",
        1.5: "ليس جيد",
        2: "ليس جيد",
        2.5: "مقبول",
        3: "جيد",
        3.5: "جيد جداً",
        4: "جيد جداً",
        4.5: "ممتاز",
        5: "ممتاز"
      };
      // البحث عن أقرب قيمة في labels أو استخدام النص الافتراضي
      ratingText.textContent = ratingLabels[selectedRating] || ratingLabels[Math.round(selectedRating * 2) / 2] || "اضغط على النجوم للتقييم";
    }

    // === حفظ التعليقات في Firebase (المسار: reviews/{productId}) ===
    submitReviewBtn.addEventListener('click', async () => {
      const name = reviewerNameInput.value.trim() || "مجهول";
      const comment = reviewText.value.trim();

      if (selectedRating === 0) {
        alert("يرجى اختيار تقييم بالنجوم قبل الإرسال.");
        return;
      }

      if (!comment) {
        alert("يرجى كتابة تعليق قبل الإرسال.");
        return;
      }

      try {
        // push إلى المسار reviews/{currentProductId}
        const reviewRef = push(ref(db, `reviews/${currentProductId}`));
        await set(reviewRef, {
          reviewerName: name,
          rating: selectedRating, // سيتم إرسال قيمة نصف نجمة إذا تم اختيارها
          comment: comment,
          timestamp: Date.now()
        });

        // إعادة تهيئة النموذج
        reviewerNameInput.value = '';
        reviewText.value = '';
        selectedRating = 0;
        renderInteractiveStars(selectedRating); // تحديث النجوم لإظهار عدم التحديد
        updateRatingText();

        alert("تم إرسال تعليقك بنجاح!");
      } catch (error) {
        console.error("Error submitting review:", error);
        alert("حدث خطأ أثناء إرسال التعليق. يرجى المحاولة مرة أخرى.");
      }
    });

    // === جلب وعرض التعليقات من Firebase (المسار reviews/{productId}) ===
    function fetchAndDisplayReviews() {
        if (!currentProductId) return;

        const reviewsRef = ref(db, `reviews/${currentProductId}`);
        onValue(reviewsRef, (snapshot) => {
            const ratingSummaryEl = document.getElementById('ratingSummary');
            commentsList.innerHTML = '';

            if (!snapshot.exists()) {
                commentsList.innerHTML = '<p style="text-align: center; color: #777;">لا توجد تعليقات حتى الآن. كن أول من يعلق!</p>';
                if (ratingSummaryEl) displayAverageRating(0, 0);
                return;
            }

            const reviewsObj = snapshot.val();
            const reviews = Object.keys(reviewsObj).map(k => ({ id: k, ...reviewsObj[k] }));
            // ترتيب الأحدث أولاً
            reviews.sort((a, b) => b.timestamp - a.timestamp);

            // حساب وعرض ملخص التقييم
            const averageRating = calculateAverageRating(reviews);
            if (ratingSummaryEl) displayAverageRating(averageRating, reviews.length);

            // عرض كل تعليق
            commentsList.innerHTML = '';
            reviews.forEach(review => {
                const date = new Date(review.timestamp).toLocaleDateString('ar-DZ', {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                commentsList.innerHTML += `
                    <div class="comment-item">
                        <strong>${escapeHtml(review.reviewerName)}</strong>
                        <div class="comment-rating">
                            ${generateStarIconsForDisplay(parseFloat(review.rating))}
                        </div>
                        <p>${escapeHtml(review.comment)}</p>
                        <span class="comment-date">${date}</span>
                    </div>
                `;
            });
        }, (error) => {
          console.error("Error reading reviews:", error);
        });
    }

    // استدعاء جلب التعليقات بعد تحميل تفاصيل المنتج
    fetchAndDisplayReviews();

  } catch(err) {
    console.error("Error fetching product details:", err);
    container.innerHTML = '<p class="error-message">حدث خطأ أثناء تحميل تفاصيل المنتج.</p>';
  }
}

fetchProductDetails();
</script>
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
</body>
</html>