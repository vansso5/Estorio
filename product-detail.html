<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø·Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬</title>
<link rel="stylesheet" href="customer-style.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css ">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css ">
<meta name="google-site-verification" content="lgCRZS6OSalJssBPY7QkuciuXfNh6Uf_nfvWLKNvmQg" />

</head>

<body>
    <!-- Ø´Ø±ÙŠØ· ØªÙ†ÙˆÙŠÙ‡ Ø§Ù„Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ù…ØªØ­Ø±Ùƒ -->
<div class="top-marquee">
  <div class="marquee-content">
    ğŸ”’ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© ØªÙØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ ÙˆÙ„Ù† ØªÙØ´Ø§Ø±Ùƒ Ù…Ø¹ Ø£ÙŠ Ø·Ø±Ù Ø«Ø§Ù„Ø«.
  </div>
</div>

<div id="loadingScreen" class="hidden">
  <div class="spinner"></div>
  <p>Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨...</p>
</div>

<!-- Ø§Ù„Ù„ÙˆØ¬Ùˆ -->
<div class="logo-container">
    <img id="storeLogo" src="https://via.placeholder.com/500x120?text =Ø¬Ø§Ø±ÙŠ+Ø§Ù„ØªØ­Ù…ÙŠÙ„..." alt="Logo">
</div>

<div class="container">
  <div id="productDetailContainer"><p style="text-align:center; padding:20px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬...</p></div>
</div>

<div class="image-preview-modal" id="imagePreviewModal">
  <button class="close-preview" id="closePreview">&times;</button>
  <img id="previewImage" src="" alt="">
</div>

<div id="thankYouModal" class="modal hidden">
    <div class="modal-content">
      <div class="check-icon">âœ”</div>
      <h3>ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ!</h3>
      <p id="thankYouMessage"></p>
      <div id="orderIdBox"></div>
      <div class="modal-buttons">
          <button id="copyOrderId">Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…</button>
          <button id="closeModal">Ø­Ø³Ù†Ø§Ù‹</button>
      </div>
    </div>
</div>
<!-- Ø§Ù„Ø²Ø± Ø§Ù„Ø«Ø§Ø¨Øª ÙÙŠ Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø© -->
<div id="floatingOrderBtn">
    <button id="floatingConfirmBtn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ğŸš€</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js ";
import { getDatabase, ref, get, child, push, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js ";

const firebaseConfig = {
  apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
  authDomain: "myestore-34f65.firebaseapp.com",
  databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
  projectId: "myestore-34f65",
  storageBucket: "myestore-34f65.appspot.com",
  messagingSenderId: "14078917211",
  appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
  measurementId: "G-9181DX0XNJ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const contactFooter = document.querySelector('.contact-footer .contact-container');

// Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
onValue(ref(db, 'settings/contactPhone'), (snapshot) => {
    if (snapshot.exists()) {
        const phone = snapshot.val();
        contactFooter.innerHTML = `
            <span>ğŸ“ Ø§ØªØµÙ„ Ø¨Ù†Ø§: </span>
            <a href="tel:${phone}">${phone}</a>
        `;
    }
});

// ============================================================
// ğŸŸ¢ ÙƒÙˆØ¯ ØªØªØ¨Ø¹ Ø§Ù„Ø²ÙˆØ§Ø± (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
// ============================================================
const presenceRef = ref(db, "site_presence");
const myCon = push(presenceRef);
onDisconnect(myCon).remove();
set(myCon, {
    timestamp: Date.now(),
    page: window.location.href
});
// (ØªÙ… Ù†Ù‚Ù„ Ø¬Ø²Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© onValue Ù„Ù„Ø£Ø³ÙÙ„ Ù„ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­)
// ============================================================

const container = document.getElementById('productDetailContainer');
const previewModal = document.getElementById('imagePreviewModal');
const previewImage = document.getElementById('previewImage');
const closePreview = document.getElementById('closePreview');
const storeLogoImg = document.getElementById('storeLogo');

let currentProductId = null;
let currentProductPrice = 0;
let shippingZones = []; 

const shippingRef = ref(db, 'shipping_zones');
onValue(shippingRef, (snapshot) => {
    shippingZones = [];
    if (snapshot.exists()) {
        snapshot.forEach((childSnapshot) => { shippingZones.push(childSnapshot.val()); });
    }
});

function getProductIdFromUrl() {
  return new URLSearchParams(window.location.search).get('id');
}

async function fetchProductDetails() {
  const productId = getProductIdFromUrl();
  if (!productId) { container.innerHTML = '<p class="error-text">Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.</p>'; return; }
  currentProductId = productId;

  try {
    const snapshot = await get(child(ref(db, 'products'), productId));
    if (!snapshot.exists()) { container.innerHTML = '<p class="error-text">Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.</p>'; return; }

    const product = snapshot.val();
    currentProductPrice = parseFloat(product.newPrice);
    
    if (product.customLogo && product.customLogo.trim() !== "") {
        storeLogoImg.src = product.customLogo;
    } else {
        onValue(ref(db, 'settings/logo'), (snap) => {
            if(snap.exists()) storeLogoImg.src = snap.val();
            else storeLogoImg.src = "https://via.placeholder.com/500x120?text=Welcome ";
        });
    }

    const images = Array.isArray(product.images) ? product.images : [product.images || 'default.jpg'];
    const swiperSlides = images.map(src => `<div class="swiper-slide"><img src="${src}" alt="ØµÙˆØ±Ø©"></div>`).join('');

    const wilayas = [
      "Ø£Ø¯Ø±Ø§Ø±","Ø§Ù„Ø´Ù„Ù","Ø§Ù„Ø£ØºÙˆØ§Ø·","Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ","Ø¨Ø§ØªÙ†Ø©","Ø¨Ø¬Ø§ÙŠØ©","Ø¨Ø³ÙƒØ±Ø©","Ø¨Ø´Ø§Ø±","Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©","Ø§Ù„Ø¨ÙˆÙŠØ±Ø©","ØªÙ…Ù†Ø±Ø§Ø³Øª","ØªØ¨Ø³Ø©","ØªÙ„Ù…Ø³Ø§Ù†","ØªÙŠØ§Ø±Øª","ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ","Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±","Ø§Ù„Ø¬Ù„ÙØ©","Ø¬ÙŠØ¬Ù„","Ø³Ø·ÙŠÙ","Ø³Ø¹ÙŠØ¯Ø©","Ø³ÙƒÙŠÙƒØ¯Ø©","Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³","Ø¹Ù†Ø§Ø¨Ø©","Ù‚Ø§Ù„Ù…Ø©","Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©","Ø§Ù„Ù…Ø¯ÙŠØ©","Ù…Ø³ØªØºØ§Ù†Ù…","Ø§Ù„Ù…Ø³ÙŠÙ„Ø©","Ù…Ø¹Ø³ÙƒØ±","ÙˆØ±Ù‚Ù„Ø©","ÙˆÙ‡Ø±Ø§Ù†","Ø§Ù„Ø¨ÙŠØ¶","Ø¥Ù„ÙŠØ²ÙŠ","Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬","Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³","Ø§Ù„Ø·Ø§Ø±Ù","ØªÙ†Ø¯ÙˆÙ","ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª","Ø§Ù„ÙˆØ§Ø¯ÙŠ","Ø®Ù†Ø´Ù„Ø©","Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³","ØªÙŠØ¨Ø§Ø²Ø©","Ù…ÙŠÙ„Ø©","Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰","Ø§Ù„Ù†Ø¹Ø§Ù…Ø©","Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª","ØºØ±Ø¯Ø§ÙŠØ©","ØºÙ„ÙŠØ²Ø§Ù†","ØªÙŠÙ…ÙŠÙ…ÙˆÙ†","Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±","Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„","Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³","Ø¥Ù† ØµØ§Ù„Ø­","Ø¥Ù† Ù‚Ø²Ø§Ù…","ØªÙ‚Ø±Øª","Ø¬Ø§Ù†Øª","Ø§Ù„Ù…ØºÙŠØ±","Ø§Ù„Ù…Ù†ÙŠØ¹Ø©"
    ];
    const wilayaOptions = wilayas.map(w => `<option value="${w}">${w}</option>`).join('');

    let descriptionHTML = '';
    if (Array.isArray(product.description)) {
        product.description.forEach(block => {
            if (block.type === 'text') {
                descriptionHTML += `<p>${block.val}</p>`;
            } else if (block.type === 'image') {
                descriptionHTML += `<img src="${block.val}" alt="ØªÙˆØ¶ÙŠØ­">`;
            }
        });
    } else {
        descriptionHTML = `<p>${product.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ.'}</p>`;
    }

    container.innerHTML = `
      <div class="swiper mySwiper"><div class="swiper-wrapper">${swiperSlides}</div><div class="swiper-pagination"></div></div>
      
      <div class="product-header">
        <h2>${product.name}</h2>
        <div class="price-badge">
            ${Number(product.newPrice).toLocaleString()} Ø¯Ø¬
            ${product.oldPrice ? `<small>${Number(product.oldPrice).toLocaleString()}</small>` : ''}
        </div>
        
        <!-- ğŸŸ¢ Ù…ÙƒØ§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ (ØªÙ… ÙˆØ¶Ø¹Ù‡ Ù‡Ù†Ø§) -->
        <div id="liveViewersWrapper" style="display: none; text-align: center; margin-top: 10px; color: #c0392b; font-weight: bold;">
            <span style="animation: pulse 1.5s infinite;">â—</span> 
            ÙŠØ´Ø§Ù‡Ø¯ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¢Ù†: <span id="liveViewersCount">0</span> Ø£Ø´Ø®Ø§Øµ
        </div>
        <!-- ------------------------------ -->

      </div>

      <div class="compact-card" id="orderCard">
        <div class="card-header">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† ğŸ‘‡</div>
        
        <div class="input-wrapper">
            <i class="fas fa-phone input-icon"></i>
            <input type="tel" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" dir="ltr" style="text-align:right;">
        </div>

        <div class="input-wrapper">
            <i class="fas fa-user input-icon"></i>
            <input type="text" id="fullName" placeholder="Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨">
        </div>

        <div class="row-dual">
            <div class="col-half">
                <select id="wilaya">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</option>
                    ${wilayaOptions}
                </select>
            </div>
            <div class="col-half">
                <select id="deliveryType">
                    <option value="Ø§Ù„Ù…Ù†Ø²Ù„">ğŸ  ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…Ù†Ø²Ù„</option>
                    <option value="Ù…ÙƒØªØ¨ Ø§Ù„Ø´Ø±ÙƒØ©">ğŸ¢ Ø§Ø³ØªÙ„Ø§Ù… Ù…ÙƒØªØ¨</option>
                </select>
            </div>
        </div>
        
        <div class="input-wrapper">
            <i class="fas fa-map-marker-alt input-icon"></i>
            <input type="text" id="address" placeholder="Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
        </div>

        <div class="price-summary">
            <div class="total-row">
                <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
                <span id="summaryTotalPrice" class="final-price">0 Ø¯Ø¬</span>
            </div>
            <small id="shippingText" class="ship-note">(Ø§Ù„Ø´Ø­Ù† ØºÙŠØ± Ù…Ø­Ø¯Ø¯)</small>
        </div>

        <div class="action-bar">
            <div class="qty-box">
                <button type="button" id="increaseQty">+</button>
                <span id="quantityValue">1</span>
                <button type="button" id="decreaseQty">-</button>
            </div>
            <!-- âœ… Ø§Ù„Ø²Ø± Ø§Ù„Ù…ØªØ­Ø±Ùƒ -->
            <button id="confirmOrderBtn">
                ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ğŸš€
            </button>
        </div>
      </div>

      <div class="desc-section">
        <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h3>
        <div class="desc-content">
            ${descriptionHTML}
        </div>
      </div>

      <!-- âœ… Ù‚Ø³Ù… Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± (ÙŠÙØ¹Ø±Ø¶ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª Ø³ÙŠØ§Ø³Ø§Øª) -->
      <div id="storePolicySection" class="store-policy-section" style="display:none;">
        <h3>ğŸ“œ Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±</h3>
        <div id="policyContent" class="policy-content"></div>
      </div>

      <!-- Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª (Ø´Ø­Ù† Ø³Ø±ÙŠØ¹ØŒ Ø¶Ù…Ø§Ù†ØŒ Ø¥Ù„Ø®) - ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
      ${product.icons && Array.isArray(product.icons) && product.icons.length > 0 ? `
      <div class="product-icons-section">
        <div class="product-icons-grid">
          ${product.icons.map(ic => `
            <div class="icon-item">
              <img src="${ic.icon || ''}" alt="Ø£ÙŠÙ‚ÙˆÙ†Ø©">
              <span>${ic.text || ''}</span>
            </div>
          `).join('')}
        </div>
      </div>
      ` : ''}

      <div class="reviews-section">
         <h3>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h3>
         <!-- âœ… Ø®Ø§Ù†Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ (Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ ÙˆØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ù„Ø¨) -->
         <div id="postOrderReview">
            <h4 style="text-align:center; color:#27ae60; margin:0 0 10px;">ğŸ‰ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø·Ù„Ø¨Ùƒ! Ù…Ø§ Ù‡Ùˆ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù„Ù„Ù…Ù†ØªØ¬ØŸ</h4>
            
            <div class="stars-box" id="reviewStars">
                <i class="fas fa-star" data-rating="1"></i>
                <i class="fas fa-star" data-rating="2"></i>
                <i class="fas fa-star" data-rating="3"></i>
                <i class="fas fa-star" data-rating="4"></i>
                <i class="fas fa-star" data-rating="5"></i>
            </div>
            
            <div class="review-input-group">
                <input type="text" id="reviewName" placeholder="Ø§Ø³Ù…Ùƒ (Ø³ÙŠØ¸Ù‡Ø± Ù…Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚)">
            </div>
            <div class="review-input-group">
                <textarea id="reviewText" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒ Ø¨ØµØ±Ø§Ø­Ø©..."></textarea>
            </div>
            <button id="submitReviewBtn" style="width:100%; padding:10px; background:#27ae60; color:white; border:none; border-radius:50px; cursor:pointer;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
         </div>

         <div id="commentsList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
    `;

    new Swiper(".mySwiper", { pagination: { el: ".swiper-pagination", clickable: true } });
    
    document.querySelectorAll('.swiper-slide img').forEach(img => {
      img.addEventListener('click', () => { previewImage.src = img.src; previewModal.classList.add('active'); });
    });
    document.querySelectorAll('.desc-content img').forEach(img => {
      img.addEventListener('click', () => { previewImage.src = img.src; previewModal.classList.add('active'); });
    });

    closePreview.addEventListener('click', () => previewModal.classList.remove('active'));
    previewModal.addEventListener('click', e => { if(e.target === previewModal) previewModal.classList.remove('active'); });

    // ================== âœ… Ø¬Ù„Ø¨ Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± Ù…Ù† Firebase ==================
    const policySection = document.getElementById('storePolicySection');
    const policyContent = document.getElementById('policyContent');

    onValue(ref(db, 'policies'), (snapshot) => {
      if (snapshot.exists()) {
        const policies = snapshot.val();
        let policyHTML = '';
        for (const id in policies) {
          const p = policies[id];
          if (p.title && p.content) {
            policyHTML += `
  <div class="policy-item">
    <h4 class="policy-title">${p.title}</h4>
    <p class="policy-body" style="display:none;">${p.content}</p>
  </div>
`;policyContent.innerHTML
          }
        }
        if (policyHTML) {
          policyContent.innerHTML = policyHTML;
          
          policySection.style.display = 'block';
          const titles = policyContent.querySelectorAll('.policy-title');
titles.forEach(title => {
    title.addEventListener('click', () => {
        const body = title.nextElementSibling;
        if (body.style.display === "none") {
            body.style.display = "block";
        } else {
            body.style.display = "none";
        }
    });
});
        } else {
          policySection.style.display = 'none';
        }
      } else {
        policySection.style.display = 'none';
      }
    });
    // ===================================================================

    const confirmBtn = document.getElementById("confirmOrderBtn");
    const qtyVal = document.getElementById("quantityValue");
    const wilayaSel = document.getElementById("wilaya");
    const delSel = document.getElementById("deliveryType");
    let qty = 1;
    let shipPrice = 0;

    function updatePrice() {
        const pPrice = currentProductPrice * qty;
        
        const zone = shippingZones.find(z => z.wilayas && z.wilayas.includes(wilayaSel.value));
        if (zone) {
            shipPrice = (delSel.value === "Ø§Ù„Ù…Ù†Ø²Ù„") ? (zone.homePrice || 0) : (zone.deskPrice || 0);
            document.getElementById("shippingText").textContent = `(+${shipPrice} Ø¯Ø¬ ØªÙˆØµÙŠÙ„)`;
            document.getElementById("shippingText").style.color = "#27ae60";
        } else {
            shipPrice = 0;
            document.getElementById("shippingText").textContent = wilayaSel.value ? "(ØªÙˆØµÙŠÙ„ ØºÙŠØ± Ù…Ø­Ø¯Ø¯)" : "(Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆØµÙŠÙ„)";
            document.getElementById("shippingText").style.color = "#7f8c8d";
        }
        
        document.getElementById("summaryTotalPrice").textContent = (pPrice + shipPrice).toLocaleString() + " Ø¯Ø¬";
    }

    document.getElementById("decreaseQty").addEventListener("click", () => { if(qty>1) { qty--; qtyVal.textContent = qty; updatePrice(); }});
    document.getElementById("increaseQty").addEventListener("click", () => { qty++; qtyVal.textContent = qty; updatePrice(); });
    wilayaSel.addEventListener("change", updatePrice);
    delSel.addEventListener("change", updatePrice);
    updatePrice();

    confirmBtn.addEventListener("click", async () => {
        const load = document.getElementById("loadingScreen");
        const ph = document.getElementById("phone").value.trim();
        const nm = document.getElementById("fullName").value.trim();
        const wl = document.getElementById("wilaya").value;
        const ad = document.getElementById("address").value.trim();

        if(!ph || !nm || !wl || !ad) { alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©!"); return; }
        
        load.classList.remove("hidden");
        try {
            const refOrd = push(ref(db, "orders"));
            await set(refOrd, {
                id: refOrd.key,
                productId: productId,
                productName: product.name,
                productPrice: currentProductPrice,
                quantity: qty,
                shippingPrice: shipPrice,
                totalPrice: (currentProductPrice * qty) + shipPrice,
                customerName: nm,
                customerPhone: ph,
                customerWilaya: wl,
                customerAddress: ad,
                deliveryOption: delSel.value,
                timestamp: Date.now(),
                status: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"
            });
            load.classList.add("hidden");
            document.getElementById("thankYouModal").classList.remove("hidden");
            document.getElementById("orderIdBox").textContent = refOrd.key;
            document.getElementById("thankYouMessage").innerHTML = `Ø´ÙƒØ±Ø§Ù‹ <b>${nm}</b>ØŒ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­.`;
            
            // âœ… Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø·Ù„Ø¨ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø¸Ù‡Ø§Ø± Ø®Ø§Ù†Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙ†Ù…Ù„Ø£ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†
            document.getElementById("postOrderReview").style.display = "block";
            document.getElementById("reviewName").value = nm; 
            document.getElementById("postOrderReview").scrollIntoView({behavior: "smooth"});

            document.getElementById("closeModal").onclick = () => {
                document.getElementById("thankYouModal").classList.add("hidden");
            };
            document.getElementById("copyOrderId").onclick = () => { navigator.clipboard.writeText(refOrd.key); alert("ØªÙ… Ø§Ù„Ù†Ø³Ø®"); };
        } catch(e) {
            console.error(e); alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); load.classList.add("hidden");
        }
    });
    
    
    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ---
    let selectedRating = 0;
    const stars = document.querySelectorAll('#reviewStars i');
    stars.forEach(star => {
        star.addEventListener('click', () => {
            selectedRating = parseInt(star.dataset.rating);
            stars.forEach(s => {
                if(parseInt(s.dataset.rating) <= selectedRating) s.classList.add('active');
                else s.classList.remove('active');
            });
        });
    });

    document.getElementById('submitReviewBtn').addEventListener('click', async () => {
        const rName = document.getElementById('reviewName').value.trim() || "Ø²Ø¨ÙˆÙ†";
        const rText = document.getElementById('reviewText').value.trim();
        
        if(selectedRating === 0) { alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¬ÙˆÙ… â­"); return; }
        if(!rText) { alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ‚"); return; }

        try {
            await push(child(ref(db), `reviews/${productId}`), {
                reviewerName: rName,
                rating: selectedRating,
                comment: rText,
                timestamp: Date.now()
            });
            alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚ÙŠÙŠÙ…ÙƒØŒ Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ! â¤ï¸");
            document.getElementById("postOrderReview").style.display = "none";
        } catch(e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        }
    });

    onValue(ref(db, `reviews/${productId}`), (snap) => {
        const list = document.getElementById('commentsList');
        if(snap.exists()) {
            list.innerHTML = '';
            snap.forEach(c => {
                 const r = c.val();
                 list.innerHTML += `
                 <div class="review-item" style="border-bottom:1px solid #eee; padding:10px 0;">
                    <b>${r.reviewerName}</b> 
                    <span style="color:#f1c40f">${'â˜…'.repeat(r.rating)}</span>
                    <br><span style="color:#555;">${r.comment}</span>
                 </div>`;
            });
        } else { list.innerHTML = '<p style="text-align:center;color:#999">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯.</p>'; }
    });
    
// ================== ÙƒÙˆØ¯ Ø§Ù„Ø²Ø± Ø§Ù„Ø«Ø§Ø¨Øª ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ ==================
    const orderCard = document.getElementById('orderCard');
    const floatingBtn = document.getElementById('floatingOrderBtn');

    function checkScroll() {
        if (!orderCard) return;
        const rect = orderCard.getBoundingClientRect();
        if (rect.bottom < 100) { // Ø¹Ù†Ø¯Ù…Ø§ ØªØ®ØªÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
            floatingBtn.classList.add('visible');
        } else {
            floatingBtn.classList.remove('visible');
        }
    }

    // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ø«Ø§Ø¨Øª â†’ ÙŠØµØ¹Ø¯ Ø¥Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨
    document.getElementById('floatingConfirmBtn').addEventListener('click', () => {
        orderCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });

    // ØªÙØ¹ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
    window.addEventListener('scroll', checkScroll);
    window.addEventListener('resize', checkScroll);

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ù…Ù‡Ù…!)
    const waitForCard = setInterval(() => {
        if (document.getElementById('orderCard')) {
            checkScroll();
            clearInterval(waitForCard);
        }
    }, 300);

    setTimeout(checkScroll, 1500); // Ø§Ø­ØªÙŠØ§Ø·ÙŠ

    // ============================================================
    // ğŸŸ¢ ÙƒÙˆØ¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯ (ØªÙ… ÙˆØ¶Ø¹Ù‡ Ù‡Ù†Ø§ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ù„ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­)
    // ============================================================
    onValue(presenceRef, (snapshot) => {
        // 1. Ø§Ø³ØªØ®Ø¯Ø§Ù… let Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† const Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…
        let count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
        
        // Ø§Ù„Ø´Ø±Ø·: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ø¯Ø¯ Ø£Ù‚Ù„ Ù…Ù† 1 (ØµÙØ±)ØŒ Ø§Ø¬Ø¹Ù„Ù‡ 1 ÙÙˆØ±Ø§Ù‹
        if (count < 1) {
            count = 1;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø©
        const wrapper = document.getElementById("liveViewersWrapper");
        const countSpan = document.getElementById("liveViewersCount");
        
        if (wrapper && countSpan) {
            countSpan.innerText = count;
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… inline-flex Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Ù‚Ø·Ø© ÙˆØ§Ù„Ù†Øµ
            wrapper.style.display = "inline-flex";
        }
    });
    // ============================================================

  } catch(err) { container.innerHTML = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.'; console.log(err); }
}

fetchProductDetails();
</script>
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js "></script>

</body>
<!-- Ù‚Ø³Ù… Ø§Ù„ØªÙˆØ§ØµÙ„ Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø© -->
<div class="contact-footer">
    <div class="contact-container"></div>
</div>
</html>