<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ุงูุชูุงุฑูุฑ ูุงูุชุญูููุงุช</title>
  <link rel="stylesheet" href="admin-style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <nav>
    <div class="logo">ููุญุฉ ุงูุชุญูู</div>
    <div class="links">
      <a href="admin-products.html">ุงูููุชุฌุงุช</a>
      <a href="admin-orders.html">ุงูุทูุจูุงุช ุงููุดุทุฉ</a>
      <a href="completed-orders.html">ุงูุทูุจูุงุช ุงูููุชููุฉ</a>
      <a href="admin-analytics.html">ุงูุชุญูููุงุช</a>
      <a href="admin-settings.html">ุงูุฅุนุฏุงุฏุงุช</a>
      <a href="admin-reviews.html" class="active">ุงูุชุนูููุงุช ูุงูุชููููุงุช</a>
      <a href="#" id="logoutBtn" style="display: none;">ุชุณุฌูู ุงูุฎุฑูุฌ</a>
    </div>
  </nav>

  <div class="container">
    <h2>๐ ุงูุชูุงุฑูุฑ ูุงูุชุญูููุงุช</h2>
    
    <!-- ุงูุจุทุงูุงุช ุงูุฅุญุตุงุฆูุฉ -->
    <div class="analytics-grid">
      <div class="stat-card">
        <h3>ุฅุฌูุงูู ุงููุจูุนุงุช</h3>
        <div class="value" id="totalSales">0 ุฏุฌ</div>
        <div class="change positive" id="salesChange">+0%</div>
      </div>
      
      <div class="stat-card">
        <h3>ุฅุฌูุงูู ุงูุฃุฑุจุงุญ</h3>
        <div class="value" id="totalProfit">0 ุฏุฌ</div>
        <div class="change positive" id="profitChange">+0%</div>
      </div>
      
      <div class="stat-card">
        <h3>ุนุฏุฏ ุงูุทูุจุงุช</h3>
        <div class="value" id="totalOrders">0</div>
        <div class="change positive" id="ordersChange">+0%</div>
      </div>
      
      <div class="stat-card">
        <h3>ูุชูุณุท ูููุฉ ุงูุทูุจ</h3>
        <div class="value" id="avgOrderValue">0 ุฏุฌ</div>
        <div class="change positive" id="avgOrderChange">+0%</div>
      </div>
      
      <div class="stat-card">
        <h3>ุฃุนูู ููุชุฌ ูุจูุนุงู</h3>
        <div class="value" id="topProduct">-</div>
        <div class="change" id="topProductSales">0 ูุจูุน</div>
      </div>
      
      <div class="stat-card">
        <h3>ูุนุฏู ุงูุฅููุงู</h3>
        <div class="value" id="completionRate">0%</div>
        <div class="change positive" id="completionChange">+0%</div>
      </div>
    </div>

    <!-- ูุฎุทุท ุงููุจูุนุงุช -->
    <div class="chart-container">
      <h3>๐ ุชุทูุฑ ุงููุจูุนุงุช</h3>
      <div class="time-filters">
        <button class="time-btn active" onclick="changeTimeRange('day')">ุงูููู</button>
        <button class="time-btn" onclick="changeTimeRange('week')">ุงูุฃุณุจูุน</button>
        <button class="time-btn" onclick="changeTimeRange('month')">ุงูุดูุฑ</button>
        <button class="time-btn" onclick="changeTimeRange('year')">ุงูุณูุฉ</button>
      </div>
      <canvas id="salesChart"></canvas>
    </div>

    <div class="charts-row">
      <!-- ุฃูุถู ุงูููุชุฌุงุช -->
      <div class="top-products">
        <h3>๐ ุฃูุถู 5 ููุชุฌุงุช ูุจูุนุงู</h3>
        <div id="topProductsList">
          <p class="loading-message">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</p>
        </div>
      </div>

      <!-- ุงูุทูุจุงุช ุงูุฃุฎูุฑุฉ -->
      <div class="recent-orders">
        <h3>๐ ุขุฎุฑ ุงูุทูุจุงุช</h3>
        <div id="recentOrdersList">
          <p class="loading-message">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</p>
        </div>
      </div>
    </div>

    <!-- ูุฎุทุท ุชูุณูู ุงููุจูุนุงุช -->
    <div class="chart-container">
      <h3>๐ฅง ุชูุณูู ุงููุจูุนุงุช ุญุณุจ ุงูููุชุฌุงุช</h3>
      <canvas id="productsChart"></canvas>
      <!-- ููุง ุณูุถูู legend ุงููุฎุตุต -->
      <div id="productsChartLegend" class="chart-legend"></div>
    </div>

  </div>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
  authDomain: "myestore-34f65.firebaseapp.com",
  databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
  projectId: "myestore-34f65",
  storageBucket: "myestore-34f65.firebasestorage.app",
  messagingSenderId: "14078917211",
  appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
  measurementId: "G-9181DX0XNJ"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const auth = getAuth(app);
const ordersRef = ref(database, 'orders');
const productsRef = ref(database, 'products');

let salesChart, productsChart;
let currentTimeRange = 'month';
let allOrders = {};
let allProducts = {};

// --- Debugging: Check if Chart.js and ChartDataLabels are loaded ---
console.log("Chart.js loaded:", typeof Chart !== 'undefined');
console.log("ChartDataLabels loaded:", typeof ChartDataLabels !== 'undefined');
// --- End Debugging ---


onAuthStateChanged(auth, (user) => {
  console.log("Auth state changed. User:", user ? user.uid : "No user");
  if (user) {
    document.getElementById('logoutBtn').style.display = 'block';
    loadAnalyticsData();
  } else {
    document.getElementById('logoutBtn').style.display = 'none';
    alert("ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูููุตูู ุฅูู ููุญุฉ ุงูุชุญูู");
    window.location.href = 'admin-login.html';
  }
});

document.getElementById('logoutBtn').addEventListener('click', async () => {
  try {
    await signOut(auth);
    window.location.href = 'admin-login.html';
  } catch (error) {
    console.error("ุฎุทุฃ ูู ุชุณุฌูู ุงูุฎุฑูุฌ:", error);
  }
});

function loadAnalyticsData() {
  console.log("Loading analytics data...");
  onValue(ordersRef, (snapshot) => {
    allOrders = snapshot.val() || {};
    console.log("Orders data received:", Object.keys(allOrders).length, "orders.");
    calculateAnalytics();
  });

  onValue(productsRef, (snapshot) => {
    allProducts = snapshot.val() || {};
    console.log("Products data received:", Object.keys(allProducts).length, "products.");
    // calculateAnalytics will be called by onValue(ordersRef) for now,
    // as we need both to be present for full analytics.
  });
}

function calculateAnalytics() {
  console.log("Calculating analytics...");
  if (Object.keys(allOrders).length === 0) {
    console.warn("No orders found, skipping analytics calculation.");
    return;
  }

  const completedOrders = Object.values(allOrders).filter(order => order.status === 'ุชู ุงูุชูุตูู' || order.status === 'Delivered');
  console.log("Completed orders count:", completedOrders.length);
  
  const totalSales = completedOrders.reduce((sum, order) => sum + parseFloat(order.totalPrice), 0);
  const totalOrdersCount = completedOrders.length;
  const avgOrderValue = totalOrdersCount > 0 ? totalSales / totalOrdersCount : 0;
  const totalProfit = totalSales * 0.3;

  document.getElementById('totalSales').textContent = totalSales.toFixed(2) + ' ุฏุฌ';
  document.getElementById('totalProfit').textContent = totalProfit.toFixed(2) + ' ุฏุฌ';
  document.getElementById('totalOrders').textContent = totalOrdersCount;
  document.getElementById('avgOrderValue').textContent = avgOrderValue.toFixed(2) + ' ุฏุฌ';
  document.getElementById('completionRate').textContent = '100%';

  calculateTopProducts(completedOrders);
  showRecentOrders(completedOrders);
  updateCharts(completedOrders); // ูุฐุง ูู ุงูููุงู ุงูุฐู ูุฌุจ ุฃู ูุชู ููู ุงุณุชุฏุนุงุก ุชุญุฏูุซ ุงููุฎุทุทุงุช
  console.log("Analytics calculation finished.");
}

function calculateTopProducts(orders) {
  const productSales = {};
  orders.forEach(order => {
    const productName = order.productName;
    if (productSales[productName]) {
      productSales[productName] += parseInt(order.quantity);
    } else {
      productSales[productName] = parseInt(order.quantity);
    }
  });

  const topProducts = Object.entries(productSales)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);

  const topProductsList = document.getElementById('topProductsList');
  topProductsList.innerHTML = '';

  if (topProducts.length > 0) {
    const maxSales = Math.max(...topProducts.map(p => p[1]));
    
    topProducts.forEach(([productName, sales]) => {
      const percentage = (sales / maxSales) * 100;
      const productItem = document.createElement('div');
      productItem.className = 'product-item';
      productItem.innerHTML = `
        <div class="product-info">
          <strong>${productName}</strong>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${percentage}%"></div>
          </div>
        </div>
        <div class="product-stats">${sales} ูุจูุน</div>
      `;
      topProductsList.appendChild(productItem);
    });

    document.getElementById('topProduct').textContent = topProducts[0][0];
    document.getElementById('topProductSales').textContent = topProducts[0][1] + ' ูุจูุน';
  }
}

function showRecentOrders(orders) {
  const recentOrders = orders
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
    .slice(0, 5);

  const recentOrdersList = document.getElementById('recentOrdersList');
  recentOrdersList.innerHTML = '';

  recentOrders.forEach(order => {
    const orderItem = document.createElement('div');
    orderItem.className = 'order-item';
    orderItem.innerHTML = `
      <div class="order-info">
        <strong>${order.customerName}</strong>
        <div>${order.productName}</div>
      </div>
      <div class="order-status">
        <div>${parseFloat(order.totalPrice).toFixed(2)} ุฏุฌ</div>
        <div class="status-delivered">ุชู ุงูุชูุตูู</div>
      </div>
    `;
    recentOrdersList.appendChild(orderItem);
  });
}

function updateCharts(orders) {
  console.log("Updating all charts...");
  updateSalesChart(orders);
  updateProductsChart(orders); // ุงุณุชุฏุนุงุก ูุฎุทุท ุงูุฏููุงุช
}

function updateSalesChart(orders) {
  const ctx = document.getElementById('salesChart').getContext('2d');
  
  if (salesChart) {
    salesChart.destroy();
  }

  const labels = generateTimeLabels();
  const data = generateSalesData(orders, labels);

  salesChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'ุงููุจูุนุงุช',
        data: data,
        borderColor: '#667eea',
        backgroundColor: 'rgba(102, 126, 234, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          rtl: true,
          labels: {
            font: {
              family: 'Arial, sans-serif'
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value + ' ุฏุฌ';
            }
          }
        }
      }
    }
  });
}

function updateProductsChart(orders) {
  console.log("Attempting to update products chart...");
  const canvasElement = document.getElementById('productsChart');
  if (!canvasElement) {
    console.error("Canvas element with ID 'productsChart' not found.");
    return;
  }
  
  const ctx = canvasElement.getContext('2d');
  if (!ctx) {
    console.error("Could not get 2D context for canvas 'productsChart'.");
    return;
  }
  console.log("Canvas context obtained successfully.");
  
  if (typeof ChartDataLabels === 'undefined') {
    console.error("ChartDataLabels plugin is still undefined inside updateProductsChart. Make sure the script is loaded correctly.");
    return;
  }
  
  Chart.register(ChartDataLabels);
  console.log("ChartDataLabels registered.");
  
  if (productsChart) {
    console.log("Destroying existing products chart.");
    productsChart.destroy();
  } else {
    console.log("No existing products chart to destroy.");
  }
  
  // Build productSales robustly: trim names, skip missing names, handle NaN prices
  const productSales = {};
  orders.forEach(order => {
    const rawName = order.productName;
    const name = rawName ? String(rawName).trim() : null;
    const price = parseFloat(order.totalPrice);
    const value = Number.isFinite(price) ? price : 0;
    
    if (!name || value <= 0) {
      // Ignoring entries with no product name or zero/invalid price
      return;
    }
    
    if (!productSales[name]) productSales[name] = 0;
    productSales[name] += value;
  });
  
  console.log("Raw product sales after sanitization:", productSales);
  
  const sortedProducts = Object.entries(productSales)
    .sort((a, b) => b[1] - a[1]);
  
  const totalSales = sortedProducts.reduce((sum, [, v]) => sum + v, 0);
  console.log("Total sales for doughnut chart:", totalSales.toFixed(2));
  
  const legendContainer = document.getElementById('productsChartLegend');
  legendContainer.innerHTML = ''; // Clear previous legend items
  
  if (totalSales === 0 || sortedProducts.length === 0) {
    console.log("No sales data or products for doughnut chart. Displaying message.");
    ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    ctx.font = '18px Arial, sans-serif';
    ctx.fillStyle = '#555';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('ูุง ุชูุฌุฏ ุจูุงูุงุช ูุจูุนุงุช ูุนุฑุถูุง ุญุงูููุง.', canvasElement.width / 2, canvasElement.height / 2);
    productsChart = null;
    return;
  }
  
  // Exclude strictly-zero items (should be none after sanitization)
  const productsToDisplay = sortedProducts.filter(([_, sales]) => sales > 0);
  
  if (productsToDisplay.length === 0) {
    console.log("Products list is empty after filtering non-positive sales.");
    ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    ctx.font = '18px Arial, sans-serif';
    ctx.fillStyle = '#555';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ูุนุฑุถูุง ูู ุงููุฎุทุท.', canvasElement.width / 2, canvasElement.height / 2);
    productsChart = null;
    return;
  }
  
  console.log("Products to be displayed in chart:", productsToDisplay);
  
  const colors = [
    '#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b',
    '#ff9a9e', '#fbd540', '#fa709a', '#a6c1ee', '#fbc2eb',
    '#5C7AFF', '#8E44AD', '#3498DB', '#2ECC71', '#F1C40F',
    '#e74c3c', '#9b59b6', '#34495e', '#f39c12', '#c0392b',
    '#9B59B6', '#1ABC9C', '#C0392B', '#2980B9', '#8E44AD',
    '#2C3E50', '#D35400', '#F39C12', '#E74C3C', '#7F8C8D',
    '#A569BD', '#16A085', '#D68910', '#3498DB', '#95A5A6',
    '#EB984E', '#BA4A00', '#27AE60', '#ECF0F1', '#D4AC0D'
  ];
  
  productsChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: productsToDisplay.map(p => p[0]),
      datasets: [{
        data: productsToDisplay.map(p => p[1]),
        backgroundColor: colors.slice(0, productsToDisplay.length),
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%',
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.parsed;
              const percentage = ((value / totalSales) * 100);
              const percDisplay = (percentage > 0 && percentage < 0.1) ? '<0.1' : percentage.toFixed(1);
              return `${context.label}: ${value.toFixed(2)} ุฏุฌ (${percDisplay}%)`;
            }
          }
        },
        datalabels: {
          color: '#fff',
          font: { weight: 'bold', size: 11 },
          formatter: (value, context) => {
            const percentage = (value / totalSales) * 100;
            // show small percentages as '<0.1%' instead of hiding them or showing 0%
            if (percentage > 0 && percentage < 0.5) {
              // small slices: show very small label to avoid overlap; you can adjust threshold
              return '<0.5%';
            }
            return `${percentage.toFixed(1)}%`;
          },
          anchor: 'center',
          align: 'center',
        }
      }
    },
    plugins: [ChartDataLabels]
  });
  
  console.log("Products chart created successfully.");
  
  // Custom legend (with safe small-percentage display)
  productsToDisplay.forEach(([productName, sales], index) => {
    const percentage = (sales / totalSales) * 100;
    const percentageText = (percentage > 0 && percentage < 0.1) ? '<0.1%' : percentage.toFixed(1) + '%';
    const legendItem = document.createElement('div');
    legendItem.className = 'legend-item';
    legendItem.innerHTML = `
      <span class="color-box" style="background-color: ${colors[index]}"></span>
      <span class="product-name">${productName}</span>
      <span class="percentage">${percentageText}</span>
    `;
    legendContainer.appendChild(legendItem);
  });
}

function generateTimeLabels() {
  switch(currentTimeRange) {
    case 'day':
      return ['8 ุต', '10 ุต', '12 ุธ', '2 ู', '4 ู', '6 ู', '8 ู'];
    case 'week':
      return ['ุงูุณุจุช', 'ุงูุฃุญุฏ', 'ุงูุฅุซููู', 'ุงูุซูุงุซุงุก', 'ุงูุฃุฑุจุนุงุก', 'ุงูุฎููุณ', 'ุงูุฌูุนุฉ'];
    case 'month':
      return ['ุงูุฃุณุจูุน 1', 'ุงูุฃุณุจูุน 2', 'ุงูุฃุณุจูุน 3', 'ุงูุฃุณุจูุน 4'];
    case 'year':
      return ['ููุงูุฑ', 'ูุจุฑุงูุฑ', 'ูุงุฑุณ', 'ุฃุจุฑูู', 'ูุงูู', 'ููููู', 'ููููู', 'ุฃุบุณุทุณ', 'ุณุจุชูุจุฑ', 'ุฃูุชูุจุฑ', 'ููููุจุฑ', 'ุฏูุณูุจุฑ'];
    default:
      return [];
  }
}

function generateSalesData(orders, labels) {
  const data = new Array(labels.length).fill(0);
  
  orders.forEach(order => {
    const orderDate = new Date(order.timestamp);
    let index = -1;

    switch(currentTimeRange) {
      case 'day':
        index = Math.floor(orderDate.getHours() / 3);
        break;
      case 'week':
        index = orderDate.getDay();
        break;
      case 'month':
        index = Math.floor((orderDate.getDate() - 1) / 7);
        break;
      case 'year':
        index = orderDate.getMonth();
        break;
    }

    if (index >= 0 && index < data.length) {
      data[index] += parseFloat(order.totalPrice);
    }
  });

  return data;
}

function changeTimeRange(range) {
  currentTimeRange = range;
  
  document.querySelectorAll('.time-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  const clickedButton = Array.from(document.querySelectorAll('.time-btn')).find(btn => 
    btn.textContent.includes(
      range === 'day' ? 'ุงูููู' : 
      range === 'week' ? 'ุงูุฃุณุจูุน' : 
      range === 'month' ? 'ุงูุดูุฑ' : 
      'ุงูุณูุฉ'
    )
  );
  if (clickedButton) {
      clickedButton.classList.add('active');
  }

  if (Object.keys(allOrders).length > 0) {
    const completedOrders = Object.values(allOrders).filter(order => order.status === 'ุชู ุงูุชูุตูู' || order.status === 'Delivered');
    updateCharts(completedOrders);
  }
}

// Ensure the global function is defined for HTML onclicks
window.changeTimeRange = changeTimeRange;

  </script>
</body>
</html>