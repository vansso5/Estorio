<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</title>
  <link rel="stylesheet" href="admin-style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      font-family: 'Cairo', sans-serif;
      background-color: #f5f6fa;
      color: #333;
    }

    nav {
      background-color: #667eea;
      color: #fff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    nav .links a {
      margin-left: 15px;
      color: #fff;
      text-decoration: none;
    }

    nav .links a.active {
      font-weight: bold;
      text-decoration: underline;
    }

    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }

    h2, h3 {
      margin: 15px 0;
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .stat-card .value {
      font-size: 1.3em;
      margin: 10px 0;
    }

    .stat-card .change {
      font-size: 0.9em;
    }

    .chart-container {
      margin-bottom: 30px;
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .charts-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
    }

    .top-products, .recent-orders {
      flex: 1;
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    #productsChartLegend {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-top: 15px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.95em;
    }

    .color-box {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .percentage {
      margin-left: 5px;
      font-weight: bold;
    }

    /* Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù€ canvas Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */
    #productsChart {
      max-height: 300px;
    }

    .product-item, .order-item {
      margin-bottom: 10px;
    }

    .progress-bar {
      background: #eee;
      border-radius: 5px;
      height: 10px;
      overflow: hidden;
      margin-top: 5px;
    }

    .progress-fill {
      height: 100%;
      background: #667eea;
    }
  </style>
</head>
<body>
  <nav>
    <div class="logo">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
    <div class="links">
      <a href="admin-products.html">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
      <a href="admin-orders.html">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</a>
      <a href="completed-orders.html">Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</a>
      <a href="admin-analytics.html" class="active">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</a>
      <a href="admin-settings.html">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
      <a href="admin-reviews.html">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</a>
      <a href="#" id="logoutBtn" style="display: none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
    </div>
  </nav>

  <div class="container">
    <h2>ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</h2>
    
    <div class="analytics-grid">
      <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø¥Ø­ØµØ§Ø¦ÙŠØ© -->
      <div class="stat-card">
        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
        <div class="value" id="totalSales">0 Ø¯Ø¬</div>
        <div class="change positive" id="salesChange">+0%</div>
      </div>
      <div class="stat-card">
        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h3>
        <div class="value" id="totalProfit">0 Ø¯Ø¬</div>
        <div class="change positive" id="profitChange">+0%</div>
      </div>
      <div class="stat-card">
        <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
        <div class="value" id="totalOrders">0</div>
        <div class="change positive" id="ordersChange">+0%</div>
      </div>
      <div class="stat-card">
        <h3>Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨</h3>
        <div class="value" id="avgOrderValue">0 Ø¯Ø¬</div>
        <div class="change positive" id="avgOrderChange">+0%</div>
      </div>
      <div class="stat-card">
        <h3>Ø£Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬ Ù…Ø¨ÙŠØ¹Ø§Ù‹</h3>
        <div class="value" id="topProduct">-</div>
        <div class="change" id="topProductSales">0 Ù…Ø¨ÙŠØ¹</div>
      </div>
      <div class="stat-card">
        <h3>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„</h3>
        <div class="value" id="completionRate">0%</div>
        <div class="change positive" id="completionChange">+0%</div>
      </div>
    </div>

    <!-- Ù…Ø®Ø·Ø· Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
    <div class="chart-container">
      <h3>ğŸ“ˆ ØªØ·ÙˆØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
      <div class="time-filters">
        <button class="time-btn active" onclick="changeTimeRange('day')">Ø§Ù„ÙŠÙˆÙ…</button>
        <button class="time-btn" onclick="changeTimeRange('week')">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
        <button class="time-btn" onclick="changeTimeRange('month')">Ø§Ù„Ø´Ù‡Ø±</button>
        <button class="time-btn" onclick="changeTimeRange('year')">Ø§Ù„Ø³Ù†Ø©</button>
      </div>
      <canvas id="salesChart"></canvas>
    </div>

    <div class="charts-row">
      <div class="top-products">
        <h3>ğŸ† Ø£ÙØ¶Ù„ 5 Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹</h3>
        <div id="topProductsList">
          <p class="loading-message">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>
      </div>
      <div class="recent-orders">
        <h3>ğŸ•’ Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
        <div id="recentOrdersList">
          <p class="loading-message">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>
      </div>
    </div>

    <div class="chart-container">
      <h3>ğŸ¥§ ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
      <canvas id="productsChart"></canvas>
      <div id="productsChartLegend" class="chart-legend"></div>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBUeCV2eX3LgA1X3WcEMcsTIubXN1YlVl4",
    authDomain: "myestore-34f65.firebaseapp.com",
    databaseURL: "https://myestore-34f65-default-rtdb.firebaseio.com",
    projectId: "myestore-34f65",
    storageBucket: "myestore-34f65.firebasestorage.app",
    messagingSenderId: "14078917211",
    appId: "1:14078917211:web:a48eab2a7396c094f7dd7e",
    measurementId: "G-9181DX0XNJ"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const auth = getAuth(app);
  const ordersRef = ref(database, 'orders');
  const productsRef = ref(database, 'products');

  let salesChart, productsChart;
  let currentTimeRange = 'month';
  let allOrders = {};
  let allProducts = {};

  onAuthStateChanged(auth, (user) => {
    if (user) {
      document.getElementById('logoutBtn').style.display = 'block';
      loadAnalyticsData();
    } else {
      document.getElementById('logoutBtn').style.display = 'none';
      alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…");
      window.location.href = 'admin-login.html';
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await signOut(auth);
    window.location.href = 'admin-login.html';
  });

  function loadAnalyticsData() {
    onValue(ordersRef, (snapshot) => {
      allOrders = snapshot.val() || {};
      calculateAnalytics();
    });
    onValue(productsRef, (snapshot) => {
      allProducts = snapshot.val() || {};
    });
  }

  function calculateAnalytics() {
    const completedOrders = Object.values(allOrders).filter(order =>
      (order.status === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„' || order.status === 'Delivered') &&
      !order.isDeliveredToOwner
    );

    const totalSales = completedOrders.reduce((sum, order) => sum + parseFloat(order.totalPrice), 0);
    const totalOrdersCount = completedOrders.length;
    const avgOrderValue = totalOrdersCount > 0 ? totalSales / totalOrdersCount : 0;
    const totalProfit = totalSales * 0.3;

    document.getElementById('totalSales').textContent = totalSales.toFixed(2) + ' Ø¯Ø¬';
    document.getElementById('totalProfit').textContent = totalProfit.toFixed(2) + ' Ø¯Ø¬';
    document.getElementById('totalOrders').textContent = totalOrdersCount;
    document.getElementById('avgOrderValue').textContent = avgOrderValue.toFixed(2) + ' Ø¯Ø¬';
    document.getElementById('completionRate').textContent = totalOrdersCount > 0 ? '100%' : '0%';

    calculateTopProducts(completedOrders);
    showRecentOrders(completedOrders);
    updateCharts(completedOrders);
  }

  function calculateTopProducts(orders) {
    const productSales = {};
    orders.forEach(order => {
      if (!order.productName) return;
      if (!productSales[order.productName]) productSales[order.productName] = 0;
      productSales[order.productName] += parseInt(order.quantity);
    });

    const topProducts = Object.entries(productSales).sort((a,b)=>b[1]-a[1]).slice(0,5);
    const topProductsList = document.getElementById('topProductsList');
    topProductsList.innerHTML = '';

    if (topProducts.length > 0) {
      const maxSales = Math.max(...topProducts.map(p => p[1]));
      topProducts.forEach(([name, sales]) => {
        const percentage = (sales / maxSales) * 100;
        const productItem = document.createElement('div');
        productItem.className = 'product-item';
        productItem.innerHTML = `
          <div class="product-info">
            <strong>${name}</strong>
            <div class="progress-bar">
              <div class="progress-fill" style="width:${percentage}%"></div>
            </div>
          </div>
          <div class="product-stats">${sales} Ù…Ø¨ÙŠØ¹</div>
        `;
        topProductsList.appendChild(productItem);
      });

      document.getElementById('topProduct').textContent = topProducts[0][0];
      document.getElementById('topProductSales').textContent = topProducts[0][1] + ' Ù…Ø¨ÙŠØ¹';
    }
  }

  function showRecentOrders(orders) {
    const recentOrders = orders.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)).slice(0,5);
    const recentOrdersList = document.getElementById('recentOrdersList');
    recentOrdersList.innerHTML = '';
    recentOrders.forEach(order => {
      const orderItem = document.createElement('div');
      orderItem.className = 'order-item';
      orderItem.innerHTML = `
        <div class="order-info">
          <strong>${order.customerName}</strong>
          <div>${order.productName}</div>
        </div>
        <div class="order-status">
          <div>${parseFloat(order.totalPrice).toFixed(2)} Ø¯Ø¬</div>
          <div class="status-delivered">ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</div>
        </div>
      `;
      recentOrdersList.appendChild(orderItem);
    });
  }

  function updateCharts(orders) {
    updateSalesChart(orders);
    updateProductsChart(orders);
  }

  function updateSalesChart(orders) {
    const ctx = document.getElementById('salesChart').getContext('2d');
    if (salesChart) salesChart.destroy();

    const labels = generateTimeLabels();
    const data = generateSalesData(orders, labels);

    salesChart = new Chart(ctx, {
      type:'line',
      data:{labels:labels,datasets:[{label:'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',data:data,borderColor:'#667eea',backgroundColor:'rgba(102,126,234,0.1)',borderWidth:3,fill:true,tension:0.4}]},
      options:{responsive:true,plugins:{legend:{rtl:true,labels:{font:{family:'Arial, sans-serif'}}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>v+' Ø¯Ø¬'}}}}
    });
  }

  function updateProductsChart(orders) {
    const ctx = document.getElementById('productsChart').getContext('2d');
    if (productsChart) productsChart.destroy();

    const productSales = {};
    orders.forEach(o=>{if(o.productName){productSales[o.productName]=(productSales[o.productName]||0)+parseFloat(o.totalPrice)}});

    const sortedProducts = Object.entries(productSales).sort((a,b)=>b[1]-a[1]);
    const totalSales = sortedProducts.reduce((sum,[,v])=>sum+v,0);
    const legendContainer = document.getElementById('productsChartLegend');
    legendContainer.innerHTML='';

    if(totalSales===0){ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);return;}

    const colors = ['#667eea','#764ba2','#f093fb','#4facfe','#43e97b','#ff9a9e','#fbd540','#fa709a','#a6c1ee','#fbc2eb'];

    productsChart = new Chart(ctx,{
      type:'doughnut',
      data:{labels:sortedProducts.map(p=>p[0]),datasets:[{data:sortedProducts.map(p=>p[1]),backgroundColor:colors.slice(0,sortedProducts.length),borderWidth:2,borderColor:'#fff'}]},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        cutout:'70%',
        plugins:{
          legend:{display:false},
          tooltip:{callbacks:{label:function(context){const value=context.parsed;return context.label+': '+value.toFixed(2)+' Ø¯Ø¬'}}},
          datalabels:{display:false} // Ø§Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ù‚Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
        }
      }
    });

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø© Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ù„ÙˆÙ†Ø© ÙˆØ§Ù„Ù†Ø³Ø¨ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
    sortedProducts.forEach(([name,sales],i)=>{
      const percentage=((sales/totalSales)*100);
      const legendItem=document.createElement('div');
      legendItem.className='legend-item';
      legendItem.innerHTML=`<span class="color-box" style="background-color:${colors[i]}"></span>${name} <span class="percentage">${percentage<0.1?'<0.1':percentage.toFixed(1)}%</span>`;
      legendContainer.appendChild(legendItem);
    });
  }

  function generateTimeLabels(){
    switch(currentTimeRange){
      case 'day':return['8 Øµ','10 Øµ','12 Ø¸','2 Ù…','4 Ù…','6 Ù…','8 Ù…'];
      case 'week':return['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©'];
      case 'month':return['Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 1','Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 2','Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 3','Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 4'];
      case 'year':return['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
      default:return[];
    }
  }

  function generateSalesData(orders,labels){
    const data=new Array(labels.length).fill(0);
    orders.forEach(order=>{
      const d=new Date(order.timestamp);
      let i=-1;
      switch(currentTimeRange){
        case 'day': i = Math.floor(d.getHours() / 3); break;
        case 'week': i = d.getDay(); break;
        case 'month': i = Math.floor((d.getDate() - 1) / 7); break;
        case 'year': i = d.getMonth(); break;
      }
      if (i >= 0 && i < data.length) data[i] += parseFloat(order.totalPrice);
    });
    return data;
  }

  function changeTimeRange(range) {
    currentTimeRange = range;
    document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
    const clicked = Array.from(document.querySelectorAll('.time-btn'))
      .find(btn => btn.textContent.includes(range === 'day' ? 'Ø§Ù„ÙŠÙˆÙ…' : range === 'week' ? 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹' : range === 'month' ? 'Ø§Ù„Ø´Ù‡Ø±' : 'Ø§Ù„Ø³Ù†Ø©'));
    if (clicked) clicked.classList.add('active');

    if (Object.keys(allOrders).length > 0) {
      const completedOrders = Object.values(allOrders).filter(order =>
        (order.status === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„' || order.status === 'Delivered') &&
        !order.isDeliveredToOwner
      );
      updateCharts(completedOrders);
    }
  }

  window.changeTimeRange = changeTimeRange;
  </script>
</body>
</html>